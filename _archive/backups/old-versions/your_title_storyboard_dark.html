<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AIFI ÏòÅÏÉÅ ÌîÑÎ†àÏûÑÏõåÌÅ¨ Ïä§ÌÜ†Î¶¨Î≥¥Îìú - Dark Theme</title>
    
    <!-- Ïô∏Î∂Ä Ïä§ÌÉÄÏùºÏãúÌä∏ -->
    <link rel="stylesheet" href="styles/main.css">
    <link rel="stylesheet" href="styles/components/tabs.css">
    
    <!-- Content Security Policy for Google Drive iframe -->
    <meta http-equiv="Content-Security-Policy" content="default-src 'self' 'unsafe-inline' 'unsafe-eval' data: blob:; frame-src 'self' https://drive.google.com https://*.googleusercontent.com https://docs.google.com; img-src 'self' data: blob: https: http:; media-src 'self' data: blob: https: http:;">
    
    <!-- SEO -->
    <meta name="description" content="AI Í∏∞Î∞ò ÏòÅÏÉÅ Ï†úÏûëÏùÑ ÏúÑÌïú Ï¢ÖÌï©Ï†ÅÏù∏ Ïä§ÌÜ†Î¶¨Î≥¥Îìú Í¥ÄÎ¶¨ ÏãúÏä§ÌÖú. ÏãúÌÄÄÏä§, Ïî¨, ÏÉ∑ Îã®ÏúÑÎ°ú Ï≤¥Í≥ÑÏ†Å Í¥ÄÎ¶¨">
    <meta name="keywords" content="AI ÏòÅÏÉÅÏ†úÏûë, Ïä§ÌÜ†Î¶¨Î≥¥Îìú, Luma, Kling, Veo2, Runway, ÏòÅÏÉÅ ÌîÑÎ†àÏûÑÏõåÌÅ¨">
    
    <!-- Open Graph / Facebook -->
    <meta property="og:type" content="website">
    <meta property="og:url" content="https://aifiwb.netlify.app/your_title_storyboard_v9.4.html">
    <meta property="og:title" content="AIFI ÏòÅÏÉÅ ÌîÑÎ†àÏûÑÏõåÌÅ¨ Ïä§ÌÜ†Î¶¨Î≥¥Îìú">
    <meta property="og:description" content="AI Í∏∞Î∞ò ÏòÅÏÉÅ Ï†úÏûëÏùÑ ÏúÑÌïú Ï¢ÖÌï©Ï†ÅÏù∏ Ïä§ÌÜ†Î¶¨Î≥¥Îìú Í¥ÄÎ¶¨ ÏãúÏä§ÌÖú. ÏãúÌÄÄÏä§, Ïî¨, ÏÉ∑ Îã®ÏúÑÎ°ú Ï≤¥Í≥ÑÏ†ÅÏúºÎ°ú Í¥ÄÎ¶¨ÌïòÎ©∞ Îã§ÏñëÌïú AI ÎèÑÍµ¨ÏôÄ Ïó∞ÎèôÎê©ÎãàÎã§.">
    <meta property="og:image" content="https://aifiwb.netlify.app/og-image-storyboard.jpg">
    <meta property="og:image:width" content="1200">
    <meta property="og:image:height" content="630">
    <meta property="og:locale" content="ko_KR">
    <meta property="og:site_name" content="AIFI ÌîÑÎ°úÏ†ùÌä∏">

    <!-- Twitter -->
    <meta property="twitter:card" content="summary_large_image">
    <meta property="twitter:url" content="https://aifiwb.netlify.app/your_title_storyboard_v9.4.html">
    <meta property="twitter:title" content="AIFI ÏòÅÏÉÅ ÌîÑÎ†àÏûÑÏõåÌÅ¨ Ïä§ÌÜ†Î¶¨Î≥¥Îìú">
    <meta property="twitter:description" content="AI Í∏∞Î∞ò ÏòÅÏÉÅ Ï†úÏûëÏùÑ ÏúÑÌïú Ï¢ÖÌï©Ï†ÅÏù∏ Ïä§ÌÜ†Î¶¨Î≥¥Îìú Í¥ÄÎ¶¨ ÏãúÏä§ÌÖú. ÏãúÌÄÄÏä§, Ïî¨, ÏÉ∑ Îã®ÏúÑÎ°ú Ï≤¥Í≥ÑÏ†Å Í¥ÄÎ¶¨">
    <meta property="twitter:image" content="https://aifiwb.netlify.app/og-image-storyboard.jpg">

    <!-- Ïπ¥Ïπ¥Ïò§ÌÜ° -->
    <meta property="kakao:title" content="AIFI ÏòÅÏÉÅ ÌîÑÎ†àÏûÑÏõåÌÅ¨ Ïä§ÌÜ†Î¶¨Î≥¥Îìú">
    <meta property="kakao:description" content="AI Í∏∞Î∞ò ÏòÅÏÉÅ Ï†úÏûëÏùÑ ÏúÑÌïú Ï¢ÖÌï©Ï†ÅÏù∏ Ïä§ÌÜ†Î¶¨Î≥¥Îìú Í¥ÄÎ¶¨ ÏãúÏä§ÌÖú">
    <meta property="kakao:image" content="https://aifiwb.netlify.app/og-image-storyboard.jpg">

    <!-- ÌååÎπÑÏΩò -->
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üé¨</text></svg>">
    <style>
        /* Paperlogy Font Faces */
        @font-face {
            font-family: 'Paperlogy';
            src: url('fonts/Paperlogy-1Thin.ttf') format('truetype');
            font-weight: 100;
            font-style: normal;
        }
        @font-face {
            font-family: 'Paperlogy';
            src: url('fonts/Paperlogy-2ExtraLight.ttf') format('truetype');
            font-weight: 200;
            font-style: normal;
        }
        @font-face {
            font-family: 'Paperlogy';
            src: url('fonts/Paperlogy-3Light.ttf') format('truetype');
            font-weight: 300;
            font-style: normal;
        }
        @font-face {
            font-family: 'Paperlogy';
            src: url('fonts/Paperlogy-4Regular.ttf') format('truetype');
            font-weight: 400;
            font-style: normal;
        }
        @font-face {
            font-family: 'Paperlogy';
            src: url('fonts/Paperlogy-5Medium.ttf') format('truetype');
            font-weight: 500;
            font-style: normal;
        }
        @font-face {
            font-family: 'Paperlogy';
            src: url('fonts/Paperlogy-6SemiBold.ttf') format('truetype');
            font-weight: 600;
            font-style: normal;
        }
        @font-face {
            font-family: 'Paperlogy';
            src: url('fonts/Paperlogy-7Bold.ttf') format('truetype');
            font-weight: 700;
            font-style: normal;
        }
        @font-face {
            font-family: 'Paperlogy';
            src: url('fonts/Paperlogy-8ExtraBold.ttf') format('truetype');
            font-weight: 800;
            font-style: normal;
        }
        @font-face {
            font-family: 'Paperlogy';
            src: url('fonts/Paperlogy-9Black.ttf') format('truetype');
            font-weight: 900;
            font-style: normal;
        }

        /* Design Tokens */
        :root {
            /* Modern Color Palette */
            --primary-gradient: linear-gradient(135deg, #6366F1 0%, #A855F7 50%, #EC4899 100%);
            --secondary-gradient: linear-gradient(135deg, #3B82F6 0%, #8B5CF6 100%);
            --accent-gradient: linear-gradient(135deg, #F59E0B 0%, #EF4444 100%);
            
            /* Base Colors */
            --bg-primary: #0F0F0F;
            --bg-secondary: #1A1A1A;
            --bg-tertiary: #242424;
            --bg-card: #1E1E1E;
            --bg-hover: #2A2A2A;
            
            /* Text Colors */
            --text-primary: #FFFFFF;
            --text-secondary: #A1A1AA;
            --text-tertiary: #71717A;
            
            /* Accent Colors */
            --accent-purple: #A855F7;
            --accent-blue: #3B82F6;
            --accent-pink: #EC4899;
            --accent-orange: #F59E0B;
            --accent-green: #10B981;
            
            /* Shadows */
            --shadow-sm: 0 2px 4px rgba(0,0,0,0.1);
            --shadow-md: 0 4px 12px rgba(0,0,0,0.15);
            --shadow-lg: 0 8px 24px rgba(0,0,0,0.2);
            --shadow-glow: 0 0 20px rgba(168, 85, 247, 0.4);
            
            /* Transitions */
            --transition-fast: 0.15s ease;
            --transition-base: 0.3s ease;
            --transition-slow: 0.5s ease;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Paperlogy', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background-color: var(--bg-primary);
            color: var(--text-primary);
            font-weight: 400;
            line-height: 1.6;
        }

        /* Background Pattern */
        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-image: 
                radial-gradient(circle at 20% 50%, rgba(168, 85, 247, 0.1) 0%, transparent 50%),
                radial-gradient(circle at 80% 50%, rgba(59, 130, 246, 0.1) 0%, transparent 50%),
                radial-gradient(circle at 50% 100%, rgba(236, 72, 153, 0.1) 0%, transparent 50%);
            pointer-events: none;
            z-index: 0;
        }

        .container {
            display: flex;
            min-height: 100vh;
            position: relative;
            z-index: 1;
        }

        /* Header */
        .header {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            height: 72px;
            background: rgba(15, 15, 15, 0.9);
            backdrop-filter: blur(20px);
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            color: var(--text-primary);
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 2rem;
            z-index: 1000;
            box-shadow: var(--shadow-lg);
        }

        .header-left {
            display: flex;
            align-items: center;
            gap: 2rem;
        }

        .home-btn {
            background: rgba(255,255,255,0.1);
            color: var(--text-primary);
            border: 1px solid rgba(255,255,255,0.2);
            padding: 0.5rem 1rem;
            border-radius: 9999px;
            text-decoration: none;
            font-size: 0.9rem;
            font-weight: 500;
            transition: all var(--transition-base);
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .home-btn:hover {
            background: rgba(255,255,255,0.2);
            transform: translateY(-2px);
            box-shadow: var(--shadow-glow);
        }

        .header-title {
            font-size: 1.5rem;
            font-weight: 700;
            background: var(--primary-gradient);
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .project-info {
            font-size: 0.9rem;
            color: var(--text-secondary);
        }

        .header-actions {
            display: flex;
            gap: 0.75rem;
        }

        .btn {
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 0.75rem;
            cursor: pointer;
            font-size: 0.9rem;
            font-weight: 600;
            transition: all var(--transition-base);
            position: relative;
            overflow: hidden;
        }

        .btn::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.2);
            transform: translate(-50%, -50%);
            transition: width 0.6s, height 0.6s;
        }

        .btn:active::before {
            width: 300px;
            height: 300px;
        }

        .btn-primary {
            background: var(--primary-gradient);
            color: white;
            box-shadow: 0 4px 15px rgba(168, 85, 247, 0.3);
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(168, 85, 247, 0.4);
        }

        .btn-secondary {
            background: var(--bg-tertiary);
            color: var(--text-primary);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .btn-secondary:hover {
            background: var(--bg-hover);
            border-color: var(--accent-purple);
            box-shadow: 0 0 15px rgba(168, 85, 247, 0.3);
        }

        .btn-small {
            padding: 0.25rem 0.5rem;
            font-size: 0.8rem;
        }

        .btn-success {
            background: linear-gradient(135deg, #10B981 0%, #059669 100%);
            color: white;
        }

        .btn-success:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(16, 185, 129, 0.4);
        }

        .btn-danger {
            background: linear-gradient(135deg, #EF4444 0%, #DC2626 100%);
            color: white;
        }

        .btn-danger:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(239, 68, 68, 0.4);
        }

        .btn-warning {
            background: linear-gradient(135deg, #F59E0B 0%, #D97706 100%);
            color: white;
        }

        .btn-warning:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(245, 158, 11, 0.4);
        }

        /* Navigation Panel */
        .navigation {
            width: 350px;
            background: var(--bg-secondary);
            border-right: 1px solid rgba(255, 255, 255, 0.1);
            margin-top: 72px;
            padding-bottom: 50px; /* Ìë∏ÌÑ∞ Í≥µÍ∞Ñ ÌôïÎ≥¥ */
            overflow-y: auto;
            height: calc(100vh - 72px);
            scrollbar-width: thin;
            scrollbar-color: var(--bg-hover) transparent;
        }

        .navigation::-webkit-scrollbar {
            width: 6px;
        }

        .navigation::-webkit-scrollbar-track {
            background: transparent;
        }

        .navigation::-webkit-scrollbar-thumb {
            background: var(--bg-hover);
            border-radius: 3px;
        }

        .nav-header {
            padding: 1.5rem;
            background: var(--bg-tertiary);
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .project-header h3 {
            font-size: 1.1rem;
            color: var(--text-primary);
            margin-bottom: 0.5rem;
            font-weight: 600;
        }

        .project-header small {
            color: var(--text-secondary);
            font-size: 0.85rem;
        }

        .nav-controls {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 0.5rem;
            margin-top: 1rem;
        }

        .nav-controls .btn {
            font-size: 0.8rem;
            padding: 0.5rem 0.75rem;
        }

        .search-box {
            margin-top: 0.75rem;
        }

        .search-box input {
            width: 100%;
            padding: 0.75rem 1rem;
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 0.5rem;
            font-size: 0.85rem;
            background: var(--bg-primary);
            color: var(--text-primary);
            transition: all var(--transition-base);
        }

        .search-box input:focus {
            outline: none;
            border-color: var(--accent-purple);
            box-shadow: 0 0 0 3px rgba(168, 85, 247, 0.2);
        }

        .search-box input::placeholder {
            color: var(--text-tertiary);
        }

        .nav-content {
            padding: 0;
        }

        .empty-state {
            text-align: center;
            padding: 3rem 1.5rem;
            color: var(--text-tertiary);
        }

        .empty-state-icon {
            font-size: 3rem;
            margin-bottom: 1.5rem;
            opacity: 0.3;
        }

        .sequence-item {
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
        }

        .sequence-header {
            padding: 1rem 1.5rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 0.75rem;
            transition: all var(--transition-base);
            font-weight: 500;
            color: var(--text-primary);
            position: relative;
            overflow: hidden;
        }

        .sequence-header::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(168, 85, 247, 0.1), transparent);
            transition: left 0.6s;
        }

        .sequence-header:hover {
            background-color: var(--bg-hover);
            padding-left: 2rem;
        }

        .sequence-header:hover::before {
            left: 100%;
        }

        .sequence-header.active {
            background: linear-gradient(135deg, rgba(99, 102, 241, 0.2), rgba(168, 85, 247, 0.2));
            color: var(--text-primary);
            border-left: 3px solid var(--accent-purple);
        }

        .toggle-icon {
            font-size: 0.8rem;
            transition: transform var(--transition-fast);
            color: var(--text-secondary);
        }

        .toggle-icon.expanded {
            transform: rotate(90deg);
        }
        
		/* ÏßÑÌñâ ÏÉÅÌÉú ÌëúÏãú */
        .status-indicator {
            position: relative;
            cursor: help;
        }
        
        .status-indicator:hover::after {
            content: attr(data-tooltip);
            position: absolute;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%);
            background: var(--bg-tertiary);
            color: var(--text-primary);
            padding: 0.25rem 0.5rem;
            border-radius: 0.25rem;
            font-size: 0.75rem;
            white-space: nowrap;
            z-index: 100;
            border: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: var(--shadow-md);
        }
		
        /* Ïî¨ Ïä§ÌÉÄÏùº */
        .scenes-container {
            background-color: rgba(0, 0, 0, 0.2);
            border-top: 1px solid rgba(255, 255, 255, 0.05);
        }

        .scenes-container.collapsed {
            display: none;
        }

        .scene-item {
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
        }

        .scene-header {
            padding: 0.75rem 2.5rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 0.75rem;
            transition: all var(--transition-base);
            font-size: 0.95rem;
            color: var(--text-secondary);
        }

        .scene-header:hover {
            background-color: var(--bg-hover);
            color: var(--text-primary);
            padding-left: 3rem;
        }

        .scene-header.active {
            background: linear-gradient(135deg, rgba(16, 185, 129, 0.2), rgba(59, 130, 246, 0.2));
            color: var(--accent-green);
            border-left: 3px solid var(--accent-green);
        }

        /* ÏÉ∑ Ïä§ÌÉÄÏùº */
        .shots-container {
            background-color: rgba(0, 0, 0, 0.3);
        }

        .shots-container.collapsed {
            display: none;
        }

        .shot-item {
            padding: 0.5rem 3.5rem;
            cursor: pointer;
            transition: all var(--transition-base);
            font-size: 0.9rem;
            border-bottom: 1px solid rgba(255, 255, 255, 0.03);
            display: flex;
            justify-content: space-between;
            align-items: center;
            color: var(--text-tertiary);
        }

        .shot-item:hover {
            background-color: var(--bg-hover);
            color: var(--text-primary);
            padding-left: 4rem;
        }

        .shot-item.active {
            background: linear-gradient(135deg, rgba(245, 158, 11, 0.2), rgba(236, 72, 153, 0.2));
            color: var(--accent-orange);
            font-weight: 500;
            border-left: 3px solid var(--accent-orange);
        }

        .shot-actions {
            display: flex;
            gap: 0.25rem;
            opacity: 0;
            transition: opacity var(--transition-base);
        }

        .shot-item:hover .shot-actions {
            opacity: 1;
        }

        /* Main Content */
        .main-content {
            flex: 1;
            margin-top: 72px;
            padding: 2rem;
            padding-bottom: 70px; /* Ìë∏ÌÑ∞ ÎÜíÏù¥(ÏïΩ 40px) + Ïó¨Ïú† Í≥µÍ∞Ñ(30px) */
            overflow-y: auto;
            height: calc(100vh - 72px);
            background: var(--bg-primary);
            scrollbar-width: thin;
            scrollbar-color: var(--bg-hover) transparent;
        }

        .main-content::-webkit-scrollbar {
            width: 8px;
        }

        .main-content::-webkit-scrollbar-track {
            background: transparent;
        }

        .main-content::-webkit-scrollbar-thumb {
            background: var(--bg-hover);
            border-radius: 4px;
        }

        .content-header {
            margin-bottom: 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            animation: fadeIn 0.6s ease;
        }

        .content-title {
            font-size: 2rem;
            font-weight: 700;
            background: var(--primary-gradient);
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 0.5rem;
        }

        .content-subtitle {
            color: var(--text-secondary);
            font-size: 1rem;
        }

        .content-actions {
            display: flex;
            gap: 0.75rem;
        }

        /* Info Section */
        .info-section {
            background: var(--bg-secondary);
            border-radius: 1rem;
            padding: 1.75rem;
            margin-bottom: 1.5rem;
            border: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: var(--shadow-md);
            animation: fadeIn 0.8s ease;
        }

        .info-section h3 {
            font-size: 1.25rem;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 1rem;
            padding-bottom: 0.75rem;
            border-bottom: 2px solid var(--accent-purple);
            background: linear-gradient(90deg, var(--accent-purple), var(--accent-blue));
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
        }
         .info-section h4 { 
            font-size: 1.1rem;
            font-weight: 600;
            color: var(--text-primary);
            margin-top: 1rem;
            margin-bottom: 0.75rem;
        }

        .info-table {
            width: 100%;
            border-collapse: collapse;
            overflow: hidden;
            border-radius: 0.5rem;
        }

        .info-table th {
            text-align: left;
            padding: 0.75rem 1rem;
            background: linear-gradient(135deg, rgba(168, 85, 247, 0.2), rgba(59, 130, 246, 0.2));
            border: 1px solid rgba(255, 255, 255, 0.1);
            font-weight: 600;
            color: var(--text-primary);
            width: 150px;
        }

        .info-table td {
            padding: 0.75rem 1rem;
            border: 1px solid rgba(255, 255, 255, 0.1);
            color: var(--text-secondary);
            background: var(--bg-tertiary);
        }

        .info-table tr:hover td {
            background: var(--bg-hover);
            color: var(--text-primary);
        }

        /* ÌÉ≠ Ïä§ÌÉÄÏùº */
        .tabs {
            margin-bottom: 2rem;
        }

        .tab-buttons {
            display: flex;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            margin-bottom: 1.5rem;
            gap: 0.25rem;
            overflow-x: auto;
            scrollbar-width: none;
        }

        .tab-buttons::-webkit-scrollbar {
            display: none;
        }

        .tab-button {
            padding: 1rem 1.5rem;
            background: transparent;
            border: none;
            cursor: pointer;
            font-size: 1rem;
            color: var(--text-secondary);
            font-weight: 600;
            transition: all var(--transition-base);
            border-bottom: 3px solid transparent;
            position: relative;
            white-space: nowrap;
        }

        .tab-button::after {
            content: '';
            position: absolute;
            bottom: -1px;
            left: 0;
            right: 0;
            height: 3px;
            background: var(--primary-gradient);
            transform: scaleX(0);
            transition: transform var(--transition-base);
        }

        .tab-button.active {
            color: var(--text-primary);
            background: rgba(168, 85, 247, 0.1);
        }

        .tab-button.active::after {
            transform: scaleX(1);
        }

        .tab-button:hover {
            color: var(--text-primary);
            background: rgba(255, 255, 255, 0.05);
        }

        .tab-content {
            display: none;
            position: relative;
            isolation: isolate;
            overflow: hidden;
            contain: layout style;
            z-index: 1;
            animation: fadeIn 0.4s ease;
        }

        .tab-content.active {
            display: block;
            z-index: 10;
        }
        
        /* ÌÉ≠Ïù¥ ÎπÑÌôúÏÑ±ÌôîÎê† Îïå Î™®Îì† ÏûêÏãù ÏöîÏÜåÎèÑ Ïà®ÍπÄ */
        .tab-content:not(.active) {
            pointer-events: none !important;
        }
        
        .tab-content:not(.active) * {
            visibility: hidden !important;
            display: none !important;
            opacity: 0 !important;
        }
        
        /* Ïò§ÎîîÏò§ ÏÑπÏÖòÏùÄ Ïò§ÎîîÏò§ ÌÉ≠ÏóêÏÑúÎßå ÌëúÏãú */
        .tab-content:not(#tab-audio) .audio-section {
            display: none !important;
            visibility: hidden !important;
            height: 0 !important;
            overflow: hidden !important;
        }
        
        /* ÏùåÏïÖ ÏÑπÏÖòÏùÄ ÏùåÏïÖ ÌÉ≠ÏóêÏÑúÎßå ÌëúÏãú */
        .tab-content:not(#tab-music) .music-ost-section {
            display: none !important;
            visibility: hidden !important;
            height: 0 !important;
            overflow: hidden !important;
        }
        
        /* Í∞Å ÌÉ≠Î≥Ñ Í≤©Î¶¨ Í∞ïÌôî */
        #tab-info { z-index: 11; }
        #tab-image { z-index: 12; }
        #tab-video { z-index: 13; }
        #tab-audio { z-index: 14; }
        #tab-music { z-index: 15; }

        /* ÌîÑÎ°¨ÌîÑÌä∏ Í¥ÄÎ†® Ïä§ÌÉÄÏùº (ÏùºÎ∞ò) */
        .prompt-container { 
            background: var(--bg-tertiary);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 0.75rem;
            padding: 1rem;
            margin-bottom: 1.5rem;
        }

        .prompt-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.75rem;
        }

        .prompt-title { 
            font-weight: 600;
            color: var(--text-primary);
        }

        .copy-btn { 
            background: var(--accent-green);
            color: white;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 0.5rem;
            cursor: pointer;
            font-size: 0.85rem;
            font-weight: 600;
            transition: all var(--transition-base);
        }

        .copy-btn:hover {
            background: #059669;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3);
        }

        .copy-btn:active {
            transform: translateY(0);
        }

        .prompt-text { 
            background: var(--bg-primary);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 0.5rem;
            padding: 1rem;
            font-family: 'Monaco', 'Consolas', monospace;
            font-size: 0.9rem;
            line-height: 1.6;
            white-space: pre-wrap;
            color: var(--text-secondary);
            max-height: 200px;
            overflow-y: auto;
            scrollbar-width: thin;
            scrollbar-color: var(--bg-hover) transparent;
        }

        .prompt-text::-webkit-scrollbar {
            width: 6px;
        }

        .prompt-text::-webkit-scrollbar-track {
            background: transparent;
        }

        .prompt-text::-webkit-scrollbar-thumb {
            background: var(--bg-hover);
            border-radius: 3px;
        }

        /* Form Elements */
        .form-group {
            margin-bottom: 1rem;
        }

        .form-label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 500;
            color: var(--text-primary);
        }

        .form-input {
            width: 100%;
            padding: 0.75rem 1rem;
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 0.5rem;
            font-size: 0.95rem;
            background: var(--bg-primary);
            color: var(--text-primary);
            transition: all var(--transition-base);
        }

        .form-input:focus {
            outline: none;
            border-color: var(--accent-purple);
            box-shadow: 0 0 0 3px rgba(168, 85, 247, 0.2);
        }

        .form-select {
            width: 100%;
            padding: 0.75rem 1rem;
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 0.5rem;
            font-size: 0.95rem;
            background: var(--bg-primary);
            color: var(--text-primary);
            transition: all var(--transition-base);
        }

        .form-select:focus {
            outline: none;
            border-color: var(--accent-purple);
            box-shadow: 0 0 0 3px rgba(168, 85, 247, 0.2);
        }

        .form-textarea {
            width: 100%;
            padding: 0.75rem 1rem;
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 0.5rem;
            font-size: 0.95rem;
            min-height: 80px;
            resize: vertical;
            background: var(--bg-primary);
            color: var(--text-primary);
            transition: all var(--transition-base);
        }

        .form-textarea:focus {
            outline: none;
            border-color: var(--accent-purple);
            box-shadow: 0 0 0 3px rgba(168, 85, 247, 0.2);
        }

        /* Ïò§ÎîîÏò§ ÏÑπÏÖò Ïä§ÌÉÄÏùº */
        .audio-section {
            background: var(--bg-secondary);
            border-radius: 0.75rem;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            box-shadow: var(--shadow-md);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .audio-section h4 {
            color: var(--text-primary);
            margin-bottom: 1rem;
            padding-bottom: 0.5rem;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            font-weight: 600;
        }

        .audio-player-area {
            min-height: 80px;
            background: var(--bg-tertiary);
            border-radius: 0.5rem;
            display: flex;
            align-items: center;
            justify-content: center;
            border: 2px dashed rgba(255, 255, 255, 0.2);
            margin-bottom: 1rem;
            transition: all var(--transition-base);
        }

        .audio-player-area:hover {
            border-color: var(--accent-purple);
            background: rgba(168, 85, 247, 0.05);
        }

        .audio-content-display {
            background: var(--bg-tertiary);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 0.5rem;
            padding: 1rem;
            margin-bottom: 0.75rem;
            font-family: 'Paperlogy', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            font-size: 0.9rem;
            line-height: 1.6;
            white-space: pre-wrap;
            color: var(--text-secondary);
            min-height: 60px;
        }

        /* ÏùåÏïÖ ÌÉ≠ Ï†ÑÏö© Ïä§ÌÉÄÏùº */
        .music-ost-section {
            background: linear-gradient(135deg, var(--bg-secondary), var(--bg-tertiary));
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 1rem;
            padding: 1.75rem;
            margin-bottom: 1.75rem;
            box-shadow: var(--shadow-lg);
        }

        .music-ost-section h4 {
            color: var(--text-primary);
            margin-bottom: 1.5rem;
            padding-bottom: 0.75rem;
            border-bottom: 2px solid var(--accent-purple);
            font-size: 1.1rem;
            font-weight: 600;
            background: linear-gradient(90deg, var(--accent-purple), var(--accent-pink));
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .ost-prompt-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1.5rem;
        }

        .ost-prompt-item {
            background: var(--bg-tertiary);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 0.5rem;
            padding: 1rem;
            transition: all var(--transition-base);
        }

        .ost-prompt-item:hover {
            border-color: var(--accent-purple);
            box-shadow: 0 0 20px rgba(168, 85, 247, 0.2);
            transform: translateY(-2px);
        }

        .ost-prompt-item .prompt-title { 
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 0.75rem;
            font-size: 0.95rem;
        }

        .ost-prompt-item .prompt-text { 
            background: var(--bg-primary); 
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 0.25rem;
            padding: 0.75rem;
            font-family: 'Monaco', 'Consolas', monospace;
            font-size: 0.85rem;
            line-height: 1.5;
            white-space: pre-wrap;
            color: var(--text-secondary);
            max-height: 120px;
            overflow-y: auto;
            margin-bottom: 0.75rem;
            scrollbar-width: thin;
            scrollbar-color: var(--bg-hover) transparent;
        }

        .ost-prompt-item .prompt-text::-webkit-scrollbar {
            width: 4px;
        }

        .ost-prompt-item .prompt-text::-webkit-scrollbar-track {
            background: transparent;
        }

        .ost-prompt-item .prompt-text::-webkit-scrollbar-thumb {
            background: var(--bg-hover);
            border-radius: 2px;
        }

        /* Messages */
        .message-container {
            position: fixed;
            top: 90px;
            right: 20px;
            z-index: 1001;
            max-width: 400px;
        }

        .message {
            background: var(--bg-tertiary);
            border-radius: 0.75rem;
            padding: 1rem 1.5rem;
            margin-bottom: 0.75rem;
            box-shadow: var(--shadow-lg);
            border-left: 4px solid var(--accent-blue);
            position: relative;
            color: var(--text-primary);
            backdrop-filter: blur(10px);
            animation: slideInRight 0.3s ease;
        }

        .message.success-message {
            border-left-color: var(--accent-green);
            background: linear-gradient(135deg, rgba(16, 185, 129, 0.1), var(--bg-tertiary));
        }

        .message.error-message {
            border-left-color: #EF4444;
            background: linear-gradient(135deg, rgba(239, 68, 68, 0.1), var(--bg-tertiary));
        }

        .message.warning-message {
            border-left-color: var(--accent-orange);
            background: linear-gradient(135deg, rgba(245, 158, 11, 0.1), var(--bg-tertiary));
        }

        .close-button {
            position: absolute;
            top: 0.5rem;
            right: 0.75rem;
            background: none;
            border: none;
            font-size: 1.2rem;
            cursor: pointer;
            color: var(--text-tertiary);
            transition: all var(--transition-base);
        }

        .close-button:hover {
            color: var(--text-primary);
            transform: rotate(90deg);
        }

        .hidden-file-input {
            display: none;
        }

        /* ÏòÅÏÉÅ ÌÉ≠ AI Ïπ¥Îìú Í∑∏Î¶¨Îìú Ïä§ÌÉÄÏùº ÏãúÏûë */
        .video-ai-grid {
            display: grid;
            grid-template-columns: 1fr; 
            gap: 1.5rem;
            margin-top: 1.5rem;
        }

        .ai-video-card { 
            background: var(--bg-secondary);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 1rem;
            padding: 1.5rem;
            box-shadow: var(--shadow-md);
            display: flex;
            flex-direction: column;
            transition: all var(--transition-base);
            position: relative;
            overflow: hidden;
        }

        .ai-video-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, transparent, currentColor, transparent);
            transform: translateX(-100%);
            transition: transform 0.6s;
        }

        .ai-video-card:hover {
            box-shadow: var(--shadow-lg);
            transform: translateY(-2px);
        }

        .ai-video-card:hover::before {
            transform: translateX(100%);
        }

        .ai-video-card .ai-card-header { 
            font-size: 1.2rem;
            font-weight: 700;
            padding-bottom: 0.75rem;
            margin-bottom: 1rem;
            border-bottom-width: 2px; 
            border-bottom-style: solid;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .ai-video-card.luma .ai-card-header { 
            border-color: #FF8C00; 
            color: #FF8C00;
            text-shadow: 0 0 20px rgba(255, 140, 0, 0.5);
        } 
        .ai-video-card.kling .ai-card-header { 
            border-color: #1E90FF; 
            color: #1E90FF;
            text-shadow: 0 0 20px rgba(30, 144, 255, 0.5);
        } 
        .ai-video-card.veo2 .ai-card-header { 
            border-color: #9370DB; 
            color: #9370DB;
            text-shadow: 0 0 20px rgba(147, 112, 219, 0.5);
        } 
        .ai-video-card.runway .ai-card-header { 
            border-color: #3CB371; 
            color: #3CB371;
            text-shadow: 0 0 20px rgba(60, 179, 113, 0.5);
        } 

        .ai-video-card .ai-card-content {
            flex-grow: 1;
        }

        .ai-video-card .ai-prompt-area {
            margin-bottom: 1rem;
        }

        .ai-video-card .prompt-text { 
            background: var(--bg-tertiary);
            border: 1px solid rgba(255, 255, 255, 0.1);
            font-size: 0.85rem; 
            max-height: 150px;
            margin-bottom: 0.75rem;
            color: var(--text-secondary);
        }

        .ai-video-card .copy-prompt-btn { 
            background: var(--bg-tertiary);
            color: var(--text-primary);
            border: 1px solid rgba(255, 255, 255, 0.2);
            padding: 0.5rem 1rem;
            border-radius: 0.5rem;
            cursor: pointer;
            font-size: 0.8rem;
            font-weight: 600;
            transition: all var(--transition-base);
            margin-bottom: 1rem;
        }

        .ai-video-card .copy-prompt-btn:hover {
            background: var(--accent-purple);
            border-color: var(--accent-purple);
            color: white;
            box-shadow: 0 4px 12px rgba(168, 85, 247, 0.3);
        }

        .ai-video-card .form-input { 
            padding: 0.5rem 0.75rem;
            font-size: 0.9rem;
        }

        .ai-video-preview {
            min-height: 150px;
            background: var(--bg-tertiary);
            border-radius: 0.5rem;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 0.75rem;
            border: 1px solid rgba(255, 255, 255, 0.1);
            position: relative;
            overflow: hidden;
        }

        .ai-video-preview::after {
            content: '‚ñ∂';
            position: absolute;
            font-size: 3rem;
            color: rgba(255, 255, 255, 0.3);
            pointer-events: none;
        }

        .ai-video-preview video {
            max-width: 100%;
            max-height: 250px;
            border-radius: 0.25rem;
            z-index: 1;
        }

        .ai-select-button {
            background: var(--accent-blue);
            color: white;
            border: none;
            padding: 0.75rem 1.25rem;
            border-radius: 0.5rem;
            cursor: pointer;
            font-size: 0.9rem;
            font-weight: 600;
            transition: all var(--transition-base);
            width: 100%;
            margin-top: auto;
        }

        .ai-select-button:hover {
            background: #2563EB;
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(59, 130, 246, 0.4);
        }

        .ai-select-button.selected {
            background: var(--accent-green);
            cursor: default;
        }
        
        .ai-video-card.selected-ai-card {
            border-left: 5px solid var(--accent-green);
            box-shadow: 0 4px 20px rgba(16, 185, 129, 0.3);
            background: linear-gradient(135deg, rgba(16, 185, 129, 0.1), var(--bg-secondary));
        }
        
        .ai-video-card .ai-settings-info { 
            font-size: 0.8rem;
            color: var(--text-tertiary);
            margin-top: 0.75rem;
            padding-top: 0.75rem;
            border-top: 1px dashed rgba(255, 255, 255, 0.1);
        }

        /* Ï∂îÏ∂úÎêú Ïù¥ÎØ∏ÏßÄ Ï†ïÎ≥¥ ÏÑπÏÖò */
        .extracted-images-info {
            background: var(--bg-tertiary);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 0.75rem;
            padding: 1rem;
            margin-top: 1rem;
        }

        .extracted-images-info h5 {
            font-size: 1rem;
            color: var(--text-primary);
            margin-bottom: 0.75rem;
            font-weight: 600;
        }

        .extracted-image-item {
            background: var(--bg-primary);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 0.5rem;
            padding: 0.75rem;
            margin-bottom: 0.5rem;
            transition: all var(--transition-base);
        }

        .extracted-image-item:hover {
            border-color: var(--accent-purple);
            transform: translateX(4px);
        }

        .extracted-image-item .image-id {
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 0.25rem;
        }

        .extracted-image-item .image-description {
            font-size: 0.85rem;
            color: var(--text-secondary);
        }

        /* ÏòÅÏÉÅ ÌÉ≠ AI Ïπ¥Îìú Í∑∏Î¶¨Îìú Ïä§ÌÉÄÏùº ÎÅù */

        /* Ïù¥ÎØ∏ÏßÄ ÌÉ≠ - Ïù¥ÎØ∏ÏßÄ ÏÑ§Í≥Ñ ÌîåÎûú Ïä§ÌÉÄÏùº */
        .image-design-plan-selector {
            background: var(--bg-secondary);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 1rem;
            padding: 1.5rem;
            margin-bottom: 1.75rem;
            box-shadow: var(--shadow-md);
        }

        .plan-tabs {
            display: flex;
            gap: 0.75rem;
            margin-bottom: 1.5rem;
        }

        .plan-tab {
            padding: 0.75rem 1.5rem;
            background: var(--bg-tertiary);
            border: 2px solid rgba(255, 255, 255, 0.1);
            border-radius: 0.75rem;
            cursor: pointer;
            transition: all var(--transition-base);
            flex: 1;
            text-align: center;
            font-weight: 600;
            color: var(--text-secondary);
        }

        .plan-tab.active {
            background: var(--accent-blue);
            color: white;
            border-color: var(--accent-blue);
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
        }

        .plan-tab:hover:not(.active) {
            background: var(--bg-hover);
            color: var(--text-primary);
            border-color: var(--accent-purple);
        }

        .plan-content {
            display: none;
            animation: fadeIn 0.4s ease;
        }

        .plan-content.active {
            display: block;
        }

        .plan-info {
            background: var(--bg-tertiary);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 0.5rem;
            padding: 1rem;
            margin-bottom: 1.5rem;
        }

        .plan-info h5 {
            font-size: 1.05rem;
            color: var(--text-primary);
            margin-bottom: 0.75rem;
            font-weight: 600;
        }

        .plan-metadata {
            font-size: 0.85rem;
            color: var(--text-secondary);
            margin-bottom: 0.5rem;
        }

        /* Ïù¥ÎØ∏ÏßÄ AI ÏÑπÏÖò (ÌîåÎûúÎ≥Ñ) */
        .image-ai-grid { 
            display: grid;
            grid-template-columns: 1fr; 
            gap: 2rem; 
            margin-top: 1.5rem;
        }

        .ai-image-section { 
            background: var(--bg-secondary);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 1rem;
            padding: 1.5rem;
            box-shadow: var(--shadow-md);
            position: relative;
            overflow: hidden;
        }

        .ai-image-section::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, transparent, currentColor, transparent);
            transform: translateX(-100%);
            transition: transform 0.6s;
        }

        .ai-image-section:hover::before {
            transform: translateX(100%);
        }

        .ai-image-section .ai-card-header { 
            font-size: 1.3rem; 
            font-weight: 700;
            border-bottom-width: 2px;
            border-bottom-style: solid; 
            margin-bottom: 1.5rem;
            padding-bottom: 0.75rem;
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
        }

        .ai-image-section.midjourney .ai-card-header { 
            border-color: #0099FF; 
            color: #0099FF;
            text-shadow: 0 0 20px rgba(0, 153, 255, 0.5);
        } 
        .ai-image-section.ideogram .ai-card-header { 
            border-color: #FF6600; 
            color: #FF6600;
            text-shadow: 0 0 20px rgba(255, 102, 0, 0.5);
        } 
        .ai-image-section.leonardo .ai-card-header { 
            border-color: #9933CC; 
            color: #9933CC;
            text-shadow: 0 0 20px rgba(153, 51, 204, 0.5);
        } 
        .ai-image-section.imagefx .ai-card-header { 
            border-color: #00CC66; 
            color: #00CC66;
            text-shadow: 0 0 20px rgba(0, 204, 102, 0.5);
        } 
		.ai-image-section.openart .ai-card-header { 
            border-color: #FF6B6B; 
            color: #FF6B6B;
            text-shadow: 0 0 20px rgba(255, 107, 107, 0.5);
        }

        /* CSV Ï†ïÎ≥¥ ÌëúÏãú */
        .csv-info-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 0.75rem;
            margin-bottom: 1rem;
            padding: 0.75rem;
            background: var(--bg-tertiary);
            border-radius: 0.5rem;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .csv-item {
            font-size: 0.85rem;
            color: var(--text-secondary);
        }

        .csv-item strong {
            color: var(--text-primary);
            font-weight: 600;
        }

        /* ÌîÑÎ°¨ÌîÑÌä∏ Ï†ïÎ≥¥ (ÏõêÎ≥∏ + Î≤àÏó≠) */
        .ai-image-prompt-details {
            background: var(--bg-tertiary);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 0.5rem;
            padding: 1rem;
            margin-bottom: 1.5rem;
        }

        .prompt-original,
        .prompt-translated {
            margin-bottom: 1rem;
        }

        .prompt-text-label {
            font-weight: 600;
            color: var(--text-primary);
            font-size: 0.95rem;
            margin-bottom: 0.5rem;
            display: block;
        }

        .ai-image-prompt-full-text { 
            background: var(--bg-primary);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 0.25rem;
            padding: 0.75rem;
            font-family: 'Monaco', 'Consolas', monospace;
            font-size: 0.9rem;
            line-height: 1.6;
            white-space: pre-wrap;
            color: var(--text-secondary);
            max-height: 180px;
            overflow-y: auto;
            margin-bottom: 0.75rem;
            scrollbar-width: thin;
            scrollbar-color: var(--bg-hover) transparent;
        }

        .ai-image-prompt-full-text::-webkit-scrollbar {
            width: 6px;
        }

        .ai-image-prompt-full-text::-webkit-scrollbar-track {
            background: transparent;
        }

        .ai-image-prompt-full-text::-webkit-scrollbar-thumb {
            background: var(--bg-hover);
            border-radius: 3px;
        }

        .generated-images-grid { 
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); 
            gap: 1.5rem;
            margin-top: 1.5rem;
            padding-top: 1.5rem;
            border-top: 1px dashed rgba(255, 255, 255, 0.1);
        }

        .image-slot-card { 
            background: var(--bg-tertiary);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 0.5rem;
            padding: 1rem;
            display: flex;
            flex-direction: column;
            transition: all var(--transition-base);
        }

        .image-slot-card:hover {
            border-color: var(--accent-purple);
            box-shadow: 0 0 20px rgba(168, 85, 247, 0.2);
            transform: translateY(-2px);
        }

        .image-slot-preview {
            width: 100%;
            height: 180px; 
            border: 2px dashed rgba(255, 255, 255, 0.2);
            border-radius: 0.25rem;
            display: flex;
            align-items: center;
            justify-content: center;
            background: var(--bg-primary);
            margin-bottom: 0.75rem;
            overflow: hidden;
            transition: all var(--transition-base);
            position: relative;
        }

        .image-slot-preview:hover {
            border-color: var(--accent-purple);
            background: rgba(168, 85, 247, 0.05);
        }

        .image-slot-preview img {
            max-width: 100%;
            max-height: 100%;
            object-fit: contain; 
            border-radius: 0.25rem;
            cursor: zoom-in;
        }

        .image-slot-card .form-group {
            margin-bottom: 0.75rem;
        }
        .image-slot-card .form-label {
            font-size: 0.85rem;
            margin-bottom: 0.25rem;
        }
        .image-slot-card .form-input,
        .image-slot-card .form-textarea {
            font-size: 0.9rem;
            padding: 0.5rem 0.75rem;
        }
        .image-slot-card .form-textarea {
            min-height: 60px;
            resize: vertical;
        }

        .image-slot-actions {
            margin-top: 0.75rem;
            display: flex;
            gap: 0.5rem;
        }
        .image-slot-actions .btn-small { 
            flex-grow: 1; 
        }

        /* Ï∞∏Ï°∞ Ïù¥ÎØ∏ÏßÄ ÏÑπÏÖò Ïä§ÌÉÄÏùº */
        .reference-image-slots-container {
            margin-top: 2rem;
            padding-top: 1.5rem;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
        }
        .reference-image-slots-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 1.5rem;
        }

        .reference-image-slot { 
            background: var(--bg-secondary);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 0.75rem;
            padding: 1rem;
            box-shadow: var(--shadow-md);
            transition: all var(--transition-base);
        }

        .reference-image-slot:hover {
            border-color: var(--accent-purple);
            box-shadow: 0 0 20px rgba(168, 85, 247, 0.2);
            transform: translateY(-2px);
        }

        .reference-image-slot .reference-preview { 
            width: 100%;
            height: 160px;
            margin-bottom: 1rem;
            border: 2px dashed rgba(255, 255, 255, 0.2); 
            border-radius: 0.5rem; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            background: var(--bg-tertiary); 
            overflow: hidden;
            transition: all var(--transition-base);
        }

        .reference-image-slot .reference-preview:hover {
            border-color: var(--accent-purple);
            background: rgba(168, 85, 247, 0.05);
        }

         .reference-image-slot .reference-preview img { 
            max-width: 100%;
            max-height: 100%;
            object-fit: contain;
            border-radius: 0.25rem;
            cursor: zoom-in;
        }

        .reference-image-slot .form-group {
            margin-bottom: 0.75rem;
        }
        .reference-image-slot .form-label {
            font-size: 0.85rem;
        }
        .reference-image-slot .form-input,
        .reference-image-slot .form-select,
        .reference-image-slot .form-textarea {
            font-size: 0.9rem;
            padding: 0.5rem 0.75rem;
        }
        .reference-image-slot .btn-danger { 
            width: 100%;
            margin-top: 0.75rem;
        }

        /* Ïù¥ÎØ∏ÏßÄ ÌÅ¨Í≤å Î≥¥Í∏∞ Î™®Îã¨ */
        .image-modal {
            display: none; 
            position: fixed;
            z-index: 2000; 
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0, 0, 0, 0.95);
            backdrop-filter: blur(10px);
            justify-content: center; 
            align-items: center;
            cursor: zoom-out;
        }
        .image-modal-content {
            margin: auto;
            display: block;
            max-width: 85%;
            max-height: 85%;
            border-radius: 0.5rem;
            box-shadow: 0 0 40px rgba(168, 85, 247, 0.5);
            animation: zoomIn 0.3s ease;
        }
        .image-modal-close {
            position: absolute;
            top: 1.5rem;
            right: 2.5rem;
            color: white;
            font-size: 2.5rem;
            font-weight: bold;
            transition: all var(--transition-base);
            cursor: pointer;
            background: rgba(0, 0, 0, 0.5);
            width: 50px;
            height: 50px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .image-modal-close:hover,
        .image-modal-close:focus {
            color: var(--accent-purple);
            transform: rotate(90deg);
        }

        /* ÏõêÎ≥∏ ÏãúÎÇòÎ¶¨Ïò§ ÌëúÏãú Ïä§ÌÉÄÏùº */
        .original-scenario-section {
            background: var(--bg-secondary);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 1rem;
            padding: 1.5rem;
            margin-top: 1.5rem;
            box-shadow: var(--shadow-md);
        }

        .original-scenario-section h4 {
            font-size: 1.1rem;
            color: var(--text-primary);
            margin-bottom: 1rem;
            padding-bottom: 0.75rem;
            border-bottom: 2px solid var(--accent-purple);
            font-weight: 600;
        }

        .scenario-text {
            background: var(--bg-tertiary);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 0.5rem;
            padding: 1rem;
            font-family: 'Paperlogy', 'Georgia', serif;
            font-size: 1rem;
            line-height: 1.8;
            color: var(--text-primary);
            white-space: pre-wrap;
        }

        .scenario-metadata {
            margin-top: 0.75rem;
            font-size: 0.85rem;
            color: var(--text-secondary);
        }

        /* Animations */
        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes zoomIn {
            from {
                opacity: 0;
                transform: scale(0.8);
            }
            to {
                opacity: 1;
                transform: scale(1);
            }
        }

        @keyframes slideInRight {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }
		 /* Ï§ëÍ∞Ñ ÌôîÎ©¥ Î∞òÏùëÌòï */
		@media (max-width: 1200px) {
			.header-title {
				font-size: 1.1rem;
			}

			.header-actions {
				flex-wrap: wrap;
			}

			.header-actions .btn {
				font-size: 0.8rem;
				padding: 6px 12px;
			}
		}

		/* ÏûëÏùÄ ÌôîÎ©¥ Î∞òÏùëÌòï */
		@media (max-width: 992px) {
			.navigation {
				width: 280px;
			}

			.header {
				padding: 0 15px;
			}
		}

        /* Î∞òÏùëÌòï ÎîîÏûêÏù∏ */
        @media (max-width: 768px) {
            .navigation {
                width: 100%;
                height: auto;
                position: relative;
                margin-top: 0;
            }
            
            .main-content {
                width: 100%;
                margin-top: 0;
                padding: 15px;
                padding-bottom: 60px; /* Î™®Î∞îÏùºÏóêÏÑúÎèÑ Ìë∏ÌÑ∞ Í≥µÍ∞Ñ ÌôïÎ≥¥ */
            }
            
            .container {
                flex-direction: column;
            }
            
            .header {
                position: relative;
            }

            .ost-prompt-grid {
                grid-template-columns: 1fr;
            }

            .video-ai-grid { 
                grid-template-columns: 1fr; 
            }
            .generated-images-grid, .reference-image-slots-grid { 
                grid-template-columns: 1fr;
            }

            .plan-tabs {
                flex-direction: column;
            }

            .csv-info-grid {
                grid-template-columns: 1fr;
            }
        }
		/* ÏòÅÏÉÅ Ïù¥ÎØ∏ÏßÄ Ïª®ÌÖåÏù¥ÎÑà */
			.video-images-container {
				margin-top: 20px;
			}

			.video-image-card {
				background: #f8f9fa;
				border: 1px solid #e0e0e0;
				border-radius: 8px;
				padding: 20px;
				margin-bottom: 30px;
			}

			.video-image-card h5 {
				color: #333;
				margin-bottom: 15px;
				font-size: 1.1rem;
			}

			/* Ïù¥ÎØ∏ÏßÄÎ≥Ñ AI Í∑∏Î¶¨Îìú */
			.video-image-card .video-ai-grid {
				display: grid;
				grid-template-columns: repeat(2, 1fr);
				gap: 15px;
				margin-top: 15px;
			}

			@media (max-width: 768px) {
				.video-image-card .video-ai-grid {
					grid-template-columns: 1fr;
				}
			}
    </style>
</head>
<body>
    <header class="header">
        <div class="header-left">
            <a href="index.html" class="home-btn">üè† Ìôà</a>
            <div class="header-title">Film Storyboard</div>
         <!-- <div class="project-info">
                <div id="project-title">ÏÉà ÌîÑÎ°úÏ†ùÌä∏</div>
                <div id="project-file" style="font-size: 0.8rem; opacity: 0.8;">ÌååÏùº: ÏóÜÏùå</div>
            </div> -->
        </div>
        <div class="header-actions">
            <button class="btn btn-secondary" id="concept-art-btn">Ïª®ÏÖâÏïÑÌä∏ Î≥¥Í∏∞</button>
            <button class="btn btn-primary" id="import-btn">JSON Í∞ÄÏ†∏Ïò§Í∏∞</button>
            <div class="dropdown" style="display: inline-block;">
                <button class="btn btn-primary dropdown-toggle" id="export-btn" onclick="toggleExportDropdown(event)">
                    JSON ÎÇ¥Î≥¥ÎÇ¥Í∏∞ ‚ñº
                </button>
                <div id="export-dropdown" class="dropdown-menu" style="display: none; position: absolute; background: white; border: 1px solid #ccc; border-radius: 4px; box-shadow: 0 2px 5px rgba(0,0,0,0.2); z-index: 1000; min-width: 180px;">
                    <button class="dropdown-item" onclick="exportFullData(); hideExportDropdown();" style="display: block; width: 100%; padding: 10px 15px; border: none; background: none; text-align: left; cursor: pointer;" onmouseover="this.style.backgroundColor='#f0f0f0'" onmouseout="this.style.backgroundColor='transparent'">
                        üì¶ Ï†ÑÏ≤¥ ÌîÑÎ°úÏ†ùÌä∏ Î∞±ÏóÖ
                    </button>
                </div>
            </div>
			<button class="btn btn-secondary" id="scenario-export-btn" style="display:none;">ÏãúÎÇòÎ¶¨Ïò§ Îã§Ïö¥</button>
			<button class="btn btn-danger" id="reset-btn" style="margin-left: 20px;">Îç∞Ïù¥ÌÑ∞ Ï¥àÍ∏∞Ìôî</button>
        </div>
    </header>

    <div class="container">
        <nav class="navigation">
            <div class="nav-header">
                <div class="project-header">
                    <h3 id="nav-project-title">ÌîÑÎ°úÏ†ùÌä∏ Î°úÎî© Ï§ë...</h3>
                    <small id="nav-project-description" style="color: #666;">ÌîÑÎ°úÏ†ùÌä∏ ÏÑ§Î™ÖÏù¥ Ïó¨Í∏∞Ïóê ÌëúÏãúÎê©ÎãàÎã§</small>
                </div>
                <div class="nav-controls">
                    <button class="btn btn-secondary" id="expand-all-btn">Ï†ÑÏ≤¥ ÌéºÏπòÍ∏∞</button>
                    <button class="btn btn-secondary" id="collapse-all-btn">Ï†ÑÏ≤¥ Ï†ëÍ∏∞</button>
                </div>
                <div class="search-box">
                    <input type="text" id="search-input" placeholder="ÏãúÌÄÄÏä§, Ïî¨, ÏÉ∑ Í≤ÄÏÉâ..." />
                </div>
            </div>
            <div class="nav-content" id="navigation-content">
                <div class="empty-state" id="nav-empty">
                    <div class="empty-state-icon">üìÅ</div>
                    <div>Îç∞Ïù¥ÌÑ∞Í∞Ä ÏóÜÏäµÎãàÎã§</div>
                    <div style="font-size: 0.9rem; margin-top: 10px;">JSON Í∞ÄÏ†∏Ïò§Í∏∞Î•º ÏÇ¨Ïö©Ìï¥ Îç∞Ïù¥ÌÑ∞Î•º Î°úÎìúÌï¥Ï£ºÏÑ∏Ïöî</div>
                </div>
            </div>
        </nav>

        <main class="main-content">
            <div class="content-header">
                <div>
                    <h1 class="content-title" id="content-title">ÌîÑÎ°úÏ†ùÌä∏ ÏÑ†ÌÉù</h1>
                    <p class="content-subtitle" id="content-subtitle">Ï¢åÏ∏°ÏóêÏÑú ÏãúÌÄÄÏä§, Ïî¨, ÎòêÎäî ÏÉ∑ÏùÑ ÏÑ†ÌÉùÌïòÏÑ∏Ïöî</p>
                </div>
                <div class="content-actions" id="content-actions" style="display: none;">
                </div>
            </div>

            <div id="content-area">
                <div class="empty-state">
                    <div class="empty-state-icon">üé¨</div>
                    <div>ÏãúÌÄÄÏä§, Ïî¨, ÎòêÎäî ÏÉ∑ÏùÑ ÏÑ†ÌÉùÌïòÏó¨ ÏÉÅÏÑ∏ Ï†ïÎ≥¥Î•º ÌôïÏù∏ÌïòÏÑ∏Ïöî</div>
                </div>
            </div>
        </main>
    </div>

    <div id="message-container" class="message-container"></div>
	<footer style="position: fixed; bottom: 0; left: 0; right: 0; text-align: center; padding: 10px; background: rgba(255,255,255,0.9); border-top: 1px solid #e0e0e0; font-size: 0.85rem; color: #666;">
    ¬© 2025 AiFi. All rights reserved.
    </footer>

    <input type="file" id="file-input" class="hidden-file-input" accept=".json">
	<!-- Ïù¥ÎØ∏ÏßÄ ÌÅ¨Í≤å Î≥¥Í∏∞ Î™®Îã¨ -->
		<div id="imageDisplayModal" class="image-modal" onclick="closeImageModal(event)">
			<span class="image-modal-close" onclick="closeImageModal(event)">&times;</span>
			<img class="image-modal-content" id="modalImageContent">
		</div>

    <!-- Î™®Îìà Ïä§ÌÅ¨Î¶ΩÌä∏ Î°úÎìú -->
    <script type="module">
        import { createTabManager } from './js/components/common/TabManager.js';
        import { dataAdapter } from './js/utils/dataAdapter.js';
        import { dataManager } from './js/utils/dataManager.js';
        
        // Ï†ÑÏó≠ Î≥ÄÏàò ÏÑ§Ï†ï
        window.tabManager = null;
        window.dataAdapter = dataAdapter;
        window.dataManager = dataManager;
        
        // Î™®ÎìàÌôîÎêú showShotContent Ìï®Ïàò
        window.showShotContentModular = function(shotId) {
            try {
                // currentDataÎ•º dataAdapterÏóê ÏÑ§Ï†ï
                dataAdapter.setCurrentData(currentData);
                
                // dataManagerÏóêÎèÑ adapter ÏÑ§Ï†ï
                dataManager.setAdapter(dataAdapter);
                
                const shotData = dataAdapter.findShotById(shotId);
                if (!shotData) {
                    console.error('Shot not found:', shotId);
                    return;
                }
                
                // TabManagerÍ∞Ä ÏóÜÏúºÎ©¥ ÏÉùÏÑ±
                if (!window.tabManager) {
                    window.tabManager = createTabManager('#content-area');
                }
                
                // ÌÉ≠ Ïª®ÌÖåÏù¥ÎÑà HTML ÏÉùÏÑ±
                document.getElementById('content-area').innerHTML = `
                    <div class="tabs">
                        <div class="tab-buttons">
                            <button class="tab-button active" data-tab="info" onclick="showTab('info')">Ï†ïÎ≥¥</button>
                            <button class="tab-button" data-tab="image" onclick="showTab('image')">Ïù¥ÎØ∏ÏßÄ</button>
                            <button class="tab-button" data-tab="video" onclick="showTab('video')">ÏòÅÏÉÅ</button>
                            <button class="tab-button" data-tab="audio" onclick="showTab('audio')">Ïò§ÎîîÏò§</button>
                            <button class="tab-button" data-tab="music" onclick="showTab('music')">ÏùåÏïÖ</button>
                        </div>
                        <div id="shot-content-container" class="tab-content"></div>
                    </div>
                `;
                
                // TabManagerÏóê ÏÉàÎ°úÏö¥ Ïª®ÌÖåÏù¥ÎÑà ÏÑ§Ï†ï
                window.tabManager.container = document.querySelector('#shot-content-container');
                
                // Shot ÏÑ§Ï†ï Î∞è Ï≤† Î≤àÏß∏ ÌÉ≠ ÌëúÏãú
                window.tabManager.setShot(
                    shotData.sequenceIndex, 
                    shotData.sceneIndex, 
                    shotData.shotIndex
                );
                
                // Í∏∞Î≥∏ Ï†ïÎ≥¥ ÌÉ≠ ÌëúÏãú
                window.tabManager.switchTab('info');
                
                // Ï†ÑÏó≠ showTab Ìï®Ïàò ÏÑ§Ï†ï
                window.showTab = function(tabName) {
                    window.tabManager.switchTab(tabName);
                };
                
            } catch (error) {
                console.error('Error in showShotContentModular:', error);
                showMessage('ÏÉ∑ ÎÇ¥Ïö© ÌëúÏãú Ïò§Î•ò: ' + error.message, 'error');
            }
        };
    </script>
    
    <script>
        
        // Ï†ÑÏó≠ Î≥ÄÏàò
        let currentData = null;
        let selectedType = null;
        let selectedId = null;
        let selectedSceneId = null;
		let hasStage2Structure = false; // Stage 2 Íµ¨Ï°∞ Î°úÎìú Ïó¨Î∂Ä
		
		// ÎîîÎ≤ÑÍπÖÏö© Ï†ÑÏó≠ Î≥ÄÏàò ÎÖ∏Ï∂ú
		window.debugData = {
			getCurrentData: () => currentData,
			updateNavigation: () => updateNavigation(),
			checkSequences: () => {
				return currentData?.breakdown_data?.sequences;
			}
		};
        const IMAGE_AI_TOOLS = ['midjourney', 'ideogram', 'leonardo', 'imagefx', 'openart'];

        // ÎèôÏ†Å ÌååÏùºÎ™Ö Í¥ÄÎ¶¨
        function getProjectFileName() {
            try {
                const htmlFileName = window.location.pathname.split('/').pop();
                const baseName = htmlFileName.replace('.html', '');
                return baseName + '.json';
            } catch (error) {
                return 'Film_Production_Manager.json';
            }
        }

        function getProjectName() {
            try {
                return getProjectFileName()
                    .replace('_Manager.json', '')
                    .replace('Film_Production_Manager.json', 'Film Production Manager');
            } catch (error) {
                return 'Film Production Manager';
            }
        }

        // Î©îÏãúÏßÄ ÌëúÏãú
        function showMessage(message, type) {
            
            try {
                const messageContainer = document.getElementById('message-container');
                if (!messageContainer) {
                    return;
                }
                
                const messageElement = document.createElement('div');
                messageElement.className = `message ${type}-message`;
                messageElement.innerHTML = `
                    ${message}
                    <button class="close-button" onclick="this.parentElement.remove()">√ó</button>
                `;
                
                messageContainer.appendChild(messageElement);
                
                if (type !== 'error') {
                    setTimeout(() => {
                        if (messageContainer.contains(messageElement)) {
                            messageContainer.removeChild(messageElement);
                        }
                    }, 5000);
                }
            } catch (error) {
                alert(message);
            }
        }

        // ÌÅ¥Î¶ΩÎ≥¥Îìú Î≥µÏÇ¨ Ìï®Ïàò
        async function copyToClipboard(text) {
            try {
                await navigator.clipboard.writeText(text);
                return true;
            } catch (error) {
                try {
                    const textArea = document.createElement('textarea');
                    textArea.value = text;
                    document.body.appendChild(textArea);
                    textArea.select();
                    document.execCommand('copy');
                    document.body.removeChild(textArea);
                    return true;
                } catch (fallbackError) {
                    showMessage('ÌÅ¥Î¶ΩÎ≥¥Îìú Î≥µÏÇ¨Ïóê Ïã§Ìå®ÌñàÏäµÎãàÎã§.', 'error');
                    return false;
                }
            }
        }

          // Îπà Îç∞Ïù¥ÌÑ∞ Íµ¨Ï°∞ ÏÉùÏÑ± Ìï®Ïàò - Ïî¨ Îã®ÏúÑ ÏßÄÏõê Ï∂îÍ∞Ä
			function getEmptyData() {
				try {
					return {
						film_id: 'FILM_NEW',
						current_stage_name: 'scenario_breakdown',
						timestamp: new Date().toISOString(),
						schema_version: '1.1.0', 
						film_metadata: {
							title_working: getProjectName(),
							confirmed_genre: '',
							// Ïî¨ Îã®ÏúÑ ÏûëÏóÖÏùÑ ÏúÑÌïú ÌïÑÎìú Ï∂îÍ∞Ä
							current_scene: null,
							total_scenes: 0,
							completed_scenes: []
						},
						breakdown_data: {
							sequences: [],
							scenes: [],
							shots: []
						},
						visual_consistency_info: {},
						concept_art_prompt_data: {}
					};
				} catch (error) {
					return null;
				}
			}

        // [DEPRECATED] ÌÖåÏä§Ìä∏Ïö© JSON Îç∞Ïù¥ÌÑ∞ ÏÉùÏÑ± Ìï®Ïàò - Îçî Ïù¥ÏÉÅ ÏÇ¨Ïö©ÎêòÏßÄ ÏïäÏùå
        // TODO: Ìñ•ÌõÑ Î≤ÑÏ†ÑÏóêÏÑú Ï†úÍ±∞ ÏòàÏ†ï
        function createTestData() {
            
            return {
                "film_id": "FILM_TEST001",
                "current_stage_name": "scenario_breakdown",
                "timestamp": new Date().toISOString(),
                "schema_version": "1.1.0",
                "film_metadata": {
                    "title_working": "ÌÖåÏä§Ìä∏ ÏòÅÌôî",
                    "confirmed_genre": "SF",
                    "project_music_prompts": {
                        "main_ost": {
                            "style_prompt": "ÏõÖÏû•ÌïòÍ≥† ÎØ∏ÎûòÏ†ÅÏù∏ Î©îÏù∏ ÌÖåÎßà (ÌîÑÎ°úÏ†ùÌä∏ Ï†ÑÏ≤¥)",
                            "lyrics_structure_prompt": "A-B-A Íµ¨Ï°∞Ïùò Í∏∞ÏïÖÍ≥°, Î∞òÎ≥µÏ†ÅÏù∏ Î™®Ìã∞ÌîÑ ÏÇ¨Ïö©"
                        },
                        "sub_ost_1": {
                            "style_prompt": "Í∏¥Ïû•Í∞ê ÎÑòÏπòÎäî Ï∂îÍ≤©Ïî¨Ïö© ÏùåÏïÖ Ïä§ÌÉÄÏùº (ÌîÑÎ°úÏ†ùÌä∏ Ï†ÑÏ≤¥)",
                            "lyrics_structure_prompt": "Îπ†Î•∏ ÌÖúÌè¨, Ï†ÑÏûêÏùåÏïÖÍ≥º Ïò§ÏºÄÏä§Ìä∏Îùº ÌòºÌï©"
                        },
                        "sub_ost_2": {
                            "style_prompt": "Í∞êÏÑ±Ï†ÅÏù∏ Ïû•Î©¥ÏùÑ ÏúÑÌïú ÏÑúÏ†ïÏ†ÅÏù∏ ÌîºÏïÑÎÖ∏ ÏÑ†Ïú® (ÌîÑÎ°úÏ†ùÌä∏ Ï†ÑÏ≤¥)",
                            "lyrics_structure_prompt": "ÎäêÎ¶∞ ÌÖúÌè¨, ÎØ∏ÎãàÎ©ÄÌïú Íµ¨ÏÑ±"
                        }
                    },
                    "project_music_urls": {
                        "main_ost": "https://example.com/project_main_theme.mp3",
                        "sub_ost_1": "https://example.com/project_tension_theme.mp3",
                        "sub_ost_2": ""
                    }
                },
                "breakdown_data": {
                    "sequences": [
                        {
                            "id": "SEQ01",
                            "title": "Ïò§ÌîÑÎãù ÏãúÌÄÄÏä§",
                            "function": "Ï£ºÏù∏Í≥µ ÏÜåÍ∞ú Î∞è Î∞∞Í≤Ω ÏÑ§Ï†ï",
                            "description": "Î†àÏù¥Î∏êÏùò ÏùºÏÉÅÍ≥º Ï≤´ ÏûÑÎ¨¥",
                            "duration_estimate": "5-7Î∂Ñ"
                        }
                    ],
                    "scenes": [
                        {
                            "id": "S01",
                            "sequence_id": "SEQ01",
                            "title": "Î†àÏù¥Î∏êÏùò ÏùÄÏã†Ï≤ò",
                            "description": "Ïñ¥ÎëêÏö¥ ÏÇ¨Î¨¥Ïã§ÏóêÏÑú ÏûëÏóÖÌïòÎäî Î†àÏù¥Î∏ê",
                            "visual_consistency_info": {
                                "location_id": "LOC_001",
                                "character_ids": ["CHAR_001"],
                                "prop_ids": ["PROP_001", "PROP_002"]
                            }
                        },
                        {
                            "id": "S02",
                            "sequence_id": "SEQ01",
                            "title": "Í∏¥Í∏â ÌöåÏùò",
                            "description": "Î†àÏù¥Î∏êÍ≥º Ïû≠Ïùò ÎßåÎÇ®",
                            "visual_consistency_info": {
                                "location_id": "LOC_002",
                                "character_ids": ["CHAR_001", "CHAR_002"],
                                "prop_ids": []
                            }
                        }
                    ],
                    "shots": [
                        {
                            "id": "S01.01",
                            "scene_id": "S01",
                            "title": "Î†àÏù¥Î∏êÏùò Ï≤´ Îì±Ïû•",
                            "shot_type": "CU",
                            "description": "Ïª¥Ìì®ÌÑ∞ ÌôîÎ©¥Ïóê ÎπÑÏπú Î†àÏù¥Î∏êÏùò ÏñºÍµ¥",
                            "other_info": {
                                "estimated_duration": 5
                            },
                            "camera_framing": {
                                "framing": "Close-up",
                                "angle": "Eye level",
                                "view_direction": "Front",
                                "composition": "Center"
                            },
                            "visual_consistency_info": {
                                "location_id": "LOC_001",
                                "character_ids": ["CHAR_001"],
                                "prop_ids": ["PROP_001"]
                            },
                            "content": {
                                "action": "Î†àÏù¥Î∏êÏù¥ Ïª¥Ìì®ÌÑ∞ ÏïûÏóê ÏïâÏïÑ ÏßëÏ§ëÌïòÎ©∞ ÌÇ§Î≥¥ÎìúÎ•º ÌÉÄÏù¥Ìïë",
                                "dialogue_by_character": {
                                    "Î†àÏù¥Î∏ê": {
                                        "character_name": "Î†àÏù¥Î∏ê",
                                        "voice_style": "ÎÇÆÍ≥† Îπ†Î•∏ Ïñ¥Ï°∞, ÌïµÏã¨Îßå ÎßêÌïòÎäî Ïä§ÌÉÄÏùº",
                                        "voice_gender": "female",
                                        "voice_age": "young",
                                        "lines": [
                                            {
                                                "index": 1,
                                                "text": "Ïù¥Î≤à ÏùºÏùÄ Ï¢Ä Îã§Î•¥Íµ∞... Ï°∞Ïã¨Ìï¥ÏïºÍ≤†Ïñ¥.",
                                                "text_translated": "This job is different... I need to be careful.",
                                                "emotion": "ÏßëÏ§ë"
                                            }
                                        ]
                                    }
                                },
                                "dialogue_sequence": [
                                    {"character": "Î†àÏù¥Î∏ê", "line_index": 0}
                                ],
                                "narration": "Í∑∏ÎÖÄÎäî Ïñ¥Îë† ÏÜçÏóêÏÑú ÎπõÏùÑ Ï∞æÍ≥† ÏûàÏóàÎã§.",
                                "sound_effects": "ÌÇ§Î≥¥Îìú ÌÉÄÏù¥Ìïë ÏÜåÎ¶¨, Ïª¥Ìì®ÌÑ∞ Ìå¨ ÏÜåÎ¶¨, ÎπóÏÜåÎ¶¨",
                                "audio_urls": {
                                    "dialogue": {
                                        "Î†àÏù¥Î∏ê": ["https://example.com/audio/S01.01_dialogue_raven.mp3"]
                                    },
                                    "narration": "https://example.com/audio/S01.01_narration.mp3",
                                    "sound_effects": "https://example.com/audio/S01.01_sfx.mp3"
                                }
                            },
                            "music_memo": "Ïù¥ ÏÉ∑Ïùò Ïò§ÌîÑÎãù ÏãúÌÄÄÏä§ÏóêÎäî ÌîÑÎ°úÏ†ùÌä∏ Î©îÏù∏ ÌÖåÎßàÎ•º ÏÇ¨Ïö©ÌïúÎã§. Í∏¥Ïû•Í∞êÏùÑ ÏÑúÏÑúÌûà Í≥†Ï°∞ÏãúÌÇ§Îäî Ìé∏Í≥°.",
                            "audio_prompts": {
                                "dialogue": {
                                    "Î†àÏù¥Î∏ê": {
                                        "prompts": [
                                            {
                                                "line_index": 0,
                                                "prompt": "S01.01 Î†àÏù¥Î∏êÏùò ÎåÄÏÇ¨: ÏßëÏ§ëÎêú Í∞êÏ†ïÏúºÎ°ú ÎÇÆÍ≥† Îπ†Î•∏ Ïñ¥Ï°∞, ÌïµÏã¨Îßå ÎßêÌïòÎäî Ïä§ÌÉÄÏùº. ÎåÄÏÇ¨: 'Ïù¥Î≤à ÏùºÏùÄ Ï¢Ä Îã§Î•¥Íµ∞... Ï°∞Ïã¨Ìï¥ÏïºÍ≤†Ïñ¥.'",
                                                "prompt_translated": "S01.01 Raven's dialogue: Focused emotion with low and fast tone, concise speaking style. Line: 'This job is different... I need to be careful.'"
                                            }
                                        ],
                                        "settings": {
                                            "voice_gender": "female",
                                            "voice_age": "young",
                                            "base_emotion": "focused",
                                            "speed": "fast",
                                            "tone": "low"
                                        }
                                    }
                                },
                                "narration": {
                                    "prompt": "S01.01 ÎÇòÎ†àÏù¥ÏÖò: Ïã†ÎπÑÎ°≠Í≥† Ï∞®Î∂ÑÌïú ÌÜ§. ÎÇ¥Ïö©: 'Í∑∏ÎÖÄÎäî Ïñ¥Îë† ÏÜçÏóêÏÑú ÎπõÏùÑ Ï∞æÍ≥† ÏûàÏóàÎã§.'",
                                    "prompt_translated": "S01.01 Narration: Mysterious and calm tone. Content: 'She was searching for light in the darkness.'",
                                    "settings": {
                                        "voice_style": "narrator",
                                        "tone": "mysterious",
                                        "speed": "slow"
                                    }
                                },
                                "sound_effects": {
                                    "prompt_ko": "S01.01 ÏùåÌñ•: ÌÇ§Î≥¥Îìú ÌÉÄÏù¥Ìïë ÏÜåÎ¶¨, Ïª¥Ìì®ÌÑ∞ Ìå¨ ÏÜåÎ¶¨, Ï∞ΩÎ∞ñ ÎπóÏÜåÎ¶¨",
                                    "prompt_en": "S01.01 SFX: keyboard typing sounds, computer fan noise, rain sounds from window",
                                    "settings": {
                                        "duration": "5s",
                                        "intensity": "medium",
                                        "environment": "indoor_office"
                                    }
                                }
                            },
                            "original_scenario": {
                                "text": "Ïû•Î©¥ 1. Î†àÏù¥Î∏êÏùò ÏùÄÏã†Ï≤ò - Î∞§\n\nÏñ¥ÎëêÏö¥ ÏÇ¨Î¨¥Ïã§. Î™®ÎãàÌÑ∞Ïùò Ìë∏Î•∏ ÎπõÎßåÏù¥ Í≥µÍ∞ÑÏùÑ ÎπÑÏ∂òÎã§.\nÎ†àÏù¥Î∏ê(20ÎåÄ Ïó¨ÏÑ±)Ïù¥ Ïª¥Ìì®ÌÑ∞ ÏïûÏóê ÏïâÏïÑ ÏûàÎã§.\n\nÎ†àÏù¥Î∏ê\n(ÏßëÏ§ëÌïòÎ©∞)\nÏù¥Î≤à ÏùºÏùÄ Ï¢Ä Îã§Î•¥Íµ∞... Ï°∞Ïã¨Ìï¥ÏïºÍ≤†Ïñ¥.\n\nÏ∞ΩÎ∞ñÏúºÎ°ú ÎπÑÍ∞Ä ÎÇ¥Î¶∞Îã§. ÌÇ§Î≥¥Îìú ÌÉÄÏù¥Ìïë ÏÜåÎ¶¨Í∞Ä Î¶¨ÎìúÎØ∏Ïª¨ÌïòÍ≤å Ïö∏Î¶∞Îã§.",
                                "scene_number": 1,
                                "location": "Î†àÏù¥Î∏êÏùò ÏùÄÏã†Ï≤ò",
                                "time": "Î∞§"
                            },
                            "image_design_plans": {
                                "plan_a": {
                                    "description": "Îã®Ïùº Ïù¥ÎØ∏ÏßÄÎ°ú Ï†ÑÏ≤¥ ÏÉ∑ ÌëúÌòÑ",
                                    "image_count": 1,
                                    "complexity": "high",
                                    "images": [
                                        {
                                            "id": "IMG_A_001",
                                            "description": "Î™®ÎãàÌÑ∞ ÎπõÏóê ÎπÑÏπú Î†àÏù¥Î∏êÏùò ÌÅ¥Î°úÏ¶àÏóÖ, ÏßëÏ§ëÎêú ÌëúÏ†ï",
                                            "csv_attributes": {
                                                "201": "20ÎåÄ ÌïúÍµ≠Ïù∏ Ïó¨ÏÑ± Ìï¥Ïª§",
                                                "301": "Ïñ¥ÎëêÏö¥ ÏÇ¨Î¨¥Ïã§",
                                                "401": "Ïª¥Ìì®ÌÑ∞ Î™®ÎãàÌÑ∞, ÌÇ§Î≥¥Îìú",
                                                "501": "Ìë∏Î•∏ Î™®ÎãàÌÑ∞ Îπõ",
                                                "502": "16:9"
                                            }
                                        }
                                    ]
                                },
                                "plan_b": {
                                    "description": "2Í∞ú Ïù¥ÎØ∏ÏßÄÎ°ú Î∂ÑÌï†ÌïòÏó¨ ÏïàÏ†ïÏ†Å ÏÉùÏÑ±",
                                    "image_count": 2,
                                    "complexity": "medium",
                                    "images": [
                                        {
                                            "id": "IMG_B_001",
                                            "description": "Ïñ¥ÎëêÏö¥ ÏÇ¨Î¨¥Ïã§ Ï†ÑÍ≤Ω",
                                            "csv_attributes": {
                                                "301": "Ïñ¥ÎëêÏö¥ ÏÇ¨Î¨¥Ïã§ Î∞§",
                                                "401": "Ïª¥Ìì®ÌÑ∞ Ï±ÖÏÉÅ",
                                                "501": "Ïñ¥ÎëêÏö¥ Ï°∞Î™Ö",
                                                "502": "16:9"
                                            }
                                        },
                                        {
                                            "id": "IMG_B_002",
                                            "description": "Î†àÏù¥Î∏ê ÌÅ¥Î°úÏ¶àÏóÖ",
                                            "csv_attributes": {
                                                "201": "20ÎåÄ ÌïúÍµ≠Ïù∏ Ïó¨ÏÑ±",
                                                "501": "Ìë∏Î•∏ Îπõ",
                                                "502": "16:9"
                                            }
                                        }
                                    ]
                                },
                                "plan_c": {
                                    "description": "ÏµúÏÜåÌïúÏùò Ïù¥ÎØ∏ÏßÄÎ°ú ÌïµÏã¨Îßå ÌëúÌòÑ",
                                    "image_count": 1,
                                    "complexity": "low",
                                    "images": [
                                        {
                                            "id": "IMG_C_001",
                                            "description": "Ïª¥Ìì®ÌÑ∞ ÏïûÏùò Ïã§Î£®Ïó£",
                                            "csv_attributes": {
                                                "301": "Ïñ¥ÎëêÏö¥ Î∞©",
                                                "401": "Ïª¥Ìì®ÌÑ∞",
                                                "501": "Ïã§Î£®Ïó£ Ï°∞Î™Ö",
                                                "502": "16:9"
                                            }
                                        }
                                    ]
                                }
                            },
                            "image_prompts": {
                                "midjourney": {
                                    "main_prompt": "Young Korean woman hacker in dark office, blue monitor light on face, focused expression, typing on keyboard, cinematic close-up --ar 16:9 --v 6",
                                    "main_prompt_translated": "Ïñ¥ÎëêÏö¥ ÏÇ¨Î¨¥Ïã§Ïùò Ï†äÏùÄ ÌïúÍµ≠Ïù∏ Ïó¨ÏÑ± Ìï¥Ïª§, ÏñºÍµ¥Ïóê ÎπÑÏπú Ìë∏Î•∏ Î™®ÎãàÌÑ∞ Îπõ, ÏßëÏ§ëÎêú ÌëúÏ†ï, ÌÇ§Î≥¥Îìú ÌÉÄÏù¥Ìïë, ÏòÅÌôîÏ†Å ÌÅ¥Î°úÏ¶àÏóÖ",
                                    "parameters": "--ar 16:9 --v 6 --style raw"
                                },
                                "ideogram": {
                                    "main_prompt": "Cinematic close-up of female hacker working late at night",
                                    "main_prompt_translated": "Î∞§Îä¶Í≤å ÏûëÏóÖÌïòÎäî Ïó¨ÏÑ± Ìï¥Ïª§Ïùò ÏòÅÌôîÏ†Å ÌÅ¥Î°úÏ¶àÏóÖ",
                                    "negative_prompt": "bright lighting, daylight, happy expression",
                                    "parameters": "Cinematic style, Dark mood"
                                },
                                "leonardo": {
                                    "main_prompt": "Professional hacker woman at computer in dark room",
                                    "main_prompt_translated": "Ïñ¥ÎëêÏö¥ Î∞©ÏóêÏÑú Ïª¥Ìì®ÌÑ∞ ÏïûÏùò Ï†ÑÎ¨∏ Ìï¥Ïª§ Ïó¨ÏÑ±",
                                    "parameters": "Leonardo Vision XL, Cinematic"
                                },
                                "imagefx": {
                                    "main_prompt": "Female programmer in dark office with computer screen glow",
                                    "main_prompt_translated": "Ïª¥Ìì®ÌÑ∞ ÌôîÎ©¥ ÎπõÍ≥º Ìï®Íªò Ïñ¥ÎëêÏö¥ ÏÇ¨Î¨¥Ïã§Ïùò Ïó¨ÏÑ± ÌîÑÎ°úÍ∑∏ÎûòÎ®∏",
                                    "parameters": "Photorealistic, Moody lighting"
                                }
                            },
                            "image_design": {
                                "aspect_ratio": "16:9",
                                "selected_plan": "plan_a",
                                "ai_generated_images": {
                                    "midjourney": [
                                        {
                                            "url": "https://example.com/midjourney/shot1_1.jpg",
                                            "description": "Î©îÏù∏ ÏÉ∑ - Î†àÏù¥Î∏ê ÌÅ¥Î°úÏ¶àÏóÖ"
                                        },
                                        {
                                            "url": "",
                                            "description": ""
                                        },
                                        {
                                            "url": "",
                                            "description": ""
                                        }
                                    ],
                                    "ideogram": [
                                        {
                                            "url": "",
                                            "description": ""
                                        },
                                        {
                                            "url": "",
                                            "description": ""
                                        },
                                        {
                                            "url": "",
                                            "description": ""
                                        }
                                    ],
                                    "leonardo": [
                                        {
                                            "url": "",
                                            "description": ""
                                        },
                                        {
                                            "url": "",
                                            "description": ""
                                        },
                                        {
                                            "url": "",
                                            "description": ""
                                        }
                                    ],
                                    "imagefx": [
                                        {
                                            "url": "",
                                            "description": ""
                                        },
                                        {
                                            "url": "",
                                            "description": ""
                                        },
                                        {
                                            "url": "",
                                            "description": ""
                                        }
                                    ]
                                }
                            },
                            "video_prompts": {
                                "luma": {
                                    "main_prompt": "Close-up shot of Asian female hacker typing intensely on keyboard in dark room with blue monitor glow on her focused face",
                                    "main_prompt_translated": "Ïñ¥ÎëêÏö¥ Î∞©ÏóêÏÑú ÌÇ§Î≥¥ÎìúÎ•º ÏßëÏ§ëÌï¥ÏÑú ÌÉÄÏù¥ÌïëÌïòÎäî ÏïÑÏãúÏïÑ Ïó¨ÏÑ± Ìï¥Ïª§Ïùò ÌÅ¥Î°úÏ¶àÏóÖ ÏÉ∑, ÏßëÏ§ëÎêú ÏñºÍµ¥Ïóê Ìë∏Î•∏ Î™®ÎãàÌÑ∞ Îπõ",
                                    "settings": {
                                        "duration": "5s",
                                        "style": "cinematic"
                                    }
                                },
                                "kling": {
                                    "main_prompt": "ÏòÅÌôîÏ†Å ÌÅ¥Î°úÏ¶àÏóÖ: Î∞§Ïóê ÏûëÏóÖÌïòÎäî Ïó¨ÏÑ± ÌîÑÎ°úÍ∑∏ÎûòÎ®∏",
                                    "settings": {
                                        "mode": "Í≥†ÌíàÏßà",
                                        "duration": "5Ï¥à"
                                    }
                                },
                                "veo2": {
                                    "main_prompt": "Cinematic close-up of female developer",
                                    "settings": {}
                                },
                                "runway": {
                                    "main_prompt": "Dark office hacker scene",
                                    "settings": {
                                        "motion_amount": 2
                                    }
                                }
                            },
                            "video_urls": {
                                "luma": "https://example.com/luma_video.mp4",
                                "kling": "",
                                "veo2": "",
                                "runway": ""
                            },
                            "video_design": {
                                "selected_ai": "luma",
                                "video_url": "https://example.com/luma_video.mp4",
                                "extracted_image_info": [
                                    {
                                        "image_id": "IMG_A_001",
                                         "description": "ÌÇ§ÌîÑÎ†àÏûÑ 1: Î†àÏù¥Î∏êÏùò ÏßëÏ§ëÎêú ÌëúÏ†ï"
                                   }
                               ]
                           },
                           "reference_images": [
                               {
                                   "id": "ref_img_1_S01.01",
                                   "url": "https://example.com/ref/blade_runner_office.jpg",
                                   "description": "Î∏îÎ†àÏù¥ÎìúÎü¨ÎÑà Ïä§ÌÉÄÏùºÏùò Ïñ¥ÎëêÏö¥ ÏÇ¨Î¨¥Ïã§",
                                   "type": "mood"
                               },
                               {
                                   "id": "ref_img_2_S01.01",
                                   "url": "",
                                   "description": "",
                                   "type": "composition"
                               },
                               {
                                   "id": "ref_img_3_S01.01",
                                   "url": "",
                                   "description": "",
                                   "type": "composition"
                               }
                           ]
                       },
                       {
                           "id": "S01.02",
                           "scene_id": "S01",
                           "title": "ÌôîÎ©¥ ÌÅ¥Î°úÏ¶àÏóÖ",
                           "shot_type": "ECU",
                           "description": "Î™®ÎãàÌÑ∞Ïóê ÎÇòÌÉÄÎÇòÎäî ÏïîÌò∏ÌôîÎêú Î©îÏãúÏßÄ",
                           "other_info": {
                               "estimated_duration": 3
                           },
                           "content": {
                               "action": "Î†àÏù¥Î∏êÏùò ÌëúÏ†ï Î≥ÄÌôîÎ•º ÌÅ¥Î°úÏ¶àÏóÖÏúºÎ°ú Ìè¨Ï∞©",
                               "dialogue_by_character": {},
                               "dialogue_sequence": [],
                               "narration": "Í∑∏ÎÖÄÏùò ÎààÏóêÎäî Í≤∞ÏùòÍ∞Ä Îã¥Í≤® ÏûàÏóàÎã§.",
                               "music": "",
                               "audio_urls": {}
                           },
                           "music_memo": "Ïù¥ ÏÉ∑ÏùÄ Í∞êÏ†ïÏî¨Ïù¥ÎØÄÎ°ú ÌîÑÎ°úÏ†ùÌä∏ ÏÑúÎ∏å OST 2 (ÏÑúÏ†ïÏ†Å ÌîºÏïÑÎÖ∏)Î•º ÏÇ¨Ïö©. ÎåÄÏÇ¨ ÏóÜÏù¥ ÏùåÏïÖÍ≥º ÌëúÏ†ïÏúºÎ°ú Ï†ÑÎã¨.",
                           "audio_prompts": {},
                           "original_scenario": {
                               "text": "Î™®ÎãàÌÑ∞ ÌôîÎ©¥Ïù¥ ÌÅ¥Î°úÏ¶àÏóÖÎêúÎã§.\nÏïîÌò∏ÌôîÎêú Î©îÏãúÏßÄÍ∞Ä Ìïú Ï§ÑÏî© ÎÇòÌÉÄÎÇúÎã§.\n\nÎ†àÏù¥Î∏êÏùò ÎààÏù¥ Îπ†Î•¥Í≤å ÏõÄÏßÅÏù∏Îã§.\nÍ≤∞ÏùòÏóê Ï∞¨ ÌëúÏ†ï.",
                               "scene_number": 1,
                               "location": "Î†àÏù¥Î∏êÏùò ÏùÄÏã†Ï≤ò",
                               "time": "Í≥ÑÏÜç"
                           },
                           "image_design_plans": {
                               "plan_a": {
                                   "description": "Î™®ÎãàÌÑ∞ÏôÄ Îàà ÌÅ¥Î°úÏ¶àÏóÖ Îã®Ïùº Ïù¥ÎØ∏ÏßÄ",
                                   "image_count": 1,
                                   "complexity": "medium",
                                   "images": [
                                       {
                                           "id": "IMG_A_001",
                                           "description": "ÏïîÌò∏ Î©îÏãúÏßÄÍ∞Ä Îú¨ Î™®ÎãàÌÑ∞ÏôÄ Í∑∏Í≤ÉÏùÑ Î≥¥Îäî Îàà",
                                           "csv_attributes": {
                                               "201": "Ïó¨ÏÑ±Ïùò Îàà ÌÅ¥Î°úÏ¶àÏóÖ",
                                               "401": "Ïª¥Ìì®ÌÑ∞ Î™®ÎãàÌÑ∞",
                                               "501": "Î™®ÎãàÌÑ∞ Îπõ Î∞òÏÇ¨",
                                               "502": "16:9"
                                           }
                                       }
                                   ]
                               }
                           },
                           "image_prompts": {
                               "midjourney": {
                                   "main_prompt": "Extreme close-up of computer monitor showing encrypted green text messages, reflection in woman's eyes --ar 16:9",
                                   "parameters": "--ar 16:9 --v 6"
                               },
                               "ideogram": {
                                   "main_prompt": "ECU encrypted computer screen with code",
                                   "parameters": "Cyberpunk style"
                               },
                               "leonardo": {
                                   "main_prompt": "Close up monitor with encrypted messages",
                                   "parameters": "Tech noir style"
                               },
                               "imagefx": {
                                   "main_prompt": "Computer screen with green encrypted text",
                                   "parameters": "Matrix style"
                               }
                           }
                       },
                       {
                           "id": "S02.01",
                           "scene_id": "S02",
                           "title": "Ïû≠Ïùò Îì±Ïû•",
                           "shot_type": "MS",
                           "description": "ÌöåÏùòÏã§ Î¨∏Ïù¥ Ïó¥Î¶¨Î©∞ Ïû≠Ïù¥ Îì§Ïñ¥Ïò®Îã§",
                           "other_info": {
                               "estimated_duration": 4
                           },
                           "content": {
                               "action": "Ïû≠Ïù¥ Í∏âÌïòÍ≤å ÌöåÏùòÏã§Î°ú Îì§Ïñ¥Ïò§Î©∞ Î†àÏù¥Î∏êÏùÑ Ï∞æÎäîÎã§",
                               "dialogue_by_character": {
                                   "Î†àÏù¥Î∏ê": {
                                       "character_name": "Î†àÏù¥Î∏ê",
                                       "voice_style": "ÎÇÆÍ≥† Îπ†Î•∏ Ïñ¥Ï°∞, ÌïµÏã¨Îßå ÎßêÌïòÎäî Ïä§ÌÉÄÏùº",
                                       "voice_gender": "female",
                                       "voice_age": "young",
                                       "lines": [
                                           {
                                               "index": 1,
                                               "text": "Î≠êÎùºÍ≥†? Í∑∏Í≤å Í∞ÄÎä•Ìï¥?",
                                               "text_translated": "What? Is that possible?",
                                               "emotion": "ÎÜÄÎûå"
                                           },
                                           {
                                               "index": 3,
                                               "text": "Í∑∏Îüº ÎÅùÍπåÏßÄ Í∞ÄÎäî Í±∞Ïïº.",
                                               "text_translated": "Then we go all the way.",
                                               "emotion": "Í≤∞Ïùò"
                                           }
                                       ]
                                   },
                                   "Ïû≠": {
                                       "character_name": "Ïû≠",
                                       "voice_style": "ÍπäÍ≥† ÏïàÏ†ïÏ†ÅÏù∏ Î™©ÏÜåÎ¶¨, Í∂åÏúÑÏûàÎäî ÌÜ§",
                                       "voice_gender": "male",
                                       "voice_age": "middle",
                                       "lines": [
                                           {
                                               "index": 2,
                                               "text": "Ïù¥ÎØ∏ ÏãúÏûëÎêêÏñ¥. ÎèåÏù¥ÌÇ¨ Ïàò ÏóÜÏñ¥.",
                                               "text_translated": "It's already started. There's no turning back.",
                                               "emotion": "Ï∞®Î∂ÑÌï®"
                                           }
                                       ]
                                   }
                               },
                               "dialogue_sequence": [
                                   {"character": "Î†àÏù¥Î∏ê", "line_index": 0},
                                   {"character": "Ïû≠", "line_index": 0},
                                   {"character": "Î†àÏù¥Î∏ê", "line_index": 1}
                               ],
                               "narration": "",
                               "sound_effects": "Î¨∏ Ïó¥Î¶¨Îäî ÏÜåÎ¶¨, Î∞úÍ±∏Ïùå ÏÜåÎ¶¨, ÏùòÏûê ÎÅÑÎäî ÏÜåÎ¶¨",
                               "audio_urls": {
                                   "dialogue": {
                                       "Î†àÏù¥Î∏ê": ["", ""],
                                       "Ïû≠": [""]
                                   },
                                   "narration": "",
                                   "sound_effects": ""
                               }
                           },
                           "original_scenario": {
                               "text": "Ïû•Î©¥ 2. ÎπÑÎ∞Ä ÌöåÏùòÏã§ - Î∞§\n\nÎ¨∏Ïù¥ Í∏âÌïòÍ≤å Ïó¥Î¶∞Îã§.\nÏû≠(40ÎåÄ ÎÇ®ÏÑ±)Ïù¥ Îì§Ïñ¥Ïò®Îã§.\n\nÎ†àÏù¥Î∏ê\n(ÎÜÄÎùºÎ©∞)\nÎ≠êÎùºÍ≥†? Í∑∏Í≤å Í∞ÄÎä•Ìï¥?\n\nÏû≠\n(Ï∞®Î∂ÑÌïòÍ≤å)\nÏù¥ÎØ∏ ÏãúÏûëÎêêÏñ¥. ÎèåÏù¥ÌÇ¨ Ïàò ÏóÜÏñ¥.\n\nÎ†àÏù¥Î∏ê\n(Í≤∞ÏùòÏóê Ï∞¨)\nÍ∑∏Îüº ÎÅùÍπåÏßÄ Í∞ÄÎäî Í±∞Ïïº.",
                               "scene_number": 2,
                               "location": "ÎπÑÎ∞Ä ÌöåÏùòÏã§",
                               "time": "Î∞§"
                           }
                       }
                   ]
               }
           };
       }

       // Îç∞Ïù¥ÌÑ∞ Î°úÎìú Ìï®Ïàò - Ïî¨ Îã®ÏúÑ ÏßÄÏõê Ï∂îÍ∞Ä
		async function loadData() {
			try {
				const jsonFileName = getProjectFileName();
                const savedData = localStorage.getItem(`breakdownData_${jsonFileName}`);
				if (!savedData) {
					// Ï†ÄÏû•Îêú Îç∞Ïù¥ÌÑ∞Í∞Ä ÏóÜÎäî Í≤ΩÏö∞, ÏûÑÏãú Îç∞Ïù¥ÌÑ∞Î•º Ï≤òÎ¶¨Ìï† Ïàò ÏûàÎèÑÎ°ù Ï≤òÎ¶¨ ÌîåÎûòÍ∑∏ Ï¥àÍ∏∞Ìôî
					const processedFlags = [
						'stage2TempProcessed', 'stage4TempProcessed', 'stage5TempProcessed',
						'stage6TempProcessed', 'stage6TempFilesProcessed',
						'stage7TempProcessed', 'stage8TempProcessed'
					];
					processedFlags.forEach(flag => {
						if (localStorage.getItem(flag)) {
							localStorage.removeItem(flag);
						}
					});
					updateUI();
					return;
				}

				const parsedData = JSON.parse(savedData);
				
				// Stage 6, 7 Îç∞Ïù¥ÌÑ∞ Î≥µÏõê
				const savedStage6 = localStorage.getItem(`stage6ImagePrompts_${jsonFileName}`);
				if (savedStage6) {
					window.stage6ImagePrompts = JSON.parse(savedStage6);
				}

				const savedStage7 = localStorage.getItem(`stage7VideoPrompts_${jsonFileName}`);
				if (savedStage7) {
					window.stage7VideoPrompts = JSON.parse(savedStage7);
				}
				
				// Ïò§ÎîîÏò§ ÌååÏùº Îç∞Ïù¥ÌÑ∞ Î≥µÏõê
				const savedAudioFiles = localStorage.getItem(`audioFiles_${jsonFileName}`);
				if (savedAudioFiles) {
					window.localAudioFiles = JSON.parse(savedAudioFiles);
				}

				// Îç∞Ïù¥ÌÑ∞ Ïú†Ìö®ÏÑ± Í≤ÄÏ¶ù
				if (!validateLoadedData(parsedData)) {
					throw new Error('Ï†ÄÏû•Îêú Îç∞Ïù¥ÌÑ∞Í∞Ä Ïú†Ìö®ÌïòÏßÄ ÏïäÏäµÎãàÎã§.');
				}

				currentData = parsedData;
				// Stage 2 Íµ¨Ï°∞ Ï°¥Ïû¨ Ïó¨Î∂Ä ÌôïÏù∏ (Ìñ•ÏÉÅÎêú Ï≤¥ÌÅ¨)
				if (currentData.hasStage2Structure || 
				    (currentData.breakdown_data && currentData.breakdown_data.sequences && currentData.breakdown_data.sequences.length > 0) ||
				    (currentData.stage2_data)) {
					hasStage2Structure = true;
					currentData.hasStage2Structure = true; // Îç∞Ïù¥ÌÑ∞ÏóêÎèÑ ÌîåÎûòÍ∑∏ ÏÑ§Ï†ï
					console.log('üé¨ Stage 2 Íµ¨Ï°∞Í∞Ä Î≥µÏõêÎêòÏóàÏäµÎãàÎã§:', hasStage2Structure);
				} else {
					hasStage2Structure = false;
					console.log('‚ö†Ô∏è Stage 2 Íµ¨Ï°∞Í∞Ä ÏóÜÏäµÎãàÎã§.');
				}
				
				// ÏãúÌÄÄÏä§ Îç∞Ïù¥ÌÑ∞ ÏÉÅÏÑ∏ ÌôïÏù∏
				if (currentData.breakdown_data?.sequences?.length > 0) {
					currentData.breakdown_data.sequences.forEach(seq => {
					});
				}
				
				// Ïî¨ Îç∞Ïù¥ÌÑ∞ ÌôïÏù∏
				if (currentData.breakdown_data?.scenes?.length > 0) {
					const firstScene = currentData.breakdown_data.scenes[0];
				}

				updateUI();
				// Stage 5 Îã§Ï§ë ÌååÏùº ÏóÖÎ°úÎìúÍ∞Ä ÏïÑÎãå Í≤ΩÏö∞ÏóêÎßå Î©îÏãúÏßÄ ÌëúÏãú
				const isStage5MultipleUpload = new URLSearchParams(window.location.search).get('loadStage5JsonMultiple') === 'true';
				if (!isStage5MultipleUpload) {
					showMessage('Ïù¥Ï†Ñ ÏûëÏóÖ Îç∞Ïù¥ÌÑ∞Î•º Î∂àÎü¨ÏôîÏäµÎãàÎã§.', 'success');
				}

			} catch (error) {
				localStorage.removeItem('filmProductionData');
				currentData = getEmptyData();
				updateUI();
				showMessage('Ï†ÄÏû•Îêú Îç∞Ïù¥ÌÑ∞Î•º Î∂àÎü¨Ïò¨ Ïàò ÏóÜÏäµÎãàÎã§. ÏÉàÎ°ú ÏãúÏûëÌï©ÎãàÎã§.', 'warning');
			}
		}
		// Îç∞Ïù¥ÌÑ∞ Ïú†Ìö®ÏÑ± Í≤ÄÏ¶ù Ìï®Ïàò - Ïî¨ Îã®ÏúÑ ÏßÄÏõê Ï∂îÍ∞Ä
			function validateLoadedData(data) {
				if (!data || typeof data !== 'object') return false;

				// ÌïÑÏàò ÌïÑÎìú ÌôïÏù∏
				if (!data.film_metadata || !data.breakdown_data) return false;

				// Ïî¨ Îã®ÏúÑ Îç∞Ïù¥ÌÑ∞Ïù∏ Í≤ΩÏö∞
				if (data.film_metadata.current_scene !== undefined) {
					// Ïî¨ Îã®ÏúÑ Íµ¨Ï°∞ Í≤ÄÏ¶ù
					if (!data.breakdown_data.scenes || !Array.isArray(data.breakdown_data.scenes)) {
						return false;
					}
					// ÏµúÏÜåÌïú ÌïòÎÇòÏùò Ïî¨Ïù¥ ÏûàÏñ¥Ïïº Ìï®
					if (data.breakdown_data.scenes.length === 0) return false;

					// ÌòÑÏû¨ Ïî¨Ïù¥ scenes Î∞∞Ïó¥Ïóê Ï°¥Ïû¨ÌïòÎäîÏßÄ ÌôïÏù∏
					const currentSceneId = data.film_metadata.current_scene;
					const sceneExists = data.breakdown_data.scenes.some(scene => scene.id === currentSceneId);
					if (!sceneExists) {
					}
				}
				// ÏãúÌÄÄÏä§ Îã®ÏúÑ Îç∞Ïù¥ÌÑ∞Ïù∏ Í≤ΩÏö∞ (Í∏∞Ï°¥ Ìò∏ÌôòÏÑ±)
				else if (data.breakdown_data.sequences) {
					if (!Array.isArray(data.breakdown_data.sequences)) return false;
				}
				else {
					return false; // Ïñ¥Îäê Íµ¨Ï°∞ÏóêÎèÑ ÎßûÏßÄ ÏïäÏùå
				}

				return true;
			}

       // Îç∞Ïù¥ÌÑ∞ Ï†ÄÏû•
		function saveDataToLocalStorage() {
			try {
				if (currentData) {
					const jsonFileName = getProjectFileName();
					const dataString = JSON.stringify(currentData);
					
					// localStorage Ïö©Îüâ Ï≤¥ÌÅ¨ Î∞è Ï≤òÎ¶¨
					try {
						localStorage.setItem(`breakdownData_${jsonFileName}`, dataString);
						localStorage.setItem(`lastSaved_${jsonFileName}`, new Date().toISOString());
					} catch (quotaError) {
						if (quotaError.name === 'QuotaExceededError') {
							showMessage('Ï†ÄÏû• Í≥µÍ∞ÑÏù¥ Î∂ÄÏ°±Ìï©ÎãàÎã§. Ïù¥ÎØ∏ÏßÄ Îç∞Ïù¥ÌÑ∞Î•º Ï†ïÎ¶¨ÌïòÍ±∞ÎÇò JSONÏúºÎ°ú Î∞±ÏóÖ ÌõÑ Ï¥àÍ∏∞ÌôîÌïòÏÑ∏Ïöî.', 'error');
							
							// Ïö©Îüâ Ï†ïÎ≥¥ ÌëúÏãú
							const currentSize = new Blob([dataString]).size;
							const mbSize = (currentSize / (1024 * 1024)).toFixed(2);
							
							return false;
						}
						throw quotaError;
					}

					// Stage 6 Ïù¥ÎØ∏ÏßÄ ÌîÑÎ°¨ÌîÑÌä∏ Ï†ÄÏû•
					if (window.stage6ImagePrompts) {
						try {
							localStorage.setItem(`stage6ImagePrompts_${jsonFileName}`, JSON.stringify(window.stage6ImagePrompts));
						} catch (e) {
						}
					}

					// Stage 7 ÏòÅÏÉÅ ÌîÑÎ°¨ÌîÑÌä∏ Ï†ÄÏû•
					if (window.stage7VideoPrompts) {
						try {
							localStorage.setItem(`stage7VideoPrompts_${jsonFileName}`, JSON.stringify(window.stage7VideoPrompts));
						} catch (e) {
						}
					}

				}
			} catch (error) { 
				showMessage('Î°úÏª¨ Ï†ÄÏû• Ïã§Ìå®: ' + error.message, 'error'); 
			}
		}


       // Ï†ÑÏ≤¥ ÌîÑÎ°úÏ†ùÌä∏ Îç∞Ïù¥ÌÑ∞ Î∞±ÏóÖ
       function exportFullData() {
           try {
               if (!currentData) {
                   return showMessage('Ï†ÄÏû•Ìï† ÌîÑÎ°úÏ†ùÌä∏ Îç∞Ïù¥ÌÑ∞Í∞Ä ÏóÜÏäµÎãàÎã§.', 'error');
               }
               
               // Ï†ÑÏ≤¥ Î∞±ÏóÖ Îç∞Ïù¥ÌÑ∞ Íµ¨ÏÑ±
               const fullBackup = {
                   type: 'full_project_backup',
                   version: '2.0',
                   timestamp: new Date().toISOString(),
                   project_info: {
                       name: getProjectFileName(),
                       created: localStorage.getItem(`projectCreated_${getProjectFileName()}`) || new Date().toISOString(),
                       lastModified: new Date().toISOString()
                   },
                   data: {
                       // Ï†ÑÏ≤¥ currentDataÎ•º Ìè¨Ìï®
                       ...currentData,
                       // Ï∂îÍ∞Ä Î©îÌÉÄÎç∞Ïù¥ÌÑ∞
                       backup_metadata: {
                           hasStage2Structure: hasStage2Structure,
                           totalSequences: currentData.breakdown_data?.sequences?.length || 0,
                           totalScenes: currentData.breakdown_data?.scenes?.length || 0,
                           totalShots: currentData.breakdown_data?.shots?.length || 0,
                           stageDataIncluded: {
                               stage2: !!currentData.stage2_data,
                               stage3: !!currentData.stage3_data,
                               stage4: !!currentData.stage4_data,
                               stage5: true, // breakdown_dataÍ∞Ä stage5
                               stage6: !!(currentData.breakdown_data?.shots?.some(shot => shot.image_prompts)),
                               stage7: !!(currentData.breakdown_data?.shots?.some(shot => shot.video_prompts)),
                               stage8: !!(currentData.breakdown_data?.shots?.some(shot => shot.content?.audio_urls))
                           }
                       }
                   },
                   // Ï∂îÍ∞Ä StageÎ≥Ñ Îç∞Ïù¥ÌÑ∞ (localStorageÏóê Ï†ÄÏû•Îêú Í≤ÉÎì§)
                   additional_stage_data: {}
               };
               
               // localStorageÏóêÏÑú StageÎ≥Ñ Îç∞Ïù¥ÌÑ∞ Ï∂îÍ∞Ä
               const jsonFileName = getProjectFileName();
               
               // Stage 6 Ïù¥ÎØ∏ÏßÄ ÌîÑÎ°¨ÌîÑÌä∏ Îç∞Ïù¥ÌÑ∞
               const stage6Data = localStorage.getItem(`stage6ImagePrompts_${jsonFileName}`);
               if (stage6Data) {
                   try {
                       fullBackup.additional_stage_data.stage6ImagePrompts = JSON.parse(stage6Data);
                   } catch (e) {
                       console.warn('Stage 6 Îç∞Ïù¥ÌÑ∞ ÌååÏã± Ïã§Ìå®:', e);
                   }
               }
               
               // Stage 7 ÎπÑÎîîÏò§ ÌîÑÎ°¨ÌîÑÌä∏ Îç∞Ïù¥ÌÑ∞
               const stage7Data = localStorage.getItem(`stage7VideoPrompts_${jsonFileName}`);
               if (stage7Data) {
                   try {
                       fullBackup.additional_stage_data.stage7VideoPrompts = JSON.parse(stage7Data);
                   } catch (e) {
                       console.warn('Stage 7 Îç∞Ïù¥ÌÑ∞ ÌååÏã± Ïã§Ìå®:', e);
                   }
               }
               
               // Stage 8 Ïò§ÎîîÏò§ ÌîÑÎ°¨ÌîÑÌä∏ Îç∞Ïù¥ÌÑ∞
               const stage8Data = localStorage.getItem(`stage8AudioPrompts_${jsonFileName}`);
               if (stage8Data) {
                   try {
                       fullBackup.additional_stage_data.stage8AudioPrompts = JSON.parse(stage8Data);
                   } catch (e) {
                       console.warn('Stage 8 Îç∞Ïù¥ÌÑ∞ ÌååÏã± Ïã§Ìå®:', e);
                   }
               }
               
               // ÌååÏùº Îã§Ïö¥Î°úÎìú
               const backupFileName = getProjectFileName().replace('.json', '_full_backup.json');
               const blob = new Blob([JSON.stringify(fullBackup, null, 2)], { type: 'application/json' });
               const url = URL.createObjectURL(blob);
               const a = document.createElement('a');
               a.href = url;
               a.download = backupFileName;
               document.body.appendChild(a);
               a.click();
               document.body.removeChild(a);
               URL.revokeObjectURL(url);
               
               showMessage(`Ï†ÑÏ≤¥ ÌîÑÎ°úÏ†ùÌä∏ Î∞±ÏóÖÏù¥ ${backupFileName} ÌååÏùºÎ°ú Ï†ÄÏû•ÎêòÏóàÏäµÎãàÎã§.`, 'success');
           } catch (error) {
               showMessage(`Ï†ÑÏ≤¥ Î∞±ÏóÖ Ïò§Î•ò: ${error.message}`, 'error');
               console.error('Ï†ÑÏ≤¥ Î∞±ÏóÖ Ïò§Î•ò:', error);
           }
       }

       // Ïã§Ïö©Ï†Å JSON Ìï∏Îì§Îü¨
		function practicalJSONHandler(jsonString) {
			try {
				// 1Ï∞® ÏãúÎèÑ: Í∑∏ÎÉ• ÌååÏã±
				return { success: true, data: JSON.parse(jsonString) };
			} catch (error) {

				
				// 2Ï∞® ÏãúÎèÑ: Í∞ÑÎã®Ìïú Ïò§Î•ò ÏûêÎèô ÏàòÏ†ï
				let fixedString = jsonString;

				// ÏàúÏÑúÍ∞Ä Ï§ëÏöîÌï®!
				// 1. Ïä§ÎßàÌä∏ Îî∞Ïò¥Ìëú Î®ºÏ†Ä ÏàòÏ†ï
				fixedString = fixedString.replace(/[""]/g, '"');
				fixedString = fixedString.replace(/['']/g, "'");

				// 2. NaN, undefined, Infinity Ï≤òÎ¶¨
				fixedString = fixedString
					.replace(/\bNaN\b/g, 'null')
					.replace(/\bundefined\b/g, 'null')
					.replace(/\bInfinity\b/g, 'null');

				// 3. ÌõÑÌñâ ÏâºÌëú Ï†úÍ±∞
				fixedString = fixedString.replace(/,(\s*[}\]])/g, '$1');

				// 4. ÎàÑÎùΩÎêú ÏâºÌëú Ï∂îÍ∞Ä - Îçî Ï†ïÌôïÌïú Ìå®ÌÑ¥ÏúºÎ°ú Í∞úÏÑ†
				fixedString = fixedString
					.replace(/}(\s*){/g, '},$1{')                // Ï§ëÍ¥ÑÌò∏ ÏÇ¨Ïù¥
					.replace(/\](\s*){/g, '],$1{')               // Î∞∞Ïó¥ Îí§
					.replace(/}(\s*)\[/g, '},$1[')               // Ï§ëÍ¥ÑÌò∏ Îã§Ïùå Î∞∞Ïó¥
					.replace(/\](\s*)\[/g, '],$1[')              // Î∞∞Ïó¥ Îã§Ïùå Î∞∞Ïó¥
					.replace(/"([^",\s]+)"(\s*)"/g, '"$1",$2"'); // Ïó∞ÏÜçÎêú Î¨∏ÏûêÏó¥
				
				try {
					const data = JSON.parse(fixedString);

					// Stage 2 ÌäπÏàò Ï≤òÎ¶¨: ÏûòÎ™ª Î∞∞ÏπòÎêú Ï∫êÎ¶≠ÌÑ∞ Îç∞Ïù¥ÌÑ∞ ÏàòÏ†ï
					if (data.current_stage_name === 'narrative_development' && data.narrative_data) {
						const fixed = fixStage2Structure(data);
						if (fixed.wasFixed) {
							showMessage('Stage 2 JSON Íµ¨Ï°∞Î•º ÏûêÎèôÏúºÎ°ú ÏàòÏ†ïÌñàÏäµÎãàÎã§. (Ï∫êÎ¶≠ÌÑ∞ Îç∞Ïù¥ÌÑ∞ ÏúÑÏπò Ï°∞Ï†ï)', 'info');
						}
						return { success: true, data: fixed.data, wasFixed: true };
					}

					// ÏàòÏ†ïÎêú ÎÇ¥Ïö© ÏÉÅÏÑ∏ ÌëúÏãú
					const fixes = [];
					if (jsonString.match(/[""'']/)) fixes.push('Ïä§ÎßàÌä∏ Îî∞Ïò¥Ìëú');
					if (jsonString.match(/,(\s*[}\]])/)) fixes.push('ÌõÑÌñâ ÏâºÌëú');
					if (fixedString !== jsonString) fixes.push('ÎàÑÎùΩÎêú ÏâºÌëú');

					if (fixes.length > 0) {
						showMessage(`JSON ÏûêÎèô ÏàòÏ†ï ÏôÑÎ£å: ${fixes.join(', ')} ÏàòÏ†ïÎê®`, 'info');
					} else {
						showMessage('JSONÏùò ÏÇ¨ÏÜåÌïú Î¨∏Î≤ï Ïò§Î•òÎ•º ÏûêÎèôÏúºÎ°ú ÏàòÏ†ïÌñàÏäµÎãàÎã§.', 'info');
					}
					return { success: true, data, wasFixed: true };

				} catch (stillError) {
					// 3Ï∞® ÏãúÎèÑ: Îçî Í≥µÍ≤©Ï†ÅÏù∏ ÏàòÏ†ï
					try {
						
						// Ïú†ÎãàÏΩîÎìú Î∞è ÌäπÏàòÎ¨∏Ïûê Ï≤òÎ¶¨
						fixedString = fixedString
							.replace(/[\u0000-\u001F]+/g, '') // Ï†úÏñ¥ Î¨∏Ïûê Ï†úÍ±∞
							.replace(/\\x[0-9a-fA-F]{2}/g, '') // hex Ïù¥Ïä§ÏºÄÏù¥ÌîÑ Ï†úÍ±∞
							.replace(/[\u200B-\u200D\uFEFF]/g, ''); // Î≥¥Ïù¥ÏßÄ ÏïäÎäî Î¨∏Ïûê Ï†úÍ±∞
						
						// Í∞ùÏ≤¥ ÌÇ§ Îî∞Ïò¥Ìëú Ï∂îÍ∞Ä (Í∞úÏÑ†Îêú Ìå®ÌÑ¥)
						fixedString = fixedString
							.replace(/(\{|,)\s*(\w+)\s*:/g, '$1"$2":')
							.replace(/""([^"]+)":/g, '"$1":'); // Ï§ëÎ≥µ Îî∞Ïò¥Ìëú Ï†úÍ±∞
						
						const finalData = JSON.parse(fixedString);
						return { success: true, data: finalData, wasFixed: true };
					} catch (finalError) {
						// Î≥µÍµ¨ Î∂àÍ∞ÄÎä•

						// Ïò§Î•ò ÏúÑÏπò Ï∞æÍ∏∞
						const match = finalError.message.match(/position (\d+)/);
						if (match) {
							const position = parseInt(match[1]);
							const lines = jsonString.substring(0, position).split('\n');
							const lineNumber = lines.length;
							const columnNumber = lines[lines.length - 1].length + 1;

							showMessage(
								`JSON ÏûêÎèô ÏàòÏ†ï Ïã§Ìå®<br>` +
								`Ïò§Î•ò ÏúÑÏπò: ${lineNumber}Î≤àÏß∏ Ï§Ñ, ${columnNumber}Î≤àÏß∏ Î¨∏Ïûê<br>` +
								`<small>ÌÖçÏä§Ìä∏ ÏóêÎîîÌÑ∞ÏóêÏÑú ÏßÅÏ†ë ÏàòÏ†ïÌï¥Ï£ºÏÑ∏Ïöî.</small>`,
								'error'
							);
						} else {
							showMessage(`JSON ÌååÏã± Ïò§Î•ò: ${finalError.message}`, 'error');
						}

						return { success: false, error: finalError };
					}
				}
			}
		}

		// Stage 2 Íµ¨Ï°∞ ÏàòÏ†ï Ìï®Ïàò
		function fixStage2Structure(data) {
			try {
				if (!data.narrative_data?.treatment_data?.story_summary_by_act_or_sequence) {
					return { data, wasFixed: false };
				}

				const storyArray = data.narrative_data.treatment_data.story_summary_by_act_or_sequence;
				const characterArray = data.narrative_data.treatment_data.character_arcs || [];

				const properStories = [];
				const misplacedCharacters = [];
				let wasFixed = false;

				// Î∂ÑÎ•ò
				storyArray.forEach(item => {
					if (item.character_name && (item.backstory_summary_relevant || item.arc_description_full)) {
						misplacedCharacters.push(item);
						wasFixed = true;
					} else if (item.act_or_sequence_number !== undefined) {
						properStories.push(item);
					}
				});

				if (wasFixed) {
					data.narrative_data.treatment_data.story_summary_by_act_or_sequence = properStories;
					data.narrative_data.treatment_data.character_arcs = [...characterArray, ...misplacedCharacters];
				}

				return { data, wasFixed };

			} catch (error) {
				return { data, wasFixed: false };
			}
		}
		// JSON Í∞ÄÏ†∏Ïò§Í∏∞
       function importData() {
           document.getElementById('file-input')?.click();
       }
       
      function handleFileSelect(event) {
           const file = event.target.files[0];
           if (!file) { 
               return; 
           }

           const reader = new FileReader();
           reader.onload = function(e) {
               try {
					// ÏÉàÎ°úÏö¥ Ïã§Ïö©Ï†Å JSON Ìï∏Îì§Îü¨ ÏÇ¨Ïö©
					const result = practicalJSONHandler(e.target.result);

					if (!result.success) {
						event.target.value = '';
						return;
					}

					const newData = result.data;
					let updated = false;
					let message = '';

                   // Ï†ÑÏ≤¥ ÌîÑÎ°úÏ†ùÌä∏ Î∞±ÏóÖ ÌååÏùº Ï≤òÎ¶¨
                   if (newData.type === 'full_project_backup' && newData.data) {
                       const confirmRestore = confirm(
                           'Ï†ÑÏ≤¥ ÌîÑÎ°úÏ†ùÌä∏ Î∞±ÏóÖ ÌååÏùºÏûÖÎãàÎã§.\n' +
                           `ÌîÑÎ°úÏ†ùÌä∏: ${newData.project_info?.name || 'Ïïå Ïàò ÏóÜÏùå'}\n` +
                           `Î∞±ÏóÖ ÏãúÍ∞Ñ: ${new Date(newData.timestamp).toLocaleString()}\n\n` +
                           'ÌòÑÏû¨ ÌîÑÎ°úÏ†ùÌä∏ Îç∞Ïù¥ÌÑ∞Î•º Î™®Îëê ÎåÄÏ≤¥ÌïòÏãúÍ≤†ÏäµÎãàÍπå?'
                       );
                       
                       if (!confirmRestore) {
                           event.target.value = '';
                           return;
                       }
                       
                       // Ï†ÑÏ≤¥ Îç∞Ïù¥ÌÑ∞ Î≥µÏõê
                       currentData = newData.data;
                       
                       // hasStage2Structure Î≥µÏõê
                       if (newData.data.backup_metadata?.hasStage2Structure !== undefined) {
                           hasStage2Structure = newData.data.backup_metadata.hasStage2Structure;
                       }
                       
                       // localStorageÏóê Ï∂îÍ∞Ä Stage Îç∞Ïù¥ÌÑ∞ Î≥µÏõê
                       if (newData.additional_stage_data) {
                           const jsonFileName = getProjectFileName();
                           
                           if (newData.additional_stage_data.stage6ImagePrompts) {
                               localStorage.setItem(`stage6ImagePrompts_${jsonFileName}`, 
                                   JSON.stringify(newData.additional_stage_data.stage6ImagePrompts));
                           }
                           
                           if (newData.additional_stage_data.stage7VideoPrompts) {
                               localStorage.setItem(`stage7VideoPrompts_${jsonFileName}`, 
                                   JSON.stringify(newData.additional_stage_data.stage7VideoPrompts));
                           }
                           
                           if (newData.additional_stage_data.stage8AudioPrompts) {
                               localStorage.setItem(`stage8AudioPrompts_${jsonFileName}`, 
                                   JSON.stringify(newData.additional_stage_data.stage8AudioPrompts));
                           }
                       }
                       
                       saveDataToLocalStorage();
                       updateUI();
                       
                       const stats = newData.data.backup_metadata || {};
                       showMessage(
                           `Ï†ÑÏ≤¥ ÌîÑÎ°úÏ†ùÌä∏ Î∞±ÏóÖÏù¥ ÏÑ±Í≥µÏ†ÅÏúºÎ°ú Î≥µÏõêÎêòÏóàÏäµÎãàÎã§.\n` +
                           `ÏãúÌÄÄÏä§: ${stats.totalSequences || 0}Í∞ú, ` +
                           `Ïî¨: ${stats.totalScenes || 0}Í∞ú, ` +
                           `ÏÉ∑: ${stats.totalShots || 0}Í∞ú`, 
                           'success'
                       );
                       
                       event.target.value = '';
                       return;
                   }
                   
                   // URL Î∞±ÏóÖ ÌååÏùº Ï≤òÎ¶¨
                   else if (newData.type === 'urls_backup' && newData.urls) {
                       if (!currentData || !currentData.breakdown_data || !currentData.breakdown_data.shots) {
                           showMessage('Î®ºÏ†Ä ÌîÑÎ°úÏ†ùÌä∏ Îç∞Ïù¥ÌÑ∞Î•º Î°úÎìúÌïú ÌõÑ URLÏùÑ Í∞ÄÏ†∏ÏôÄÏ£ºÏÑ∏Ïöî.', 'warning');
                           event.target.value = '';
                           return;
                       }
                       
                       let urlUpdateCount = 0;
                       Object.keys(newData.urls).forEach(shotId => {
                           const shot = currentData.breakdown_data.shots.find(s => s.id === shotId);
                           if (shot) {
                               const shotUrls = newData.urls[shotId];
                               
                               // Ïù¥ÎØ∏ÏßÄ URL Î≥µÏõê
                               if (shotUrls.image_urls) {
                                   if (!shot.image_design) shot.image_design = {};
                                   shot.image_design.ai_generated_images = shotUrls.image_urls;
                                   urlUpdateCount++;
                               }
                               
                               // ÎπÑÎîîÏò§ URL Î≥µÏõê
                               if (shotUrls.video_urls) {
                                   shot.video_urls = shotUrls.video_urls;
                                   urlUpdateCount++;
                               }
                               
                               // Ïò§ÎîîÏò§ URL Î≥µÏõê
                               if (shotUrls.audio_urls) {
                                   if (!shot.content) shot.content = {};
                                   shot.content.audio_urls = shotUrls.audio_urls;
                                   urlUpdateCount++;
                               }
                               
                               // Ï∞∏Ï°∞ Ïù¥ÎØ∏ÏßÄ Î≥µÏõê
                               if (shotUrls.reference_images) {
                                   shot.reference_images = shotUrls.reference_images;
                                   urlUpdateCount++;
                               }
                           }
                       });
                       
                       // ÌîÑÎ°úÏ†ùÌä∏ ÏùåÏïÖ URL Î≥µÏõê
                       if (newData.project_music_urls) {
                           if (!currentData.film_metadata) currentData.film_metadata = {};
                           currentData.film_metadata.project_music_urls = newData.project_music_urls;
                           urlUpdateCount++;
                       }
                       
                       saveDataToLocalStorage();
                       updateUI();
                       showMessage(`URL Îç∞Ïù¥ÌÑ∞Î•º ÏÑ±Í≥µÏ†ÅÏúºÎ°ú Î≥µÏõêÌñàÏäµÎãàÎã§. (${urlUpdateCount}Í∞ú Ìï≠Î™©)`, 'success');
                       event.target.value = '';
                       return;
                   }

                   // 1. Ïä§ÌÖåÏù¥ÏßÄ 8 (Ïò§ÎîîÏò§ ÌîÑÎ°¨ÌîÑÌä∏ ÏÉùÏÑ±) Îç∞Ïù¥ÌÑ∞ Î≥ëÌï©
                   if (newData.stage === 8 && newData.audio_data) {
		             // Stage 2 Íµ¨Ï°∞ ÌôïÏù∏ - Í≤ΩÍ≥†Îßå ÌëúÏãúÌïòÍ≥† Í≥ÑÏÜç ÏßÑÌñâ (ÏôÑÌôîÎêú Ï≤¥ÌÅ¨)
                       if (!hasStage2Structure && 
                           (!currentData?.breakdown_data?.sequences || currentData.breakdown_data.sequences.length === 0) &&
                           !currentData?.stage2_data) {
                           console.warn('‚ö†Ô∏è Stage 2 Íµ¨Ï°∞Í∞Ä ÏóÜÏñ¥ÎèÑ Stage 8 Îç∞Ïù¥ÌÑ∞Î•º Ï≤òÎ¶¨Ìï©ÎãàÎã§.');
                       }
                       if (!currentData || !currentData.breakdown_data || !currentData.breakdown_data.shots || currentData.breakdown_data.shots.length === 0) {
                           message = 'Ïò§ÎîîÏò§ Îç∞Ïù¥ÌÑ∞Î•º Î≥ëÌï©ÌïòÎ†§Î©¥ Î®ºÏ†Ä Ïú†Ìö®Ìïú Í∏∞Î≥∏ ÌîÑÎ°úÏ†ùÌä∏ Îç∞Ïù¥ÌÑ∞(ÏÉ∑ Ìè¨Ìï®)Î•º Î°úÎìúÌï¥Ïïº Ìï©ÎãàÎã§.';
                           showMessage(message, 'warning');
                           event.target.value = '';
                           return;
                       }

                       if (newData.project_info && newData.project_info.film_id) {
                           currentData.film_id = newData.project_info.film_id;
                       }

                       if (newData.audio_data && newData.audio_data.shots) {
                           
                           newData.audio_data.shots.forEach(newShotData => {
                               const shotIdToFind = newShotData.id;
                               const existingShot = currentData.breakdown_data.shots.find(shot => shot.id === shotIdToFind);

                               if (existingShot) {
                                   
                                   if (newShotData.content) {
                                       if (!existingShot.content) existingShot.content = {};
                                       
                                       if (newShotData.content.dialogue_by_character) {
                                           existingShot.content.dialogue_by_character = newShotData.content.dialogue_by_character;
                                           updated = true;
                                       }
                                       if (newShotData.content.dialogue_sequence) {
                                           existingShot.content.dialogue_sequence = newShotData.content.dialogue_sequence;
                                           updated = true;
                                       }
                                       if (newShotData.content.narration !== undefined) {
                                           existingShot.content.narration = newShotData.content.narration;
                                           updated = true;
                                       }
                                       if (newShotData.content.narration_translated !== undefined) {
                                           existingShot.content.narration_translated = newShotData.content.narration_translated;
                                           updated = true;
                                       }
                                       if (newShotData.content.sound_effects !== undefined) {
                                           existingShot.content.sound_effects = newShotData.content.sound_effects;
                                           updated = true;
                                       }
                                       if (newShotData.content.sound_effects_en !== undefined) {
                                           existingShot.content.sound_effects_en = newShotData.content.sound_effects_en;
                                           updated = true;
                                       }
                                       if (newShotData.content.audio_urls) {
                                           existingShot.content.audio_urls = newShotData.content.audio_urls;
                                           updated = true;
                                       }
                                   }
                                   
                                   if (newShotData.audio_prompts) {
                                       existingShot.audio_prompts = newShotData.audio_prompts;
                                       updated = true;
                                   }
                                   
                                   if (newShotData.music_memo !== undefined) {
                                       existingShot.music_memo = newShotData.music_memo;
                                       updated = true;
                                   }
                                   
                                   if (newShotData.title) existingShot.title = newShotData.title;
                                   if (newShotData.description) existingShot.description = newShotData.description;
                               } else {
                               }
                           });
                       }

                       if (updated) {
                           currentData.current_stage_name = "audio_prompt_generation";
                           currentData.timestamp = new Date().toISOString();
                           saveDataToLocalStorage();
                           updateUI();
                           message = 'Ïä§ÌÖåÏù¥ÏßÄ 8 Ïò§ÎîîÏò§ Ï†ïÎ≥¥Î•º ÌòÑÏû¨ Îç∞Ïù¥ÌÑ∞Ïóê ÏÑ±Í≥µÏ†ÅÏúºÎ°ú Î≥ëÌï©ÌñàÏäµÎãàÎã§.';
                           showMessage(message, 'success');
                           event.target.value = '';
                           return;
                       } else {
                           message = 'Ïä§ÌÖåÏù¥ÏßÄ 8 Ïò§ÎîîÏò§ Î≥ëÌï©ÏùÑ ÏãúÎèÑÌñàÏúºÎÇò, Î≥ÄÍ≤ΩÎêú ÎÇ¥Ïö©Ïù¥ ÏóÜÍ±∞ÎÇò ÎåÄÏÉÅ Îç∞Ïù¥ÌÑ∞Î•º Ï∞æÏßÄ Î™ªÌñàÏäµÎãàÎã§.';
                           showMessage(message, 'info');
                           event.target.value = '';
                           return;
                       }
                   }
                // Stage 6 Îç∞Ïù¥ÌÑ∞Î•º Ï†ÑÏó≠ Î≥ÄÏàòÏóê Ï†ÄÏû• (Î≥ëÌï© Ï†ÑÏóê Î®ºÏ†Ä Ï†ÄÏû•)
						if (newData.stage === 6 && newData.shots) {
							// Í∏∞Ï°¥ Îç∞Ïù¥ÌÑ∞Í∞Ä ÏóÜÏúºÎ©¥ ÏÉàÎ°ú ÎßåÎì§Í≥†, ÏûàÏúºÎ©¥ Ïú†ÏßÄ
							if (!window.stage6ImagePrompts) {
								window.stage6ImagePrompts = {};
							}

							newData.shots.forEach(shotData => {
								const shotId = shotData.shot_id;
								// Í∏∞Ï°¥ Îç∞Ïù¥ÌÑ∞Î•º ÏôÑÏ†ÑÌûà ÎåÄÏ≤¥ (ÏóÖÎç∞Ïù¥Ìä∏)
								window.stage6ImagePrompts[shotId] = {};

								shotData.images.forEach(imageData => {
									const imageId = imageData.image_id;
									window.stage6ImagePrompts[shotId][imageId] = imageData;
								});
							});

                            showMessage('Stage 6 Ïù¥ÎØ∏ÏßÄ ÌîÑÎ°¨ÌîÑÌä∏ Îç∞Ïù¥ÌÑ∞Í∞Ä Î°úÎìúÎêòÏóàÏäµÎãàÎã§.', 'success');

								// Stage 6 Îç∞Ïù¥ÌÑ∞ localStorageÏóê Ï†ÄÏû•
								const jsonFileName = getProjectFileName();
								localStorage.setItem(`stage6ImagePrompts_${jsonFileName}`, JSON.stringify(window.stage6ImagePrompts));

							// Stage 6Îßå Î°úÎìúÌïú Í≤ΩÏö∞ Î©îÏãúÏßÄ ÌëúÏãú
							if (!currentData || !currentData.breakdown_data) {
								showMessage('Stage 6 Îç∞Ïù¥ÌÑ∞Í∞Ä Î°úÎìúÎêòÏóàÏäµÎãàÎã§. Stage 5 Îç∞Ïù¥ÌÑ∞Î•º Î®ºÏ†Ä Í∞ÄÏ†∏ÏôÄÏ£ºÏÑ∏Ïöî.', 'info');
								// Stage 6 Îç∞Ïù¥ÌÑ∞ÎßåÏù¥ÎùºÎèÑ Ï†ÄÏû•
								const jsonFileName = getProjectFileName();
								localStorage.setItem(`stage6ImagePrompts_${jsonFileName}`, JSON.stringify(window.stage6ImagePrompts));
								event.target.value = '';
								return;
							}
						}

						// 2. Ïä§ÌÖåÏù¥ÏßÄ 6 (ÏÉ∑Î≥Ñ AI Ïù¥ÎØ∏ÏßÄ ÌîÑÎ°¨ÌîÑÌä∏) Î≥ëÌï©
						else if (newData.stage === 6 && newData.scene_info && newData.shots) {
                            // Stage 2 Íµ¨Ï°∞ ÌôïÏù∏ (ÏôÑÌôîÎêú Ï≤¥ÌÅ¨)
                           if (!hasStage2Structure && 
                               (!currentData?.breakdown_data?.sequences || currentData.breakdown_data.sequences.length === 0) &&
                               !currentData?.stage2_data) {
                               showMessage('Stage 6 Îç∞Ïù¥ÌÑ∞Î•º Î°úÎìúÌïòÎ†§Î©¥ Î®ºÏ†Ä Stage 2 ÏãúÎÇòÎ¶¨Ïò§ Íµ¨Ï°∞Î•º ÏóÖÎ°úÎìúÌï¥Ïïº Ìï©ÎãàÎã§.', 'warning');
                               event.target.value = '';
                               return;
                           }
							if (!currentData || !currentData.breakdown_data || !currentData.breakdown_data.shots) {
								showMessage('Ïä§ÌÖåÏù¥ÏßÄ6 Îç∞Ïù¥ÌÑ∞Î•º Î≥ëÌï©ÌïòÎ†§Î©¥ Î®ºÏ†Ä Ïä§ÌÖåÏù¥ÏßÄ5 Îç∞Ïù¥ÌÑ∞Î•º Î°úÎìúÌï¥Ïïº Ìï©ÎãàÎã§.', 'warning');
								event.target.value = '';
								return;
							}

							newData.shots.forEach(newShotData => {
								const shotIdToFind = newShotData.shot_id;
								const existingShot = currentData.breakdown_data.shots.find(shot => shot.id === shotIdToFind);

								if (existingShot) {

									// Stage 6Ïùò ÌîÑÎ°¨ÌîÑÌä∏ Ï†ïÎ≥¥Îßå Í∞ÄÏ†∏Ïò§Í∏∞
									if (newShotData.images && newShotData.images.length > 0) {
										// image_design_plans ÏÉùÏÑ± (ÏóÜÎäî Í≤ΩÏö∞)
										if (!existingShot.image_design_plans) {
											existingShot.image_design_plans = {
												plan_a: {
													description: `${newShotData.images.length}Í∞ú Ïù¥ÎØ∏ÏßÄÎ°ú Ï†ÑÏ≤¥ ÌëúÌòÑ`,
													image_count: newShotData.images.length,
													complexity: "high",
													images: newShotData.images.map((img, idx) => ({
														id: img.image_id || `IMG_A_${String(idx + 1).padStart(3, '0')}`,
														description: img.image_description || '',
														csv_attributes: img.csv_data || {}
													}))
												},
												plan_b: {
													description: "Ï§ëÍ∞Ñ Î≥µÏû°ÎèÑ ÌëúÌòÑ",
													image_count: Math.ceil(newShotData.images.length / 2),
													complexity: "medium",
													images: []
												},
												plan_c: {
													description: "Îã®Ïàú ÌëúÌòÑ",
													image_count: 1,
													complexity: "low",
													images: []
												}
											};
										}

										// promptsÍ∞Ä ÏûàÎäî Ï≤´ Î≤àÏß∏ Ïù¥ÎØ∏ÏßÄ Ï∞æÍ∏∞
										const imageWithPrompts = newShotData.images.find(img => img.prompts);

										if (imageWithPrompts && imageWithPrompts.prompts) {
											// image_prompts Ï¥àÍ∏∞Ìôî (Í∏∞Ï°¥ Îç∞Ïù¥ÌÑ∞Í∞Ä ÏóÜÏùÑ ÎïåÎßå)
											if (!existingShot.image_prompts) {
												existingShot.image_prompts = {};
											}

											// Stage 6Ïóê ÏûàÎäî AI ÎèÑÍµ¨Îì§Îßå ÏóÖÎç∞Ïù¥Ìä∏ (Í∏∞Ï°¥ Îç∞Ïù¥ÌÑ∞ Î≥¥Ï°¥ÌïòÎ©¥ÏÑú Î≥ëÌï©)
											Object.keys(imageWithPrompts.prompts).forEach(aiTool => {
												const promptData = imageWithPrompts.prompts[aiTool];

												if (aiTool === 'midjourney') {
													// Í∏∞Ï°¥ midjourney Îç∞Ïù¥ÌÑ∞ÏôÄ Î≥ëÌï©
													existingShot.image_prompts.midjourney = {
														...(existingShot.image_prompts.midjourney || {}),
														main_prompt: promptData.prompt || existingShot.image_prompts.midjourney?.main_prompt || '',
														main_prompt_translated: promptData.prompt_translated || existingShot.image_prompts.midjourney?.main_prompt_translated || '',
														parameters: promptData.parameters || existingShot.image_prompts.midjourney?.parameters || ''
													};
												} else {
													// Îã§Î•∏ AI ÎèÑÍµ¨Îì§ÎèÑ Í∏∞Ï°¥ Îç∞Ïù¥ÌÑ∞ÏôÄ Î≥ëÌï©
													let parameters = '';
													if (promptData.negative_prompt) {
														parameters = `Negative: ${promptData.negative_prompt}`;
													}
													if (promptData.aspect_ratio) {
														parameters += parameters ? `; Aspect Ratio: ${promptData.aspect_ratio}` : `Aspect Ratio: ${promptData.aspect_ratio}`;
													}

													existingShot.image_prompts[aiTool] = {
														...(existingShot.image_prompts[aiTool] || {}),
														main_prompt: promptData.prompt || existingShot.image_prompts[aiTool]?.main_prompt || '',
														main_prompt_translated: promptData.prompt_translated || existingShot.image_prompts[aiTool]?.main_prompt_translated || '',
														parameters: parameters || existingShot.image_prompts[aiTool]?.parameters || ''
													};
												}
											});
										}
									}

									// ÏÉ∑ ÏÑ§Î™Ö ÏóÖÎç∞Ïù¥Ìä∏
									if (newShotData.shot_description) {
										existingShot.title = existingShot.title || newShotData.shot_description;
									}

									updated = true;
								} else {
								}
							});

							if (updated) {
								showMessage('Ïä§ÌÖåÏù¥ÏßÄ6 Ïù¥ÎØ∏ÏßÄ ÌîÑÎ°¨ÌîÑÌä∏ Ï†ïÎ≥¥Î•º ÌòÑÏû¨ Îç∞Ïù¥ÌÑ∞Ïóê ÏÑ±Í≥µÏ†ÅÏúºÎ°ú Î≥ëÌï©ÌñàÏäµÎãàÎã§.', 'success');
							} else {
								showMessage('Ïä§ÌÖåÏù¥ÏßÄ6 JSONÏóêÏÑú ÏóÖÎç∞Ïù¥Ìä∏Ìï† ÏÉ∑ Ï†ïÎ≥¥Î•º Ï∞æÏßÄ Î™ªÌñàÍ±∞ÎÇò, Î≥ÄÍ≤ΩÏÇ¨Ìï≠Ïù¥ ÏóÜÏäµÎãàÎã§.', 'info');
							}
                            // Stage 6 Îç∞Ïù¥ÌÑ∞ Ï†ÄÏû•
                             saveDataToLocalStorage();
						}
                    // 2.5 Ïä§ÌÖåÏù¥ÏßÄ 2 (ÏãúÎÇòÎ¶¨Ïò§ Íµ¨Ï°∞) Ï≤òÎ¶¨
                   else if (newData.current_stage_name === 'narrative_development' && newData.narrative_data) {
                       handleStage2Data(newData);
                       event.target.value = '';
                       return;
                   }
                    // 3.5 Ïä§ÌÖåÏù¥ÏßÄ 5 Ïî¨ Îã®ÏúÑ Îç∞Ïù¥ÌÑ∞ Ï≤òÎ¶¨
					else if (newData.film_metadata && newData.film_metadata.current_scene !== undefined && newData.breakdown_data) {
                      // Stage 2 Íµ¨Ï°∞ ÌôïÏù∏ (ÏôÑÌôîÎêú Ï≤¥ÌÅ¨)
                       if (!hasStage2Structure && 
                           (!currentData?.breakdown_data?.sequences || currentData.breakdown_data.sequences.length === 0) &&
                           !currentData?.stage2_data) {
                           showMessage('Stage 5 Ïî¨ Îç∞Ïù¥ÌÑ∞Î•º Î°úÎìúÌïòÎ†§Î©¥ Î®ºÏ†Ä Stage 2 ÏãúÎÇòÎ¶¨Ïò§ Íµ¨Ï°∞Î•º ÏóÖÎ°úÎìúÌï¥Ïïº Ìï©ÎãàÎã§.', 'warning');
                           event.target.value = '';
                           return;
                       }
						handleStage5SceneData(newData);
						return;
					}
                   // 3. Ïä§ÌÖåÏù¥ÏßÄ 7 (ÏòÅÏÉÅ Í¥ÄÎ†® Îç∞Ïù¥ÌÑ∞) Î≥ëÌï©
					else if (newData.stage === 7 && newData.video_prompts) {
                      // Stage 2 Íµ¨Ï°∞ ÌôïÏù∏ (ÏôÑÌôîÎêú Ï≤¥ÌÅ¨)
                        if (!hasStage2Structure && 
                            (!currentData?.breakdown_data?.sequences || currentData.breakdown_data.sequences.length === 0) &&
                            !currentData?.stage2_data) {
                            showMessage('Stage 7 Îç∞Ïù¥ÌÑ∞Î•º Î°úÎìúÌïòÎ†§Î©¥ Î®ºÏ†Ä Stage 2 ÏãúÎÇòÎ¶¨Ïò§ Íµ¨Ï°∞Î•º ÏóÖÎ°úÎìúÌï¥Ïïº Ìï©ÎãàÎã§.', 'warning');
                            event.target.value = '';
                            return;
                        }
                        // Stage 7 Îç∞Ïù¥ÌÑ∞Î•º Ï†ÑÏó≠ Î≥ÄÏàòÏóê Ï†ÄÏû•
						if (!window.stage7VideoPrompts) {
							window.stage7VideoPrompts = {};
						}

						if (Array.isArray(newData.video_prompts)) {
							newData.video_prompts.forEach(promptData => {
								const shotId = promptData.shot_id;
								const imageId = promptData.image_id;

								if (!window.stage7VideoPrompts[shotId]) {
									window.stage7VideoPrompts[shotId] = {};
								}

								window.stage7VideoPrompts[shotId][imageId] = promptData;
							});

						}
                        
						if (!currentData || !currentData.breakdown_data || !currentData.breakdown_data.shots || currentData.breakdown_data.shots.length === 0) {
							showMessage('ÏòÅÏÉÅ Îç∞Ïù¥ÌÑ∞Î•º Î≥ëÌï©ÌïòÎ†§Î©¥ Î®ºÏ†Ä Ïú†Ìö®Ìïú Í∏∞Î≥∏ ÌîÑÎ°úÏ†ùÌä∏ Îç∞Ïù¥ÌÑ∞(ÏÉ∑ Ìè¨Ìï®)Î•º Î°úÎìúÌï¥Ïïº Ìï©ÎãàÎã§.', 'warning');
							event.target.value = '';
							return;
						}

						let videoDataUpdated = false;

						if (newData.video_prompts && Array.isArray(newData.video_prompts)) {
							newData.video_prompts.forEach(promptData => {
								const shotIdToFind = promptData.shot_id;
								const existingShot = currentData.breakdown_data.shots.find(shot => shot.id === shotIdToFind);

								if (existingShot) {

									// video_prompts Î≥ëÌï©
									if (!existingShot.video_prompts) existingShot.video_prompts = {};

									if (promptData.prompts) {
										Object.keys(promptData.prompts).forEach(aiTool => {
											existingShot.video_prompts[aiTool] = {
												main_prompt: promptData.prompts[aiTool].prompt_en || '',
												main_prompt_translated: promptData.prompts[aiTool].prompt_translated || '',
												settings: promptData.prompts[aiTool].settings || {}
											};
										});
										videoDataUpdated = true;
									}

									// video_designÏùò extracted_image_info Ï≤òÎ¶¨
									if (promptData.extracted_data) {
										if (!existingShot.video_design) existingShot.video_design = {};
										existingShot.video_design.extracted_image_info = [{
											image_id: promptData.image_id,
											description: promptData.image_reference?.description || ''
										}];
										videoDataUpdated = true;
									}

									// Ï†úÎ™© ÏóÖÎç∞Ïù¥Ìä∏
									if (promptData.image_reference?.title) {
										existingShot.title = existingShot.title || promptData.image_reference.title;
									}
								} else {
								}
							});
						}

						if (videoDataUpdated) {
							currentData.current_stage_name = "video_prompt_generation";
							currentData.timestamp = new Date().toISOString();
							updated = true;
							showMessage('Ïä§ÌÖåÏù¥ÏßÄ 7 ÏòÅÏÉÅ Ï†ïÎ≥¥Î•º ÌòÑÏû¨ Îç∞Ïù¥ÌÑ∞Ïóê ÏÑ±Í≥µÏ†ÅÏúºÎ°ú Î≥ëÌï©ÌñàÏäµÎãàÎã§.', 'success');
						} else {
							showMessage('Ïä§ÌÖåÏù¥ÏßÄ 7 ÏòÅÏÉÅ Î≥ëÌï©ÏùÑ ÏãúÎèÑÌñàÏúºÎÇò, Î≥ÄÍ≤ΩÎêú ÎÇ¥Ïö©Ïù¥ ÏóÜÍ±∞ÎÇò ÎåÄÏÉÅ Îç∞Ïù¥ÌÑ∞Î•º Ï∞æÏßÄ Î™ªÌñàÏäµÎãàÎã§.', 'info');
						}
					}
                   // 4. Ïä§ÌÖåÏù¥ÏßÄ 5 ÎòêÎäî Ï†ÑÏ≤¥ ÌîÑÎ°úÏ†ùÌä∏ Íµ¨Ï°∞ Î°úÎìú (ÎçÆÏñ¥Ïì∞Í∏∞)
                   else if (newData.film_metadata && newData.breakdown_data && newData.breakdown_data.sequences) {
                       currentData = newData;
                       
                       if (currentData.breakdown_data && currentData.breakdown_data.shots) {
                           currentData.breakdown_data.shots.forEach(shot => {
                               if (!shot.image_prompts) shot.image_prompts = {};
                               IMAGE_AI_TOOLS.forEach(toolId => {
                                   if (!shot.image_prompts[toolId]) {
                                       shot.image_prompts[toolId] = { 
                                           main_prompt: '', 
                                           main_prompt_translated: '',
                                           parameters: '' 
                                       };
                                   }
                               });
                               
                               if (!shot.image_design) {
                                   shot.image_design = { 
                                       aspect_ratio: "16:9", 
                                       selected_plan: "plan_a",
                                       ai_generated_images: {} 
                                   };
                               } else if (!shot.image_design.ai_generated_images) {
                                   shot.image_design.ai_generated_images = {};
                               }
                               
                               IMAGE_AI_TOOLS.forEach(toolId => {
                                   if (!shot.image_design.ai_generated_images[toolId]) {
                                       shot.image_design.ai_generated_images[toolId] = [
                                           { url: '', description: '' },
                                           { url: '', description: '' },
                                           { url: '', description: '' }
                                       ];
                                   }
                               });
                               
                               if (!shot.content) shot.content = {};
                               if (!shot.content.audio_urls) {
                                   shot.content.audio_urls = { 
                                       dialogue: {}, 
                                       narration: "", 
                                       sound_effects: "" 
                                   };
                               }
                               if (!shot.audio_prompts) {
                                   shot.audio_prompts = { 
                                       dialogue: {}, 
                                       narration: { prompt: "", settings: {} }, 
                                       sound_effects: { prompt: "", settings: {} } 
                                   };
                               }
                               
                               if (!shot.reference_images) {
                                   shot.reference_images = [];
                               }
                           });
                       }
                       
                       updated = true;
                       message = (newData.film_metadata.title_working || 'ÌîÑÎ°úÏ†ùÌä∏') + ' Ï†ÑÏ≤¥ Îç∞Ïù¥ÌÑ∞Î•º Î°úÎìúÌñàÏäµÎãàÎã§.';
                       showMessage(message, 'success');
                   }
                   // 5. Ïù∏ÏãùÌï† Ïàò ÏóÜÎäî ÌòïÏãù
                   else {
                       message = 'Í∞ÄÏ†∏Ïò® JSON ÌååÏùºÏùò Íµ¨Ï°∞Î•º Ïù∏ÏãùÌï† Ïàò ÏóÜÍ±∞ÎÇò, ÌòÑÏû¨ Îç∞Ïù¥ÌÑ∞ÏôÄ Î≥ëÌï©/Î°úÎìúÌï† Ïàò ÏóÜÏäµÎãàÎã§.';
                       showMessage(message, 'warning');
                       event.target.value = '';
                       return;
                   }

                   if (updated) {
                       saveDataToLocalStorage();
                       updateUI();
                       
                       if (selectedType === 'shot' && selectedId) {
                           showShotContent(selectedId);
                           const lastActiveTab = localStorage.getItem(`shot_${selectedId}_activeTab`) || 'info';
                           setTimeout(() => switchTab(lastActiveTab, selectedId), 0);
                       } else if (selectedType === 'scene' && selectedId) {
                           showSceneContent(selectedId);
                       } else if (selectedType === 'sequence' && selectedId) {
                           showSequenceContent(selectedId);
                       } else {
                           updateNavigation();
                       }
                   }

               } catch (parseError) {
                   showMessage(`JSON ÌååÏã± Ïò§Î•ò: ${parseError.message}`, 'error');
               }
           };
           
           reader.onerror = function(error) {
               showMessage('ÌååÏùº ÏùΩÍ∏∞ Ïò§Î•ò', 'error');
           };
           
           reader.readAsText(file);
           event.target.value = '';
       }
           // ÏÉàÎ°úÏö¥ Ìï®Ïàò: Stage 2 Îç∞Ïù¥ÌÑ∞ Ï≤òÎ¶¨
			function handleStage2Data(jsonData) {

				try {
					// Stage 2 Îç∞Ïù¥ÌÑ∞ Í≤ÄÏ¶ù
					if (!jsonData.narrative_data || !jsonData.narrative_data.treatment_data || !jsonData.narrative_data.scenario_data) {
						throw new Error('Stage 2 Îç∞Ïù¥ÌÑ∞ Íµ¨Ï°∞Í∞Ä Ïò¨Î∞îÎ•¥ÏßÄ ÏïäÏäµÎãàÎã§.');
					}

					// ÏãúÌÄÄÏä§ Íµ¨Ï°∞ ÌôïÏù∏
					const sequences = jsonData.narrative_data.treatment_data.sequence_structure || [];
					const scenes = jsonData.narrative_data.scenario_data.scenes || [];
					

					if (sequences.length === 0 || scenes.length === 0) {
						throw new Error('ÏãúÌÄÄÏä§ ÎòêÎäî Ïî¨ Îç∞Ïù¥ÌÑ∞Í∞Ä ÎπÑÏñ¥ÏûàÏäµÎãàÎã§.');
					}

					// Í∏∞Ï°¥ Îç∞Ïù¥ÌÑ∞Í∞Ä ÏóÜÏúºÎ©¥ ÏÉàÎ°ú ÏÉùÏÑ±
					if (!currentData) {
						currentData = getEmptyData();
					}
					
					// breakdown_dataÍ∞Ä ÏóÜÏúºÎ©¥ Ï¥àÍ∏∞Ìôî
					if (!currentData.breakdown_data) {
						currentData.breakdown_data = {
							sequences: [],
							scenes: [],
							shots: []
						};
					}

					// Stage 2 Îç∞Ïù¥ÌÑ∞ Ï†ÄÏû•
					currentData.stage2_data = jsonData;
					currentData.film_metadata = {
						...currentData.film_metadata,
						...jsonData.film_metadata
					};

					// ÏãúÌÄÄÏä§/Ïî¨ Íµ¨Ï°∞Îßå ÏÑ§Ï†ï (ÏÉ∑ÏùÄ Ï†úÏô∏)
					currentData.breakdown_data.sequences = sequences.map(seq => ({
						id: seq.sequence_id,
						title: seq.title,
						function: seq.function,
						description: seq.description,
						scenes: seq.scene_ids,
						duration_estimate: `${seq.scene_ids.length * 3}-${seq.scene_ids.length * 5}Î∂Ñ`,
						scenario_text: seq.sequence_scenario_text || ''
					}));

					currentData.breakdown_data.scenes = scenes.map(scene => ({
						id: scene.scene_id,
						sequence_id: scene.sequence_id,
						title: scene.scene_heading ? 
							`${scene.scene_heading.setting_type} ${scene.scene_heading.location_name} - ${scene.scene_heading.time_of_day}` : 
							`Ïî¨ ${scene.scene_number}`,
						description: scene.scene_metadata?.scene_purpose || '',
						source_scene_number: scene.scene_number,
						original_scenario: {
							scene_heading: scene.scene_heading,
							action_lines: scene.action_lines || [],
							dialogue_blocks: scene.dialogue_blocks || [],
							scenario_text: scene.scenario_text || ''
						},
						shot_ids: [] // ÏÉ∑ÏùÄ ÎπÑÏõåÎë† (Stage 5ÏóêÏÑú Ï∂îÍ∞Ä)
					}));

					// Stage 2 Íµ¨Ï°∞ Î°úÎìú ÏôÑÎ£å ÌëúÏãú
					hasStage2Structure = true;
					currentData.hasStage2Structure = true;


					saveDataToLocalStorage();
					updateUI();
                    // Ï†ÑÏ≤¥ ÏãúÎÇòÎ¶¨Ïò§ Îã§Ïö¥Î°úÎìú Î≤ÑÌäº ÌëúÏãú
					const scenarioExportBtn = document.getElementById('scenario-export-btn');
					if (scenarioExportBtn) {
						scenarioExportBtn.style.display = 'inline-block';
					}


				} catch (error) {
					showMessage(`Stage 2 Îç∞Ïù¥ÌÑ∞ Ï≤òÎ¶¨ Ïò§Î•ò: ${error.message}`, 'error');
				}
			}
        // ÏÉàÎ°úÏö¥ Ìï®Ïàò: Ïî¨ Îã®ÏúÑ Stage 5 Îç∞Ïù¥ÌÑ∞ Ï≤òÎ¶¨
		function handleStage5SceneData(jsonData, suppressMessages = false) {

			try {
				// Îç∞Ïù¥ÌÑ∞ Íµ¨Ï°∞ Í≤ÄÏ¶ù
				if (!jsonData.film_metadata || !jsonData.breakdown_data) {
					throw new Error('ÌïÑÏàò ÌïÑÎìúÍ∞Ä ÏóÜÏäµÎãàÎã§: film_metadata, breakdown_data');
				}

				// ÌòÑÏû¨ Îç∞Ïù¥ÌÑ∞Í∞Ä ÏóÜÏúºÎ©¥ ÏÉàÎ°ú ÏÉùÏÑ±
				if (!currentData || !currentData.breakdown_data) {
					currentData = getEmptyData();
					currentData.film_metadata = jsonData.film_metadata;
				}

				// film_metadata ÏóÖÎç∞Ïù¥Ìä∏
				currentData.film_metadata = {
					...currentData.film_metadata,
					...jsonData.film_metadata
				};

				// breakdown_data Ï¥àÍ∏∞Ìôî (ÌïÑÏöîÏãú)
				if (!currentData.breakdown_data.sequences) {
					currentData.breakdown_data.sequences = [];
				}
				if (!currentData.breakdown_data.scenes) {
					currentData.breakdown_data.scenes = [];
				}
				if (!currentData.breakdown_data.shots) {
					currentData.breakdown_data.shots = [];
				}

				// Ïî¨ Îç∞Ïù¥ÌÑ∞ Î≥ëÌï© ÎòêÎäî Ï∂îÍ∞Ä
				const newScenes = jsonData.breakdown_data.scenes || [];
				const newShots = jsonData.breakdown_data.shots || [];
				const newSequences = jsonData.breakdown_data.sequences || [];


                // Í≥µÌÜµ CSV Îç∞Ïù¥ÌÑ∞ Ï≤òÎ¶¨ (Stage 5 v2.1)
				if (newScenes.length > 0 && newScenes[0].common_csv) {
					newScenes.forEach(scene => {
						const existingScene = currentData.breakdown_data.scenes.find(s => s.id === scene.id);
						if (existingScene && scene.common_csv) {
							existingScene.common_csv = scene.common_csv;
						}
					});
				}
				// Stage 5ÏóêÏÑúÎäî ÏÉ∑ Ï†ïÎ≥¥Îßå Î≥ëÌï© (ÏãúÌÄÄÏä§/Ïî¨ Íµ¨Ï°∞Îäî Stage 2ÏóêÏÑúÎßå)
				const sceneId = jsonData.film_metadata.current_scene;
				let currentScene = currentData.breakdown_data.scenes.find(scene => scene.id === sceneId);
				
				if (!currentScene) {
					// Stage 2Í∞Ä ÏóÜÎäî Í≤ΩÏö∞ Stage 5 Îç∞Ïù¥ÌÑ∞ÏóêÏÑú Ïî¨ Ï†ïÎ≥¥ Í∞ÄÏ†∏Ïò§Í∏∞
					
					if (newScenes.length > 0) {
						// Stage 5ÏóêÏÑú Ï†úÍ≥µÌïú Ïî¨ Ï†ïÎ≥¥ Ï∂îÍ∞Ä
						newScenes.forEach(scene => {
							const existingScene = currentData.breakdown_data.scenes.find(s => s.id === scene.id);
							if (!existingScene) {
								// shot_ids Î∞∞Ïó¥Ïù¥ ÏóÜÏúºÎ©¥ Ï¥àÍ∏∞Ìôî
								if (!scene.shot_ids) {
									scene.shot_ids = [];
								}
								currentData.breakdown_data.scenes.push(scene);
							}
						});
						
						// ÏãúÌÄÄÏä§ Ï†ïÎ≥¥ÎèÑ ÌïÑÏöîÌïú Í≤ΩÏö∞ Ï∂îÍ∞Ä
						if (newSequences.length > 0) {
							newSequences.forEach(seq => {
								const existingSeq = currentData.breakdown_data.sequences.find(s => s.id === seq.id);
								if (!existingSeq) {
									currentData.breakdown_data.sequences.push(seq);
								}
							});
						}
						
						// Îã§Ïãú Ïî¨ Ï∞æÍ∏∞
						currentScene = currentData.breakdown_data.scenes.find(scene => scene.id === sceneId);
					}
					
					if (!currentScene) {
						// Ïó¨Ï†ÑÌûà ÏóÜÏúºÎ©¥ Í∏∞Î≥∏ Ïî¨ ÏÉùÏÑ±
						const newScene = {
							id: sceneId,
							title: `Ïî¨ ${sceneId}`,
							description: '',
							shots: [],
							shot_ids: []  // shot_ids Î∞∞Ïó¥ Ï∂îÍ∞Ä
						};
						currentData.breakdown_data.scenes.push(newScene);
						currentScene = newScene;
					}
				}

				// Ìï¥Îãπ Ïî¨Ïùò ÏÉ∑Îßå Î≥ëÌï© (Í∏∞Ï°¥ Îç∞Ïù¥ÌÑ∞ Î≥¥Ï°¥)
				newShots.forEach(newShot => {
					if (newShot.scene_id === sceneId) {
						const existingIndex = currentData.breakdown_data.shots.findIndex(
							shot => shot.id === newShot.id
						);
						if (existingIndex >= 0) {
							// Í∏∞Ï°¥ ÏÉ∑Ïùò Îç∞Ïù¥ÌÑ∞Î•º Î≥¥Ï°¥ÌïòÎ©¥ÏÑú ÏÉàÎ°úÏö¥ Îç∞Ïù¥ÌÑ∞ Î≥ëÌï©
							const existingShot = currentData.breakdown_data.shots[existingIndex];
							
							// ÍπäÏùÄ Î≥ëÌï©: Í∏∞Ï°¥ Îç∞Ïù¥ÌÑ∞Î•º Ïú†ÏßÄÌïòÎ©¥ÏÑú ÏÉà Îç∞Ïù¥ÌÑ∞ Ï∂îÍ∞Ä
							currentData.breakdown_data.shots[existingIndex] = {
								...existingShot,
								...newShot,
								// Ï§ëÏöîÌïú ÌïÑÎìúÎì§ÏùÄ ÍπäÏùÄ Î≥ëÌï© ÏàòÌñâ
								content: {
									...existingShot.content,
									...newShot.content,
									// audio_urlsÎèÑ ÍπäÏùÄ Î≥ëÌï©
									audio_urls: {
										...existingShot.content?.audio_urls,
										...newShot.content?.audio_urls
									}
								},
								image_prompts: {
									...existingShot.image_prompts,
									...newShot.image_prompts,
									// Í∞Å AI ÎèÑÍµ¨Î≥ÑÎ°ú ÍπäÏùÄ Î≥ëÌï©
									...(function() {
										const merged = {};
										const allTools = new Set([
											...Object.keys(existingShot.image_prompts || {}),
											...Object.keys(newShot.image_prompts || {})
										]);
										allTools.forEach(tool => {
											if (existingShot.image_prompts?.[tool] || newShot.image_prompts?.[tool]) {
												merged[tool] = {
													...existingShot.image_prompts?.[tool],
													...newShot.image_prompts?.[tool]
												};
											}
										});
										return merged;
									})()
								},
								video_prompts: {
									...existingShot.video_prompts,
									...newShot.video_prompts
								},
								video_design: {
									...existingShot.video_design,
									...newShot.video_design
								},
								image_design: {
									...existingShot.image_design,
									...newShot.image_design,
									// ai_generated_imagesÎèÑ ÍπäÏùÄ Î≥ëÌï©
									ai_generated_images: {
										...existingShot.image_design?.ai_generated_images,
										...newShot.image_design?.ai_generated_images
									}
								},
								// images Î∞∞Ïó¥ÏùÄ Ï§ëÎ≥µ Ï†úÍ±∞ÌïòÎ©¥ÏÑú Î≥ëÌï©
								images: existingShot.images && newShot.images ? 
									[...existingShot.images, ...newShot.images].filter((img, index, self) => 
										index === self.findIndex(i => i.image_id === img.image_id)
									) : (existingShot.images || newShot.images || []),
								// reference_images Î∞∞Ïó¥ÎèÑ Î≥ëÌï©
								reference_images: existingShot.reference_images && newShot.reference_images ? 
									[...existingShot.reference_images, ...newShot.reference_images].filter((img, index, self) => 
										index === self.findIndex(i => i.id === img.id)
									) : (existingShot.reference_images || newShot.reference_images || [])
							};
						} else {
							currentData.breakdown_data.shots.push(newShot);
						}
						
                        // csv_mapping Ï∂îÍ∞Ä (Í∞úÎ≥Ñ CSV - Stage 5 v2.1)
						if (newShot.csv_mapping) {
							if (existingIndex >= 0) {
								currentData.breakdown_data.shots[existingIndex].csv_mapping = newShot.csv_mapping;
							} else {
								// ÏÉà ÏÉ∑Ïù∏ Í≤ΩÏö∞ Ïù¥ÎØ∏ csv_mappingÏù¥ Ìè¨Ìï®ÎêòÏñ¥ ÏûàÏùå
							}
						}
						// Ïî¨Ïùò shot_ids ÏóÖÎç∞Ïù¥Ìä∏ (ÏïàÏ†Ñ Ï≤¥ÌÅ¨ Ï∂îÍ∞Ä)
						if (!currentScene.shot_ids) {
							currentScene.shot_ids = [];
						}
						if (!currentScene.shot_ids.includes(newShot.id)) {
							currentScene.shot_ids.push(newShot.id);
						}
					}
				});

				// visual_consistency_infoÏôÄ concept_art_prompt_data Î≥ëÌï©
				if (jsonData.visual_consistency_info) {
					currentData.visual_consistency_info = jsonData.visual_consistency_info;
				}
				if (jsonData.concept_art_prompt_data) {
					currentData.concept_art_prompt_data = jsonData.concept_art_prompt_data;
				}

				// ÌÉÄÏûÑÏä§ÌÉ¨ÌîÑ ÏóÖÎç∞Ïù¥Ìä∏
				currentData.timestamp = new Date().toISOString();
				currentData.current_stage_name = "scenario_breakdown";

				// Ï†ÄÏû• Î∞è UI ÏóÖÎç∞Ïù¥Ìä∏
				saveDataToLocalStorage();
				updateUI();

				const currentSceneId = jsonData.film_metadata.current_scene;
				// suppressMessagesÍ∞Ä falseÏù∏ Í≤ΩÏö∞ÏóêÎßå Í∞úÎ≥Ñ Î©îÏãúÏßÄ ÌëúÏãú
				if (!suppressMessages) {
					showMessage(`Ïî¨ ${currentSceneId} Îç∞Ïù¥ÌÑ∞Î•º ÏÑ±Í≥µÏ†ÅÏúºÎ°ú Î°úÎìúÌñàÏäµÎãàÎã§.`, 'success');
				}

				// Î°úÎìúÎêú Ïî¨ÏúºÎ°ú ÏûêÎèô Ïù¥Îèô
				if (currentSceneId) {
					selectedId = currentSceneId;
					selectedType = 'scene';
					showSceneContent(currentSceneId);
				}

			} catch (error) {
				showMessage(`Îç∞Ïù¥ÌÑ∞ Ï≤òÎ¶¨ Ïò§Î•ò: ${error.message}`, 'error');
			}
		}

       // Í≤ÄÏÉâ Í∏∞Îä•
       function searchNavigation() {
           const searchInput = document.getElementById('search-input');
           const searchTerm = searchInput.value.toLowerCase();
           if (!currentData || !currentData.breakdown_data) return;
           
           const sequenceItems = document.querySelectorAll('.sequence-item');
           sequenceItems.forEach(item => {
               const sequenceText = item.textContent.toLowerCase();
               const isVisible = searchTerm === '' || sequenceText.includes(searchTerm);
               item.style.display = isVisible ? 'block' : 'none';
               
               if (isVisible && searchTerm !== '') {
                   const scenesContainer = item.querySelector('.scenes-container');
                   if (scenesContainer && scenesContainer.classList.contains('collapsed')) {
                       item.querySelector('.sequence-header').click();
                   }
               }
           });
       }

       // Ï†ÑÏ≤¥ ÌéºÏπòÍ∏∞/Ï†ëÍ∏∞
       // [DEPRECATED] Î™®Îëê ÌéºÏπòÍ∏∞ Í∏∞Îä• - Îçî Ïù¥ÏÉÅ ÏÇ¨Ïö©ÎêòÏßÄ ÏïäÏùå
       // TODO: Ìñ•ÌõÑ Î≤ÑÏ†ÑÏóêÏÑú Ï†úÍ±∞ ÏòàÏ†ï
       function expandAll() {
           document.querySelectorAll('.sequence-header').forEach(header => {
               const sequenceId = header.dataset.sequenceId;
               const scenesContainer = document.getElementById(`scenes-${sequenceId}`);
               if (scenesContainer && scenesContainer.classList.contains('collapsed')) {
                   header.click();
               }
           });
           
           setTimeout(() => {
               document.querySelectorAll('.scene-header').forEach(header => {
                   const sceneId = header.dataset.sceneId;
                   const shotsContainer = document.getElementById(`shots-${sceneId}`);
                   if (shotsContainer && shotsContainer.classList.contains('collapsed')) {
                       header.click();
                   }
               });
           }, 400);
       }

       // [DEPRECATED] Î™®Îëê Ï†ëÍ∏∞ Í∏∞Îä• - Îçî Ïù¥ÏÉÅ ÏÇ¨Ïö©ÎêòÏßÄ ÏïäÏùå
       // TODO: Ìñ•ÌõÑ Î≤ÑÏ†ÑÏóêÏÑú Ï†úÍ±∞ ÏòàÏ†ï
       function collapseAll() {
           // ÏÉ∑ Î®ºÏ†Ä Ï†ëÍ∏∞
           document.querySelectorAll('.scene-header').forEach(header => {
               const sceneId = header.dataset.sceneId;
               const shotsContainer = document.getElementById(`shots-${sceneId}`);
               if (shotsContainer && !shotsContainer.classList.contains('collapsed')) {
                   header.click();
               }
           });
           
           // ÏãúÌÄÄÏä§ Ï†ëÍ∏∞
           setTimeout(() => {
               document.querySelectorAll('.sequence-header').forEach(header => {
                   const sequenceId = header.dataset.sequenceId;
                   const scenesContainer = document.getElementById(`scenes-${sequenceId}`);
                   if (scenesContainer && !scenesContainer.classList.contains('collapsed')) {
                       header.click();
                   }
               });
           }, 400);
       }

       // UI ÏóÖÎç∞Ïù¥Ìä∏
       function updateUI() {
           try {
               updateHeaderInfo();
               updateNavigation();
               
               if (selectedId && selectedType) {
                   if (selectedType === 'shot') showShotContent(selectedId);
                   else if (selectedType === 'scene') showSceneContent(selectedId);
                   else if (selectedType === 'sequence') showSequenceContent(selectedId);
               } else {
                   document.getElementById('content-area').innerHTML = `
                       <div class="empty-state">
                           <div class="empty-state-icon">üé¨</div>
                           <div>ÏãúÌÄÄÏä§, Ïî¨, ÎòêÎäî ÏÉ∑ÏùÑ ÏÑ†ÌÉùÌïòÏó¨ ÏÉÅÏÑ∏ Ï†ïÎ≥¥Î•º ÌôïÏù∏ÌïòÏÑ∏Ïöî</div>
                       </div>`;
               }
		       // Ï†ÑÏ≤¥ ÏãúÎÇòÎ¶¨Ïò§ Îã§Ïö¥Î°úÎìú Î≤ÑÌäº ÌëúÏãú Ïó¨Î∂Ä Í≤∞Ï†ï
				const scenarioExportBtn = document.getElementById('scenario-export-btn');
				if (scenarioExportBtn) {
					// Stage 2 Íµ¨Ï°∞Í∞Ä ÏûàÍ±∞ÎÇò ÏãúÎÇòÎ¶¨Ïò§ ÌÖçÏä§Ìä∏Í∞Ä ÏûàÎäî Ïî¨Ïù¥ ÌïòÎÇòÎùºÎèÑ ÏûàÏúºÎ©¥ ÌëúÏãú
					const hasScenarioData = hasStage2Structure || 
						(currentData?.breakdown_data?.scenes?.some(scene => 
							scene.original_scenario?.scenario_text?.trim()
						) || false);

					scenarioExportBtn.style.display = hasScenarioData ? 'inline-block' : 'none';
				}
           } catch (error) {
               showMessage('ÌôîÎ©¥ ÏóÖÎç∞Ïù¥Ìä∏ Ïò§Î•ò: ' + error.message, 'error');
           }
       }

       // Ìó§Îçî Ï†ïÎ≥¥ ÏóÖÎç∞Ïù¥Ìä∏
       function updateHeaderInfo() {
           try {
               const projectName = getProjectName();
               const jsonFileName = getProjectFileName();
               const projectTitleEl = document.getElementById('project-title');
               const projectFileEl = document.getElementById('project-file');
               const navProjectTitleEl = document.getElementById('nav-project-title');
               const navProjectFileEl = document.getElementById('nav-project-file');
               
               if (projectTitleEl) projectTitleEl.textContent = currentData?.film_metadata?.title_working || projectName;
               if (projectFileEl) projectFileEl.textContent = `ÌååÏùº: ${jsonFileName}`;
               if (navProjectTitleEl) navProjectTitleEl.textContent = currentData?.film_metadata?.title_working || projectName;
               const navProjectDescEl = document.getElementById('nav-project-description');
			if (navProjectDescEl) {
				const genre = currentData?.film_metadata?.confirmed_genre || '';
				const description = genre ? `Ïû•Î•¥: ${genre}` : 'ÌîÑÎ°úÏ†ùÌä∏ ÏÑ§Î™ÖÏù¥ Ïó¨Í∏∞Ïóê ÌëúÏãúÎê©ÎãàÎã§';
				navProjectDescEl.textContent = description;
			}
           } catch (error) {
           }
       }

       // ÎÑ§ÎπÑÍ≤åÏù¥ÏÖò ÏóÖÎç∞Ïù¥Ìä∏
       function updateNavigation() {
           try {
               const navContent = document.getElementById('navigation-content');
               if (!navContent) return;
               
               if (!currentData || !currentData.breakdown_data) {
					navContent.innerHTML = `
						<div class="empty-state" id="nav-empty">
							<div class="empty-state-icon">üìÅ</div>
							<div>Îç∞Ïù¥ÌÑ∞Í∞Ä ÏóÜÏäµÎãàÎã§</div>
							<div style="font-size: 0.9rem; margin-top: 10px;">JSON Í∞ÄÏ†∏Ïò§Í∏∞Î•º ÏÇ¨Ïö©Ìï¥ Îç∞Ïù¥ÌÑ∞Î•º Î°úÎìúÌï¥Ï£ºÏÑ∏Ïöî</div>
						</div>`;
					return;
				}

				// ÏãúÌÄÄÏä§ Íµ¨Ï°∞Í∞Ä ÏûàÎäîÏßÄ ÌôïÏù∏
				if (currentData.breakdown_data.sequences?.length > 0) {
				}
				
				// ÏãúÌÄÄÏä§Í∞Ä ÏûàÎäî Í≤ΩÏö∞ÏôÄ ÏóÜÎäî Í≤ΩÏö∞Î•º Íµ¨Î∂Ñ
				const hasSequences = currentData.breakdown_data.sequences && 
									 Array.isArray(currentData.breakdown_data.sequences) && 
									 currentData.breakdown_data.sequences.length > 0;
				
				if (!hasSequences) {
					// Ïî¨ Îã®ÏúÑ Îç∞Ïù¥ÌÑ∞Ïù∏ Í≤ΩÏö∞ (ÏãúÌÄÄÏä§ ÏóÜÏù¥ Ïî¨Îßå ÏûàÎäî Í≤ΩÏö∞)

					// Ïî¨Îì§ÏùÑ ÏûÑÏãú ÏãúÌÄÄÏä§Î°ú Í∑∏Î£πÌôî
					const scenes = currentData.breakdown_data.scenes || [];
					if (scenes.length > 0) {
						let html = '<div class="sequence-item">';
						html += '<div class="sequence-header" data-sequence-id="TEMP_SEQ">';
						html += '<span class="toggle-icon">‚ñº</span>';
						html += '<span>Ïî¨ Îã®ÏúÑ ÏûëÏóÖ</span>';
						html += '</div>';
						html += '<div class="scenes-container" id="scenes-TEMP_SEQ">';

						scenes.forEach(scene => {
							html += `
								<div class="scene-item">
									<div class="scene-header" data-scene-id="${scene.id}">
										<span class="toggle-icon">‚ñ∑</span>
										<span>${scene.id}: ${scene.title || 'Ï†úÎ™© ÏóÜÏùå'}</span>
									</div>
									<div class="shots-container collapsed" id="shots-${scene.id}"></div>
								</div>`;
						});

						html += '</div></div>';
						navContent.innerHTML = html;

						// Ïî¨ Ïù¥Î≤§Ìä∏ Î¶¨Ïä§ÎÑà ÏÑ§Ï†ï
						navContent.querySelectorAll('.scene-header').forEach(header => {
							header.addEventListener('click', function(e) {
								e.stopPropagation();
								selectScene(this.dataset.sceneId, this);
							});
						});

						return;
					}
				} else {
					// ÏãúÌÄÄÏä§ Í∏∞Î∞ò ÎÑ§ÎπÑÍ≤åÏù¥ÏÖò
					
					let html = '';
					currentData.breakdown_data.sequences.forEach(sequence => {
						// Í∞Å ÏãúÌÄÄÏä§Ïóê ÏÜçÌïú Ïî¨ Í∞úÏàò Í≥ÑÏÇ∞
						const sceneCount = currentData.breakdown_data.scenes.filter(
							scene => scene.sequence_id === sequence.id
						).length;
						
						html += `
							<div class="sequence-item">
								<div class="sequence-header" data-sequence-id="${sequence.id}">
									<span class="toggle-icon">‚ñ∂</span>
									<span>${sequence.id}: ${sequence.title}</span>
								</div>
								<div class="scenes-container collapsed" id="scenes-${sequence.id}"></div>
							</div>`;
					});
					
					navContent.innerHTML = html;
					setupSequenceEventListeners();
				}
           } catch (error) {
               showMessage('ÎÑ§ÎπÑÍ≤åÏù¥ÏÖò ÏóÖÎç∞Ïù¥Ìä∏ Ïò§Î•ò: ' + error.message, 'error');
           }
       }

       // ÏãúÌÄÄÏä§ Ïù¥Î≤§Ìä∏ Î¶¨Ïä§ÎÑà ÏÑ§Ï†ï
       function setupSequenceEventListeners() {
           try {
               document.querySelectorAll('.sequence-header[data-sequence-id]').forEach(header => {
                   const newHeader = header.cloneNode(true);
                   header.parentNode.replaceChild(newHeader, header);
                   newHeader.addEventListener('click', function(e) {
                       e.preventDefault();
                       selectSequence(this.getAttribute('data-sequence-id'), this);
                   });
               });
           } catch (error) {
           }
       }

       // ÏãúÌÄÄÏä§ ÏÑ†ÌÉù Î∞è ÌÜ†Í∏Ä
       function selectSequence(sequenceId, headerElement = null) {
           try {
               const newlySelected = selectedId !== sequenceId || selectedType !== 'sequence';
               selectedType = 'sequence';
               selectedId = sequenceId;
               
               document.querySelectorAll('.sequence-header.active, .scene-header.active, .shot-item.active').forEach(el => el.classList.remove('active'));
               
               const currentHeader = headerElement || document.querySelector(`.sequence-header[data-sequence-id="${sequenceId}"]`);
               if (currentHeader) currentHeader.classList.add('active');
               
               showSequenceContent(sequenceId);
               toggleSequenceScenes(sequenceId, newlySelected);
           } catch (error) {
               showMessage('ÏãúÌÄÄÏä§ ÏÑ†ÌÉù Ïò§Î•ò: ' + error.message, 'error');
           }
       }

       // ÏãúÌÄÄÏä§Ïùò Ïî¨Îì§ ÌÜ†Í∏Ä
       function toggleSequenceScenes(sequenceId, forceOpen = false) {
           try {
               const scenesContainer = document.getElementById(`scenes-${sequenceId}`);
               if (!scenesContainer) return;
               
               const toggleIcon = scenesContainer.previousElementSibling.querySelector('.toggle-icon');
               if (!toggleIcon) return;
               
               if (forceOpen || scenesContainer.classList.contains('collapsed')) {
                   scenesContainer.classList.remove('collapsed');
                   toggleIcon.classList.add('expanded');
                   toggleIcon.textContent = '‚ñº';
                   loadScenesForSequence(sequenceId, scenesContainer);
               } else {
                   scenesContainer.classList.add('collapsed');
                   toggleIcon.classList.remove('expanded');
                   toggleIcon.textContent = '‚ñ∂';
               }
           } catch (error) {
           }
       }

       // ÏãúÌÄÄÏä§Ïùò Ïî¨Îì§ Î°úÎìú
       function loadScenesForSequence(sequenceId, container) {
           try {
               if (!currentData || !currentData.breakdown_data) return;
               
               const scenes = currentData.breakdown_data.scenes.filter(scene => scene.sequence_id === sequenceId);
               if (scenes.length === 0) {
                   container.innerHTML = '<div style="padding: 15px 40px; color: #999; font-size: 0.9rem;">Ïî¨Ïù¥ ÏóÜÏäµÎãàÎã§</div>';
                   return;
               }
               
               let html = '';
               scenes.forEach(scene => {
                   const hasShots = scene.shot_ids && scene.shot_ids.length > 0;
                   const statusIndicator = hasShots ? 
                       '<span class="status-indicator" style="color: #4caf50; font-size: 0.8rem; margin-left: 5px;" data-tooltip="Stage 5 ÏôÑÎ£å (ÏÉ∑ ' + scene.shot_ids.length + 'Í∞ú)">‚óè</span>' : 
                       '<span class="status-indicator" style="color: #ff9800; font-size: 0.8rem; margin-left: 5px;" data-tooltip="Stage 5 ÎåÄÍ∏∞">‚óã</span>';
                   
                   html += `
                       <div class="scene-item">
                           <div class="scene-header" data-scene-id="${scene.id}">
                               <span class="toggle-icon">‚ñ∑</span>
                               <span>${scene.id}: ${scene.title}${statusIndicator}</span>
                           </div>
                           <div class="shots-container collapsed" id="shots-${scene.id}"></div>
                       </div>`;
               });
               
               container.innerHTML = html;
               
               container.querySelectorAll('.scene-header').forEach(header => {
                   const newHeader = header.cloneNode(true);
                   header.parentNode.replaceChild(newHeader, header);
                   newHeader.addEventListener('click', function(e) {
                       e.stopPropagation();
                       selectScene(this.dataset.sceneId, this);
                   });
               });
           } catch (error) {
           }
       }

       // Ïî¨ ÏÑ†ÌÉù
       function selectScene(sceneId, headerElement = null) {
           try {
               const newlySelected = selectedId !== sceneId || selectedType !== 'scene';
               selectedType = 'scene';
               selectedId = sceneId;
               selectedSceneId = sceneId;
               
               document.querySelectorAll('.scene-header.active, .shot-item.active').forEach(el => el.classList.remove('active'));
               
               const scene = currentData.breakdown_data.scenes.find(s => s.id === sceneId);
               if (scene) {
                   document.querySelector(`.sequence-header[data-sequence-id="${scene.sequence_id}"]`)?.classList.add('active');
               }
               
               const currentHeader = headerElement || document.querySelector(`.scene-header[data-scene-id="${sceneId}"]`);
               if (currentHeader) currentHeader.classList.add('active');
               
               showSceneContent(sceneId);
               toggleSceneShots(sceneId, newlySelected);
           } catch (error) {
               showMessage('Ïî¨ ÏÑ†ÌÉù Ïò§Î•ò: ' + error.message, 'error');
           }
       }

       // Ïî¨Ïùò ÏÉ∑Îì§ ÌÜ†Í∏Ä
       function toggleSceneShots(sceneId, forceOpen = false) {
           try {
               const shotsContainer = document.getElementById(`shots-${sceneId}`);
               if (!shotsContainer) return;
               
               const toggleIcon = shotsContainer.previousElementSibling.querySelector('.toggle-icon');
               if (!toggleIcon) return;
               
               if (forceOpen || shotsContainer.classList.contains('collapsed')) {
                   shotsContainer.classList.remove('collapsed');
                   toggleIcon.classList.add('expanded');
                   toggleIcon.textContent = '‚ñΩ';
                   loadShotsForScene(sceneId, shotsContainer);
               } else {
                   shotsContainer.classList.add('collapsed');
                   toggleIcon.classList.remove('expanded');
                   toggleIcon.textContent = '‚ñ∑';
               }
           } catch (error) {
           }
       }

       // Ïî¨Ïùò ÏÉ∑Îì§ Î°úÎìú
       function loadShotsForScene(sceneId, container) {
           try {
               if (!currentData || !currentData.breakdown_data) return;
               
               const shots = currentData.breakdown_data.shots.filter(shot => shot.scene_id === sceneId);
               if (shots.length === 0) {
                   container.innerHTML = '<div style="padding: 15px 60px; color: #999; font-size: 0.9rem;">ÏÉ∑Ïù¥ ÏóÜÏäµÎãàÎã§</div>';
                   return;
               }
               
               let html = '';
               shots.forEach(shot => {
                   html += `
                       <div class="shot-item" data-shot-id="${shot.id}">
                           <span>${shot.id}: ${shot.title}</span>
                       </div>`;
               });
               
               container.innerHTML = html;
               
               container.querySelectorAll('.shot-item').forEach(item => {
                   const newItem = item.cloneNode(true);
                   item.parentNode.replaceChild(newItem, item);
                   newItem.addEventListener('click', function(e) {
                       e.stopPropagation();
                       selectShot(this.dataset.shotId, this);
                   });
               });
           } catch (error) {
           }
       }

       // ÏÉ∑ ÏÑ†ÌÉù
       function selectShot(shotId, element = null) {
           try {
               selectedType = 'shot';
               selectedId = shotId;
               
               document.querySelectorAll('.shot-item.active').forEach(el => el.classList.remove('active'));
               
               const shot = currentData.breakdown_data.shots.find(s => s.id === shotId);
               if (shot) {
                   const scene = currentData.breakdown_data.scenes.find(sc => sc.id === shot.scene_id);
                   if (scene) {
                       document.querySelector(`.scene-header[data-scene-id="${scene.id}"]`)?.classList.add('active');
                       document.querySelector(`.sequence-header[data-sequence-id="${scene.sequence_id}"]`)?.classList.add('active');
                   }
               }
               
               const currentElement = element || document.querySelector(`.shot-item[data-shot-id="${shotId}"]`);
               if (currentElement) currentElement.classList.add('active');
               
               showShotContent(shotId);
           } catch (error) {
               showMessage('ÏÉ∑ ÏÑ†ÌÉù Ïò§Î•ò: ' + error.message, 'error');
           }
       }

       // ÏãúÌÄÄÏä§ ÎÇ¥Ïö© ÌëúÏãú
       function showSequenceContent(sequenceId) {
           try {
               const sequence = currentData.breakdown_data.sequences.find(s => s.id === sequenceId);
               if (!sequence) return;
               
               document.getElementById('content-title').textContent = `ÏãúÌÄÄÏä§: ${sequence.title}`;
               document.getElementById('content-subtitle').textContent = `ID: ${sequence.id}`;
               document.getElementById('content-actions').style.display = 'none';
               
               // ÏãúÌÄÄÏä§Ïóê ÏÜçÌïú Ïî¨Îì§ ÌôïÏù∏
				const sequenceScenes = currentData.breakdown_data.scenes.filter(
					scene => scene.sequence_id === sequenceId
				);

				// Ïî¨Îì§Ïùò ÏãúÎÇòÎ¶¨Ïò§ ÌÖçÏä§Ìä∏Í∞Ä ÏûàÎäîÏßÄ ÌôïÏù∏
				const hasScenarioInScenes = sequenceScenes.some(scene => 
					scene.original_scenario?.scenario_text && 
					scene.original_scenario.scenario_text.trim() !== ''
				);
               
               document.getElementById('content-area').innerHTML = `
                   <div class="info-section">
                       <h3>ÏãúÌÄÄÏä§ Ï†ïÎ≥¥</h3>
                       <table class="info-table">
                           <tr><th>ID</th><td>${sequence.id}</td></tr>
                           <tr><th>Ï†úÎ™©</th><td>${sequence.title}</td></tr>
                           <tr><th>Í∏∞Îä•</th><td>${sequence.function || '-'}</td></tr>
                           <tr><th>ÏÑ§Î™Ö</th><td>${sequence.description || '-'}</td></tr>
                           <tr><th>ÏòàÏÉÅ Í∏∏Ïù¥</th><td>${sequence.duration_estimate || '-'}</td></tr>
                       </table>
                   </div>
                   ${hasScenarioInScenes ? `
                   <div class="info-section">
                       <h3>ÏãúÌÄÄÏä§ ÏãúÎÇòÎ¶¨Ïò§</h3>
                       <div style="margin-bottom: 15px;">
                           <button class="btn btn-success" onclick="viewSequenceScenario('${sequenceId}')">
                               ÏãúÎÇòÎ¶¨Ïò§ Î≥¥Í∏∞
                           </button>
                           <button class="btn btn-warning" onclick="downloadSequenceScenario('${sequenceId}', 'txt')">
                               TXT Îã§Ïö¥Î°úÎìú
                           </button>
                          <!--<button class="btn btn-warning" onclick="downloadSequenceScenario('${sequenceId}', 'pdf')">
                               PDF Îã§Ïö¥Î°úÎìú
                           </button>-->
                       </div>
                       <!--<div class="scenario-preview" style="background: #f8f9fa; padding: 15px; border-radius: 8px; max-height: 200px; overflow-y: auto;">
                           <pre style="white-space: pre-wrap; font-family: 'Courier New', monospace; font-size: 0.9rem;">ÏãúÎÇòÎ¶¨Ïò§ ÎØ∏Î¶¨Î≥¥Í∏∞...</pre>
                       </div>-->
                   </div>` : ''}`;
           } catch (error) {
               showMessage('ÏãúÌÄÄÏä§ ÎÇ¥Ïö© ÌëúÏãú Ïò§Î•ò: ' + error.message, 'error');
           }
       }

       // Ïî¨ ÎÇ¥Ïö© ÌëúÏãú
       function showSceneContent(sceneId) {
           try {
               const scene = currentData.breakdown_data.scenes.find(s => s.id === sceneId);
               if (!scene) return;
               
               // Stage 5 ÏûëÏóÖ ÏôÑÎ£å Ïó¨Î∂Ä ÌôïÏù∏
               const hasShots = scene.shot_ids && scene.shot_ids.length > 0;
               const statusBadge = hasShots ? 
                   '<span style="background: #4caf50; color: white; padding: 4px 8px; border-radius: 4px; font-size: 0.85rem; margin-left: 10px;">Stage 5 ÏôÑÎ£å</span>' : 
                   '<span style="background: #ff9800; color: white; padding: 4px 8px; border-radius: 4px; font-size: 0.85rem; margin-left: 10px;">Stage 5 ÎåÄÍ∏∞</span>';
               
               document.getElementById('content-title').innerHTML = `Ïî¨: ${scene.title} ${statusBadge}`;
               document.getElementById('content-subtitle').textContent = `ID: ${scene.id}`;
               document.getElementById('content-actions').style.display = 'none';
               
               const scenarioText = scene.original_scenario?.scenario_text || '';
               const hasScenarioText = scenarioText.trim() !== '';
               
               document.getElementById('content-area').innerHTML = `
                   <div class="tabs">
						<div class="tab-buttons">
							<button class="tab-button active" onclick="switchSceneTab('info', '${scene.id}')">Ï†ïÎ≥¥</button>
							<button class="tab-button" onclick="switchSceneTab('images', '${scene.id}')">Ïù¥ÎØ∏ÏßÄ Í∞§Îü¨Î¶¨</button>
					        <button class="tab-button" onclick="switchSceneTab('videos', '${scene.id}')">ÏòÅÏÉÅ Í∞§Îü¨Î¶¨</button>
						</div>
						<div id="tab-info" class="tab-content active">
							<div class="info-section">
								<h3>Ïî¨ Ï†ïÎ≥¥</h3>
								<table class="info-table">
									<tr><th>ID</th><td>${scene.id}</td></tr>
									<tr><th>Ï†úÎ™©</th><td>${scene.title}</td></tr>
									<tr><th>ÏÜåÏÜç ÏãúÌÄÄÏä§</th><td>${scene.sequence_id || '-'}</td></tr>
									<tr><th>ÏÑ§Î™Ö</th><td>${scene.description || '-'}</td></tr>
									<tr><th>ÏÉ∑ Í∞úÏàò</th><td>${scene.shot_ids?.length || 0}Í∞ú ${!hasShots ? '(Stage 5 ÏóÖÎ°úÎìú ÌïÑÏöî)' : ''}</td></tr>
								</table>
							</div>
							${hasScenarioText ? `
							<div class="info-section">
								<h3>Ïî¨ ÏãúÎÇòÎ¶¨Ïò§</h3>
								<div class="scenario-preview" style="background: #000000; padding: 15px; border-radius: 8px; max-height: 300px; overflow-y: auto;">
									<pre style="white-space: pre-wrap; font-family: 'Courier New', monospace; font-size: 0.9rem;">${scenarioText}</pre>
								</div>
							</div>` : ''}
							${scene.visual_consistency_info ? `
							<div class="info-section">
								<h3>ÎπÑÏ£ºÏñº Ï†ïÎ≥¥</h3>
								<table class="info-table">
									<tr><th>Ïû•ÏÜå ID</th><td>${scene.visual_consistency_info.location_id || '-'}</td></tr>
									<tr><th>Ï∫êÎ¶≠ÌÑ∞ ID</th><td>${(scene.visual_consistency_info.character_ids || []).join(', ') || '-'}</td></tr>
									<tr><th>ÏÜåÌíà ID</th><td>${(scene.visual_consistency_info.prop_ids || []).join(', ') || '-'}</td></tr>
								</table>
							</div>` : ''}
						</div>
						<div id="tab-images" class="tab-content" style="display: none;">
							${createSceneImageGallery(scene.id)}
						</div>
					   <div id="tab-videos" class="tab-content" style="display: none;">
							${createSceneVideoGallery(scene.id)}
						</div>
					</div>`;
           } catch (error) {
               showMessage('Ïî¨ ÎÇ¥Ïö© ÌëúÏãú Ïò§Î•ò: ' + error.message, 'error');
           }
       }
	   // Ïî¨ ÌÉ≠ Ï†ÑÌôò Ìï®Ïàò
		function switchSceneTab(tabName, sceneId) {
			try {
				document.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active'));
				document.querySelectorAll('.tab-content').forEach(content => {
					content.style.display = 'none';
					content.classList.remove('active');
				});

				const activeButton = document.querySelector(`[onclick*="switchSceneTab('${tabName}'"]`);
				const activeContent = document.getElementById(`tab-${tabName}`);

				if (activeButton) activeButton.classList.add('active');
				if (activeContent) {
					activeContent.style.display = 'block';
					activeContent.classList.add('active');
				}
			} catch (error) {
			}
		}
			   
       // Ïî¨ Ïù¥ÎØ∏ÏßÄ Í∞§Îü¨Î¶¨ ÏÉùÏÑ± Ìï®Ïàò
		function createSceneImageGallery(sceneId) {
			const scene = currentData.breakdown_data.scenes.find(s => s.id === sceneId);
			const sceneShots = currentData.breakdown_data.shots.filter(shot => shot.scene_id === sceneId);

			if (sceneShots.length === 0) {
				return '<div class="empty-state"><div class="empty-state-icon">üñºÔ∏è</div><div>Ïù¥ Ïî¨Ïóê ÏÉ∑Ïù¥ ÏóÜÏäµÎãàÎã§</div></div>';
			}

			let html = '<div style="padding: 20px;">';

			// Í∞Å ÏÉ∑Î≥ÑÎ°ú Ï≤òÎ¶¨
			sceneShots.forEach(shot => {
				let shotHasImages = false;
				let shotHtml = `<h4 style="margin-top: 20px; color: #333;">${shot.id}: ${shot.title}</h4>`;
				shotHtml += '<div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 15px; margin-bottom: 30px;">';

				// AI ÏÉùÏÑ± Ïù¥ÎØ∏ÏßÄ
				const aiImages = shot.image_design?.ai_generated_images || {};
				Object.keys(aiImages).forEach(ai => {
					const images = aiImages[ai];
					if (images) {
						Object.entries(images).forEach(([imageId, imageData]) => {
							if (imageData.url) {
								shotHasImages = true;
								shotHtml += `
									<div style="border: 1px solid #ddd; border-radius: 8px; overflow: hidden;">
										<img src="${imageData.url}" 
											 style="width: 100%; height: 150px; object-fit: cover; cursor: pointer;"
											 onclick="window.open('${imageData.url}', '_blank')"
											 onerror="this.src=''; this.style.display='none'; this.parentElement.innerHTML='<div style=\\'padding:20px;text-align:center;color:#999;\\'>Î°úÎìú Ïã§Ìå®</div>'">
										<div style="padding: 10px; font-size: 0.85rem;">
											<strong>${ai}</strong><br>
											${imageId}
										</div>
									</div>`;
							}
						});
					}
				});

				// Ï∞∏Ï°∞ Ïù¥ÎØ∏ÏßÄ
				if (shot.reference_images) {
					shot.reference_images.forEach((ref, idx) => {
						if (ref.url) {
							shotHasImages = true;
							shotHtml += `
								<div style="border: 1px solid #ddd; border-radius: 8px; overflow: hidden;">
									<img src="${ref.url}" 
										 style="width: 100%; height: 150px; object-fit: cover; cursor: pointer;"
										 onclick="window.open('${ref.url}', '_blank')"
										 onerror="this.src=''; this.style.display='none'; this.parentElement.innerHTML='<div style=\\'padding:20px;text-align:center;color:#999;\\'>Î°úÎìú Ïã§Ìå®</div>'">
									<div style="padding: 10px; font-size: 0.85rem;">
										<strong>${shot.id}</strong><br>
										Ï∞∏Ï°∞ ${idx + 1}: ${ref.type || 'reference'}
									</div>
								</div>`;
						}
					});
				}

				shotHtml += '</div>';

				if (shotHasImages) {
					html += shotHtml;
				}
			});

			html += '</div>';
			return html;
}

		// Ïî¨ ÏòÅÏÉÅ Í∞§Îü¨Î¶¨ ÏÉùÏÑ± Ìï®Ïàò
		function createSceneVideoGallery(sceneId) {
			const scene = currentData.breakdown_data.scenes.find(s => s.id === sceneId);
			const sceneShots = currentData.breakdown_data.shots.filter(shot => shot.scene_id === sceneId);

			if (sceneShots.length === 0) {
				return '<div class="empty-state"><div class="empty-state-icon">üé¨</div><div>Ïù¥ Ïî¨Ïóê ÏÉ∑Ïù¥ ÏóÜÏäµÎãàÎã§</div></div>';
			}

			let html = '<div style="padding: 20px;">';

			// Í∞Å ÏÉ∑Î≥ÑÎ°ú Ï≤òÎ¶¨
			sceneShots.forEach(shot => {
				let shotHasVideos = false;
				let shotHtml = `<h4 style="margin-top: 20px; color: #333;">${shot.id}: ${shot.title}</h4>`;
				shotHtml += '<div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 20px; margin-bottom: 30px;">';

				// ÏòÅÏÉÅ URLs ÌôïÏù∏
				const videoUrls = shot.video_urls || {};

				// AIÎ≥Ñ ÏòÅÏÉÅ
				['luma', 'kling', 'veo2', 'runway'].forEach(ai => {
					// Í∏∞Î≥∏ URL ÌôïÏù∏
					if (videoUrls[ai]) {
						shotHasVideos = true;
						const processedUrl = processVideoUrl(videoUrls[ai]);
						if (processedUrl.includes('drive.google.com')) {
							shotHtml += `
								<div style="border: 1px solid #ddd; border-radius: 8px; overflow: hidden; background: #f8f9fa;">
									<div style="padding: 10px; background: #e9ecef;">
										<strong>${ai.toUpperCase()}</strong>
									</div>
									<div style="height: 200px; display: flex; align-items: center; justify-content: center; background: #000;">
										<iframe style="width: 100%; height: 100%; border: none;" src="${processedUrl}" allowfullscreen></iframe>
									</div>
								</div>`;
						} else {
							shotHtml += `
								<div style="border: 1px solid #ddd; border-radius: 8px; overflow: hidden; background: #f8f9fa;">
									<div style="padding: 10px; background: #e9ecef;">
										<strong>${ai.toUpperCase()}</strong>
									</div>
									<div style="height: 200px; display: flex; align-items: center; justify-content: center; background: #000;">
										<video controls style="max-width: 100%; max-height: 100%;" src="${processedUrl}">
											<source src="${processedUrl}" type="video/mp4">
											Î∏åÎùºÏö∞Ï†ÄÍ∞Ä ÎπÑÎîîÏò§Î•º ÏßÄÏõêÌïòÏßÄ ÏïäÏäµÎãàÎã§.
										</video>
									</div>
								</div>`;
						}
					}

					// Ïù¥ÎØ∏ÏßÄÎ≥Ñ ÏòÅÏÉÅ ÌôïÏù∏ (ÏÉàÎ°úÏö¥ Íµ¨Ï°∞)
					Object.keys(videoUrls).forEach(key => {
						if (key.startsWith(`${ai}_`)) {
							const imageId = key.replace(`${ai}_`, '');
							shotHasVideos = true;
							const processedUrl = processVideoUrl(videoUrls[key]);
							if (processedUrl.includes('drive.google.com')) {
								shotHtml += `
									<div style="border: 1px solid #ddd; border-radius: 8px; overflow: hidden; background: #f8f9fa;">
										<div style="padding: 10px; background: #e9ecef;">
											<strong>${ai.toUpperCase()}</strong><br>
											<small>${imageId}</small>
										</div>
										<div style="height: 200px; display: flex; align-items: center; justify-content: center; background: #000;">
											<iframe style="width: 100%; height: 100%; border: none;" src="${processedUrl}" allowfullscreen></iframe>
										</div>
									</div>`;
							} else {
								shotHtml += `
									<div style="border: 1px solid #ddd; border-radius: 8px; overflow: hidden; background: #f8f9fa;">
										<div style="padding: 10px; background: #e9ecef;">
											<strong>${ai.toUpperCase()}</strong><br>
											<small>${imageId}</small>
										</div>
										<div style="height: 200px; display: flex; align-items: center; justify-content: center; background: #000;">
											<video controls style="max-width: 100%; max-height: 100%;" src="${processedUrl}">
												<source src="${processedUrl}" type="video/mp4">
												Î∏åÎùºÏö∞Ï†ÄÍ∞Ä ÎπÑÎîîÏò§Î•º ÏßÄÏõêÌïòÏßÄ ÏïäÏäµÎãàÎã§.
											</video>
										</div>
									</div>`;
							}
						}
					});
				});

				shotHtml += '</div>';

				if (shotHasVideos) {
					html += shotHtml;
				}
			});

			html += '</div>';
			return html;
		}

		// ÏïàÏ†ÑÌïú iframe ÏÉùÏÑ± Ìï®Ïàò
		function createSafeIframe(url, styles = '') {
			try {
				if (!url) return '<div style="color:#999;font-size:0.9rem;">URLÏù¥ ÏóÜÏäµÎãàÎã§.</div>';
				
				// URL Ï≤òÎ¶¨ (Google Drive, ÎìúÎ°≠Î∞ïÏä§ Îì±)
				const processedUrl = processVideoUrl(url);
				
				// ÎìúÎ°≠Î∞ïÏä§ URLÏù∏ Í≤ΩÏö∞ video ÌÉúÍ∑∏ ÏÇ¨Ïö©
				if (processedUrl.includes('dropbox.com')) {
					return `<video controls style="${styles}" src="${processedUrl}" onerror="this.style.display='none';this.parentElement.innerHTML='<div style=\\'color:#ff6b6b;font-size:0.9rem;\\'>ÏòÅÏÉÅ Î°úÎìú Ïã§Ìå®</div>';"></video>`;
				}
				
				// Google DriveÍ∞Ä ÏïÑÎãå ÏùºÎ∞ò URLÏù∏ Í≤ΩÏö∞ video ÌÉúÍ∑∏ ÏÇ¨Ïö©
				if (!processedUrl.includes('drive.google.com') && !processedUrl.includes('googleusercontent.com')) {
					return `<video controls style="${styles}" src="${processedUrl}" onerror="this.style.display='none';this.parentElement.innerHTML='<div style=\\'color:#ff6b6b;font-size:0.9rem;\\'>ÏòÅÏÉÅ Î°úÎìú Ïã§Ìå®</div>';"></video>`;
				}
				
				// ÏïàÏ†ÑÌïú iframe ÏÉùÏÑ±
				const iframe = document.createElement('iframe');
				iframe.src = processedUrl;
				iframe.style.cssText = styles || 'max-width:100%;max-height:250px;border-radius:4px;border:none;';
				iframe.allowFullscreen = true;
				iframe.setAttribute('loading', 'lazy');
				iframe.onerror = function() {
					this.style.display = 'none';
					this.parentElement.innerHTML = '<div style="color:#ff6b6b;font-size:0.9rem;">Google Drive ÏòÅÏÉÅ Î°úÎìú Ïã§Ìå®<br><small>ÌååÏùºÏù¥ Í≥µÍ∞úÎ°ú ÏÑ§Ï†ïÎêòÏñ¥ ÏûàÎäîÏßÄ ÌôïÏù∏ÌïòÏÑ∏Ïöî.</small></div>';
				};
				
				return iframe.outerHTML;
			} catch (e) {
				return '<div style="color:#ff6b6b;font-size:0.9rem;">iframe ÏÉùÏÑ± Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§.</div>';
			}
		}

		// Ïî¨ ÏòÅÏÉÅ Í∞§Îü¨Î¶¨ Ïû¨Î†åÎçîÎßÅ (ÌòÑÏû¨ ÌôúÏÑ±ÌôîÎêú Í≤ΩÏö∞)
		// Ïã§Ìñâ Í∞ÄÎìúÎ•º ÏúÑÌïú Ï†ÑÏó≠ Î≥ÄÏàò
		window.refreshSceneVideoGalleryRunning = false;
		
		function refreshSceneVideoGalleryIfActive(sceneId) {
			// Ïù¥ÎØ∏ Ïã§Ìñâ Ï§ëÏù¥Î©¥ Ï§ëÎ≥µ Ïã§Ìñâ Î∞©ÏßÄ
			if (window.refreshSceneVideoGalleryRunning) {
				return;
			}
			
			try {
				// Ïã§Ìñâ ÌîåÎûòÍ∑∏ ÏÑ§Ï†ï
				window.refreshSceneVideoGalleryRunning = true;
				
				// sceneId Ïú†Ìö®ÏÑ± Í≤ÄÏÇ¨
				if (!sceneId) {
					return;
				}

				// currentData ÌôïÏù∏
				if (!window.currentData || !window.currentData.breakdown_data) {
					return;
				}

				// ÏïàÏ†ÑÌïú Î∞©ÏãùÏúºÎ°ú ÏòÅÏÉÅ Í∞§Îü¨Î¶¨ ÌÉ≠ Ï∞æÍ∏∞
				const videoTab = document.getElementById('tab-videos');
				if (!videoTab) {
					// ÏòÅÏÉÅ Í∞§Îü¨Î¶¨ ÌÉ≠Ïù¥ Ï°¥Ïû¨ÌïòÏßÄ ÏïäÏúºÎ©¥ Ï¢ÖÎ£å
					return;
				}

				// ÌÉ≠Ïù¥ ÌòÑÏû¨ ÌôúÏÑ±ÌôîÎêòÏñ¥ ÏûàÎäîÏßÄ ÌôïÏù∏ (display: block ÎòêÎäî display ÏÜçÏÑ±Ïù¥ ÏóÜÏùå)
				const computedStyle = window.getComputedStyle(videoTab);
				const isVisible = computedStyle.display !== 'none';
				
				if (!isVisible) {
					// ÏòÅÏÉÅ Í∞§Îü¨Î¶¨ ÌÉ≠Ïù¥ ÎπÑÌôúÏÑ±ÌôîÎêòÏñ¥ ÏûàÏúºÎ©¥ Ï¢ÖÎ£å
					return;
				}

				// ÏòÅÏÉÅ Í∞§Îü¨Î¶¨ Ïû¨Î†åÎçîÎßÅ
				const newContent = createSceneVideoGallery(sceneId);
				if (newContent && typeof newContent === 'string') {
					videoTab.innerHTML = newContent;
				}
			} catch (e) {
			} finally {
				// Ïã§Ìñâ ÌîåÎûòÍ∑∏ Ìï¥Ï†ú
				window.refreshSceneVideoGalleryRunning = false;
			}
		}

      // ÏãúÌÄÄÏä§ ÏãúÎÇòÎ¶¨Ïò§ Î≥¥Í∏∞
		function viewSequenceScenario(sequenceId) {
			try {
				const sequence = currentData.breakdown_data.sequences.find(s => s.id === sequenceId);
				if (!sequence) {
					showMessage('ÏãúÌÄÄÏä§Î•º Ï∞æÏùÑ Ïàò ÏóÜÏäµÎãàÎã§.', 'error');
					return;
				}

				// Ìï¥Îãπ ÏãúÌÄÄÏä§Ïùò Ïî¨Îì§ÏùÑ Ï∞æÏïÑÏÑú Ï°∞Ìï©
				const seqScenes = currentData.breakdown_data.scenes.filter(
					scene => scene.sequence_id === sequenceId
				);

				let sequenceText = '';
				seqScenes.forEach(scene => {
					if (scene.original_scenario?.scenario_text) {
						sequenceText += scene.original_scenario.scenario_text + '\n\n';
					}
				});

				if (!sequenceText.trim()) {
					showMessage('ÏãúÎÇòÎ¶¨Ïò§ ÌÖçÏä§Ìä∏Î•º Ï∞æÏùÑ Ïàò ÏóÜÏäµÎãàÎã§.', 'error');
					return;
				}

				const newWindow = window.open('', '_blank', 'width=800,height=600');
				newWindow.document.write(`
					<!DOCTYPE html>
					<html>
					<head>
						<title>${sequence.title} - ÏãúÎÇòÎ¶¨Ïò§</title>
						<style>
							body { font-family: 'Courier New', monospace; padding: 20px; line-height: 1.6; }
							h1 { font-size: 1.5rem; margin-bottom: 20px; }
							pre { white-space: pre-wrap; font-size: 1rem; }
						</style>
					</head>
					<body>
						<h1>${sequence.title}</h1>
						<pre>${sequenceText}</pre>
					</body>
					</html>
				`);
				newWindow.document.close();
			} catch (error) {
				showMessage('ÏãúÎÇòÎ¶¨Ïò§Î•º ÌëúÏãúÌï† Ïàò ÏóÜÏäµÎãàÎã§.', 'error');
			}
		}

       // ÏãúÌÄÄÏä§ ÏãúÎÇòÎ¶¨Ïò§ Îã§Ïö¥Î°úÎìú
       function downloadSequenceScenario(sequenceId, format) {
           try {
               const sequence = currentData.breakdown_data.sequences.find(s => s.id === sequenceId);
               // Ìï¥Îãπ ÏãúÌÄÄÏä§Ïùò Ïî¨Îì§ÏóêÏÑú ÏãúÎÇòÎ¶¨Ïò§ ÌÖçÏä§Ìä∏ Ï°∞Ìï©
				const seqScenes = currentData.breakdown_data.scenes.filter(
					scene => scene.sequence_id === sequenceId
				);

				let sequenceText = '';
				seqScenes.forEach(scene => {
					if (scene.original_scenario?.scenario_text) {
						sequenceText += scene.original_scenario.scenario_text + '\n\n';
					}
				});

				if (!sequenceText.trim()) {
					showMessage('ÏãúÎÇòÎ¶¨Ïò§ ÌÖçÏä§Ìä∏Î•º Ï∞æÏùÑ Ïàò ÏóÜÏäµÎãàÎã§.', 'error');
					return;
				}
               if (!sequence) {
                   showMessage('ÏãúÎÇòÎ¶¨Ïò§ ÌÖçÏä§Ìä∏Î•º Ï∞æÏùÑ Ïàò ÏóÜÏäµÎãàÎã§.', 'error');
                   return;
               }
               
               const fileName = `${sequence.id}_${sequence.title.replace(/[^a-zA-Z0-9Í∞Ä-Ìû£]/g, '_')}`;
               
               if (format === 'txt') {
                   const blob = new Blob([sequenceText], { type: 'text/plain;charset=utf-8' });
                   const url = URL.createObjectURL(blob);
                   const a = document.createElement('a');
                   a.href = url;
                   a.download = `${fileName}.txt`;
                   document.body.appendChild(a);
                   a.click();
                   document.body.removeChild(a);
                   URL.revokeObjectURL(url);
                   showMessage('ÌÖçÏä§Ìä∏ ÌååÏùºÎ°ú Îã§Ïö¥Î°úÎìúÎêòÏóàÏäµÎãàÎã§.', 'success');
               } else if (format === 'pdf') {
                   // Í∞ÑÎã®Ìïú PDF ÏÉùÏÑ± (Ïã§Ï†úÎ°úÎäî jsPDF ÎùºÏù¥Î∏åÎü¨Î¶¨ ÏÇ¨Ïö© Í∂åÏû•)
                   showMessage('PDF Îã§Ïö¥Î°úÎìú Í∏∞Îä•ÏùÄ Ï§ÄÎπÑ Ï§ëÏûÖÎãàÎã§. TXT ÌååÏùºÏùÑ ÏÇ¨Ïö©Ìï¥Ï£ºÏÑ∏Ïöî.', 'info');
               }
           } catch (error) {
               showMessage('Îã§Ïö¥Î°úÎìú Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§.', 'error');
           }
       }
       // ÏÉ∑ ÎÇ¥Ïö© ÌëúÏãú (Î™®ÎìàÌôîÎêú ÌÉ≠ ÏãúÏä§ÌÖú ÏÇ¨Ïö©)
       function showShotContent(shotId) {
           try {
               const shot = currentData.breakdown_data.shots.find(s => s.id === shotId);
               if (!shot) return;
               
               document.getElementById('content-title').textContent = `ÏÉ∑: ${shot.title}`;
               document.getElementById('content-subtitle').textContent = `ID: ${shot.id}`;
               document.getElementById('content-actions').style.display = 'none';
               
               // Îç∞Ïù¥ÌÑ∞ Ïñ¥ÎåëÌÑ∞Ïóê ÌòÑÏû¨ Îç∞Ïù¥ÌÑ∞ ÏÑ§Ï†ï
               if (window.dataAdapter) {
                   window.dataAdapter.setCurrentData(currentData);
                   // dataManagerÏóêÎèÑ adapter ÏÑ§Ï†ï
                   if (window.dataManager) {
                       window.dataManager.setAdapter(window.dataAdapter);
                   }
               }
               
               // Î™®ÎìàÌôîÎêú Î≤ÑÏ†Ñ Ìò∏Ï∂ú - Ï†ïÎ≥¥ ÌÉ≠ Î¨∏Ï†úÎ°ú Ïù∏Ìï¥ ÏûÑÏãú ÎπÑÌôúÏÑ±Ìôî
               // if (window.showShotContentModular) {
               //     window.showShotContentModular(shotId);
               // } else {
               //     // Ìè¥Î∞±: Í∏∞Ï°¥ Î∞©Ïãù ÏÇ¨Ïö©
               //     console.warn('Modular system not loaded, using fallback');
               //     showShotContentFallback(shotId);
               // }
               
               // Ìï≠ÏÉÅ Ìè¥Î∞± ÏãúÏä§ÌÖú ÏÇ¨Ïö©
               showShotContentFallback(shotId);
           } catch (error) {
               showMessage('ÏÉ∑ ÎÇ¥Ïö© ÌëúÏãú Ïò§Î•ò: ' + error.message, 'error');
           }
       }
       
       // Ìè¥Î∞± Ìï®Ïàò (Î™®Îìà Î°úÎìú Ïã§Ìå® Ïãú)
       function showShotContentFallback(shotId) {
           const shot = currentData.breakdown_data.shots.find(s => s.id === shotId);
           if (!shot) return;
           
           const lastActiveTab = localStorage.getItem(`shot_${shotId}_activeTab`) || 'info';
           
           // Í∞Å ÌÉ≠ Ïª®ÌÖêÏ∏†Î•º Í∞úÎ≥ÑÏ†ÅÏúºÎ°ú ÏÉùÏÑ±ÌïòÏó¨ Í≤©Î¶¨ Î≥¥Ïû•
           const infoContent = createShotInfoTab(shot);
           const imageContent = createShotImageTab(shot);
           const videoContent = createShotVideoTab(shot);
           const audioContent = createShotAudioTab(shot);
           const musicContent = createShotMusicTab(shot);
           
           // Í∞Å ÌÉ≠ Ïª®ÌÖêÏ∏†Î•º ÏïàÏ†ÑÌïòÍ≤å ÎûòÌïë
           const wrappedInfoContent = `<div class="tab-inner-wrapper">${infoContent}</div>`;
           const wrappedImageContent = `<div class="tab-inner-wrapper">${imageContent}</div>`;
           const wrappedVideoContent = `<div class="tab-inner-wrapper">${videoContent}</div>`;
           const wrappedAudioContent = `<div class="tab-inner-wrapper">${audioContent}</div>`;
           const wrappedMusicContent = `<div class="tab-inner-wrapper">${musicContent}</div>`;
           
           document.getElementById('content-area').innerHTML = `
               <div class="tabs">
                   <div class="tab-buttons">
                       <button class="tab-button ${lastActiveTab === 'info' ? 'active' : ''}" onclick="switchTab('info', '${shotId}')">Ï†ïÎ≥¥</button>
                       <button class="tab-button ${lastActiveTab === 'image' ? 'active' : ''}" onclick="switchTab('image', '${shotId}')">Ïù¥ÎØ∏ÏßÄ</button>
                       <button class="tab-button ${lastActiveTab === 'video' ? 'active' : ''}" onclick="switchTab('video', '${shotId}')">ÏòÅÏÉÅ</button>
                       <button class="tab-button ${lastActiveTab === 'audio' ? 'active' : ''}" onclick="switchTab('audio', '${shotId}')">Ïò§ÎîîÏò§</button>
                       <button class="tab-button ${lastActiveTab === 'music' ? 'active' : ''}" onclick="switchTab('music', '${shotId}')">ÏùåÏïÖ</button>
                   </div>
                   <div id="tab-info" class="tab-content ${lastActiveTab === 'info' ? 'active' : ''}" style="display: ${lastActiveTab === 'info' ? 'block' : 'none'}; visibility: ${lastActiveTab === 'info' ? 'visible' : 'hidden'};">${wrappedInfoContent}</div>
                   <div id="tab-image" class="tab-content ${lastActiveTab === 'image' ? 'active' : ''}" style="display: ${lastActiveTab === 'image' ? 'block' : 'none'}; visibility: ${lastActiveTab === 'image' ? 'visible' : 'hidden'};">${wrappedImageContent}</div>
                   <div id="tab-video" class="tab-content ${lastActiveTab === 'video' ? 'active' : ''}" style="display: ${lastActiveTab === 'video' ? 'block' : 'none'}; visibility: ${lastActiveTab === 'video' ? 'visible' : 'hidden'};">${wrappedVideoContent}</div>
                   <div id="tab-audio" class="tab-content ${lastActiveTab === 'audio' ? 'active' : ''}" style="display: ${lastActiveTab === 'audio' ? 'block' : 'none'}; visibility: ${lastActiveTab === 'audio' ? 'visible' : 'hidden'};">${wrappedAudioContent}</div>
                   <div id="tab-music" class="tab-content ${lastActiveTab === 'music' ? 'active' : ''}" style="display: ${lastActiveTab === 'music' ? 'block' : 'none'}; visibility: ${lastActiveTab === 'music' ? 'visible' : 'hidden'};">${wrappedMusicContent}</div>
               </div>`;
           
           // Ï¥àÍ∏∞ Î°úÎìú Ïãú ÎîîÎ≤ÑÍπÖ
           console.log('üîç ÏÉ∑ Ïª®ÌÖêÏ∏† Î°úÎìú ÏôÑÎ£å. ÎîîÎ≤ÑÍπÖÏùÑ ÏúÑÌï¥ debugTabContent() Ïã§Ìñâ...');
           setTimeout(() => {
               if (window.debugTabContent) window.debugTabContent();
               // Ïò§ÎîîÏò§ ÏÑπÏÖò Í∞ïÏ†ú Ïà®ÍπÄ
               document.querySelectorAll('.tab-content:not(#tab-audio) .audio-section').forEach(section => {
                   section.style.display = 'none';
                   section.style.visibility = 'hidden';
                   console.warn('‚ö†Ô∏è Ïò§ÎîîÏò§ ÏÑπÏÖòÏù¥ ÏûòÎ™ªÎêú ÏúÑÏπòÏóêÏÑú Î∞úÍ≤¨ÎêòÏñ¥ Ïà®ÍπÄ Ï≤òÎ¶¨:', section.parentElement.id);
               });
               // ÏùåÏïÖ ÏÑπÏÖò Í∞ïÏ†ú Ïà®ÍπÄ
               document.querySelectorAll('.tab-content:not(#tab-music) .music-ost-section').forEach(section => {
                   section.style.display = 'none';
                   section.style.visibility = 'hidden';
                   console.warn('‚ö†Ô∏è ÏùåÏïÖ ÏÑπÏÖòÏù¥ ÏûòÎ™ªÎêú ÏúÑÏπòÏóêÏÑú Î∞úÍ≤¨ÎêòÏñ¥ Ïà®ÍπÄ Ï≤òÎ¶¨:', section.parentElement.id);
               });
           }, 100);
       }

       // ÌÉ≠ Ï†ÑÌôò
       function switchTab(tabName, shotId = null) {
           try {
               const tabContainer = document.querySelector('.tabs');
               if (!tabContainer) return;
               
               // ÎîîÎ≤ÑÍπÖÏö© Î°úÍ∑∏
               console.log(`üîÑ ÌÉ≠ Ï†ÑÌôò ÏãúÏûë: ${tabName}`);
               
               // Î™®Îì† ÌÉ≠ Î≤ÑÌäº ÎπÑÌôúÏÑ±Ìôî
               tabContainer.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active'));
               
               // Î™®Îì† ÌÉ≠ Ïª®ÌÖêÏ∏† Ïà®Í∏∞Í∏∞ - Îçî ÌôïÏã§ÌïòÍ≤å
               tabContainer.querySelectorAll('.tab-content').forEach(content => {
                   content.style.display = 'none';
                   content.classList.remove('active');
                   // Ï∂îÍ∞Ä Î≥¥Ïïà - visibilityÎèÑ hiddenÏúºÎ°ú
                   content.style.visibility = 'hidden';
                   
                   // Ïò§ÎîîÏò§ ÏÑπÏÖòÏù¥ ÏûàÎäî Í≤ΩÏö∞ ÌäπÎ≥Ñ Ï≤òÎ¶¨
                   content.querySelectorAll('.audio-section').forEach(audioSection => {
                       audioSection.style.display = 'none';
                       audioSection.style.visibility = 'hidden';
                   });
                   
                   // ÏùåÏïÖ ÏÑπÏÖòÏù¥ ÏûàÎäî Í≤ΩÏö∞ ÌäπÎ≥Ñ Ï≤òÎ¶¨
                   content.querySelectorAll('.music-ost-section').forEach(musicSection => {
                       musicSection.style.display = 'none';
                       musicSection.style.visibility = 'hidden';
                   });
                   
                   // ÎÇòÎ†àÏù¥ÏÖò Í¥ÄÎ†® ÏöîÏÜå Î™ÖÏãúÏ†Å Ïà®ÍπÄ
                   content.querySelectorAll('[class*="narration"], [class*="sound-effect"]').forEach(elem => {
                       elem.style.display = 'none';
                       elem.style.visibility = 'hidden';
                   });
               });
               
               // ÏÑ†ÌÉùÎêú ÌÉ≠ ÌôúÏÑ±Ìôî
               const activeButton = tabContainer.querySelector(`[onclick*="switchTab('${tabName}'"]`);
               const activeContent = document.getElementById(`tab-${tabName}`);
               
               if (activeButton) activeButton.classList.add('active');
               if (activeContent) {
                   // ÌôúÏÑ± ÌÉ≠ ÌëúÏãú Ï†ÑÏóê Ìïú Î≤à Îçî ÌôïÏù∏
                   activeContent.style.display = 'none';
                   activeContent.style.visibility = 'hidden';
                   
                   // Ïû†Ïãú ÌõÑ ÌëúÏãú (DOM ÏóÖÎç∞Ïù¥Ìä∏ Î≥¥Ïû•)
                   setTimeout(() => {
                       activeContent.style.display = 'block';
                       activeContent.style.visibility = 'visible';
                       activeContent.classList.add('active');
                       
                       // Ïò§ÎîîÏò§ ÌÉ≠Ïù∏ Í≤ΩÏö∞ÏóêÎßå Ïò§ÎîîÏò§ ÏÑπÏÖò ÌëúÏãú
                       if (tabName === 'audio') {
                           activeContent.querySelectorAll('.audio-section').forEach(audioSection => {
                               audioSection.style.display = 'block';
                               audioSection.style.visibility = 'visible';
                           });
                       }
                       
                       // ÏùåÏïÖ ÌÉ≠Ïù∏ Í≤ΩÏö∞ÏóêÎßå ÏùåÏïÖ ÏÑπÏÖò ÌëúÏãú
                       if (tabName === 'music') {
                           activeContent.querySelectorAll('.music-ost-section').forEach(musicSection => {
                               musicSection.style.display = 'block';
                               musicSection.style.visibility = 'visible';
                           });
                       }
                       
                       // ÎîîÎ≤ÑÍπÖ: ÌôúÏÑ± ÌÉ≠Ïùò Ïò§ÎîîÏò§ ÏÑπÏÖò ÌôïÏù∏
                       const audioSections = activeContent.querySelectorAll('.audio-section');
                       console.log(`‚úÖ ${tabName} ÌÉ≠ ÌôúÏÑ±Ìôî ÏôÑÎ£å. Ïò§ÎîîÏò§ ÏÑπÏÖò Ïàò: ${audioSections.length}`);
                   }, 10);
               }
               
               if (shotId) {
                   localStorage.setItem(`shot_${shotId}_activeTab`, tabName);
               }
           } catch (error) {
               console.error('ÌÉ≠ Ï†ÑÌôò Ïò§Î•ò:', error);
               showMessage('ÌÉ≠ Ï†ÑÌôò Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§.', 'error');
           }
       }
       
       // ÌÉ≠ Ïª®ÌÖêÏ∏† ÎîîÎ≤ÑÍπÖ Ìï®Ïàò
       window.debugTabContent = function() {
           console.log('===== ÌÉ≠ Ïª®ÌÖêÏ∏† ÎîîÎ≤ÑÍπÖ ÏãúÏûë =====');
           const tabs = document.querySelectorAll('.tab-content');
           
           tabs.forEach(tab => {
               const audioSections = tab.querySelectorAll('.audio-section');
               const musicSections = tab.querySelectorAll('.music-ost-section');
               const narrationElements = tab.querySelectorAll('[class*="narration"]');
               const soundEffectElements = tab.querySelectorAll('[class*="sound-effect"]');
               const allTextContaining = Array.from(tab.querySelectorAll('*')).filter(el => 
                   el.textContent.includes('ÎÇòÎ†àÏù¥ÏÖò Ïò§ÎîîÏò§') || 
                   el.textContent.includes('ÏùåÌñ• Ìö®Í≥º') ||
                   el.textContent.includes('üìñ ÎÇòÎ†àÏù¥ÏÖò') ||
                   el.textContent.includes('üîä ÏùåÌñ•') ||
                   el.textContent.includes('Î©îÏù∏ OST') ||
                   el.textContent.includes('ÏÑúÎ∏å OST') ||
                   el.textContent.includes('üéº') ||
                   el.textContent.includes('üéµ') ||
                   el.textContent.includes('üé∂')
               );
               
               console.log(`
üìã ÌÉ≠: ${tab.id}
- display: ${window.getComputedStyle(tab).display}
- visibility: ${window.getComputedStyle(tab).visibility}
- active ÌÅ¥ÎûòÏä§: ${tab.classList.contains('active')}
- Ïò§ÎîîÏò§ ÏÑπÏÖò Ïàò: ${audioSections.length}
- ÏùåÏïÖ ÏÑπÏÖò Ïàò: ${musicSections.length}
- ÎÇòÎ†àÏù¥ÏÖò ÏöîÏÜå Ïàò: ${narrationElements.length}
- ÏùåÌñ•Ìö®Í≥º ÏöîÏÜå Ïàò: ${soundEffectElements.length}
- ÏùåÏïÖ/Ïò§ÎîîÏò§ ÌÖçÏä§Ìä∏ Ìè¨Ìï® ÏöîÏÜå: ${allTextContaining.length}
               `);
               
               // Ïò§ÎîîÏò§ ÏÑπÏÖòÏù¥ ÏûòÎ™ªÎêú ÌÉ≠Ïóê ÏûàÎäîÏßÄ ÌôïÏù∏
               if (tab.id !== 'tab-audio' && audioSections.length > 0) {
                   console.error(`‚ùå Ïò§Î•ò: ${tab.id}Ïóê Ïò§ÎîîÏò§ ÏÑπÏÖòÏù¥ Î∞úÍ≤¨Îê®!`);
                   audioSections.forEach((section, i) => {
                       console.log(`  - Ïò§ÎîîÏò§ ÏÑπÏÖò ${i+1}:`, section);
                       console.log(`    HTML:`, section.outerHTML.substring(0, 200) + '...');
                   });
               }
               
               // ÏùåÏïÖ ÏÑπÏÖòÏù¥ ÏûòÎ™ªÎêú ÌÉ≠Ïóê ÏûàÎäîÏßÄ ÌôïÏù∏
               if (tab.id !== 'tab-music' && musicSections.length > 0) {
                   console.error(`‚ùå Ïò§Î•ò: ${tab.id}Ïóê ÏùåÏïÖ ÏÑπÏÖòÏù¥ Î∞úÍ≤¨Îê®!`);
                   musicSections.forEach((section, i) => {
                       console.log(`  - ÏùåÏïÖ ÏÑπÏÖò ${i+1}:`, section);
                       console.log(`    HTML:`, section.outerHTML.substring(0, 200) + '...');
                   });
               }
               
               // ÎÇòÎ†àÏù¥ÏÖò/ÏùåÌñ•/ÏùåÏïÖ ÌÖçÏä§Ìä∏Í∞Ä ÏûòÎ™ªÎêú ÌÉ≠Ïóê ÏûàÎäîÏßÄ ÌôïÏù∏
               if (tab.id !== 'tab-audio' && tab.id !== 'tab-info' && tab.id !== 'tab-music' && allTextContaining.length > 0) {
                   console.error(`‚ùå Ïò§Î•ò: ${tab.id}Ïóê Ïò§ÎîîÏò§/ÏùåÏïÖ Í¥ÄÎ†® ÌÖçÏä§Ìä∏ Î∞úÍ≤¨!`);
                   allTextContaining.slice(0, 3).forEach((el, i) => {
                       console.log(`  - ÏöîÏÜå ${i+1}:`, el.tagName, el.className);
                       console.log(`    ÌÖçÏä§Ìä∏:`, el.textContent.substring(0, 100) + '...');
                   });
               }
           });
           
           console.log('===== ÌÉ≠ Ïª®ÌÖêÏ∏† ÎîîÎ≤ÑÍπÖ Ï¢ÖÎ£å =====');
           return 'ÎîîÎ≤ÑÍπÖ ÏôÑÎ£å - ÏΩòÏÜî ÌôïÏù∏';
       };

     // ÏÉ∑ Ï†ïÎ≥¥ ÌÉ≠ ÏÉùÏÑ±
        function createShotInfoTab(shot) {
            const originalScenario = shot.original_scenario || {};
            
            return `
                <div class="info-section">
                    <h3>Í∏∞Î≥∏ Ï†ïÎ≥¥</h3>
                    <table class="info-table">
                        <tr><th>ID</th><td>${shot.id}</td></tr>
                        <tr><th>Ï†úÎ™©</th><td>${shot.title}</td></tr>
                        <tr><th>ÏÜåÏÜç Ïî¨</th><td>${shot.scene_id || '-'}</td></tr>
                        <tr><th>ÏÉ∑ Ïú†Ìòï</th><td>${shot.shot_type || '-'}</td></tr>
                        <tr><th>ÏÑ§Î™Ö</th><td>${shot.description || '-'}</td></tr>
                        <tr><th>ÏòàÏÉÅ Í∏∏Ïù¥</th><td>${shot.other_info?.estimated_duration || '-'}Ï¥à</td></tr>
                    </table>
                </div>
                
                ${originalScenario.text ? `
                <div class="info-section original-scenario-section">
                    <h4>üìú ÏõêÎ≥∏ ÏãúÎÇòÎ¶¨Ïò§</h4>
                    <div class="scenario-text">${originalScenario.text || ''}</div>
                    <div class="scenario-metadata">
                        ${originalScenario.scene_number ? `Ïû•Î©¥ Î≤àÌò∏: ${originalScenario.scene_number}` : ''}
                        ${originalScenario.location ? ` | Ïû•ÏÜå: ${originalScenario.location}` : ''}
                        ${originalScenario.time ? ` | ÏãúÍ∞Ñ: ${originalScenario.time}` : ''}
                    </div>
                </div>` : ''}
                
                <div class="info-section">
                    <h3>Î©îÎ™®</h3>
                    <textarea class="form-textarea" placeholder="Ïù¥ ÏÉ∑Ïóê ÎåÄÌïú Î©îÎ™®..." onchange="updateShotMemo('${shot.id}', this.value)">${getShotMemo(shot.id)}</textarea>
                    <small style="color:#666;font-size:0.85rem;">Î©îÎ™®Îäî ÏûêÎèôÏúºÎ°ú Ï†ÄÏû•Îê©ÎãàÎã§.</small>
                </div>
                
                ${shot.visual_consistency_info ? `
                <div class="info-section">
                    <h3>ÎπÑÏ£ºÏñº ÏùºÍ¥ÄÏÑ± Ï†ïÎ≥¥</h3>
                    <table class="info-table">
                        <tr><th>Ïû•ÏÜå ID</th><td>${shot.visual_consistency_info.location_id || '-'}</td></tr>
                        <tr><th>Ï∫êÎ¶≠ÌÑ∞ ID</th><td>${(shot.visual_consistency_info.character_ids || []).join(', ') || '-'}</td></tr>
                        <tr><th>ÏÜåÌíà ID</th><td>${(shot.visual_consistency_info.prop_ids || []).join(', ') || '-'}</td></tr>
                    </table>
                </div>` : ''}
                
                ${shot.camera_framing ? `
                <div class="info-section">
                    <h3>Ïπ¥Î©îÎùº Ï†ïÎ≥¥</h3>
                    <table class="info-table">
                        <tr><th>ÌîÑÎ†àÏù¥Î∞ç</th><td>${shot.camera_framing.framing || '-'}</td></tr>
                        <tr><th>ÏïµÍ∏Ä</th><td>${shot.camera_framing.angle || '-'}</td></tr>
                        <tr><th>ÏãúÏ†ê Î∞©Ìñ•</th><td>${shot.camera_framing.view_direction || '-'}</td></tr>
                        <tr><th>Íµ¨ÎèÑ</th><td>${shot.camera_framing.composition || '-'}</td></tr>
                    </table>
                </div>` : ''}
                
                ${shot.content ? `
                <div class="info-section">
                    <h3>ÏΩòÌÖêÏ∏†</h3>
                    <table class="info-table">
                        <tr><th>Ïï°ÏÖò</th><td>${shot.content.action || '-'}</td></tr>
                        <tr><th>ÏùåÌñ• Ìö®Í≥º</th><td>${shot.content.sound_effects || '-'}</td></tr>
                        <tr><th>ÎÇòÎ†àÏù¥ÏÖò</th><td>${shot.content.narration || '-'}</td></tr>
                    </table>
                </div>` : ''}`;
        }

       // ÏÉ∑ Ïù¥ÎØ∏ÏßÄ ÌÉ≠ ÏÉùÏÑ± (Ïù¥ÎØ∏ÏßÄ ÏÑ§Í≥Ñ ÌîåÎûú Î∞©Ïãù)

	function createShotImageTab(shot) {
    console.log('üñºÔ∏è createShotImageTab ÏãúÏûë (Ïù¥ÎØ∏ÏßÄÎ≥Ñ ÌîÑÎ°¨ÌîÑÌä∏ ÌëúÏãú)');
    try {
        const imageDesign = shot.image_design || {};
        const imageDesignPlans = imageDesign.plans || {};
        const selectedPlan = imageDesign.selected_plan || 'A';
        const complexity = imageDesign.complexity || 'complex';
        const aiGeneratedImages = imageDesign.ai_generated_images || {};
        const referenceImagesData = shot.reference_images || [];
        
        // Stage 6 Îç∞Ïù¥ÌÑ∞ÏóêÏÑú Ïù¥ÎØ∏ÏßÄÎ≥Ñ ÌîÑÎ°¨ÌîÑÌä∏ Í∞ÄÏ†∏Ïò§Í∏∞
        const stage6Data = window.stage6ImagePrompts || {};
        const shotStage6Data = stage6Data[shot.id] || {};

        let planSelectorHtml = '';
        let selectedPlanData = null;

        // Simple ÏÉ∑Ïù∏ Í≤ΩÏö∞
        if (complexity === 'simple' && imageDesignPlans.single) {
            selectedPlanData = imageDesignPlans.single;
            planSelectorHtml = `
                <div class="image-design-plan-selector">
                    <h4>üé® Ïù¥ÎØ∏ÏßÄ ÏÑ§Í≥Ñ (Simple - Îã®Ïùº Ïù¥ÎØ∏ÏßÄ)</h4>
                    <div class="plan-info">
                        <h5>${selectedPlanData.description || 'Îã®Ïùº Ïù¥ÎØ∏ÏßÄÎ°ú ÌëúÌòÑ'}</h5>
                        <div class="plan-metadata">
                            <span>Ïù¥ÎØ∏ÏßÄ Ïàò: ${selectedPlanData.images?.length || 1}Í∞ú</span>
                        </div>
                    </div>
                </div>
            `;
        } 
        // Complex ÏÉ∑Ïù∏ Í≤ΩÏö∞
        else {
            selectedPlanData = imageDesignPlans[selectedPlan] || imageDesignPlans.A || {};
            planSelectorHtml = `
                <div class="image-design-plan-selector">
                    <h4>üé® Ïù¥ÎØ∏ÏßÄ ÏÑ§Í≥Ñ ÌîåÎûú ÏÑ†ÌÉù</h4>
                    <div class="plan-tabs">
                        ${['A', 'B', 'C'].map(planId => {
                            const plan = imageDesignPlans[planId];
                            if (!plan) return '';
                            return `
                                <div class="plan-tab ${selectedPlan === planId ? 'active' : ''}" 
                                     onclick="selectImagePlan('${shot.id}', '${planId}')">
                                    Plan ${planId} - ${plan.description || 'ÏÑ§Î™Ö ÏóÜÏùå'}
                                </div>
                            `;
                        }).join('')}
                    </div>
                    
                    ${['A', 'B', 'C'].map(planId => {
                        const plan = imageDesignPlans[planId];
                        if (!plan) return '';
                        const isActive = selectedPlan === planId;
                        return `
                            <div class="plan-content ${isActive ? 'active' : ''}" 
                                 id="plan-content-${planId}" 
                                 style="display: ${isActive ? 'block' : 'none'};">
                                <div class="plan-info">
                                    <h5>Plan ${planId}: ${plan.description || 'ÏÑ§Î™Ö ÏóÜÏùå'}</h5>
                                    <div class="plan-metadata">
                                        <span>Ïù¥ÎØ∏ÏßÄ Ïàò: ${plan.images?.length || 0}Í∞ú</span>
                                    </div>
                                    ${plan.images && plan.images.length > 0 ? `
                                        <div style="margin-top: 15px;">
                                            <h6>Ïù¥ÎØ∏ÏßÄ Íµ¨ÏÑ±:</h6>
                                            ${plan.images.map((img, idx) => `
                                                <div style="margin-bottom: 10px; padding: 10px; background: #f8f9fa; border-radius: 4px;">
                                                    <strong>${img.id}:</strong> ${img.description || 'ÏÑ§Î™Ö ÏóÜÏùå'}
                                                </div>
                                            `).join('')}
                                        </div>
                                    ` : '<p style="color: #999;">Ïù¥ÎØ∏ÏßÄ Ï†ïÎ≥¥Í∞Ä ÏóÜÏäµÎãàÎã§.</p>'}
                                </div>
                            </div>
                        `;
                    }).join('')}
                </div>
            `;
        }

        // AIÎ≥Ñ ÌîÑÎ°¨ÌîÑÌä∏ Î∞è ÏÉùÏÑ±Îêú Ïù¥ÎØ∏ÏßÄ ÏÑπÏÖò
        const imageAIs = [
            { id: 'midjourney', name: 'Midjourney' },
            { id: 'ideogram', name: 'Ideogram' },
            { id: 'leonardo', name: 'Leonardo' },
            { id: 'imagefx', name: 'ImageFX' },
			{ id: 'openart', name: 'OpenArt' }
        ];

        let aiSectionsHtml = '';
        
   // ÏÑ†ÌÉùÎêú ÌîåÎûúÏùò Ïù¥ÎØ∏ÏßÄÎì§Ïóê ÎåÄÌï¥ Ï≤òÎ¶¨
			if (selectedPlanData && selectedPlanData.images) {
				// AIÎ≥ÑÎ°ú Í∑∏Î£πÌôî
				imageAIs.forEach(ai => {
					let aiHasContent = false;
					let aiContentHtml = '';

					selectedPlanData.images.forEach((planImage, imgIdx) => {
						const imageId = planImage.id;
						const imageStage6Data = shotStage6Data[imageId] || {};
						const imagePrompts = imageStage6Data.prompts?.[ai.id] || {};
						const hasPrompt = imagePrompts.prompt || imagePrompts.main_prompt;

						//if (!hasPrompt) return;

						aiHasContent = true;
						const mainPrompt = imagePrompts.prompt || imagePrompts.main_prompt || '';
						const translatedPrompt = imagePrompts.prompt_translated || imagePrompts.main_prompt_translated || '';
						const parameters = imagePrompts.parameters || '';

						// AIÎ≥Ñ ÏÉùÏÑ±Îêú Ïù¥ÎØ∏ÏßÄ Îç∞Ïù¥ÌÑ∞
						const imageData = aiGeneratedImages[ai.id]?.[imageId] || { url: '', description: '' };

						aiContentHtml += `
							<div style="margin-bottom: 30px; padding: 15px; background: white; border: 1px solid #e0e0e0; border-radius: 6px;">
								<h5 style="color: #555; margin-bottom: 10px;">üì∏ ${imageId}: ${planImage.description || 'ÏÑ§Î™Ö ÏóÜÏùå'}</h5>
								<div class="ai-image-prompt-details">
									<div class="prompt-original">
										<label class="prompt-text-label">ÌîÑÎ°¨ÌîÑÌä∏:</label>
										<div class="ai-image-prompt-full-text">${mainPrompt}</div>
									</div>
									${translatedPrompt ? `
										<div class="prompt-translated">
											<label class="prompt-text-label">Î≤àÏó≠:</label>
											<div class="ai-image-prompt-full-text">${translatedPrompt}</div>
										</div>
									` : ''}
									${parameters ? `<div style="margin-top: 5px; font-size: 0.9em; color: #666;">Parameters: ${parameters}</div>` : ''}
									<button class="copy-btn" onclick="copyImagePrompt('${mainPrompt.replace(/'/g, "\\'").replace(/"/g, '\\"')}', '${ai.name}', '${imageId}')">
										ÌîÑÎ°¨ÌîÑÌä∏ Î≥µÏÇ¨
									</button>
								</div>

								<div style="margin-top: 15px;">
									<h6>ÏÉùÏÑ±Îêú Ïù¥ÎØ∏ÏßÄ</h6>
									<div class="image-slot-card">
										<div class="image-slot-preview">
											${imageData.url ? 
												`<img src="${imageData.url}" alt="${ai.name} - ${imageId}" 
												style="cursor: pointer;" 
												onclick="openImageModal('${imageData.url}')"
												onerror="this.style.display='none'; this.parentElement.innerHTML='<div style=&quot;color:#999;font-size:0.8rem;&quot;>Î°úÎìú Ïã§Ìå®</div>';">` :
												`<div style="color:#999;font-size:0.8rem;">URL ÏûÖÎ†•</div>`
											}
										</div>
										<div class="form-group">
											<label class="form-label">URL:</label>
											<div style="display: flex; gap: 8px; align-items: center;">
												<input type="text" class="form-input" 
													   value="${imageData.url || ''}" 
													   placeholder="${ai.name} URL" 
													   onchange="updateImageUrl('${shot.id}', '${ai.id}', '${imageId}', this.value)"
													   style="flex: 1;">
												<button type="button" class="btn btn-secondary btn-small" 
														onclick="uploadImageForShot('${shot.id}', '${ai.id}', '${imageId}')" 
														title="Î°úÏª¨ ÌååÏùº ÏóÖÎ°úÎìú">
													üìÅ ÌååÏùº ÏóÖÎ°úÎìú
												</button>
											</div>
										</div>
										<div class="form-group">
											<label class="form-label">ÏÑ§Î™Ö:</label>
											<textarea class="form-textarea" 
													  placeholder="${ai.name} ÏÑ§Î™Ö" 
													  onchange="updateImageDescription('${shot.id}', '${ai.id}', '${imageId}', this.value)">${imageData.description || ''}</textarea>
										</div>
									</div>
								</div>
							</div>
						`;
					});

					if (aiHasContent) {
						aiSectionsHtml += `
							<div class="ai-image-section ${ai.id}" style="margin-bottom: 40px;">
								<div class="ai-card-header">${ai.name}</div>
								${aiContentHtml}
							</div>
						`;
					}
				});
			}

        // Ï∞∏Ï°∞ Ïù¥ÎØ∏ÏßÄ ÏÑπÏÖò
        let referenceSlotsHtml = '';
        for (let i = 0; i < 3; i++) {
            const refData = referenceImagesData[i] || { url: '', description: '', type: 'composition' };
            const uniqueRefId = `${shot.id}-ref${i}`;
            referenceSlotsHtml += `
                <div class="reference-image-slot">
                    <div class="reference-preview" id="ref-preview-${uniqueRefId}">
                        ${refData.url ? 
                            `<img src="${refData.url}" alt="Ï∞∏Ï°∞ ${i+1}" style="cursor: pointer;" onclick="openImageModal('${refData.url}')">` : 
                            `<div style="color:#999;font-size:0.8rem;">Ï∞∏Ï°∞ ${i+1} URL</div>`
                        }
                    </div>
                    <div class="form-group">
                        <label class="form-label">URL:</label>
                        <input type="text" class="form-input" 
                               value="${refData.url || ''}" 
                               placeholder="Ï∞∏Ï°∞ ${i+1} URL" 
                               onchange="updateReferenceImage('${shot.id}', ${i}, 'url', this.value)">
                    </div>
                    <div class="form-group">
                        <label class="form-label">ÏÑ§Î™Ö:</label>
                        <textarea class="form-textarea" 
                                  onchange="updateReferenceImage('${shot.id}', ${i}, 'description', this.value)">${refData.description || ''}</textarea>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Ïú†Ìòï:</label>
                        <select class="form-select" 
                                onchange="updateReferenceImage('${shot.id}', ${i}, 'type', this.value)">
                            <option value="composition" ${refData.type === 'composition' ? 'selected' : ''}>Íµ¨ÎèÑ</option>
                            <option value="style" ${refData.type === 'style' ? 'selected' : ''}>Ïä§ÌÉÄÏùº</option>
                            <option value="lighting" ${refData.type === 'lighting' ? 'selected' : ''}>Ï°∞Î™Ö</option>
                            <option value="mood" ${refData.type === 'mood' ? 'selected' : ''}>Î∂ÑÏúÑÍ∏∞</option>
                        </select>
                    </div>
                </div>`;
        }

        return `
            ${planSelectorHtml}
            <div class="info-section">
                <h3>üé® AI Ïù¥ÎØ∏ÏßÄ ÏÉùÏÑ± Î∞è Í¥ÄÎ¶¨</h3>
                <p style="font-size:0.9em;color:#555;margin-bottom:20px;">
                    Í∞Å Ïù¥ÎØ∏ÏßÄÎ≥ÑÎ°ú AI ÎèÑÍµ¨Ïùò ÌîÑÎ°¨ÌîÑÌä∏Î•º ÌôïÏù∏ÌïòÍ≥† ÏÉùÏÑ±Îêú Ïù¥ÎØ∏ÏßÄÎ•º Í¥ÄÎ¶¨ÌïòÏÑ∏Ïöî.
                </p>
                ${aiSectionsHtml || '<p style="color:#999;">ÌîÑÎ°¨ÌîÑÌä∏ Îç∞Ïù¥ÌÑ∞Í∞Ä ÏóÜÏäµÎãàÎã§.</p>'}
            </div>
            <div class="info-section reference-image-slots-container">
                <h3>üñºÔ∏è Ï∞∏Ï°∞ Ïù¥ÎØ∏ÏßÄ</h3>
                <div class="reference-image-slots-grid">${referenceSlotsHtml}</div>
            </div>`;
            
    } catch (error) {
        console.error('‚ùå createShotImageTab Ïò§Î•ò:', error);
        return `<div class="info-section"><h3>Ïù¥ÎØ∏ÏßÄ ÌÉ≠ Î°úÎìú Ïò§Î•ò</h3><p>${error.message}</p></div>`;
    }
}	

    // Ïù¥ÎØ∏ÏßÄ ÌîåÎûú ÏÑ†ÌÉù Ìï®Ïàò
    function selectImagePlan(shotId, planId) {
    try {
        const shot = currentData.breakdown_data.shots.find(s => s.id === shotId);
        if (!shot) return showMessage('ÏÉ∑ Îç∞Ïù¥ÌÑ∞Î•º Ï∞æÏùÑ Ïàò ÏóÜÏäµÎãàÎã§.', 'error');
        
        if (!shot.image_design) shot.image_design = {};
        shot.image_design.selected_plan = planId; // Ïù¥Ï†ú 'A', 'B', 'C'Í∞Ä Îì§Ïñ¥Ïò¥
        
        saveDataToLocalStorage();
        showShotContent(shotId); // Ï†ÑÏ≤¥ Ïû¨Î†åÎçîÎßÅ
        setTimeout(() => switchTab('image', shotId), 0); // Ïù¥ÎØ∏ÏßÄ ÌÉ≠ Ïú†ÏßÄ
        
        showMessage(`Plan ${planId}Ïù¥(Í∞Ä) ÏÑ†ÌÉùÎêòÏóàÏäµÎãàÎã§.`, 'success');
    } catch (error) {
        showMessage('Ïù¥ÎØ∏ÏßÄ ÌîåÎûú ÏÑ†ÌÉù Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§.', 'error');
    }
}
    // AI Ïù¥ÎØ∏ÏßÄ ÌîÑÎ°¨ÌîÑÌä∏ Î≥µÏÇ¨
    function copyImageAIPrompt(fullPrompt, aiName) {
        const actualFullPrompt = fullPrompt.replace(/\\n/g, "\n");
        if (!actualFullPrompt || actualFullPrompt.trim() === 'ÌîÑÎ°¨ÌîÑÌä∏Í∞Ä ÏóÜÏäµÎãàÎã§.') {
            return showMessage(`${aiName} ÌîÑÎ°¨ÌîÑÌä∏Í∞Ä ÎπÑÏñ¥ ÏûàÏñ¥ Î≥µÏÇ¨Ìï† Ïàò ÏóÜÏäµÎãàÎã§.`, 'warning');
        }
        copyToClipboard(actualFullPrompt).then(ok => {
            if (ok) showMessage(`${aiName} Ï†ÑÏ≤¥ ÌîÑÎ°¨ÌîÑÌä∏Í∞Ä Î≥µÏÇ¨ÎêòÏóàÏäµÎãàÎã§.`, 'success');
        });
    }

    // AIÎ≥Ñ ÏÉùÏÑ± Ïù¥ÎØ∏ÏßÄ URL ÏóÖÎç∞Ïù¥Ìä∏
    function updateAIGeneratedImageUrl(shotId, aiType, imageIndex, newUrl) {
        try {
            const shot = currentData.breakdown_data.shots.find(s => s.id === shotId);
            if (!shot) return showMessage('ÏÉ∑ Îç∞Ïù¥ÌÑ∞Î•º Ï∞æÏùÑ Ïàò ÏóÜÏäµÎãàÎã§.', 'error');
            
            if (!shot.image_design) shot.image_design = { aspect_ratio: "16:9", selected_plan: "plan_a" };
            if (!shot.image_design.ai_generated_images) shot.image_design.ai_generated_images = {};
            if (!shot.image_design.ai_generated_images[aiType]) {
                shot.image_design.ai_generated_images[aiType] = [
                    { url: '', description: '' },
                    { url: '', description: '' },
                    { url: '', description: '' }
                ];
            }
            
            if (imageIndex < 3) {
                shot.image_design.ai_generated_images[aiType][imageIndex].url = newUrl;
            }
            
            saveDataToLocalStorage();
            
            // UI ÏóÖÎç∞Ïù¥Ìä∏
            const uid = `${shotId}-${aiType}-img${imageIndex}`;
            const preview = document.getElementById(`slot-preview-${uid}`);
            const viewBtn = document.querySelector(`#slot-card-${uid} .image-slot-actions button`);
            
            if (preview) {
                if (newUrl) {
                  preview.innerHTML = `<img src="${newUrl}" alt="${aiType} ${imageIndex+1}" style="cursor: pointer;" onclick="openImageModal('${newUrl}')" onerror="(function(event){this.style.display='none';this.parentElement.innerHTML='<div style=&quot;color:#999;font-size:0.8rem;&quot;>Î°úÎìú Ïã§Ìå®</div>';}).call(this, event)">`;
                    if (viewBtn) viewBtn.disabled = false;
                } else {
                    preview.innerHTML = `<div style="color:#999;font-size:0.8rem;">URL ÏûÖÎ†•</div>`;
                    if (viewBtn) viewBtn.disabled = true;
                }
            }
        } catch (e) {
            showMessage('URL ÏóÖÎç∞Ïù¥Ìä∏ Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§.', 'error');
        }
    }

    // AIÎ≥Ñ ÏÉùÏÑ± Ïù¥ÎØ∏ÏßÄ ÏÑ§Î™Ö ÏóÖÎç∞Ïù¥Ìä∏
    function updateAIGeneratedImageDescription(shotId, aiType, imageIndex, newDescription) {
        try {
            const shot = currentData.breakdown_data.shots.find(s => s.id === shotId);
            if (!shot) return showMessage('ÏÉ∑ Îç∞Ïù¥ÌÑ∞Î•º Ï∞æÏùÑ Ïàò ÏóÜÏäµÎãàÎã§.', 'error');
            
            if (!shot.image_design) shot.image_design = { aspect_ratio: "16:9", selected_plan: "plan_a" };
            if (!shot.image_design.ai_generated_images) shot.image_design.ai_generated_images = {};
            if (!shot.image_design.ai_generated_images[aiType]) {
                shot.image_design.ai_generated_images[aiType] = [
                    { url: '', description: '' },
                    { url: '', description: '' },
                    { url: '', description: '' }
                ];
            }
            
            if (imageIndex < 3) {
                shot.image_design.ai_generated_images[aiType][imageIndex].description = newDescription;
                saveDataToLocalStorage();
            }
        } catch (e) {
            showMessage('ÏÑ§Î™Ö ÏóÖÎç∞Ïù¥Ìä∏ Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§.', 'error');
        }
    }
    // Ïù¥ÎØ∏ÏßÄÎ≥Ñ URL ÏóÖÎç∞Ïù¥Ìä∏ (ÏÉàÎ°úÏö¥ Íµ¨Ï°∞)
	function updateImageUrl(shotId, aiType, imageId, newUrl) {
		try {
			const shot = currentData.breakdown_data.shots.find(s => s.id === shotId);
			if (!shot) return showMessage('ÏÉ∑ Îç∞Ïù¥ÌÑ∞Î•º Ï∞æÏùÑ Ïàò ÏóÜÏäµÎãàÎã§.', 'error');

			if (!shot.image_design) shot.image_design = {};
			if (!shot.image_design.ai_generated_images) shot.image_design.ai_generated_images = {};
			if (!shot.image_design.ai_generated_images[aiType]) {
				shot.image_design.ai_generated_images[aiType] = {};
			}

			// Ïù¥ÎØ∏ÏßÄ IDÎ≥ÑÎ°ú Ï†ÄÏû•
			if (!shot.image_design.ai_generated_images[aiType][imageId]) {
				shot.image_design.ai_generated_images[aiType][imageId] = { url: '', description: '' };
			}

			shot.image_design.ai_generated_images[aiType][imageId].url = newUrl;
			saveDataToLocalStorage();

			// ÎØ∏Î¶¨Î≥¥Í∏∞ ÏóÖÎç∞Ïù¥Ìä∏ - ID Í∏∞Î∞òÏúºÎ°ú Ï∞æÍ∏∞
			updateImagePreview(shotId, aiType, imageId, newUrl);
		} catch (e) {
			showMessage('URL ÏóÖÎç∞Ïù¥Ìä∏ Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§.', 'error');
		}
	}

	// Ïù¥ÎØ∏ÏßÄ ÎØ∏Î¶¨Î≥¥Í∏∞ ÏóÖÎç∞Ïù¥Ìä∏ Ìï®Ïàò
	function updateImagePreview(shotId, aiType, imageId, newUrl) {
		try {
			// Ìï¥Îãπ Ïù¥ÎØ∏ÏßÄ Ïä¨Î°ØÏùò ÎØ∏Î¶¨Î≥¥Í∏∞ ÏòÅÏó≠ÏùÑ Ï∞æÍ∏∞
			const inputElement = document.querySelector(`input[onchange*="updateImageUrl('${shotId}', '${aiType}', '${imageId}',"]`);
			if (!inputElement) {
				return;
			}
			
			const card = inputElement.closest('.image-slot-card');
			if (!card) {
				return;
			}
			
			const preview = card.querySelector('.image-slot-preview');
			if (!preview) {
				return;
			}
			
			if (newUrl && newUrl.trim() !== '') {
				// blob URL Í∞êÏßÄ Î∞è Í≤ΩÍ≥†
				if (newUrl.startsWith('blob:')) {
					preview.innerHTML = `<div style="color:#ff9800;font-size:0.8rem;">ÏûÑÏãú Ïù¥ÎØ∏ÏßÄ - Îã§Ïãú ÏóÖÎ°úÎìúÌï¥Ï£ºÏÑ∏Ïöî</div>`;
				} else {
					preview.innerHTML = `<img src="${newUrl}" alt="${aiType} - ${imageId}" 
					style="cursor: pointer;" 
					onclick="openImageModal('${newUrl}')"
					onerror="(function(event){this.style.display='none'; this.parentElement.innerHTML='<div style=&quot;color:#999;font-size:0.8rem;&quot;>Î°úÎìú Ïã§Ìå®</div>';}).call(this, event)">`;
				}
			} else {
				preview.innerHTML = `<div style="color:#999;font-size:0.8rem;">URL ÏûÖÎ†•</div>`;
			}
		} catch (e) {
		}
	}

	// Ïù¥ÎØ∏ÏßÄ Î¶¨ÏÇ¨Ïù¥Ïßï Ìï®Ïàò
	function resizeImage(file, maxWidth, maxHeight, quality = 0.85) {
		return new Promise((resolve, reject) => {
			const reader = new FileReader();
			reader.onload = function(event) {
				const img = new Image();
				img.onload = function() {
					// Ï∫îÎ≤ÑÏä§ ÏÉùÏÑ±
					const canvas = document.createElement('canvas');
					const ctx = canvas.getContext('2d');
					
					// ÎπÑÏú® Ïú†ÏßÄÌïòÎ©∞ ÌÅ¨Í∏∞ Í≥ÑÏÇ∞
					let width = img.width;
					let height = img.height;
					
					if (width > maxWidth || height > maxHeight) {
						const ratio = Math.min(maxWidth / width, maxHeight / height);
						width = Math.floor(width * ratio);
						height = Math.floor(height * ratio);
					}
					
					canvas.width = width;
					canvas.height = height;
					
					// Ïù¥ÎØ∏ÏßÄ Í∑∏Î¶¨Í∏∞
					ctx.drawImage(img, 0, 0, width, height);
					
					// base64Î°ú Î≥ÄÌôò (JPEGÎ°ú ÏïïÏ∂ï)
					canvas.toBlob((blob) => {
						if (!blob) {
							reject(new Error('Ïù¥ÎØ∏ÏßÄ Î≥ÄÌôò Ïã§Ìå®'));
							return;
						}
						const reader = new FileReader();
						reader.onloadend = () => resolve(reader.result);
						reader.onerror = reject;
						reader.readAsDataURL(blob);
					}, 'image/jpeg', quality);
				};
				img.onerror = () => reject(new Error('Ïù¥ÎØ∏ÏßÄ Î°úÎìú Ïã§Ìå®'));
				img.src = event.target.result;
			};
			reader.onerror = () => reject(new Error('ÌååÏùº ÏùΩÍ∏∞ Ïã§Ìå®'));
			reader.readAsDataURL(file);
		});
	}

	// Î°úÏª¨ Ïù¥ÎØ∏ÏßÄ ÌååÏùº ÏóÖÎ°úÎìú Ìï®Ïàò
	function uploadImageForShot(shotId, aiType, imageId) {
		const input = document.createElement('input');
		input.type = 'file';
		input.accept = 'image/*';
		input.style.display = 'none';
		
		input.onchange = async function(e) {
			const file = e.target.files[0];
			if (!file) return;
			
			try {
				// ÌååÏùº ÌÅ¨Í∏∞ ÌôïÏù∏
				const fileSizeMB = file.size / 1024 / 1024;
				
				if (fileSizeMB > 10) {
					showMessage('ÌååÏùº ÌÅ¨Í∏∞Í∞Ä ÌÅΩÎãàÎã§. Î¶¨ÏÇ¨Ïù¥ÏßïÏùÑ ÏßÑÌñâÌï©ÎãàÎã§...', 'info');
				}
				
				// Ïù¥ÎØ∏ÏßÄ Î¶¨ÏÇ¨Ïù¥Ïßï (ÏµúÎåÄ 1200x1200, ÌíàÏßà 0.85)
				const resizedDataUrl = await resizeImage(file, 1200, 1200, 0.85);
				
				// Î¶¨ÏÇ¨Ïù¥ÏßïÎêú ÌÅ¨Í∏∞ ÌôïÏù∏
				const resizedSize = (resizedDataUrl.length * 0.75) / 1024 / 1024; // ÎåÄÎûµÏ†ÅÏù∏ MB Í≥ÑÏÇ∞
				
				// Îç∞Ïù¥ÌÑ∞ Ï†ÄÏû•
				const shot = currentData?.breakdown_data?.shots?.find(s => s.id === shotId);
				if (!shot) {
					return showMessage('ÏÉ∑ Îç∞Ïù¥ÌÑ∞Î•º Ï∞æÏùÑ Ïàò ÏóÜÏäµÎãàÎã§.', 'error');
				}

				if (!shot.image_design) shot.image_design = {};
				if (!shot.image_design.ai_generated_images) shot.image_design.ai_generated_images = {};
				if (!shot.image_design.ai_generated_images[aiType]) {
					shot.image_design.ai_generated_images[aiType] = {};
				}
				if (!shot.image_design.ai_generated_images[aiType][imageId]) {
					shot.image_design.ai_generated_images[aiType][imageId] = { url: '', description: '' };
				}

				shot.image_design.ai_generated_images[aiType][imageId].url = resizedDataUrl;
				
				// localStorage Ï†ÄÏû• ÏãúÎèÑ
				try {
					saveDataToLocalStorage();
					showMessage('Ïù¥ÎØ∏ÏßÄÍ∞Ä ÏÑ±Í≥µÏ†ÅÏúºÎ°ú Ï†ÄÏû•ÎêòÏóàÏäµÎãàÎã§.', 'success');
				} catch (saveError) {
					if (saveError.name === 'QuotaExceededError') {
						showMessage('Ï†ÄÏû• Í≥µÍ∞ÑÏù¥ Î∂ÄÏ°±Ìï©ÎãàÎã§. Ïù¥ÎØ∏ÏßÄ ÌíàÏßàÏùÑ ÎÇÆÏ∂∞ÏÑú Îã§Ïãú ÏãúÎèÑÌïòÍ±∞ÎÇò Í∏∞Ï°¥ Îç∞Ïù¥ÌÑ∞Î•º Ï†ïÎ¶¨Ìï¥Ï£ºÏÑ∏Ïöî.', 'error');
					} else {
						showMessage('Ï†ÄÏû• Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§.', 'error');
					}
				}

				// UI ÏóÖÎç∞Ïù¥Ìä∏
				const inputElement = document.querySelector(`input[onchange*="updateImageUrl('${shotId}', '${aiType}', '${imageId}',"]`);
				if (inputElement) {
					inputElement.value = resizedDataUrl;
				}
				
				updateImagePreview(shotId, aiType, imageId, resizedDataUrl);
				
			} catch (error) {
				showMessage('Ïù¥ÎØ∏ÏßÄ Ï≤òÎ¶¨ Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§: ' + error.message, 'error');
			}
			
			// input ÏöîÏÜå Ï†ïÎ¶¨
			document.body.removeChild(input);
		};
		
		input.oncancel = function() {
			document.body.removeChild(input);
		};
		
		document.body.appendChild(input);
		input.click();
	}

	// Ïù¥ÎØ∏ÏßÄÎ≥Ñ ÏÑ§Î™Ö ÏóÖÎç∞Ïù¥Ìä∏ (ÏÉàÎ°úÏö¥ Íµ¨Ï°∞)
	function updateImageDescription(shotId, aiType, imageId, newDescription) {
		try {
			const shot = currentData.breakdown_data.shots.find(s => s.id === shotId);
			if (!shot) return showMessage('ÏÉ∑ Îç∞Ïù¥ÌÑ∞Î•º Ï∞æÏùÑ Ïàò ÏóÜÏäµÎãàÎã§.', 'error');

			if (!shot.image_design) shot.image_design = {};
			if (!shot.image_design.ai_generated_images) shot.image_design.ai_generated_images = {};
			if (!shot.image_design.ai_generated_images[aiType]) {
				shot.image_design.ai_generated_images[aiType] = {};
			}

			if (!shot.image_design.ai_generated_images[aiType][imageId]) {
				shot.image_design.ai_generated_images[aiType][imageId] = { url: '', description: '' };
			}

			shot.image_design.ai_generated_images[aiType][imageId].description = newDescription;
			saveDataToLocalStorage();
		} catch (e) {
			showMessage('ÏÑ§Î™Ö ÏóÖÎç∞Ïù¥Ìä∏ Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§.', 'error');
		}
	}

	// Ïù¥ÎØ∏ÏßÄ ÌîÑÎ°¨ÌîÑÌä∏ Î≥µÏÇ¨ (Ïù¥ÎØ∏ÏßÄ ID Ìè¨Ìï®)
	function copyImagePrompt(prompt, aiName, imageId) {
		if (!prompt || prompt.trim() === '') {
			return showMessage(`${aiName} ÌîÑÎ°¨ÌîÑÌä∏Í∞Ä ÎπÑÏñ¥ ÏûàÏäµÎãàÎã§.`, 'warning');
		}
		copyToClipboard(prompt).then(ok => {
			if (ok) showMessage(`${aiName} ÌîÑÎ°¨ÌîÑÌä∏ (${imageId})Í∞Ä Î≥µÏÇ¨ÎêòÏóàÏäµÎãàÎã§.`, 'success');
		});
	}

    // Ï∞∏Ï°∞ Ïù¥ÎØ∏ÏßÄ ÏóÖÎç∞Ïù¥Ìä∏
    function updateReferenceImage(shotId, refIndex, field, value) {
        try {
            const shot = currentData.breakdown_data.shots.find(s => s.id === shotId);
            if (!shot) return showMessage('ÏÉ∑ Îç∞Ïù¥ÌÑ∞Î•º Ï∞æÏùÑ Ïàò ÏóÜÏäµÎãàÎã§.', 'error');
            
            if (!shot.reference_images) shot.reference_images = [];
            
            while (shot.reference_images.length <= refIndex) {
                shot.reference_images.push({
                    id: `ref_img_${shot.reference_images.length + 1}_${shotId}`,
                    url: '',
                    description: '',
                    type: 'composition'
                });
            }
            
            shot.reference_images[refIndex][field] = value;
            if (!shot.reference_images[refIndex].id) {
                shot.reference_images[refIndex].id = `ref_img_${refIndex + 1}_${shotId}`;
            }
            
            saveDataToLocalStorage();
            
            if (field === 'url') {
                const uid = `${shotId}-ref${refIndex}`;
                const preview = document.getElementById(`ref-preview-${uid}`);
                if (preview) {
                    if (value) {
                     preview.innerHTML = `<img src="${value}" alt="Ï∞∏Ï°∞ ${refIndex+1}" style="cursor: pointer;" onclick="openImageModal('${value}')" onerror="(function(event){this.style.display='none';this.parentElement.innerHTML='<div style=&quot;color:#999;font-size:0.8rem;&quot;>Î°úÎìú Ïã§Ìå®</div>';}).call(this, event)">`;
                    } else {
                        preview.innerHTML = `<div style="color:#999;font-size:0.8rem;">Ï∞∏Ï°∞ ${refIndex+1} URL</div>`;
                    }
                }
            }
        } catch (e) {
            showMessage('Ï∞∏Ï°∞ Ïù¥ÎØ∏ÏßÄ ÏóÖÎç∞Ïù¥Ìä∏ Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§.', 'error');
        }
    }

    // Ï∞∏Ï°∞ Ïù¥ÎØ∏ÏßÄ Ïä¨Î°Ø ÎπÑÏö∞Í∏∞
    function clearReferenceImageSlot(shotId, refIndex) {
        try {
            const shot = currentData.breakdown_data.shots.find(s => s.id === shotId);
            if (shot && shot.reference_images && shot.reference_images[refIndex]) {
                shot.reference_images[refIndex] = {
                    id: `ref_img_${refIndex + 1}_${shotId}`,
                    url: '',
                    description: '',
                    type: 'composition'
                };
                saveDataToLocalStorage();
            }
            
            const uid = `${shotId}-ref${refIndex}`;
            const urlInput = document.getElementById(`ref-url-${uid}`);
            const descInput = document.getElementById(`ref-desc-${uid}`);
            const typeSelect = document.getElementById(`ref-type-${uid}`);
            const preview = document.getElementById(`ref-preview-${uid}`);
            
            if (urlInput) urlInput.value = '';
            if (descInput) descInput.value = '';
            if (typeSelect) typeSelect.value = 'composition';
            if (preview) preview.innerHTML = `<div style="color:#999;font-size:0.8rem;">Ï∞∏Ï°∞ ${refIndex+1} URL</div>`;
            
            showMessage(`Ï∞∏Ï°∞ Ïù¥ÎØ∏ÏßÄ Ïä¨Î°Ø ${refIndex+1}Ïù¥ ÎπÑÏõåÏ°åÏäµÎãàÎã§.`, 'success');
        } catch (e) {
            showMessage('Ï∞∏Ï°∞ Ïä¨Î°ØÏùÑ ÎπÑÏö∞Îäî Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§.', 'error');
        }
    }

    // Ïù¥ÎØ∏ÏßÄ ÌÅ¨Í≤å Î≥¥Í∏∞ Î™®Îã¨
    function openImageModal(imageUrl) {
        const modal = document.getElementById('imageDisplayModal');
        const modalImg = document.getElementById('modalImageContent');
        
        if (modal && modalImg && imageUrl && imageUrl.trim() !== '') {
            modalImg.src = imageUrl;
            modal.style.display = "flex";
        } else if (!imageUrl || imageUrl.trim() === '') {
            showMessage('Ïù¥ÎØ∏ÏßÄ URLÏù¥ ÏóÜÏñ¥ ÌÅ¨Í≤å Î≥º Ïàò ÏóÜÏäµÎãàÎã§.', 'warning');
        }
    }

    function closeImageModal(event) {
        const modal = document.getElementById('imageDisplayModal');
        if (modal && (
            (event && event.target === modal) ||
            (event && event.target.classList.contains('image-modal-close')) ||
            !event
        )) {
            modal.style.display = "none";
            document.getElementById('modalImageContent').src = "";
        }
    }

    // ÏÉ∑ ÏòÅÏÉÅ ÌÉ≠ ÏÉùÏÑ± (Ï∂îÏ∂úÎêú Ïù¥ÎØ∏ÏßÄ Ï†ïÎ≥¥ Ìè¨Ìï®)
    function createShotVideoTab(shot) {
    console.log('üé• createShotVideoTab ÏãúÏûë (Ïù¥ÎØ∏ÏßÄÎ≥Ñ ÏòÅÏÉÅ ÌîÑÎ°¨ÌîÑÌä∏ ÌëúÏãú)');
    try {
        const imageDesign = shot.image_design || {};
		const imageDesignPlans = imageDesign.plans || {};

		// ÏòÅÏÉÅ ÌÉ≠ÏóêÏÑú ÏÑ†ÌÉùÎêú ÌîåÎûú ÌôïÏù∏ (ÏóÜÏúºÎ©¥ Ïù¥ÎØ∏ÏßÄ ÌÉ≠Ïùò ÏÑ†ÌÉù ÏÇ¨Ïö©)
		const videoSelectedPlan = window.videoTabSelectedPlans?.[shot.id];
		const selectedPlan = videoSelectedPlan || imageDesign.selected_plan || 'A';

		const complexity = imageDesign.complexity || 'complex';
		const videoPrompts = shot.video_prompts || {};
		const videoUrls = shot.video_urls || {};
        
        let planSelectorHtml = '';
        let selectedPlanData = null;

        // Simple ÏÉ∑Ïù∏ Í≤ΩÏö∞
        if (complexity === 'simple' && imageDesignPlans.single) {
            selectedPlanData = imageDesignPlans.single;
            planSelectorHtml = `
                <div class="image-design-plan-selector">
                    <h4>üé¨ ÏòÅÏÉÅ ÏÑ§Í≥Ñ (Simple - Îã®Ïùº Ïù¥ÎØ∏ÏßÄ)</h4>
                    <div class="plan-info">
                        <h5>${selectedPlanData.description || 'Îã®Ïùº Ïù¥ÎØ∏ÏßÄÎ°ú ÌëúÌòÑ'}</h5>
                        <div class="plan-metadata">
                            <span>Ïù¥ÎØ∏ÏßÄ Ïàò: ${selectedPlanData.images?.length || 1}Í∞ú</span>
                        </div>
                    </div>
                </div>
            `;
        } 
        // Complex ÏÉ∑Ïù∏ Í≤ΩÏö∞
        else {
            selectedPlanData = imageDesignPlans[selectedPlan] || imageDesignPlans.A || {};
            planSelectorHtml = `
                <div class="image-design-plan-selector">
                    <h4>üé¨ ÏòÅÏÉÅ ÏÑ§Í≥Ñ ÌîåÎûú ÏÑ†ÌÉù</h4>
                    <div class="plan-tabs">
                        ${['A', 'B', 'C'].map(planId => {
                            const plan = imageDesignPlans[planId];
                            if (!plan) return '';
                            return `
                                <div class="plan-tab ${selectedPlan === planId ? 'active' : ''}" 
                                     onclick="selectVideoPlan('${shot.id}', '${planId}')">
                                    <h5>ÌîåÎûú ${planId}</h5>
                                    <p>${plan.description || 'ÏÑ§Î™Ö ÏóÜÏùå'}</p>
                                    <span class="image-count">Ïù¥ÎØ∏ÏßÄ ${plan.images?.length || 0}Í∞ú</span>
                                </div>
                            `;
                        }).join('')}
                    </div>
                </div>
            `;
        }

        // AIÎ≥ÑÎ°ú ÏòÅÏÉÅ ÌîÑÎ°¨ÌîÑÌä∏ Í∑∏Î£πÌôîÌïòÏó¨ ÌëúÏãú
        let aiGroupedHtml = '';
        if (selectedPlanData && selectedPlanData.images) {
			const aiTools = [
				{ id: 'luma', name: 'Luma AI', color: '#FF8C00' },
				{ id: 'kling', name: 'Kling AI', color: '#1E90FF' },
				{ id: 'veo2', name: 'Google Veo 2', color: '#9370DB' },
				{ id: 'runway', name: 'Runway ML', color: '#3CB371' }
			];

			aiGroupedHtml = '<div class="video-ai-container">';

			aiTools.forEach(ai => {
				let aiHasContent = false;
				let aiImagesHtml = '';

				selectedPlanData.images.forEach((image, index) => {
					const imageId = image.id || `IMG_${index + 1}`;
					const videoPromptsForImage = findVideoPromptsForImage(shot.id, imageId, videoPrompts);
					const promptData = videoPromptsForImage[ai.id];

					if (promptData) {
						aiHasContent = true;
						const prompt = promptData.prompt_en || promptData.main_prompt || '';
						const promptTranslated = promptData.prompt_translated || promptData.main_prompt_translated || '';
						const settings = promptData.settings || {};
						const url = videoUrls[`${ai.id}_${imageId}`] || '';

						aiImagesHtml += `
							<div class="ai-video-image-item" style="background: #f8f9fa; border: 1px solid #e0e0e0; border-radius: 8px; padding: 15px; margin-bottom: 15px;">
								<h6 style="color: #555; margin-bottom: 10px;">üì∏ ${imageId}: ${image.description || 'ÏÑ§Î™Ö ÏóÜÏùå'}</h6>
								<div class="prompt-section" style="margin-bottom: 10px;">
									<div class="prompt-text" style="background: white; border: 1px solid #dee2e6; border-radius: 4px; padding: 10px; font-family: 'Courier New', monospace; font-size: 0.85rem; max-height: 120px; overflow-y: auto; white-space: pre-wrap; word-break: break-word; line-height: 1.4;">${prompt || 'ÌîÑÎ°¨ÌîÑÌä∏Í∞Ä ÏóÜÏäµÎãàÎã§.'}</div>
									${promptTranslated ? `<div style="margin-top: 5px; font-size: 0.85rem; color: #666;">Î≤àÏó≠: ${promptTranslated}</div>` : ''}
									${Object.keys(settings).length > 0 ? `
										<div style="margin-top: 5px; font-size: 0.8rem; color: #666;">
											${Object.entries(settings).map(([key, value]) => `${key}: ${value}`).join(', ')}
										</div>
									` : ''}
									<button class="copy-btn btn-small" style="margin-top: 8px;" 
											onclick="copyVideoPrompt('${prompt.replace(/'/g, "\\'").replace(/"/g, '\\"').replace(/\n/g, "\\n")}', '${ai.name}', '${imageId}')">
										ÌîÑÎ°¨ÌîÑÌä∏ Î≥µÏÇ¨
									</button>
								</div>
								<div class="video-url-section">
									<label style="font-size: 0.85rem; color: #555;">ÏÉùÏÑ±Îêú ÏòÅÏÉÅ URL:</label>
									<input type="url" class="form-input" style="font-size: 0.9rem;"
										   placeholder="ÏòÅÏÉÅ URL ÏûÖÎ†•" 
										   value="${url}"
										   onchange="updateVideoUrl('${shot.id}', '${ai.id}', '${imageId}', this.value)">
								</div>
								<div class="video-preview-section" style="margin-top: 10px;">
									<div id="video-preview-${shot.id}-${ai.id}-${imageId}" class="ai-video-preview">
										${(function(){
											if (!url) return `<div style="color:#999;font-size:0.85rem;">ÏòÅÏÉÅ ÎØ∏Î¶¨Î≥¥Í∏∞</div>`;
											const videoUrl = processVideoUrl(url);
											if (videoUrl.includes('drive.google.com')) {
												return `<iframe style="max-width:100%;max-height:200px;border-radius:4px;border:none;" src="${videoUrl}" allowfullscreen onerror="console.error('Google Drive ÎπÑÎîîÏò§ Î°úÎìú Ïã§Ìå®:', '${videoUrl}'); this.style.display='none'; this.parentElement.innerHTML='<div style=&quot;color:#ff6b6b;font-size:0.85rem;&quot;>Google Drive ÏòÅÏÉÅ Î°úÎìú Ïã§Ìå®<br><small>ÌååÏùºÏù¥ Í≥µÍ∞úÎ°ú ÏÑ§Ï†ïÎêòÏñ¥ ÏûàÎäîÏßÄ ÌôïÏù∏ÌïòÏÑ∏Ïöî.</small></div>';"></iframe>`;
											} else {
												return `<video controls style="max-width:100%;max-height:200px;border-radius:4px;" src="${videoUrl}" onerror="console.error('ÎπÑÎîîÏò§ Î°úÎìú Ïã§Ìå®:', '${videoUrl}'); this.style.display='none'; this.parentElement.innerHTML='<div style=&quot;color:#ff6b6b;font-size:0.85rem;&quot;>ÏòÅÏÉÅ Î°úÎìú Ïã§Ìå®<br><small>Î°úÏª¨ ÌååÏùºÏùÄ Î∏åÎùºÏö∞Ï†Ä Î≥¥Ïïà Ï†ïÏ±ÖÏúºÎ°ú Ïù∏Ìï¥ Ï†úÌïúÎê† Ïàò ÏûàÏäµÎãàÎã§.</small></div>';"></video>`;
											}
										})()}
									</div>
								</div>
							</div>
						`;
					}
				});

				if (aiHasContent) {
					aiGroupedHtml += `
						<div class="ai-video-section" style="background: white; border: 1px solid #e0e0e0; border-radius: 8px; padding: 20px; margin-bottom: 25px; box-shadow: 0 2px 8px rgba(0,0,0,0.05);">
							<div class="ai-section-header" style="font-size: 1.3rem; font-weight: 600; color: ${ai.color}; border-bottom: 2px solid ${ai.color}; padding-bottom: 10px; margin-bottom: 20px;">
								${ai.name}
							</div>
							${aiImagesHtml}
						</div>
					`;
				}
			});

			aiGroupedHtml += '</div>';
		}

        return `
            <div class="info-section">
                <h3>üé¨ AI ÏòÅÏÉÅ ÏÉùÏÑ± Í¥ÄÎ¶¨</h3>
                <p style="font-size:0.9em;color:#555;margin-bottom:20px;">
                    AI ÎèÑÍµ¨Î≥ÑÎ°ú Í∞Å Ïù¥ÎØ∏ÏßÄÏùò ÏòÅÏÉÅ ÌîÑÎ°¨ÌîÑÌä∏Î•º ÌôïÏù∏ÌïòÍ≥†, ÏÉùÏÑ±Îêú ÏòÅÏÉÅ URLÏùÑ ÏûÖÎ†•ÌïòÏó¨ Í¥ÄÎ¶¨ÌïòÏÑ∏Ïöî.
                </p>
            </div>
            ${planSelectorHtml}
            ${aiGroupedHtml}
        `;
    } catch (e) {
        console.error('‚ùå createShotVideoTab Ïò§Î•ò:', e);
        return `<div class="info-section"><h3>ÏòÅÏÉÅ ÌÉ≠ Î°úÎìú Ïò§Î•ò</h3><p>${e.message}</p></div>`;
    }
}

    // ÏÉ∑ Ïò§ÎîîÏò§ ÌÉ≠ ÏÉùÏÑ± (dialogue_by_character Íµ¨Ï°∞ ÎåÄÏùë)
    function createShotAudioTab(shot) {
        console.log('üîä createShotAudioTab ÏãúÏûë (dialogue_by_character Íµ¨Ï°∞)');
        try {
            const audioUrls = shot.content?.audio_urls || {};
            const dialogueByCharacter = shot.content?.dialogue_by_character || {};
            const dialogueSequence = shot.content?.dialogue_sequence || [];
            const narration = shot.content?.narration || '';
            const narrationTranslated = shot.content?.narration_translated || '';
            const soundEffects = shot.content?.sound_effects || '';
            const soundEffectsEn = shot.content?.sound_effects_en || '';
            const audioPrompts = shot.audio_prompts || {};

            // ÎåÄÌôî Ïò§ÎîîÏò§ ÏÑπÏÖò
            let dialogueContentHtml = '';
            let fullDialogueForCopy = '';
            
            if (dialogueSequence.length > 0) {
                // ÏõêÎ≥∏ ÏàúÏÑúÎåÄÎ°ú ÎåÄÏÇ¨ ÌëúÏãú
                dialogueContentHtml = dialogueSequence.map(seq => {
                    const character = seq.character;
                    const lineData = dialogueByCharacter[character]?.lines[seq.line_index];
                    if (lineData) {
                        const displayText = `<strong>${character}:</strong> ${lineData.text || ''} <em>(Í∞êÏ†ï: ${lineData.emotion || '-'})</em>`;
                        fullDialogueForCopy += `${character}: ${lineData.text || ''} (Í∞êÏ†ï: ${lineData.emotion || '-'})\\n`;
                        return displayText;
                    }
                    return '';
                }).filter(text => text !== '').join('<br>');
            } else {
                dialogueContentHtml = 'ÎåÄÌôî ÎÇ¥Ïö©Ïù¥ ÏóÜÏäµÎãàÎã§.';
            }
            
            // Stage 8 audio_urls Íµ¨Ï°∞ ÌôïÏù∏ Î∞è Ï≤òÎ¶¨

            // Ï∫êÎ¶≠ÌÑ∞ ÏÑ†ÌÉù ÏòµÏÖò ÏÉùÏÑ±
            let characterOptionsHtml = Object.keys(dialogueByCharacter).map(charName => 
                `<option value="${charName}">${charName}</option>`
            ).join('');
            
            // TTSÏö© Ï¥àÍ∏∞ ÌëúÏãú ÌÖçÏä§Ìä∏
            let initialTtsDialogueText = '';
            if (Object.keys(dialogueByCharacter).length > 0) {
                const firstChar = Object.keys(dialogueByCharacter)[0];
                const firstCharLines = dialogueByCharacter[firstChar]?.lines || [];
                initialTtsDialogueText = firstCharLines.map(line => line.text).join('\n');
            }

            const dialogueHtml = `
                <div class="audio-section">
                    <h4>üé§ ÎåÄÌôî Ïò§ÎîîÏò§</h4>
                    ${(function() {
                        // Stage 8 Íµ¨Ï°∞ ÌôïÏù∏ (dialogueÍ∞Ä Í∞ùÏ≤¥Ïù∏ Í≤ΩÏö∞)
                        if (audioUrls.dialogue && typeof audioUrls.dialogue === 'object') {
                            // Ï∫êÎ¶≠ÌÑ∞Î≥Ñ Ïò§ÎîîÏò§ URL Ï≤òÎ¶¨
                            let characterAudioHtml = '';
                            for (const [character, urls] of Object.entries(audioUrls.dialogue)) {
                                const url = Array.isArray(urls) ? urls[0] : urls; // Î∞∞Ïó¥Ïù∏ Í≤ΩÏö∞ Ï≤´ Î≤àÏß∏ URL ÏÇ¨Ïö©
                                characterAudioHtml += `
                                    <div class="character-audio-section" style="margin-bottom: 15px; padding: 10px; background: #1a1a1a; border-radius: 5px;">
                                        <h5 style="margin: 0 0 10px 0;">${character}</h5>
                                        <div class="audio-player-area">
                                            ${url ? 
                                                `<audio controls style="width: 100%;" src="${processAudioUrl(url)}"></audio>` :
                                                `<div style="color: #999;">Ïò§ÎîîÏò§ URL ÏûÖÎ†• ÎåÄÍ∏∞</div>`
                                            }
                                        </div>
                                        <div class="form-group" style="margin-top: 10px;">
                                            <div style="display: flex; gap: 10px; align-items: center;">
                                                <input type="text" class="form-input" 
                                                       value="${url || ''}" 
                                                       placeholder="https://example.com/${character.replace(/\s/g, '_')}_dialogue.mp3" 
                                                       onchange="updateCharacterAudioUrl('${shot.id}', '${character}', this.value)"
                                                       onkeydown="if(event.key === 'Enter') { event.preventDefault(); this.blur(); }"
                                                       style="flex: 1;">
                                            </div>
                                        </div>
                                    </div>
                                `;
                            }
                            return characterAudioHtml || '<div style="color: #999;">Ï∫êÎ¶≠ÌÑ∞Î≥Ñ Ïò§ÎîîÏò§ URL ÏûÖÎ†•</div>';
                        } else {
                            // Í∏∞Ï°¥ Íµ¨Ï°∞ (Îã®Ïùº dialogue URL)
                            return `
                                <div class="audio-player-area">
                                    ${audioUrls.dialogue && typeof audioUrls.dialogue === 'string' ? 
                                        `<audio controls style="width: 100%;" src="${processAudioUrl(audioUrls.dialogue)}"></audio>` :
                                        `<div style="color: #999;">ÎåÄÌôî Ïò§ÎîîÏò§ URL ÏûÖÎ†•</div>`
                                    }
                                </div>
                                <div class="form-group">
                                    <label class="form-label">ÎåÄÌôî Ïò§ÎîîÏò§ URL (Ï†ÑÏ≤¥ ÌÜµÌï© ÌååÏùº)</label>
                                    <div style="display: flex; gap: 10px; align-items: center;">
                                        <input type="text" class="form-input" 
                                               value="${typeof audioUrls.dialogue === 'string' ? audioUrls.dialogue : ''}" 
                                               placeholder="https://example.com/dialogue.mp3" 
                                               onchange="updateAudioUrl('${shot.id}', 'dialogue', this.value)"
                                               onkeydown="if(event.key === 'Enter') { event.preventDefault(); this.blur(); }"
                                               style="flex: 1;">
                                    </div>
                                </div>
                            `;
                        }
                    })()}
                    </div>

                    <div class="info-section" style="padding:15px; background-color:#fcfcfc;">
                        <h5>ÎåÄÌôî ÎÇ¥Ïö© (Í≤ÄÌÜ†Ïö©)</h5>
                        <div class="audio-content-display" style="min-height:80px; white-space:normal;">${dialogueContentHtml}</div>
                        <button class="copy-btn btn-small" style="margin-top:5px;" 
                                onclick="copyToClipboard('${fullDialogueForCopy}').then(ok => ok && showMessage('Ï†ÑÏ≤¥ ÎåÄÌôî ÎÇ¥Ïö©Ïù¥ Î≥µÏÇ¨ÎêòÏóàÏäµÎãàÎã§.', 'success'))">
                            Ï†ÑÏ≤¥ ÎåÄÌôî ÎÇ¥Ïö© Î≥µÏÇ¨
                        </button>
                    </div>

                    <div class="info-section" style="padding:15px; background-color:#fcfcfc; margin-top:15px;">
                        <h5>TTSÏö© Ï∫êÎ¶≠ÌÑ∞Î≥Ñ ÎåÄÏÇ¨</h5>
                        <div class="form-group">
                            <label for="tts-char-select-${shot.id}" class="form-label">Ï∫êÎ¶≠ÌÑ∞ ÏÑ†ÌÉù:</label>
                            <select id="tts-char-select-${shot.id}" class="form-select" 
                                    onchange="updateTtsDialogueDisplay('${shot.id}')" 
                                    ${Object.keys(dialogueByCharacter).length === 0 ? 'disabled' : ''}>
                                <option value="_all">Ï†ÑÏ≤¥ ÎåÄÏÇ¨ (ÏàúÏÑúÎåÄÎ°ú)</option>
                                ${characterOptionsHtml || '<option value="">ÏÑ†ÌÉùÌï† Ï∫êÎ¶≠ÌÑ∞ ÏóÜÏùå</option>'}
                            </select>
                        </div>
                        <div class="audio-content-display" id="tts-dialogue-text-${shot.id}" style="min-height:60px;">
                            ${dialogueContentHtml}
                        </div>
                        <button class="copy-btn btn-small" style="margin-top:5px;" onclick="copyTtsDialogue('${shot.id}')">
                            ÏÑ†ÌÉùÌïú ÎåÄÏÇ¨ Î≥µÏÇ¨
                        </button>
                        ${audioPrompts.dialogue && Object.keys(audioPrompts.dialogue).length > 0 ? 
                            `<div style="margin-top:10px; padding:10px; background:#f0f0f0; border-radius:4px;">
                                <small style="color:#666;">Ï∞∏Í≥†: Ï∫êÎ¶≠ÌÑ∞Î≥Ñ Ïò§ÎîîÏò§ ÌîÑÎ°¨ÌîÑÌä∏Í∞Ä Ï°¥Ïû¨Ìï©ÎãàÎã§.</small>
                            </div>` : ''
                        }
                    </div>
                </div>
            `;

            // ÎÇòÎ†àÏù¥ÏÖò Ïò§ÎîîÏò§ ÏÑπÏÖò
            const narrationForCopy = (narration || '').replace(/'/g, "&#39;").replace(/\n/g, "\\n");
            const narrationTranslatedForCopy = (narrationTranslated || '').replace(/'/g, "&#39;").replace(/\n/g, "\\n");

            const narrationHtml = `
                <div class="audio-section">
                    <h4>üìñ ÎÇòÎ†àÏù¥ÏÖò Ïò§ÎîîÏò§</h4>
                    <div class="audio-player-area">
                        ${audioUrls.narration ? 
                            `<audio controls style="width: 100%;" src="${processAudioUrl(audioUrls.narration)}"></audio>` : 
                            `<div style="color: #999;">ÎÇòÎ†àÏù¥ÏÖò Ïò§ÎîîÏò§ URL ÏûÖÎ†•</div>`
                        }
                    </div>
                    <div class="form-group">
                        <label class="form-label">ÎÇòÎ†àÏù¥ÏÖò Ïò§ÎîîÏò§ URL</label>
                        <div style="display: flex; gap: 10px; align-items: center;">
                            <input type="text" class="form-input" value="${audioUrls.narration || ''}" 
                                   placeholder="https://example.com/narration.mp3" 
                                   onchange="updateAudioUrl('${shot.id}', 'narration', this.value)"
                                   onkeydown="if(event.key === 'Enter') { event.preventDefault(); this.blur(); }"
                                   style="flex: 1;">
                        </div>
                    </div>

                    <div class="info-section" style="padding:15px; background-color:#fcfcfc;">
                        <h5>ÎÇòÎ†àÏù¥ÏÖò ÎÇ¥Ïö©</h5>
                        <div class="audio-content-display" style="min-height:60px;">${narration || 'ÎÇòÎ†àÏù¥ÏÖòÏù¥ ÏóÜÏäµÎãàÎã§.'}</div>
                        ${narrationTranslated ? `
                            <div style="margin-top:10px;">
                                <label style="font-weight:500;">Î≤àÏó≠Îêú ÎÇòÎ†àÏù¥ÏÖò:</label>
                                <div class="audio-content-display" style="min-height:40px;">${narrationTranslated}</div>
                            </div>
                        ` : ''}
                        <button class="copy-btn btn-small" style="margin-top:5px;" 
                                onclick="copyToClipboard('${narrationForCopy}').then(ok => ok && showMessage('ÎÇòÎ†àÏù¥ÏÖòÏù¥ Î≥µÏÇ¨ÎêòÏóàÏäµÎãàÎã§.', 'success'))">
                            ÎÇòÎ†àÏù¥ÏÖò Î≥µÏÇ¨
                        </button>
                        ${narrationTranslated ? `
                            <button class="copy-btn btn-small" style="margin-top:5px; margin-left:5px;" 
                                    onclick="copyToClipboard('${narrationTranslatedForCopy}').then(ok => ok && showMessage('Î≤àÏó≠Îêú ÎÇòÎ†àÏù¥ÏÖòÏù¥ Î≥µÏÇ¨ÎêòÏóàÏäµÎãàÎã§.', 'success'))">
                                Î≤àÏó≠Î≥∏ Î≥µÏÇ¨
                            </button>
                        ` : ''}
                    </div>
                </div>
            `;

            // ÏùåÌñ• Ìö®Í≥º ÏÑπÏÖò
            const soundEffectsForCopy = (soundEffects || '').replace(/'/g, "&#39;").replace(/\n/g, "\\n");
            const soundEffectsEnForCopy = (soundEffectsEn || '').replace(/'/g, "&#39;").replace(/\n/g, "\\n");

            const soundEffectsHtml = `
                <div class="audio-section">
                    <h4>üîä ÏùåÌñ• Ìö®Í≥º</h4>
                    <div class="audio-player-area">
                        ${audioUrls.sound_effects ? 
                            `<audio controls style="width: 100%;" src="${processAudioUrl(audioUrls.sound_effects)}"></audio>` : 
                            `<div style="color: #999;">ÏùåÌñ• Ìö®Í≥º URL ÏûÖÎ†•</div>`
                        }
                    </div>
                    <div class="form-group">
                        <label class="form-label">ÏùåÌñ• Ìö®Í≥º URL</label>
                        <div style="display: flex; gap: 10px; align-items: center;">
                            <input type="text" class="form-input" value="${audioUrls.sound_effects || ''}" 
                                   placeholder="https://example.com/sound.mp3" 
                                   onchange="updateAudioUrl('${shot.id}', 'sound_effects', this.value)"
                                   onkeydown="if(event.key === 'Enter') { event.preventDefault(); this.blur(); }"
                                   style="flex: 1;">
                        </div>
                    </div>
                    ${soundEffects ? `
                    <div class="form-group">
                        <label class="form-label">ÏùåÌñ• Ìö®Í≥º ÏÑ§Î™Ö</label>
                        <div class="audio-content-display">${soundEffects}</div>
                        ${soundEffectsEn ? `
                            <div style="margin-top:10px;">
                                <label style="font-weight:500;">ÏòÅÎ¨∏ ÏÑ§Î™Ö:</label>
                                <div class="audio-content-display">${soundEffectsEn}</div>
                            </div>
                        ` : ''}
                        <button class="copy-btn btn-small" style="margin-top:5px;" 
                                onclick="copyToClipboard('${soundEffectsForCopy}').then(ok => ok && showMessage('ÏùåÌñ• ÏÑ§Î™ÖÏù¥ Î≥µÏÇ¨ÎêòÏóàÏäµÎãàÎã§.', 'success'))">
                            ÌïúÍ∏Ä ÏÑ§Î™Ö Î≥µÏÇ¨
                        </button>
                        ${soundEffectsEn ? `
                            <button class="copy-btn btn-small" style="margin-top:5px; margin-left:5px;" 
                                    onclick="copyToClipboard('${soundEffectsEnForCopy}').then(ok => ok && showMessage('ÏòÅÎ¨∏ ÏùåÌñ• ÏÑ§Î™ÖÏù¥ Î≥µÏÇ¨ÎêòÏóàÏäµÎãàÎã§.', 'success'))">
                                ÏòÅÎ¨∏ ÏÑ§Î™Ö Î≥µÏÇ¨
                            </button>
                        ` : ''}
                    </div>` : ''}
                </div>`;

            console.log('‚úÖ createShotAudioTab ÏôÑÎ£å');
            return `${dialogueHtml}${narrationHtml}${soundEffectsHtml}`;
        } catch (error) {
            console.error('‚ùå createShotAudioTab Ïò§Î•ò:', error);
            return `<div class="info-section"><h3>Ïò§ÎîîÏò§ ÌÉ≠ Î°úÎìú Ïò§Î•ò</h3><p>Ïò§Î•ò: ${error.message}</p></div>`;
        }
    }

    // ÌäπÏ†ï Ïù¥ÎØ∏ÏßÄÏóê ÎåÄÌïú ÏòÅÏÉÅ ÌîÑÎ°¨ÌîÑÌä∏ Ï∞æÍ∏∞
		function findVideoPromptsForImage(shotId, imageId, videoPrompts) {
		// Stage 7 ÌòïÏãùÏùò ÏòÅÏÉÅ ÌîÑÎ°¨ÌîÑÌä∏ Îç∞Ïù¥ÌÑ∞Í∞Ä ÏûàÎäî Í≤ΩÏö∞
		if (window.stage7VideoPrompts && window.stage7VideoPrompts[shotId]) {
			const imagePromptData = window.stage7VideoPrompts[shotId][imageId];
			if (imagePromptData && imagePromptData.prompts) {
				return imagePromptData.prompts;
			}
		}

		// Stage 7 Îç∞Ïù¥ÌÑ∞Í∞Ä ÏóÜÏúºÎ©¥ Îπà Í∞ùÏ≤¥ Î∞òÌôò
		return {};
	 }

	// Ïù¥ÎØ∏ÏßÄÎ≥Ñ AI Ïπ¥Îìú ÏÉùÏÑ±
	function createVideoAICards(shotId, imageId, videoPromptsForImage, videoUrls) {
		const aiTools = [
			{ id: 'luma', name: 'Luma AI' },
			{ id: 'kling', name: 'Kling AI' },
			{ id: 'veo2', name: 'Google Veo 2' },
			{ id: 'runway', name: 'Runway ML' }
		];

		return aiTools.map(ai => {
			const promptData = videoPromptsForImage[ai.id] || {};
			const prompt = promptData.prompt_en || promptData.main_prompt || '';
			const promptTranslated = promptData.prompt_translated || promptData.main_prompt_translated || '';
			const settings = promptData.settings || {};
			const url = videoUrls[`${ai.id}_${imageId}`] || videoUrls[ai.id] || '';

			const promptForCopy = prompt.replace(/'/g, "\\'").replace(/"/g, '\\"').replace(/\n/g, "\\n");

			let settingsHtml = '';
			if (Object.keys(settings).length > 0) {
				settingsHtml = `
					<div class="video-settings">
						${Object.entries(settings).map(([key, value]) => 
							`<span class="setting-item">${key}: ${value}</span>`
						).join(' ')}
					</div>
				`;
			}

			return `
				<div class="video-ai-card">
					<div class="ai-header ${ai.id}">
						<h5>${ai.name}</h5>
					</div>
					<div class="prompt-section">
						<div class="prompt-text">${prompt || 'ÌîÑÎ°¨ÌîÑÌä∏Í∞Ä ÏóÜÏäµÎãàÎã§.'}</div>
						${promptTranslated ? `<div class="prompt-translated">${promptTranslated}</div>` : ''}
						${settingsHtml}
						<button class="copy-btn" onclick="copyVideoPrompt('${promptForCopy}', '${ai.name}', '${imageId}')">
							ÌîÑÎ°¨ÌîÑÌä∏ Î≥µÏÇ¨
						</button>
					</div>
					<div class="video-url-section">
						<label>ÏÉùÏÑ±Îêú ÏòÅÏÉÅ URL:</label>
						<input type="url" 
							   placeholder="ÏòÅÏÉÅ URL ÏûÖÎ†•" 
							   value="${url}"
							   onchange="updateVideoUrl('${shotId}', '${ai.id}', '${imageId}', this.value)">
                      </div>
                    <div class="video-preview-section" style="margin-top: 10px;">
                        <div id="video-preview-${shotId}-${ai.id}-${imageId}" class="ai-video-preview">
                            ${(function(){
                                if (!url) return `<div style="color:#999;font-size:0.9rem;">ÏòÅÏÉÅ ÎØ∏Î¶¨Î≥¥Í∏∞</div>`;
                                const videoUrl = processVideoUrl(url);
                                if (videoUrl.includes('drive.google.com')) {
                                    return `<iframe style="max-width:100%;max-height:250px;border-radius:4px;border:none;" src="${videoUrl}" allowfullscreen onerror="console.error('Google Drive ÎπÑÎîîÏò§ Î°úÎìú Ïã§Ìå®:', '${videoUrl}'); this.style.display='none'; this.parentElement.innerHTML='<div style=&quot;color:#ff6b6b;font-size:0.9rem;&quot;>Google Drive ÏòÅÏÉÅ Î°úÎìú Ïã§Ìå®<br><small>ÌååÏùºÏù¥ Í≥µÍ∞úÎ°ú ÏÑ§Ï†ïÎêòÏñ¥ ÏûàÎäîÏßÄ ÌôïÏù∏ÌïòÏÑ∏Ïöî.</small></div>';"></iframe>`;
                                } else {
                                    return `<video controls style="max-width:100%;max-height:250px;border-radius:4px;" src="${videoUrl}" onerror="console.error('ÎπÑÎîîÏò§ Î°úÎìú Ïã§Ìå®:', '${videoUrl}'); this.style.display='none'; this.parentElement.innerHTML='<div style=&quot;color:#ff6b6b;font-size:0.9rem;&quot;>ÏòÅÏÉÅ Î°úÎìú Ïã§Ìå®<br><small>Î°úÏª¨ ÌååÏùºÏùÄ Î∏åÎùºÏö∞Ï†Ä Î≥¥Ïïà Ï†ïÏ±ÖÏúºÎ°ú Ïù∏Ìï¥ Ï†úÌïúÎê† Ïàò ÏûàÏäµÎãàÎã§.</small></div>';"></video>`;
                                }
                            })()}
                        </div>
                    </div>
                </div>
				
			`;
		}).join('');
	}

	// ÏòÅÏÉÅ ÌîåÎûú ÏÑ†ÌÉù Ìï®Ïàò
		function selectVideoPlan(shotId, planId) {
			try {
				const shot = currentData.breakdown_data.shots.find(s => s.id === shotId);
				if (!shot) return;

				// ÏòÅÏÉÅ ÌÉ≠ÏùÑ ÏúÑÌïú ÏûÑÏãú ÏÑ†ÌÉù ÏÉÅÌÉú Ï†ÄÏû•
				if (!window.videoTabSelectedPlans) {
					window.videoTabSelectedPlans = {};
				}
				window.videoTabSelectedPlans[shotId] = planId;

				showMessage(`ÌîåÎûú ${planId}Ïùò ÏòÅÏÉÅ ÌîÑÎ°¨ÌîÑÌä∏Î•º ÌëúÏãúÌï©ÎãàÎã§.`, 'info');

				// ÏòÅÏÉÅ ÌÉ≠ Îã§Ïãú Î†åÎçîÎßÅ
				const videoTab = document.getElementById('tab-video');
				if (videoTab) {
					videoTab.innerHTML = createShotVideoTab(shot);
				}
			} catch (e) {
				showMessage('ÌîåÎûú ÏÑ†ÌÉù Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§.', 'error');
			}
		}

	// ÏòÅÏÉÅ ÌîÑÎ°¨ÌîÑÌä∏ Î≥µÏÇ¨
	function copyVideoPrompt(prompt, aiName, imageId) {
		const actualPromptText = prompt.replace(/\\n/g, "\n");
		if (!actualPromptText || actualPromptText.trim() === 'ÌîÑÎ°¨ÌîÑÌä∏Í∞Ä ÏóÜÏäµÎãàÎã§.') {
			return showMessage(`${aiName} ÌîÑÎ°¨ÌîÑÌä∏Í∞Ä ÎπÑÏñ¥ ÏûàÏäµÎãàÎã§.`, 'warning');
		}
		copyToClipboard(actualPromptText).then(success => {
			if (success) {
				showMessage(`${aiName} ÏòÅÏÉÅ ÌîÑÎ°¨ÌîÑÌä∏ (${imageId})Í∞Ä Î≥µÏÇ¨ÎêòÏóàÏäµÎãàÎã§.`, 'success');
			}
		});
	}

	// Î°úÏª¨ ÌååÏùº Í≤ΩÎ°úÎ•º file:// URLÎ°ú Î≥ÄÌôòÌïòÍ≥† Google Drive URL Ï≤òÎ¶¨
	function processVideoUrl(url) {
		if (!url) return url;
		
		// ÎìúÎ°≠Î∞ïÏä§ URL Ï≤òÎ¶¨
		if (url.includes('dropbox.com')) {
			// dl=0ÏùÑ dl=1Î°ú Î≥ÄÍ≤ΩÌïòÏó¨ ÏßÅÏ†ë Îã§Ïö¥Î°úÎìú URLÎ°ú Î≥ÄÌôò
			if (url.includes('dl=0')) {
				return url.replace('dl=0', 'raw=1');
			} else if (!url.includes('raw=')) {
				// raw ÌååÎùºÎØ∏ÌÑ∞Í∞Ä ÏóÜÏúºÎ©¥ Ï∂îÍ∞Ä
				const separator = url.includes('?') ? '&' : '?';
				return url + separator + 'raw=1';
			}
			return url;
		}
		
		// Google Drive URL Ï≤òÎ¶¨
		if (url.includes('drive.google.com')) {
			const fileId = extractGoogleDriveFileId(url);
			if (fileId) {
				// Google Drive ÏûÑÎ≤†Îìú URLÎ°ú Î≥ÄÌôò
				return `https://drive.google.com/file/d/${fileId}/preview`;
			}
		}
		
		// Windows Í≤ΩÎ°ú ÌòïÏãù (C:\path\to\file.mp4) Ï≤òÎ¶¨
		if (url.match(/^[A-Za-z]:\\/)) {
			return 'file:///' + url.replace(/\\/g, '/');
		}
		// Mac/Linux Ï†àÎåÄ Í≤ΩÎ°ú (/path/to/file.mp4) Ï≤òÎ¶¨
		else if (url.startsWith('/') && !url.startsWith('//')) {
			return 'file://' + url;
		}
		
		return url;
	}
	
	// Google Drive ÌååÏùº ID Ï∂îÏ∂ú Ìï®Ïàò
	function extractGoogleDriveFileId(url) {
		const patterns = [
			/\/file\/d\/([a-zA-Z0-9-_]+)/,
			/[?&]id=([a-zA-Z0-9-_]+)/,
			/\/d\/([a-zA-Z0-9-_]+)/,
			/\/view\?id=([a-zA-Z0-9-_]+)/
		];
		
		for (const pattern of patterns) {
			const match = url.match(pattern);
			if (match) {
				return match[1];
			}
		}
		
		return null;
	}

	// Ïù¥ÎØ∏ÏßÄÎ≥Ñ ÏòÅÏÉÅ URL ÏóÖÎç∞Ïù¥Ìä∏
	function updateVideoUrl(shotId, aiType, imageId, url) {
		try {
			const shot = currentData.breakdown_data.shots.find(s => s.id === shotId);
			if (!shot) return;

			if (!shot.video_urls) shot.video_urls = {};

			// Ïù¥ÎØ∏ÏßÄÎ≥Ñ URL Ï†ÄÏû• (ai_imageId ÌòïÏãù)
			shot.video_urls[`${aiType}_${imageId}`] = url;

			saveDataToLocalStorage();

			// ÎØ∏Î¶¨Î≥¥Í∏∞ ÏóÖÎç∞Ïù¥Ìä∏ - ÏïàÏ†ÑÌïú Î∞©Ïãù ÏÇ¨Ïö©
			const previewElement = document.getElementById(`video-preview-${shotId}-${aiType}-${imageId}`);
			if (previewElement) {
				try {
					if (url) {
						const safeContent = createSafeIframe(url, 'max-width:100%;max-height:250px;border-radius:4px;border:none;');
						previewElement.innerHTML = safeContent;
					} else {
						previewElement.innerHTML = `<div style="color:#999;font-size:0.9rem;">ÏòÅÏÉÅ ÎØ∏Î¶¨Î≥¥Í∏∞</div>`;
					}
				} catch (e) {
					previewElement.innerHTML = `<div style="color:#ff6b6b;font-size:0.9rem;">ÎØ∏Î¶¨Î≥¥Í∏∞ ÏóÖÎç∞Ïù¥Ìä∏ Ïã§Ìå®</div>`;
				}
			}

			// Ïî¨ ÏòÅÏÉÅ Í∞§Îü¨Î¶¨ Ïû¨Î†åÎçîÎßÅ (ÌòÑÏû¨ ÌôúÏÑ±ÌôîÎêú Í≤ΩÏö∞) - debounce Ï†ÅÏö©
			setTimeout(() => {
				refreshSceneVideoGalleryIfActive(shot.scene_id);
			}, 100);

			showMessage(`${aiType.toUpperCase()} ÏòÅÏÉÅ URL (${imageId})Ïù¥ Ï†ÄÏû•ÎêòÏóàÏäµÎãàÎã§.`, 'success');
		} catch (e) {
			showMessage('ÏòÅÏÉÅ URL ÏóÖÎç∞Ïù¥Ìä∏ Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§.', 'error');
		}
	}
    // AI ÏòÅÏÉÅ ÌîÑÎ°¨ÌîÑÌä∏ Î≥µÏÇ¨
    function copyAIPrompt(promptText, aiName) {
        const actualPromptText = promptText.replace(/\\n/g, "\n");
        if (!actualPromptText || actualPromptText.trim() === 'ÌîÑÎ°¨ÌîÑÌä∏Í∞Ä ÏóÜÏäµÎãàÎã§.') {
            return showMessage(`${aiName} ÌîÑÎ°¨ÌîÑÌä∏Í∞Ä ÎπÑÏñ¥ ÏûàÏñ¥ Î≥µÏÇ¨Ìï† Ïàò ÏóÜÏäµÎãàÎã§.`, 'warning');
        }
        copyToClipboard(actualPromptText).then(ok => {
            if (ok) showMessage(`${aiName} ÏòÅÏÉÅ ÌîÑÎ°¨ÌîÑÌä∏Í∞Ä Î≥µÏÇ¨ÎêòÏóàÏäµÎãàÎã§.`, 'success');
        });
    }

    // AIÎ≥Ñ ÏòÅÏÉÅ URL ÏóÖÎç∞Ïù¥Ìä∏
    function updateAIVideoUrl(shotId, aiType, newUrl) {
        try {
            const shot = currentData.breakdown_data.shots.find(s => s.id === shotId);
            if (!shot) return showMessage('ÏÉ∑ Îç∞Ïù¥ÌÑ∞Î•º Ï∞æÏùÑ Ïàò ÏóÜÏäµÎãàÎã§.', 'error');
            
            if (!shot.video_urls) shot.video_urls = {};
            shot.video_urls[aiType] = newUrl;
            
            if (!shot.video_design) shot.video_design = { ai_tool: '', video_url: '', selected_ai: null };
            
            if (shot.video_design.selected_ai === aiType) {
                shot.video_design.video_url = newUrl;
                const legacyUrlCell = document.getElementById(`legacy-video-url-${shot.id}`);
                if (legacyUrlCell) legacyUrlCell.textContent = newUrl || '-';
                
                const legacyAiToolCell = document.getElementById(`legacy-ai-tool-${shot.id}`);
                if (legacyAiToolCell) legacyAiToolCell.textContent = aiType || '-';
            }
            
            saveDataToLocalStorage();
            
            const preview = document.getElementById(`video-preview-${shot.id}-${aiType}`);
            if (preview) {
                try {
                    if (newUrl) {
                        const safeContent = createSafeIframe(newUrl, 'max-width:100%;max-height:200px;border-radius:6px;border:none;');
                        preview.innerHTML = safeContent;
                    } else {
                        preview.innerHTML = `<div style="color:#999;font-size:0.9rem;">URL ÏûÖÎ†•</div>`;
                    }
                } catch (e) {
                    preview.innerHTML = `<div style="color:#ff6b6b;font-size:0.9rem;">ÎØ∏Î¶¨Î≥¥Í∏∞ ÏóÖÎç∞Ïù¥Ìä∏ Ïã§Ìå®</div>`;
                }
            }

            // Ïî¨ ÏòÅÏÉÅ Í∞§Îü¨Î¶¨ Ïû¨Î†åÎçîÎßÅ (ÌòÑÏû¨ ÌôúÏÑ±ÌôîÎêú Í≤ΩÏö∞) - debounce Ï†ÅÏö©
            setTimeout(() => {
                refreshSceneVideoGalleryIfActive(shot.scene_id);
            }, 100);
            
        } catch (e) {
            showMessage('ÏòÅÏÉÅ URL ÏóÖÎç∞Ïù¥Ìä∏ Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§.', 'error');
        }
    }

    // ÏµúÏ¢Ö AI ÏÑ†ÌÉù
    function selectFinalAI(shotId, aiType) {
        try {
            const shot = currentData.breakdown_data.shots.find(s => s.id === shotId);
            if (!shot) return showMessage('ÏÉ∑ Îç∞Ïù¥ÌÑ∞Î•º Ï∞æÏùÑ Ïàò ÏóÜÏäµÎãàÎã§.', 'error');
            
            if (!shot.video_design) {
                shot.video_design = { ai_tool: aiType, video_url: '', selected_ai: aiType };
            } else {
                shot.video_design.selected_ai = aiType;
                shot.video_design.ai_tool = aiType;
            }
            
            if (!shot.video_urls) shot.video_urls = {};
            shot.video_design.video_url = shot.video_urls[aiType] || '';
            
            saveDataToLocalStorage();
            
            // UI ÏóÖÎç∞Ïù¥Ìä∏
            ['luma', 'kling', 'veo2', 'runway'].forEach(id => {
                const card = document.getElementById(`ai-card-${shot.id}-${id}`);
                const btn = document.getElementById(`select-btn-${shot.id}-${id}`);
                
                if (card && btn) {
                    if (id === aiType) {
                        card.classList.add('selected-ai-card');
                        btn.classList.add('selected');
                        btn.textContent = '‚úì ÏµúÏ¢Ö ÏÑ†ÌÉùÎê®';
                    } else {
                        card.classList.remove('selected-ai-card');
                        btn.classList.remove('selected');
                        btn.textContent = `Ïù¥ AIÎ°ú ÏµúÏ¢Ö ÏÑ†ÌÉù`;
                    }
                }
            });
            
            const legacyUrlCell = document.getElementById(`legacy-video-url-${shot.id}`);
            if (legacyUrlCell) legacyUrlCell.textContent = shot.video_design.video_url || '-';
            
            const legacyAiToolCell = document.getElementById(`legacy-ai-tool-${shot.id}`);
            if (legacyAiToolCell) legacyAiToolCell.textContent = aiType || '-';
            
            showMessage(`${aiType}Ïù¥(Í∞Ä) ÏµúÏ¢Ö ÏòÅÏÉÅÏúºÎ°ú ÏÑ†ÌÉùÎêòÏóàÏäµÎãàÎã§.`, 'success');
        } catch (e) {
            showMessage('ÏµúÏ¢Ö AI ÏÑ†ÌÉù Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§.', 'error');
        }
    }

    // TTSÏö© ÎåÄÌôî ÌëúÏãú ÏóÖÎç∞Ïù¥Ìä∏
    function updateTtsDialogueDisplay(shotId) {
        try {
            const shot = currentData.breakdown_data.shots.find(s => s.id === shotId);
            const selectElement = document.getElementById(`tts-char-select-${shotId}`);
            const displayElement = document.getElementById(`tts-dialogue-text-${shotId}`);

            if (shot && selectElement && displayElement && shot.content) {
                const selectedValue = selectElement.value;
                
                if (selectedValue === '_all') {
                    // Ï†ÑÏ≤¥ ÎåÄÏÇ¨Î•º ÏàúÏÑúÎåÄÎ°ú ÌëúÏãú
                    const dialogueSequence = shot.content.dialogue_sequence || [];
                    const dialogueByCharacter = shot.content.dialogue_by_character || {};
                    
                    const allDialogueText = dialogueSequence.map(seq => {
                        const character = seq.character;
                        const lineData = dialogueByCharacter[character]?.lines[seq.line_index];
                        if (lineData) {
                            return lineData.text || '';
                        }
                        return '';
                    }).filter(text => text !== '').join('\n');
                    
                    displayElement.innerHTML = allDialogueText.replace(/\n/g, "<br>");
                } else {
                    // ÌäπÏ†ï Ï∫êÎ¶≠ÌÑ∞Ïùò ÎåÄÏÇ¨Îßå ÌëúÏãú
                    const dialogueByCharacter = shot.content.dialogue_by_character || {};
                    const characterData = dialogueByCharacter[selectedValue];
                    
                    if (characterData && characterData.lines) {
                        const characterLines = characterData.lines.map(line => line.text || '').join('\n');
                        displayElement.innerHTML = characterLines.replace(/\n/g, "<br>");
                    } else {
                        displayElement.innerHTML = 'ÏÑ†ÌÉùÎêú Ï∫êÎ¶≠ÌÑ∞Ïùò ÎåÄÏÇ¨Í∞Ä ÏóÜÏäµÎãàÎã§.';
                    }
                }
            }
        } catch (error) {
        }
    }

    // TTSÏö© ÎåÄÏÇ¨ Î≥µÏÇ¨
    function copyTtsDialogue(shotId) {
        try {
            const selectElement = document.getElementById(`tts-char-select-${shotId}`);
            const shot = currentData.breakdown_data.shots.find(s => s.id === shotId);

            if (selectElement && shot && shot.content) {
                const selectedValue = selectElement.value;
                let dialogueText = '';
                
                if (selectedValue === '_all') {
                    // Ï†ÑÏ≤¥ ÎåÄÏÇ¨Î•º ÏàúÏÑúÎåÄÎ°ú
                    const dialogueSequence = shot.content.dialogue_sequence || [];
                    const dialogueByCharacter = shot.content.dialogue_by_character || {};
                    
                    dialogueText = dialogueSequence.map(seq => {
                        const character = seq.character;
                        const lineData = dialogueByCharacter[character]?.lines[seq.line_index];
                        return lineData ? lineData.text || '' : '';
                    }).filter(text => text !== '').join('\n');
                } else {
                    // ÌäπÏ†ï Ï∫êÎ¶≠ÌÑ∞Ïùò ÎåÄÏÇ¨Îßå
                    const dialogueByCharacter = shot.content.dialogue_by_character || {};
                    const characterData = dialogueByCharacter[selectedValue];
                    
                    if (characterData && characterData.lines) {
                        dialogueText = characterData.lines.map(line => line.text || '').join('\n');
                    }
                }
                
                if (dialogueText.trim() === '') {
                    showMessage('Î≥µÏÇ¨Ìï† ÎåÄÏÇ¨Í∞Ä ÏóÜÏäµÎãàÎã§.', 'warning');
                    return;
                }
                
                copyToClipboard(dialogueText).then(ok => {
                    if (ok) {
                        const message = selectedValue === '_all' ? 
                            'Ï†ÑÏ≤¥ ÎåÄÏÇ¨Í∞Ä Î≥µÏÇ¨ÎêòÏóàÏäµÎãàÎã§.' : 
                            `${selectedValue}Ïùò ÎåÄÏÇ¨Í∞Ä Î≥µÏÇ¨ÎêòÏóàÏäµÎãàÎã§.`;
                        showMessage(message, 'success');
                    }
                });
            } else {
                showMessage('Î≥µÏÇ¨Ìï† ÎåÄÏÇ¨Î•º Ï∞æÏùÑ Ïàò ÏóÜÏäµÎãàÎã§.', 'warning');
            }
        } catch (error) {
            showMessage('TTS ÎåÄÏÇ¨ Î≥µÏÇ¨ Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§.', 'error');
        }
    }

    // ÏÉ∑ ÏùåÏïÖ ÌÉ≠ ÏÉùÏÑ±
    function createShotMusicTab(shot) {
        console.log('üéµ createShotMusicTab ÏãúÏûë');
        try {
            const projectMusicPrompts = currentData.film_metadata?.project_music_prompts || {};
            const projectMusicUrls = currentData.film_metadata?.project_music_urls || {};
            const shotMusicMemo = shot.music_memo || '';

            const createProjectOstSection = (ostType, title, emoji) => {
    const ostPromptData = projectMusicPrompts[ostType];
    const ostUrl = projectMusicUrls[ostType] || '';

    if (!ostPromptData) {
        return `
            <div class="music-ost-section">
                <h4>${emoji} ${title} (ÌîÑÎ°úÏ†ùÌä∏)</h4>
                <div style="text-align:center;padding:20px;color:#999;">
                    ${title} ÌîÑÎ°¨ÌîÑÌä∏ Ï†ïÎ≥¥Í∞Ä ÏóÜÏäµÎãàÎã§.
                </div>
            </div>`;
    }

    const stylePrompt = ostPromptData.style_prompt || 'Ïä§ÌÉÄÏùº ÌîÑÎ°¨ÌîÑÌä∏Í∞Ä ÏóÜÏäµÎãàÎã§.';
    const lyricsPrompt = ostPromptData.lyrics_structure_prompt || 'Í∞ÄÏÇ¨&Íµ¨Ï°∞ ÌîÑÎ°¨ÌîÑÌä∏Í∞Ä ÏóÜÏäµÎãàÎã§.';
    const stylePromptForCopy = stylePrompt.replace(/'/g, "&#39;").replace(/\n/g, "\\n");
    const lyricsPromptForCopy = lyricsPrompt.replace(/'/g, "&#39;").replace(/\n/g, "\\n");

    return `
        <div class="music-ost-section">
            <h4>${emoji} ${title} (ÌîÑÎ°úÏ†ùÌä∏ Ï†ÑÏ≤¥)</h4>
            <div class="audio-player-area" style="margin-bottom:15px;">
                ${ostUrl ? 
                    `<audio controls style="width: 100%;" src="${processAudioUrl(ostUrl)}"></audio>` : 
                    `<div style="color: #999;">${title} URL ÏûÖÎ†• (ÌîÑÎ°úÏ†ùÌä∏ Î†àÎ≤®)</div>`
                }
            </div>
            <div class="form-group">
                <label class="form-label">${title} URL (ÌîÑÎ°úÏ†ùÌä∏ Ï†ÑÏ≤¥)</label>
                <input type="text" class="form-input" value="${ostUrl}" 
                       placeholder="https://example.com/${ostType}.mp3" 
                       onchange="updateProjectMusicUrl('${ostType}', this.value)">
            </div>
            <div class="ost-prompt-grid">
                <div class="ost-prompt-item">
                    <div class="prompt-title">Ïä§ÌÉÄÏùº ÌîÑÎ°¨ÌîÑÌä∏</div>
                    <div class="prompt-text">${stylePrompt}</div>
                    <button class="copy-btn btn-small" 
                            onclick="copyToClipboard('${stylePromptForCopy}').then(ok => ok && showMessage('${title} Ïä§ÌÉÄÏùº ÌîÑÎ°¨ÌîÑÌä∏Í∞Ä Î≥µÏÇ¨ÎêòÏóàÏäµÎãàÎã§.', 'success'))">
                        Î≥µÏÇ¨
                    </button>
                </div>
                <div class="ost-prompt-item">
                    <div class="prompt-title">Í∞ÄÏÇ¨ & Íµ¨Ï°∞ ÌîÑÎ°¨ÌîÑÌä∏</div>
                    <div class="prompt-text">${lyricsPrompt}</div>
                    <button class="copy-btn btn-small" 
                            onclick="copyToClipboard('${lyricsPromptForCopy}').then(ok => ok && showMessage('${title} Í∞ÄÏÇ¨/Íµ¨Ï°∞ ÌîÑÎ°¨ÌîÑÌä∏Í∞Ä Î≥µÏÇ¨ÎêòÏóàÏäµÎãàÎã§.', 'success'))">
                        Î≥µÏÇ¨
                    </button>
                </div>
            </div>
        </div>`;
};
const mainOstHtml = createProjectOstSection('main_ost', 'Î©îÏù∏ OST', 'üéº');
            const subOst1Html = createProjectOstSection('sub_ost_1', 'ÏÑúÎ∏å OST 1', 'üéµ');
            const subOst2Html = createProjectOstSection('sub_ost_2', 'ÏÑúÎ∏å OST 2', 'üé∂');
            
            const shotMusicMemoHtml = `
                <div class="info-section">
                    <h3>üìù Ïù¥ ÏÉ∑Ïùò ÏùåÏïÖ Í¥ÄÎ†® Î©îÎ™®</h3>
                    <div class="form-group">
                        <label class="form-label">ÏÉ∑ ÏùåÏïÖ Ï†ÅÏö© ÎÖ∏Ìä∏ (Ïòà: Ïù¥ ÏÉ∑Î∂ÄÌÑ∞ Î©îÏù∏ ÌÖåÎßà ÏÇ¨Ïö©):</label>
                        <textarea class="form-textarea" 
                                  style="min-height: 100px;"
                                  placeholder="Ïù¥ ÏÉ∑Ïóê Ï†ÅÏö©Îê† ÏùåÏïÖÏóê ÎåÄÌïú Íµ¨Ï≤¥Ï†ÅÏù∏ ÏßÄÏãúÏÇ¨Ìï≠Ïù¥ÎÇò ÏïÑÏù¥ÎîîÏñ¥Î•º ÏûÖÎ†•ÌïòÏÑ∏Ïöî..."
                                  onchange="updateShotMusicMemo('${shot.id}', this.value)">${shotMusicMemo}</textarea>
                        <small style="color:#777; font-size:0.85em;">Ïù¥ Î©îÎ™®Îäî ÌòÑÏû¨ ÏÑ†ÌÉùÎêú ÏÉ∑(${shot.id})ÏóêÎßå Ìï¥ÎãπÎê©ÎãàÎã§.</small>
                    </div>
                </div>`;

            return `${mainOstHtml}${subOst1Html}${subOst2Html}${shotMusicMemoHtml}`;
        } catch (error) {
            console.error('‚ùå createShotMusicTab Ïò§Î•ò:', error);
            return `<div class="info-section"><h3>ÏùåÏïÖ ÌÉ≠ Î°úÎìú Ïò§Î•ò</h3><p>Ïò§Î•ò Î©îÏãúÏßÄ: ${error.message}</p></div>`;
        }
    }

    // ÌîÑÎ°úÏ†ùÌä∏ Î†àÎ≤® ÏùåÏïÖ URL ÏóÖÎç∞Ïù¥Ìä∏
    function updateProjectMusicUrl(ostType, newUrl) {
        try {
            if (!currentData.film_metadata) currentData.film_metadata = {};
            if (!currentData.film_metadata.project_music_urls) currentData.film_metadata.project_music_urls = {};
            
            currentData.film_metadata.project_music_urls[ostType] = newUrl;
            saveDataToLocalStorage();
            
            // ÌòÑÏû¨ ÌÉ≠Ïù¥ ÏùåÏïÖ ÌÉ≠Ïù¥ÎùºÎ©¥ UI Ï¶âÏãú Í∞±Ïã†
            const activeTabId = document.querySelector('.tab-button.active')?.getAttribute('onclick').match(/'([^']+)'/)[1];
            if (activeTabId === 'music' && selectedType === 'shot' && selectedId) {
                showShotContent(selectedId);
                setTimeout(() => switchTab('music', selectedId), 0);
            }
            showMessage(`ÌîÑÎ°úÏ†ùÌä∏ ${ostType} URLÏù¥ ÏóÖÎç∞Ïù¥Ìä∏ÎêòÏóàÏäµÎãàÎã§.`, 'success');
        } catch (error) {
            showMessage('ÌîÑÎ°úÏ†ùÌä∏ ÏùåÏïÖ URL ÏóÖÎç∞Ïù¥Ìä∏ Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§.', 'error');
        }
    }

    // ÏÉ∑Î≥Ñ ÏùåÏïÖ Î©îÎ™® ÏóÖÎç∞Ïù¥Ìä∏
    function updateShotMusicMemo(shotId, memo) {
        try {
            const shot = currentData.breakdown_data.shots.find(s => s.id === shotId);
            if (!shot) return showMessage('ÏÉ∑ Îç∞Ïù¥ÌÑ∞Î•º Ï∞æÏùÑ Ïàò ÏóÜÏäµÎãàÎã§.', 'error');
            
            shot.music_memo = memo;
            saveDataToLocalStorage();
            showMessage(`ÏÉ∑ ${shotId}Ïùò ÏùåÏïÖ Î©îÎ™®Í∞Ä ÏóÖÎç∞Ïù¥Ìä∏ÎêòÏóàÏäµÎãàÎã§.`, 'success');
        } catch (error) {
            showMessage('ÏÉ∑ ÏùåÏïÖ Î©îÎ™® ÏóÖÎç∞Ïù¥Ìä∏ Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§.', 'error');
        }
    }
    
    // Î©îÎ™® Í¥ÄÎ¶¨ Ìï®ÏàòÎì§
    function getShotMemo(shotId) {
        try {
            const memos = JSON.parse(localStorage.getItem('shotMemos') || '{}');
            return memos[shotId] || '';
        } catch (e) {
            return '';
        }
    }

    function updateShotMemo(shotId, memo) {
        try {
            const memos = JSON.parse(localStorage.getItem('shotMemos') || '{}');
            memos[shotId] = memo;
            localStorage.setItem('shotMemos', JSON.stringify(memos));
        } catch (e) {
            showMessage('Î©îÎ™® Ï†ÄÏû•Ïóê Ïã§Ìå®ÌñàÏäµÎãàÎã§.', 'error');
        }
    }
    
    // Ïò§ÎîîÏò§ URL ÏóÖÎç∞Ïù¥Ìä∏
    // ÌååÏùºÎ™ÖÏùÑ ÏïàÏ†ÑÌïòÍ≤å Ïù∏ÏΩîÎî©ÌïòÎäî Ìï®Ïàò
    function encodeFileName(fileName) {
        return encodeURIComponent(fileName).replace(/'/g, '%27').replace(/"/g, '%22');
    }

    // ÌååÏùºÎ™ÖÏùÑ ÎîîÏΩîÎî©ÌïòÎäî Ìï®Ïàò
    function decodeFileName(encodedFileName) {
        return decodeURIComponent(encodedFileName);
    }

    // Ïò§ÎîîÏò§ URL Ï≤òÎ¶¨ Ìï®Ïàò
    function processAudioUrl(url) {
        if (!url || typeof url !== 'string') return '';
        
        // [Î°úÏª¨ ÌååÏùº] Ï†ëÎëêÏÇ¨Í∞Ä ÏûàÎäî Í≤ΩÏö∞ Ïã§Ï†ú Base64 Îç∞Ïù¥ÌÑ∞ Î∞òÌôò
        if (url.startsWith('[Î°úÏª¨ ÌååÏùº]')) {
            const fileName = url.replace('[Î°úÏª¨ ÌååÏùº] ', '');
            
            // Î©îÎ™®Î¶¨ÏóêÏÑú Ï∞æÍ∏∞
            if (window.localAudioFiles && window.localAudioFiles[fileName]) {
                return window.localAudioFiles[fileName];
            }
            
            // localStorageÏóêÏÑú Ï∞æÍ∏∞
            try {
                const jsonFileName = getProjectFileName();
                const audioFilesKey = `audioFiles_${jsonFileName}`;
                const audioFiles = JSON.parse(localStorage.getItem(audioFilesKey) || '{}');
                if (audioFiles[fileName]) {
                    // Î©îÎ™®Î¶¨ÏóêÎèÑ Ï∫êÏãú
                    if (!window.localAudioFiles) window.localAudioFiles = {};
                    window.localAudioFiles[fileName] = audioFiles[fileName];
                    return audioFiles[fileName];
                }
            } catch (e) {
            }
            
            // ÌååÏùºÏùÑ Ï∞æÏùÑ Ïàò ÏóÜÎäî Í≤ΩÏö∞
            return '';
        }
        
        // ÎìúÎ°≠Î∞ïÏä§ URL Ï≤òÎ¶¨
        if (url.includes('dropbox.com')) {
            // dl=0ÏùÑ dl=1Î°ú Î≥ÄÍ≤ΩÌïòÏó¨ ÏßÅÏ†ë Îã§Ïö¥Î°úÎìú URLÎ°ú Î≥ÄÌôò
            if (url.includes('dl=0')) {
                return url.replace('dl=0', 'dl=1');
            } else if (!url.includes('dl=')) {
                // dl ÌååÎùºÎØ∏ÌÑ∞Í∞Ä ÏóÜÏúºÎ©¥ Ï∂îÍ∞Ä
                const separator = url.includes('?') ? '&' : '?';
                return url + separator + 'dl=1';
            }
            return url;
        }
        
        // URLÏù¥ Ïù¥ÎØ∏ ÏôÑÏ†ÑÌïú ÌòïÌÉúÎùºÎ©¥ Í∑∏ÎåÄÎ°ú Î∞òÌôò
        if (url.startsWith('http://') || url.startsWith('https://') || url.startsWith('data:')) {
            return url;
        }
        
        // ÏùºÎ∞ò ÌååÏùº Í≤ΩÎ°úÏùò Í≤ΩÏö∞ Ïù∏ÏΩîÎî©
        return encodeURI(url);
    }

    function updateAudioUrl(shotId, audioType, newUrl) {
        try {
            const shot = currentData.breakdown_data.shots.find(sh => sh.id === shotId);
            if (!shot) return;
            
            if (!shot.content) shot.content = {};
            if (!shot.content.audio_urls) shot.content.audio_urls = {};
            
            // dialogueÏùò Í≤ΩÏö∞ Í∞ùÏ≤¥Ïùº Ïàò ÏûàÏúºÎØÄÎ°ú ÌäπÎ≥Ñ Ï≤òÎ¶¨
            if (audioType === 'dialogue') {
                // Ï†ÑÏ≤¥ ÌÜµÌï© ÌååÏùº URLÎ°ú Ï†ÄÏû•
                shot.content.audio_urls.dialogue = newUrl;
            } else {
                shot.content.audio_urls[audioType] = newUrl;
            }
            
            saveDataToLocalStorage();
            
            // ÌòÑÏû¨ Ïä§ÌÅ¨Î°§ ÏúÑÏπò Ï†ÄÏû•
            const currentScrollTop = window.pageYOffset || document.documentElement.scrollTop;
            
            // ÌòÑÏû¨ ÌÉ≠ Ïú†ÏßÄ
            const tab = document.querySelector('.tab-button.active')?.getAttribute('onclick').match(/'([^']+)'/)[1];
            showShotContent(shotId);
            
            // Ï¶âÏãú Ïä§ÌÅ¨Î°§ ÏúÑÏπò Î≥µÏõê
            requestAnimationFrame(() => {
                window.scrollTo(0, currentScrollTop);
                
                if (tab) {
                    switchTab(tab, shotId);
                    // ÌÉ≠ Ï†ÑÌôò ÌõÑÏóêÎèÑ Îã§Ïãú Ïä§ÌÅ¨Î°§ ÏúÑÏπò Î≥µÏõê
                    requestAnimationFrame(() => {
                        window.scrollTo(0, currentScrollTop);
                    });
                }
            });
            
            showMessage(`${audioType} Ïò§ÎîîÏò§ URLÏù¥ ÏóÖÎç∞Ïù¥Ìä∏ÎêòÏóàÏäµÎãàÎã§.`, 'success');
        } catch (e) {
            showMessage('Ïò§ÎîîÏò§ URL ÏóÖÎç∞Ïù¥Ìä∏Ïóê Ïã§Ìå®ÌñàÏäµÎãàÎã§.', 'error');
        }
    }
    
    // Ï∫êÎ¶≠ÌÑ∞Î≥Ñ Ïò§ÎîîÏò§ URL ÏóÖÎç∞Ïù¥Ìä∏ Ìï®Ïàò (Stage 8 ÏßÄÏõê)
    function updateCharacterAudioUrl(shotId, character, newUrl) {
        try {
            const shot = currentData.breakdown_data.shots.find(sh => sh.id === shotId);
            if (!shot) return;
            
            if (!shot.content) shot.content = {};
            if (!shot.content.audio_urls) shot.content.audio_urls = {};
            if (!shot.content.audio_urls.dialogue || typeof shot.content.audio_urls.dialogue === 'string') {
                // Í∏∞Ï°¥Ïù¥ Î¨∏ÏûêÏó¥Ïù¥Î©¥ Í∞ùÏ≤¥Î°ú Î≥ÄÌôò
                shot.content.audio_urls.dialogue = {};
            }
            
            // Ï∫êÎ¶≠ÌÑ∞Î≥Ñ URL Ï†ÄÏû• (Î∞∞Ïó¥ ÌòïÌÉú Ïú†ÏßÄ)
            shot.content.audio_urls.dialogue[character] = [newUrl];
            
            saveDataToLocalStorage();
            
            // ÌòÑÏû¨ ÌÉ≠ Ïú†ÏßÄ
            const tab = document.querySelector('.tab-button.active')?.getAttribute('onclick').match(/'([^']+)'/)[1];
            showShotContent(shotId);
            if (tab) setTimeout(() => switchTab(tab, shotId), 0);
            
            showMessage(`${character} Ïò§ÎîîÏò§ URLÏù¥ ÏóÖÎç∞Ïù¥Ìä∏ÎêòÏóàÏäµÎãàÎã§.`, 'success');
        } catch (e) {
            showMessage('Ï∫êÎ¶≠ÌÑ∞ Ïò§ÎîîÏò§ URL ÏóÖÎç∞Ïù¥Ìä∏Ïóê Ïã§Ìå®ÌñàÏäµÎãàÎã§.', 'error');
        }
    }
    
    // Ï∫êÎ¶≠ÌÑ∞Î≥Ñ Ïò§ÎîîÏò§ ÌååÏùº ÏóÖÎ°úÎìú Ìï®Ïàò
    function uploadAudioForCharacter(shotId, character) {
        const fileInput = document.createElement('input');
        fileInput.type = 'file';
        fileInput.accept = 'audio/*';
        fileInput.onchange = function(event) {
            const file = event.target.files[0];
            if (file) {
                // ÌååÏùº ÏóÖÎ°úÎìú Î°úÏßÅ (Ïã§Ï†ú Íµ¨ÌòÑ ÌïÑÏöî)
                showMessage(`${character} Ïò§ÎîîÏò§ ÌååÏùº ÏóÖÎ°úÎìú Í∏∞Îä•ÏùÄ Ï∂îÍ∞Ä Íµ¨ÌòÑÏù¥ ÌïÑÏöîÌï©ÎãàÎã§.`, 'info');
            }
        };
        fileInput.click();
    }
    
    // Ïò§ÎîîÏò§ ÌååÏùº ÏóÖÎ°úÎìú Ìï®Ïàò
    function uploadAudioForShot(shotId, audioType) {
        const input = document.createElement('input');
        input.type = 'file';
        input.accept = 'audio/*,.mp3,.wav,.m4a,.ogg,.aac,.flac';
        input.style.display = 'none';
        
        input.onchange = function(e) {
            const file = e.target.files[0];
            if (!file) return;
            
            // ÌååÏùº ÌÅ¨Í∏∞ Ï†úÌïú (50MB)
            const maxSize = 50 * 1024 * 1024;
            if (file.size > maxSize) {
                showMessage('ÌååÏùº ÌÅ¨Í∏∞Í∞Ä 50MBÎ•º Ï¥àÍ≥ºÌï©ÎãàÎã§.', 'error');
                return;
            }
            
            // ÌååÏùº ÌòïÏãù Í≤ÄÏ¶ù
            const allowedTypes = ['audio/mpeg', 'audio/wav', 'audio/mp4', 'audio/ogg', 'audio/aac', 'audio/flac'];
            const isValidType = allowedTypes.includes(file.type) || 
                              file.name.toLowerCase().match(/\.(mp3|wav|m4a|ogg|aac|flac)$/);
            
            if (!isValidType) {
                showMessage('ÏßÄÏõêÌïòÏßÄ ÏïäÎäî Ïò§ÎîîÏò§ ÌååÏùº ÌòïÏãùÏûÖÎãàÎã§. (mp3, wav, m4a, ogg, aac, flac ÏßÄÏõê)', 'error');
                return;
            }
            
            showMessage('Ïò§ÎîîÏò§ ÌååÏùºÏùÑ Ï≤òÎ¶¨ Ï§ëÏûÖÎãàÎã§...', 'info');
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    // Base64 Îç∞Ïù¥ÌÑ∞Î•º [Î°úÏª¨ ÌååÏùº] Ï†ëÎëêÏÇ¨ÏôÄ Ìï®Íªò Ï†ÄÏû•
                    const base64Data = e.target.result;
                    const localFileUrl = `[Î°úÏª¨ ÌååÏùº] ${file.name}`;
                    
                    // Îç∞Ïù¥ÌÑ∞ Ï†ÄÏû•
                    const shot = currentData?.breakdown_data?.shots?.find(s => s.id === shotId);
                    if (!shot) {
                        showMessage('ÏÉ∑ Îç∞Ïù¥ÌÑ∞Î•º Ï∞æÏùÑ Ïàò ÏóÜÏäµÎãàÎã§.', 'error');
                        return;
                    }
                    
                    if (!shot.content) shot.content = {};
                    if (!shot.content.audio_urls) shot.content.audio_urls = {};
                    
                    // Base64 Îç∞Ïù¥ÌÑ∞Î•º Î≥ÑÎèÑ Ï†ÄÏû•ÏÜåÏóê Ï†ÄÏû•
                    if (!window.localAudioFiles) window.localAudioFiles = {};
                    window.localAudioFiles[file.name] = base64Data;
                    
                    // localStorageÏóê Ïò§ÎîîÏò§ ÌååÏùº Îç∞Ïù¥ÌÑ∞ Ï†ÄÏû•
                    try {
                        const jsonFileName = getProjectFileName();
                        const audioFilesKey = `audioFiles_${jsonFileName}`;
                        const existingAudioFiles = JSON.parse(localStorage.getItem(audioFilesKey) || '{}');
                        existingAudioFiles[file.name] = base64Data;
                        localStorage.setItem(audioFilesKey, JSON.stringify(existingAudioFiles));
                    } catch (storageError) {
                        showMessage('ÌååÏùºÏù¥ ÎÑàÎ¨¥ Ïª§ÏÑú ÏôÑÏ†ÑÌûà Ï†ÄÏû•ÎêòÏßÄ ÏïäÏùÑ Ïàò ÏûàÏäµÎãàÎã§.', 'warning');
                    }
                    
                    // URL ÏóÖÎç∞Ïù¥Ìä∏
                    if (audioType === 'dialogue') {
                        shot.content.audio_urls.dialogue = localFileUrl;
                    } else {
                        shot.content.audio_urls[audioType] = localFileUrl;
                    }
                    
                    saveDataToLocalStorage();
                    
                    // UI Ï¶âÏãú ÏóÖÎç∞Ïù¥Ìä∏
                    const tab = document.querySelector('.tab-button.active')?.getAttribute('onclick').match(/'([^']+)'/)[1];
                    showShotContent(shotId);
                    if (tab) setTimeout(() => switchTab(tab, shotId), 0);
                    
                    showMessage(`${file.name} ÌååÏùºÏù¥ ÏÑ±Í≥µÏ†ÅÏúºÎ°ú ÏóÖÎ°úÎìúÎêòÏóàÏäµÎãàÎã§.`, 'success');
                    
                } catch (error) {
                    showMessage('Ïò§ÎîîÏò§ ÌååÏùº Ï≤òÎ¶¨ Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§.', 'error');
                }
            };
            
            reader.onerror = function() {
                showMessage('ÌååÏùº ÏùΩÍ∏∞ Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§.', 'error');
            };
            
            reader.readAsDataURL(file);
        };
        
        document.body.appendChild(input);
        input.click();
        document.body.removeChild(input);
    }
    
    // Îç∞Ïù¥ÌÑ∞ Ï¥àÍ∏∞Ìôî
    // [DEPRECATED] Îç∞Ïù¥ÌÑ∞ Ï¥àÍ∏∞Ìôî Í∏∞Îä• - Îçî Ïù¥ÏÉÅ ÏÇ¨Ïö©ÎêòÏßÄ ÏïäÏùå
    // TODO: Ìñ•ÌõÑ Î≤ÑÏ†ÑÏóêÏÑú Ï†úÍ±∞ ÏòàÏ†ï
		function resetData() {
			if (confirm('Î™®Îì† Îç∞Ïù¥ÌÑ∞Í∞Ä ÏÇ≠Ï†úÎê©ÎãàÎã§. Í≥ÑÏÜçÌïòÏãúÍ≤†ÏäµÎãàÍπå?')) {
				try {
					// Î™®Îì† localStorage Îç∞Ïù¥ÌÑ∞ ÏÇ≠Ï†ú
					const keysToRemove = [];
					for (let i = 0; i < localStorage.length; i++) {
						const key = localStorage.key(i);
						if (key && (key.includes('breakdownData') || 
								   key.includes('lastSaved') || 
								   key.includes('shotMemos') ||
								   key.includes('shot_') ||
								   key.includes('filmProduction') ||
								   key.includes('stage6ImagePrompts') ||  // Ï∂îÍ∞Ä
								   key.includes('stage7VideoPrompts') ||  // Ï∂îÍ∞Ä
								   key.includes('audioFiles_'))) {  // Ïò§ÎîîÏò§ ÌååÏùº Ï∂îÍ∞Ä
							keysToRemove.push(key);
						}
					}

					keysToRemove.forEach(key => localStorage.removeItem(key));

					// Ï†ÑÏó≠ Î≥ÄÏàò Ï¥àÍ∏∞Ìôî
					window.stage6ImagePrompts = null;
					window.localAudioFiles = null;
					currentData = null;
					selectedType = null;
					selectedId = null;
					selectedSceneId = null;
                    hasStage2Structure = false;

					// Îπà Îç∞Ïù¥ÌÑ∞Î°ú Ïû¨ÏÑ§Ï†ï
					currentData = getEmptyData();
					updateUI();

					showMessage('Î™®Îì† Îç∞Ïù¥ÌÑ∞Í∞Ä ÏôÑÏ†ÑÌûà Ï¥àÍ∏∞ÌôîÎêòÏóàÏäµÎãàÎã§.', 'success');

					// ÌéòÏù¥ÏßÄ ÏÉàÎ°úÍ≥†Ïπ® (ÏôÑÏ†ÑÌïú Ï¥àÍ∏∞Ìôî)
					setTimeout(() => {
						location.reload();
					}, 1000);

				} catch (error) {
					showMessage('Ï¥àÍ∏∞Ìôî Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§.', 'error');
				}
			}
		}
    // Ï†ÑÏ≤¥ ÏãúÎÇòÎ¶¨Ïò§ Îã§Ïö¥Î°úÎìú
    // [DEPRECATED] Ï†ÑÏ≤¥ ÏãúÎÇòÎ¶¨Ïò§ Îã§Ïö¥Î°úÎìú Í∏∞Îä• - Îçî Ïù¥ÏÉÅ ÏÇ¨Ïö©ÎêòÏßÄ ÏïäÏùå
    // TODO: Ìñ•ÌõÑ Î≤ÑÏ†ÑÏóêÏÑú Ï†úÍ±∞ ÏòàÏ†ï
		function downloadFullScenario() {
			try {
				if (!currentData?.stage2_data?.narrative_data?.scenario_data) {
					showMessage('ÏãúÎÇòÎ¶¨Ïò§ Îç∞Ïù¥ÌÑ∞Í∞Ä ÏóÜÏäµÎãàÎã§.', 'error');
					return;
				}

				const scenarioData = currentData.stage2_data.narrative_data.scenario_data;
				const title = scenarioData.scenario_title || 'ÏãúÎÇòÎ¶¨Ïò§';
				let fullText = `${title}\n${'='.repeat(50)}\n\n`;

				// ÏãúÌÄÄÏä§Î≥ÑÎ°ú Ïî¨Îì§Ïùò scenario_textÎ•º Ï°∞Ìï©
				const sequences = currentData.breakdown_data.sequences || [];
				sequences.forEach(seq => {
					fullText += `\n\n${seq.title}\n${'-'.repeat(40)}\n\n`;

					// Ìï¥Îãπ ÏãúÌÄÄÏä§Ïùò Ïî¨Îì§ Ï∞æÍ∏∞
					const seqScenes = currentData.breakdown_data.scenes.filter(
						scene => scene.sequence_id === seq.id
					);

					// Í∞Å Ïî¨Ïùò scenario_text Ï∂îÍ∞Ä
					seqScenes.forEach(scene => {
						if (scene.original_scenario?.scenario_text) {
							fullText += scene.original_scenario.scenario_text + '\n\n';
						}
					});
				});

				// ÌÖçÏä§Ìä∏ ÌååÏùºÎ°ú Îã§Ïö¥Î°úÎìú
				const blob = new Blob([fullText], { type: 'text/plain;charset=utf-8' });
				const url = URL.createObjectURL(blob);
				const a = document.createElement('a');
				a.href = url;
				a.download = `${title.replace(/[^a-zA-Z0-9Í∞Ä-Ìû£]/g, '_')}_Ï†ÑÏ≤¥ÏãúÎÇòÎ¶¨Ïò§.txt`;
				document.body.appendChild(a);
				a.click();
				document.body.removeChild(a);
				URL.revokeObjectURL(url);

				showMessage('Ï†ÑÏ≤¥ ÏãúÎÇòÎ¶¨Ïò§Í∞Ä Îã§Ïö¥Î°úÎìúÎêòÏóàÏäµÎãàÎã§.', 'success');
			} catch (error) {
				showMessage('ÏãúÎÇòÎ¶¨Ïò§ Îã§Ïö¥Î°úÎìú Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§.', 'error');
			}
		}

    // ÎÇ¥Î≥¥ÎÇ¥Í∏∞ ÎìúÎ°≠Îã§Ïö¥ ÌÜ†Í∏Ä
    function toggleExportDropdown(event) {
        event.stopPropagation();
        const dropdown = document.getElementById('export-dropdown');
        dropdown.style.display = dropdown.style.display === 'none' ? 'block' : 'none';
        
        // Îã§Î•∏ Í≥≥ ÌÅ¥Î¶≠ Ïãú ÎìúÎ°≠Îã§Ïö¥ Îã´Í∏∞
        document.addEventListener('click', function closeDropdown(e) {
            if (!e.target.closest('.dropdown')) {
                dropdown.style.display = 'none';
                document.removeEventListener('click', closeDropdown);
            }
        });
    }
    
    // ÎÇ¥Î≥¥ÎÇ¥Í∏∞ ÎìúÎ°≠Îã§Ïö¥ Ïà®Í∏∞Í∏∞
    function hideExportDropdown() {
        document.getElementById('export-dropdown').style.display = 'none';
    }

    // Ïª®ÏÖâÏïÑÌä∏ Î≥¥Í∏∞
    // Ïª®ÏÖâÏïÑÌä∏ ÌéòÏù¥ÏßÄ Ïó¥Í∏∞
    function openConceptArt() {
        try {
            // Ïª®ÏÖâÏïÑÌä∏ ÌéòÏù¥ÏßÄÎ°ú ÏßÅÏ†ë Ïù¥Îèô
            window.open('your_title_storyboard_v9.4_c.html', '_blank');
            
        } catch (e) {
            showMessage('Ïª®ÏÖâÏïÑÌä∏ Ïó¥Í∏∞ Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§: ' + e.message, 'error');
        }
    }

    // Ïù¥Î≤§Ìä∏ Î¶¨Ïä§ÎÑà ÏÑ§Ï†ï
    function setupEventListeners() {
        document.getElementById('import-btn')?.addEventListener('click', importData);
        // export-btnÏùÄ Ïù∏ÎùºÏù∏ onclick ÏÇ¨Ïö©ÏúºÎ°ú Î≥ÄÍ≤Ω
        document.getElementById('concept-art-btn')?.addEventListener('click', openConceptArt);
        document.getElementById('expand-all-btn')?.addEventListener('click', expandAll);
        document.getElementById('collapse-all-btn')?.addEventListener('click', collapseAll);
        document.getElementById('search-input')?.addEventListener('input', searchNavigation);
        document.getElementById('file-input')?.addEventListener('change', handleFileSelect);
        document.getElementById('reset-btn')?.addEventListener('click', resetData);
        document.getElementById('scenario-export-btn')?.addEventListener('click', downloadFullScenario);
    }

    // ÌéòÏù¥ÏßÄ Î°úÎìú Ïãú Ïã§Ìñâ
    document.addEventListener('DOMContentLoaded', async function() {
        try {
            setupEventListeners();
            await loadData();
            updateUI();
            
            // URL ÌååÎùºÎØ∏ÌÑ∞ Ï≤¥ÌÅ¨ Î∞è ÏûêÎèô JSON Ï≤òÎ¶¨
            const urlParams = new URLSearchParams(window.location.search);
            
            // Stage 2ÏóêÏÑú ÏûÑÏãú Ï†ÄÏû•Îêú JSON ÌååÏùº ÏûêÎèô Î°úÎìú
            if (urlParams.get('loadTempJson') === 'true') {
                setTimeout(() => {
                    const tempJson = localStorage.getItem('stage2TempJson');
                    const tempFileName = localStorage.getItem('stage2TempFileName');
                    
                    if (tempJson && tempFileName) {
                        // Ï§ëÎ≥µ Ï≤òÎ¶¨ Î∞©ÏßÄ Ï≤¥ÌÅ¨ - Ïù¥ÎØ∏ currentDataÏóê Îç∞Ïù¥ÌÑ∞Í∞Ä ÏûàÎäî Í≤ΩÏö∞Îßå Í±¥ÎÑàÎõ∞Í∏∞
                        if (localStorage.getItem('stage2TempProcessed') === 'true' && 
                            currentData && currentData.breakdown_data && 
                            currentData.breakdown_data.sequences && currentData.breakdown_data.sequences.length > 0) {
                            // showMessage Ï†úÍ±∞ - ÏΩòÏÜîÏóêÎßå ÌëúÏãú
                            return;
                        }
                        
                        try {
                            
                            // practicalJSONHandlerÎ•º ÏÇ¨Ïö©ÌïòÏó¨ JSON Ï≤òÎ¶¨
                            const result = practicalJSONHandler(tempJson);
                            
                            if (result.success) {
                                const newData = result.data;
                                let updated = false;
                                
                                // Í∏∞Ï°¥ handleFileSelect Î°úÏßÅÍ≥º ÎèôÏùºÌïòÍ≤å Ï≤òÎ¶¨
                                if (newData.current_stage_name === 'narrative_development' && newData.narrative_data) {
                                                 handleStage2Data(newData);
                                } else {
                                    showMessage('Stage 2 ÌòïÏãùÏùò JSON ÌååÏùºÏù¥ ÏïÑÎãôÎãàÎã§.', 'warning');
                                }
                            } else {
                                showMessage('JSON ÌååÏùº Ï≤òÎ¶¨ Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§.', 'error');
                            }
                            
                            // Ï≤òÎ¶¨ ÏôÑÎ£å ÌîåÎûòÍ∑∏ ÏÑ§Ï†ï (ÏûÑÏãú Îç∞Ïù¥ÌÑ∞Îäî Ïú†ÏßÄ)
                            localStorage.setItem('stage2TempProcessed', 'true');
                            
                        } catch (error) {
                            console.error('ÏûÑÏãú JSON Î°úÎìú Ïò§Î•ò:', error);
                            showMessage('ÏûÑÏãú Ï†ÄÏû•Îêú JSON ÌååÏùºÏùÑ Î°úÎìúÌï† Ïàò ÏóÜÏäµÎãàÎã§.', 'error');
                            // Ïò§Î•ò ÏãúÏóêÎèÑ ÏûÑÏãú Îç∞Ïù¥ÌÑ∞ Ïú†ÏßÄ (Ïû¨ÏãúÎèÑ Í∞ÄÎä•ÌïòÎèÑÎ°ù)
                        }
                    } else {
                        showMessage('ÏûÑÏãú Ï†ÄÏû•Îêú ÌååÏùºÏùÑ Ï∞æÏùÑ Ïàò ÏóÜÏäµÎãàÎã§.', 'warning');
                    }
                }, 1000);
            }
            // Stage 5ÏóêÏÑú Ïó¨Îü¨ ÏûÑÏãú Ï†ÄÏû•Îêú JSON ÌååÏùºÎì§ ÏûêÎèô Î°úÎìú
            if (urlParams.get('loadStage5JsonMultiple') === 'true') {
                // Stage 2 Î°úÎìú ÌõÑ Ï∂©Î∂ÑÌïú ÏãúÍ∞Ñ ÌõÑÏóê Ïã§Ìñâ
                setTimeout(() => {
                    const tempJsonFiles = localStorage.getItem('stage5TempJsonFiles');
                    const tempFileNames = localStorage.getItem('stage5TempFileNames');
                    
                    if (tempJsonFiles && tempFileNames) {
                        // stage5TempProcessed ÌîåÎûòÍ∑∏Îäî Ï†úÍ±∞ÎêòÏóàÏúºÎØÄÎ°ú Ìï≠ÏÉÅ Ï≤òÎ¶¨
                        
                        try {
                            const jsonFiles = JSON.parse(tempJsonFiles);
                            const fileNames = JSON.parse(tempFileNames);
                            
                            
                            let processedCount = 0;
                            let successCount = 0;
                            
                            // Í∞Å ÌååÏùºÏùÑ ÏàúÏ∞®Ï†ÅÏúºÎ°ú Ï≤òÎ¶¨
                            jsonFiles.forEach((jsonContent, index) => {
                                try {
                                    const result = practicalJSONHandler(jsonContent);
                                    
                                    if (result.success) {
                                        const newData = result.data;
                                        
                                        // Stage 5 Îç∞Ïù¥ÌÑ∞ Ï≤òÎ¶¨
                                        if (newData.film_metadata && newData.film_metadata.current_scene !== undefined && newData.breakdown_data) {
                                            handleStage5SceneData(newData, true); // Î©îÏãúÏßÄ Ïà®ÍπÄ
                                            successCount++;
                                        } 
                                        // Ï†ÑÏ≤¥ ÌîÑÎ°úÏ†ùÌä∏ Íµ¨Ï°∞ (Stage 5 Ï†ÑÏ≤¥)
                                        else if (newData.film_metadata && newData.breakdown_data && newData.breakdown_data.sequences) {
                                            currentData = newData;
                                            
                                            // Stage 2 Íµ¨Ï°∞ Ï°¥Ïû¨ Ïó¨Î∂Ä ÌôïÏù∏
                                            if (currentData.breakdown_data.sequences && currentData.breakdown_data.sequences.length > 0) {
                                                hasStage2Structure = true;
                                                currentData.hasStage2Structure = true;
                                            }
                                            
                                            saveDataToLocalStorage();
                                            updateUI();
                                            successCount++;
                                        } else {
                                            console.warn(`Stage 5 ÌòïÏãùÏù¥ ÏïÑÎãå ÌååÏùº: ${fileNames[index]}`);
                                        }
                                    } else {
                                        console.error(`JSON ÌååÏùº Ï≤òÎ¶¨ Ïã§Ìå®: ${fileNames[index]}`);
                                    }
                                } catch (error) {
                                    console.error(`ÌååÏùº Ï≤òÎ¶¨ Ïò§Î•ò (${fileNames[index]}):`, error);
                                }
                                
                                processedCount++;
                                
                                // Î™®Îì† ÌååÏùº Ï≤òÎ¶¨ ÏôÑÎ£åÏãú Î©îÏãúÏßÄ ÌëúÏãú
                                if (processedCount === jsonFiles.length) {
                                    if (successCount > 0) {
                                        console.log(`‚úÖ ${successCount}Í∞úÏùò Stage 5 ÌååÏùºÏùÑ ÏÑ±Í≥µÏ†ÅÏúºÎ°ú Î°úÎìúÌñàÏäµÎãàÎã§. (Ï¥ù ${jsonFiles.length}Í∞ú Ï§ë)`);
                                    } else {
                                        showMessage('Stage 5 ÌòïÏãùÏùò JSON ÌååÏùºÏùÑ Ï∞æÏùÑ Ïàò ÏóÜÏäµÎãàÎã§.', 'warning');
                                    }
                                }
                            });
                            
                            // Ï≤òÎ¶¨ ÏôÑÎ£å ÌõÑ ÏûÑÏãú Îç∞Ïù¥ÌÑ∞ Ï†ïÎ¶¨
                            localStorage.removeItem('stage5TempJsonFiles');
                            localStorage.removeItem('stage5TempFileNames');
                            
                        } catch (error) {
                            console.error('Stage 5 Ïó¨Îü¨ ÏûÑÏãú JSON Î°úÎìú Ïò§Î•ò:', error);
                            showMessage('ÏûÑÏãú Ï†ÄÏû•Îêú JSON ÌååÏùºÎì§ÏùÑ Î°úÎìúÌï† Ïàò ÏóÜÏäµÎãàÎã§.', 'error');
                            // Ïò§Î•ò ÏãúÏóêÎèÑ ÏûÑÏãú Îç∞Ïù¥ÌÑ∞ Ïú†ÏßÄ (Ïû¨ÏãúÎèÑ Í∞ÄÎä•ÌïòÎèÑÎ°ù)
                        }
                    } else {
                        showMessage('ÏûÑÏãú Ï†ÄÏû•Îêú ÌååÏùºÎì§ÏùÑ Ï∞æÏùÑ Ïàò ÏóÜÏäµÎãàÎã§.', 'warning');
                    }
                }, 2000);
            }
            // Stage 6ÏóêÏÑú ÏûÑÏãú Ï†ÄÏû•Îêú JSON ÌååÏùº ÏûêÎèô Î°úÎìú
            if (urlParams.get('loadStage6Json') === 'true') {
                setTimeout(() => {
                    const tempJson = localStorage.getItem('stage6TempJson');
                    const tempFileName = localStorage.getItem('stage6TempFileName');
                    
                    if (tempJson && tempFileName) {
                        // Ï§ëÎ≥µ Ï≤òÎ¶¨ Î∞©ÏßÄ Ï≤¥ÌÅ¨ - Ïù¥ÎØ∏ Stage 6 Îç∞Ïù¥ÌÑ∞Í∞Ä Ï≤òÎ¶¨Îêú Í≤ΩÏö∞Îßå Í±¥ÎÑàÎõ∞Í∏∞
                        if (localStorage.getItem('stage6TempProcessed') === 'true' && 
                            window.stage6ImagePrompts && Object.keys(window.stage6ImagePrompts).length > 0) {
                            // showMessage Ï†úÍ±∞ - ÏΩòÏÜîÏóêÎßå ÌëúÏãú
                            return;
                        }
                        
                        try {
                            
                            // practicalJSONHandlerÎ•º ÏÇ¨Ïö©ÌïòÏó¨ JSON Ï≤òÎ¶¨
                            const result = practicalJSONHandler(tempJson);
                            
                            if (result.success) {
                                const newData = result.data;
                                
                                // Stage 6 Îç∞Ïù¥ÌÑ∞ Ï≤òÎ¶¨
                                if (newData.stage === 6 && (newData.shots || (newData.scene_info && newData.shots))) {
                                    
                                    // Í∏∞Ï°¥ handleFileSelect Î°úÏßÅ Ïû¨ÏÇ¨Ïö©
                                    const fakeEvent = { target: { value: '', files: [new File([tempJson], tempFileName, { type: 'application/json' })] }};
                                    const reader = new FileReader();
                                    reader.onload = function(e) {
                                        const result = practicalJSONHandler(e.target.result);
                                        if (result.success) {
                                            const newData = result.data;
                                            
                                            // Stage 6 Îç∞Ïù¥ÌÑ∞Î•º Ï†ÑÏó≠ Î≥ÄÏàòÏóê Ï†ÄÏû•
                                            if (newData.stage === 6 && newData.shots) {
                                                if (!window.stage6ImagePrompts) {
                                                    window.stage6ImagePrompts = {};
                                                }
                                                newData.shots.forEach(shotData => {
                                                    const shotId = shotData.shot_id;
                                                    window.stage6ImagePrompts[shotId] = {};
                                                    shotData.images.forEach(imageData => {
                                                        const imageId = imageData.image_id;
                                                        window.stage6ImagePrompts[shotId][imageId] = imageData;
                                                    });
                                                });
                                                
                                                const jsonFileName = getProjectFileName();
                                                localStorage.setItem(`stage6ImagePrompts_${jsonFileName}`, JSON.stringify(window.stage6ImagePrompts));
                                                        }
                                        }
                                    };
                                    reader.readAsText(new File([tempJson], tempFileName, { type: 'application/json' }));
                                } else {
                                    showMessage('Stage 6 ÌòïÏãùÏùò JSON ÌååÏùºÏù¥ ÏïÑÎãôÎãàÎã§.', 'warning');
                                }
                            } else {
                                showMessage('JSON ÌååÏùº Ï≤òÎ¶¨ Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§.', 'error');
                            }
                            
                            // Ï≤òÎ¶¨ ÏôÑÎ£å ÌîåÎûòÍ∑∏ ÏÑ§Ï†ï (ÏûÑÏãú Îç∞Ïù¥ÌÑ∞Îäî Ïú†ÏßÄ)
                            localStorage.setItem('stage6TempProcessed', 'true');
                            
                        } catch (error) {
                            console.error('Stage 6 ÏûÑÏãú JSON Î°úÎìú Ïò§Î•ò:', error);
                            showMessage('ÏûÑÏãú Ï†ÄÏû•Îêú JSON ÌååÏùºÏùÑ Î°úÎìúÌï† Ïàò ÏóÜÏäµÎãàÎã§.', 'error');
                            // Ïò§Î•ò ÏãúÏóêÎèÑ ÏûÑÏãú Îç∞Ïù¥ÌÑ∞ Ïú†ÏßÄ (Ïû¨ÏãúÎèÑ Í∞ÄÎä•ÌïòÎèÑÎ°ù)
                        }
                    } else {
                        showMessage('ÏûÑÏãú Ï†ÄÏû•Îêú ÌååÏùºÏùÑ Ï∞æÏùÑ Ïàò ÏóÜÏäµÎãàÎã§.', 'warning');
                    }
                }, 3000);
            }
            // Stage 6ÏóêÏÑú ÏûÑÏãú Ï†ÄÏû•Îêú Ïó¨Îü¨ JSON ÌååÏùºÎì§ ÏûêÎèô Î°úÎìú
            if (urlParams.get('loadStage6JsonMultiple') === 'true') {
                setTimeout(() => {
                    const tempJsonFiles = localStorage.getItem('stage6TempJsonFiles');
                    const tempFileNames = localStorage.getItem('stage6TempFileNames');
                    
                    if (tempJsonFiles && tempFileNames) {
                        // Ï§ëÎ≥µ Ï≤òÎ¶¨ Î∞©ÏßÄ Ï≤¥ÌÅ¨
                        if (localStorage.getItem('stage6TempFilesProcessed') === 'true') {
                            // showMessage Ï†úÍ±∞ - ÏΩòÏÜîÏóêÎßå ÌëúÏãú
                            return;
                        }
                        
                        try {
                            const jsonFiles = JSON.parse(tempJsonFiles);
                            const fileNames = JSON.parse(tempFileNames);
                            
                            
                            let processedCount = 0;
                            let successCount = 0;
                            
                            // Í∞Å ÌååÏùºÏùÑ ÏàúÏ∞®Ï†ÅÏúºÎ°ú Ï≤òÎ¶¨
                            jsonFiles.forEach((jsonContent, index) => {
                                try {
                                    const result = practicalJSONHandler(jsonContent);
                                    
                                    if (result.success) {
                                        const newData = result.data;
                                        
                                        // Stage 6 Îç∞Ïù¥ÌÑ∞ Ï≤òÎ¶¨
                                        if (newData.stage === 6 && newData.shots) {
                                            
                                            // Stage 6 Îç∞Ïù¥ÌÑ∞Î•º Ï†ÑÏó≠ Î≥ÄÏàòÏóê Ï†ÄÏû•
                                            if (!window.stage6ImagePrompts) {
                                                window.stage6ImagePrompts = {};
                                            }
                                            
                                            newData.shots.forEach(shotData => {
                                                const shotId = shotData.shot_id;
                                                // Í∏∞Ï°¥ Îç∞Ïù¥ÌÑ∞Î•º ÏôÑÏ†ÑÌûà ÎåÄÏ≤¥ (ÏóÖÎç∞Ïù¥Ìä∏)
                                                window.stage6ImagePrompts[shotId] = {};
                                                shotData.images.forEach(imageData => {
                                                    const imageId = imageData.image_id;
                                                    window.stage6ImagePrompts[shotId][imageId] = imageData;
                                                });
                                            });
                                            
                                            successCount++;
                                        } else {
                                            console.warn(`Stage 6 ÌòïÏãùÏù¥ ÏïÑÎãå ÌååÏùº: ${fileNames[index]}`);
                                        }
                                    } else {
                                        console.error(`JSON ÌååÏùº Ï≤òÎ¶¨ Ïã§Ìå®: ${fileNames[index]}`);
                                    }
                                } catch (error) {
                                    console.error(`ÌååÏùº Ï≤òÎ¶¨ Ïò§Î•ò (${fileNames[index]}):`, error);
                                }
                                
                                processedCount++;
                                
                                // Î™®Îì† ÌååÏùº Ï≤òÎ¶¨ ÏôÑÎ£å
                                if (processedCount === jsonFiles.length) {
                                    
                                    if (successCount > 0) {
                                        // localStorageÏóê Stage 6 Îç∞Ïù¥ÌÑ∞ Ï†ÄÏû•
                                        const jsonFileName = getProjectFileName();
                                        localStorage.setItem(`stage6ImagePrompts_${jsonFileName}`, JSON.stringify(window.stage6ImagePrompts));
                                        
                                        console.log(`‚úÖ ${successCount}Í∞úÏùò Stage 6 ÌååÏùºÏùÑ ÏÑ±Í≥µÏ†ÅÏúºÎ°ú Î°úÎìúÌñàÏäµÎãàÎã§. (Ï¥ù ${jsonFiles.length}Í∞ú Ï§ë)`);
                                        
                                        // UI ÏóÖÎç∞Ïù¥Ìä∏
                                        updateUI();
                                    } else {
                                        showMessage('Ï≤òÎ¶¨Ìï† Ïàò ÏûàÎäî Stage 6 ÌòïÏãùÏùò ÌååÏùºÏù¥ ÏóÜÏäµÎãàÎã§.', 'warning');
                                    }
                                    
                                    // Ï≤òÎ¶¨ ÏôÑÎ£å ÌîåÎûòÍ∑∏ ÏÑ§Ï†ï (ÏûÑÏãú Îç∞Ïù¥ÌÑ∞Îäî Ïú†ÏßÄ)
                                    localStorage.setItem('stage6TempFilesProcessed', 'true');
                                }
                            });
                            
                        } catch (error) {
                            console.error('Stage 6 ÏûÑÏãú JSON ÌååÏùºÎì§ Î°úÎìú Ïò§Î•ò:', error);
                            showMessage('ÏûÑÏãú Ï†ÄÏû•Îêú JSON ÌååÏùºÎì§ÏùÑ Î°úÎìúÌï† Ïàò ÏóÜÏäµÎãàÎã§.', 'error');
                            // Ïò§Î•ò ÏãúÏóêÎèÑ ÏûÑÏãú Îç∞Ïù¥ÌÑ∞ Ïú†ÏßÄ (Ïû¨ÏãúÎèÑ Í∞ÄÎä•ÌïòÎèÑÎ°ù)
                        }
                    } else {
                        showMessage('ÏûÑÏãú Ï†ÄÏû•Îêú ÌååÏùºÎì§ÏùÑ Ï∞æÏùÑ Ïàò ÏóÜÏäµÎãàÎã§.', 'warning');
                    }
                }, 3500);
            }
            // Stage 7ÏóêÏÑú ÏûÑÏãú Ï†ÄÏû•Îêú JSON ÌååÏùºÎì§ ÏûêÎèô Î°úÎìú
            if (urlParams.get('loadStage7JsonMultiple') === 'true') {
                console.log('üîÑ Stage 7 ÏûÑÏãú Ï†ÄÏû•Îêú JSON ÌååÏùºÎì§ ÏûêÎèô Î°úÎìú Ïã§Ìñâ...');
                setTimeout(() => {
                    const tempJsonFiles = localStorage.getItem('stage7TempJsonFiles');
                    const tempFileNames = localStorage.getItem('stage7TempFileNames');
                    
                    if (tempJsonFiles && tempFileNames) {
                        // Ï§ëÎ≥µ Ï≤òÎ¶¨ Î∞©ÏßÄ Ï≤¥ÌÅ¨
                        if (localStorage.getItem('stage7TempProcessed') === 'true') {
                            console.log('‚ö†Ô∏è Stage 7 Îç∞Ïù¥ÌÑ∞Í∞Ä Ïù¥ÎØ∏ Ï≤òÎ¶¨ÎêòÏóàÏäµÎãàÎã§. Ï§ëÎ≥µ Ï≤òÎ¶¨Î•º Î∞©ÏßÄÌï©ÎãàÎã§.');
                            // showMessage Ï†úÍ±∞ - ÏΩòÏÜîÏóêÎßå ÌëúÏãú
                            return;
                        }
                        
                        try {
                            const jsonFiles = JSON.parse(tempJsonFiles);
                            const fileNames = JSON.parse(tempFileNames);
                            
                            console.log(`üìÅ Stage 7 ÏûÑÏãú JSON ÌååÏùºÎì§ Î°úÎìú: ${fileNames.length}Í∞ú`);
                            
                            let processedCount = 0;
                            let successCount = 0;
                            
                            // Stage 7 Îç∞Ïù¥ÌÑ∞Î•º Ï†ÑÏó≠ Î≥ÄÏàòÏóê Ï†ÄÏû• (Ï¥àÍ∏∞Ìôî)
                            if (!window.stage7VideoPrompts) {
                                window.stage7VideoPrompts = {};
                            }
                            
                            // Í∞Å ÌååÏùºÏùÑ ÏàúÏ∞®Ï†ÅÏúºÎ°ú Ï≤òÎ¶¨
                            jsonFiles.forEach((jsonContent, index) => {
                                try {
                                    const result = practicalJSONHandler(jsonContent);
                                    
                                    if (result.success) {
                                        const newData = result.data;
                                        
                                        // Stage 7 Îç∞Ïù¥ÌÑ∞ Ï≤òÎ¶¨
                                        if (newData.stage === 7 && newData.video_prompts) {
                                            console.log(`üìö Stage 7 ÏòÅÏÉÅ ÌîÑÎ°¨ÌîÑÌä∏ Îç∞Ïù¥ÌÑ∞ Í∞êÏßÄ: ${fileNames[index]}`);
                                            
                                            if (Array.isArray(newData.video_prompts)) {
                                                newData.video_prompts.forEach(promptData => {
                                                    const shotId = promptData.shot_id;
                                                    const imageId = promptData.image_id;
                                                    if (!window.stage7VideoPrompts[shotId]) {
                                                        window.stage7VideoPrompts[shotId] = {};
                                                    }
                                                    window.stage7VideoPrompts[shotId][imageId] = promptData;
                                                });
                                                successCount++;
                                            }
                                        } else {
                                            console.warn(`Stage 7 ÌòïÏãùÏù¥ ÏïÑÎãå ÌååÏùº: ${fileNames[index]}`);
                                        }
                                    } else {
                                        console.error(`JSON ÌååÏùº Ï≤òÎ¶¨ Ïã§Ìå®: ${fileNames[index]}`);
                                    }
                                } catch (error) {
                                    console.error(`ÌååÏùº Ï≤òÎ¶¨ Ïò§Î•ò (${fileNames[index]}):`, error);
                                }
                                
                                processedCount++;
                                
                                // Î™®Îì† ÌååÏùº Ï≤òÎ¶¨ ÏôÑÎ£åÏãú Î©îÏãúÏßÄ ÌëúÏãú Î∞è Ï†ÄÏû•
                                if (processedCount === jsonFiles.length) {
                                    if (successCount > 0) {
                                        const jsonFileName = getProjectFileName();
                                        localStorage.setItem(`stage7VideoPrompts_${jsonFileName}`, JSON.stringify(window.stage7VideoPrompts));
                                        console.log(`‚úÖ ${successCount}Í∞úÏùò Stage 7 ÌååÏùºÏùÑ ÏÑ±Í≥µÏ†ÅÏúºÎ°ú Î°úÎìúÌñàÏäµÎãàÎã§. (Ï¥ù ${jsonFiles.length}Í∞ú Ï§ë)`);
                                    } else {
                                        showMessage('Stage 7 ÌòïÏãùÏùò JSON ÌååÏùºÏùÑ Ï∞æÏùÑ Ïàò ÏóÜÏäµÎãàÎã§.', 'warning');
                                    }
                                }
                            });
                            
                            // Ï≤òÎ¶¨ ÏôÑÎ£å ÌîåÎûòÍ∑∏ ÏÑ§Ï†ï (ÏûÑÏãú Îç∞Ïù¥ÌÑ∞Îäî Ïú†ÏßÄ)
                            localStorage.setItem('stage7TempProcessed', 'true');
                            
                        } catch (error) {
                            console.error('Stage 7 Ïó¨Îü¨ ÏûÑÏãú JSON Î°úÎìú Ïò§Î•ò:', error);
                            showMessage('ÏûÑÏãú Ï†ÄÏû•Îêú JSON ÌååÏùºÎì§ÏùÑ Î°úÎìúÌï† Ïàò ÏóÜÏäµÎãàÎã§.', 'error');
                            // Ïò§Î•ò ÏãúÏóêÎèÑ ÏûÑÏãú Îç∞Ïù¥ÌÑ∞ Ïú†ÏßÄ (Ïû¨ÏãúÎèÑ Í∞ÄÎä•ÌïòÎèÑÎ°ù)
                        }
                    } else {
                        console.log('ÏûÑÏãú Ï†ÄÏû•Îêú Stage 7 JSON Îç∞Ïù¥ÌÑ∞Îì§ÏùÑ Ï∞æÏùÑ Ïàò ÏóÜÏäµÎãàÎã§.');
                        showMessage('ÏûÑÏãú Ï†ÄÏû•Îêú ÌååÏùºÎì§ÏùÑ Ï∞æÏùÑ Ïàò ÏóÜÏäµÎãàÎã§.', 'warning');
                    }
                }, 4500);
            }
            // Stage 8ÏóêÏÑú ÏûÑÏãú Ï†ÄÏû•Îêú JSON ÌååÏùºÎì§ ÏûêÎèô Î°úÎìú
            if (urlParams.get('loadStage8JsonMultiple') === 'true') {
                console.log('üîÑ Stage 8 ÏûÑÏãú Ï†ÄÏû•Îêú JSON ÌååÏùºÎì§ ÏûêÎèô Î°úÎìú Ïã§Ìñâ...');
                setTimeout(() => {
                    const tempJsonFiles = localStorage.getItem('stage8TempJsonFiles');
                    const tempFileNames = localStorage.getItem('stage8TempFileNames');
                    
                    if (tempJsonFiles && tempFileNames) {
                        // Ï§ëÎ≥µ Ï≤òÎ¶¨ Î∞©ÏßÄ Ï≤¥ÌÅ¨
                        if (localStorage.getItem('stage8TempProcessed') === 'true') {
                            console.log('‚ö†Ô∏è Stage 8 Îç∞Ïù¥ÌÑ∞Í∞Ä Ïù¥ÎØ∏ Ï≤òÎ¶¨ÎêòÏóàÏäµÎãàÎã§. Ï§ëÎ≥µ Ï≤òÎ¶¨Î•º Î∞©ÏßÄÌï©ÎãàÎã§.');
                            // showMessage Ï†úÍ±∞ - ÏΩòÏÜîÏóêÎßå ÌëúÏãú
                            return;
                        }
                        
                        try {
                            const jsonFiles = JSON.parse(tempJsonFiles);
                            const fileNames = JSON.parse(tempFileNames);
                            
                            console.log(`üìÅ Stage 8 ÏûÑÏãú JSON ÌååÏùºÎì§ Î°úÎìú: ${fileNames.length}Í∞ú`);
                            
                            let processedCount = 0;
                            let successCount = 0;
                            let audioDataUpdated = false;
                            
                            // Í∞Å ÌååÏùºÏùÑ ÏàúÏ∞®Ï†ÅÏúºÎ°ú Ï≤òÎ¶¨
                            jsonFiles.forEach((jsonContent, index) => {
                                try {
                                    const result = practicalJSONHandler(jsonContent);
                                    
                                    if (result.success) {
                                        const newData = result.data;
                                        
                                        // Stage 8 Îç∞Ïù¥ÌÑ∞ Ï≤òÎ¶¨
                                        if (newData.stage === 8 && newData.audio_data) {
                                            console.log(`üìö Stage 8 Ïò§ÎîîÏò§ ÌîÑÎ°¨ÌîÑÌä∏ Îç∞Ïù¥ÌÑ∞ Í∞êÏßÄ: ${fileNames[index]}`);
                                            
                                            // Í∏∞Ï°¥ handleFileSelect Î°úÏßÅÏóêÏÑú Stage 8 Ï≤òÎ¶¨ Î∂ÄÎ∂Ñ Ïû¨ÏÇ¨Ïö©
                                            if (currentData && currentData.breakdown_data && currentData.breakdown_data.shots && currentData.breakdown_data.shots.length > 0) {
                                                console.log(`üîç ÌòÑÏû¨ ÌîÑÎ°úÏ†ùÌä∏Ïùò shot Í∞úÏàò: ${currentData.breakdown_data.shots.length}`);
                                                console.log(`üîç ÌòÑÏû¨ ÌîÑÎ°úÏ†ùÌä∏Ïùò shot IDs:`, currentData.breakdown_data.shots.map(s => s.id));
                                                
                                                // Stage 8 JSON Íµ¨Ï°∞: audio_data.shots Î∞∞Ïó¥ Ï†ëÍ∑º
                                                const audioShots = newData.audio_data && newData.audio_data.shots ? newData.audio_data.shots : [];
                                                console.log(`üîç Ï≤òÎ¶¨Ìï† Ïò§ÎîîÏò§ shot Í∞úÏàò: ${audioShots.length}`);
                                                console.log(`üîç Ïò§ÎîîÏò§ shot IDs:`, audioShots.map(s => s.id));
                                                
                                                let matchedCount = 0;
                                                audioShots.forEach((audioShot, audioIndex) => {
                                                    console.log(`üîç Ïò§ÎîîÏò§ Shot ${audioIndex + 1}:`, audioShot);
                                                    
                                                    const shotId = audioShot.id;
                                                    console.log(`üîç Ï∞æÎäî shot_id: ${shotId}`);
                                                    
                                                    if (shotId) {
                                                        const shot = currentData.breakdown_data.shots.find(s => s.id === shotId);
                                                        
                                                        if (shot) {
                                                            console.log(`‚úÖ Shot Îß§ÏπòÎê®: ${shotId}`);
                                                            
                                                            // shot.contentÍ∞Ä ÏóÜÏúºÎ©¥ ÏÉùÏÑ±
                                                            if (!shot.content) {
                                                                shot.content = {};
                                                            }
                                                            
                                                            // Stage 8 JSON Íµ¨Ï°∞ÏóêÏÑú Ïò§ÎîîÏò§ Ï†ïÎ≥¥ Ï∂îÏ∂ú Î∞è Î≥ëÌï©
                                                            if (audioShot.content) {
                                                                // dialogue_by_character, dialogue_sequence, narration Îì±ÏùÑ Î≥ëÌï©
                                                                Object.assign(shot.content, audioShot.content);
                                                                console.log(`‚úÖ content Î≥ëÌï©Îê®:`, audioShot.content);
                                                                console.log(`‚úÖ Î≥ëÌï© ÌõÑ shot.content:`, shot.content);
                                                                console.log(`‚úÖ dialogue_by_character:`, shot.content.dialogue_by_character);
                                                                console.log(`‚úÖ dialogue_sequence:`, shot.content.dialogue_sequence);
                                                            }
                                                            
                                                            // audio_prompts Î≥ëÌï© Î∞è ÌïúÍ∏Ä ÏùåÌñ•Ìö®Í≥º ÏÑ§Î™Ö Ï≤òÎ¶¨
                                                            if (audioShot.audio_prompts) {
                                                                shot.audio_prompts = audioShot.audio_prompts;
                                                                console.log(`‚úÖ audio_prompts Î≥ëÌï©Îê®`);
                                                                
                                                                // Stage 8ÏóêÏÑú ÌïúÍ∏Ä ÏùåÌñ•Ìö®Í≥º ÏÑ§Î™Ö Ï∂îÏ∂ú (Í∞úÏÑ†Îêú Î°úÏßÅ)
                                                                // Ïù¥ÎØ∏ sound_effectsÍ∞Ä ÏûàÏúºÎ©¥ ÎçÆÏñ¥Ïì∞ÏßÄ ÏïäÏùå
                                                                if (audioShot.audio_prompts.sound_effects && !shot.content.sound_effects) {
                                                                    if (audioShot.audio_prompts.sound_effects.prompt_ko) {
                                                                        // prompt_koÏóêÏÑú ÌïúÍ∏Ä ÏÑ§Î™Ö Ï∂îÏ∂ú
                                                                        const promptKo = audioShot.audio_prompts.sound_effects.prompt_ko;
                                                                        let koDescription = '';
                                                                        
                                                                        // Ïó¨Îü¨ Ìå®ÌÑ¥ÏúºÎ°ú ÏãúÎèÑ
                                                                        // Ìå®ÌÑ¥ 1: "ÏùåÌñ•:" Îã§Ïùå Î∂ÄÎ∂Ñ Ï∂îÏ∂ú
                                                                        const pattern1 = promptKo.match(/ÏùåÌñ•:\s*(.+?)(?:\.|$)/);
                                                                        if (pattern1) {
                                                                            koDescription = pattern1[1].trim();
                                                                        }
                                                                        
                                                                        // Ìå®ÌÑ¥ 2: ÏÉ∑ Î≤àÌò∏ÏôÄ "ÏùåÌñ•:" Ï†úÍ±∞ (ÏõêÎ≥∏ Î°úÏßÅ)
                                                                        if (!koDescription) {
                                                                            koDescription = promptKo.replace(/^[^\s]+\s+ÏùåÌñ•:\s*/, '');
                                                                        }
                                                                        
                                                                        // Ìå®ÌÑ¥ 3: ÏΩúÎ°† ÏïûÎ∂ÄÎ∂ÑÎßå Ï∂îÏ∂ú
                                                                        if (!koDescription && promptKo.includes(':')) {
                                                                            const colonIndex = promptKo.indexOf(':');
                                                                            koDescription = promptKo.substring(0, colonIndex).trim();
                                                                        }
                                                                        
                                                                        // Ìå®ÌÑ¥ 4: Ï†ÑÏ≤¥ Î¨∏ÏûêÏó¥ ÏÇ¨Ïö© (ÏÉ∑ Î≤àÌò∏Îßå Ï†úÍ±∞)
                                                                        if (!koDescription) {
                                                                            koDescription = promptKo.replace(/^S\d+\.\d+\s*/, '').trim();
                                                                        }
                                                                        
                                                                        shot.content.sound_effects = koDescription;
                                                                        console.log(`‚úÖ ÌïúÍ∏Ä ÏùåÌñ•Ìö®Í≥º ÏÑ§Î™Ö Ï∂îÏ∂úÎê®:`, koDescription);
                                                                    } else if (audioShot.audio_prompts.sound_effects.description) {
                                                                        // fallback: description ÏÇ¨Ïö©
                                                                        shot.content.sound_effects = audioShot.audio_prompts.sound_effects.description;
                                                                        console.log(`‚úÖ ÏùåÌñ•Ìö®Í≥º description ÏÇ¨Ïö©:`, shot.content.sound_effects);
                                                                    }
                                                                }
                                                            }
                                                            
                                                            // music_memo Î≥ëÌï©
                                                            if (audioShot.music_memo) {
                                                                shot.music_memo = audioShot.music_memo;
                                                                console.log(`‚úÖ music_memo Î≥ëÌï©Îê®`);
                                                            }
                                                            
                                                            audioDataUpdated = true;
                                                            matchedCount++;
                                                        } else {
                                                            console.warn(`‚ùå ShotÏùÑ Ï∞æÏùÑ Ïàò ÏóÜÏùå: ${shotId}`);
                                                        }
                                                    } else {
                                                        console.warn(`‚ùå shot_idÍ∞Ä ÏóÜÎäî Ïò§ÎîîÏò§ Shot:`, audioShot);
                                                    }
                                                });
                                                
                                                console.log(`üìä Îß§ÏπòÎêú Ïò§ÎîîÏò§ Îç∞Ïù¥ÌÑ∞: ${matchedCount}/${audioShots.length}`);
                                                successCount++;
                                            } else {
                                                console.warn(`Í∏∞Î≥∏ ÌîÑÎ°úÏ†ùÌä∏ Îç∞Ïù¥ÌÑ∞ Î∂ÄÏ°±ÏúºÎ°ú ÌååÏùº Í±¥ÎÑàÎúÄ: ${fileNames[index]}`);
                                            }
                                        } else {
                                            console.warn(`Stage 8 ÌòïÏãùÏù¥ ÏïÑÎãå ÌååÏùº: ${fileNames[index]}`);
                                        }
                                    } else {
                                        console.error(`JSON ÌååÏùº Ï≤òÎ¶¨ Ïã§Ìå®: ${fileNames[index]}`);
                                    }
                                } catch (error) {
                                    console.error(`ÌååÏùº Ï≤òÎ¶¨ Ïò§Î•ò (${fileNames[index]}):`, error);
                                }
                                
                                processedCount++;
                                
                                // Î™®Îì† ÌååÏùº Ï≤òÎ¶¨ ÏôÑÎ£åÏãú Î©îÏãúÏßÄ ÌëúÏãú Î∞è Ï†ÄÏû•
                                if (processedCount === jsonFiles.length) {
                                    if (successCount > 0 && audioDataUpdated) {
                                        saveDataToLocalStorage();
                                        updateUI();
                                        console.log(`‚úÖ ${successCount}Í∞úÏùò Stage 8 ÌååÏùºÏùÑ ÏÑ±Í≥µÏ†ÅÏúºÎ°ú Î°úÎìúÌñàÏäµÎãàÎã§. (Ï¥ù ${jsonFiles.length}Í∞ú Ï§ë)`);
                                    } else if (successCount > 0) {
                                        showMessage('Ïò§ÎîîÏò§ Îç∞Ïù¥ÌÑ∞ Î≥ëÌï© Ï§ë Î¨∏Ï†úÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§.', 'warning');
                                    } else if (processedCount > 0) {
                                        showMessage('Stage 8 Îç∞Ïù¥ÌÑ∞Î•º Î°úÎìúÌïòÎ†§Î©¥ Î®ºÏ†Ä Í∏∞Î≥∏ ÌîÑÎ°úÏ†ùÌä∏ Îç∞Ïù¥ÌÑ∞Î•º Î°úÎìúÌï¥Ïïº Ìï©ÎãàÎã§.', 'warning');
                                    } else {
                                        showMessage('Stage 8 ÌòïÏãùÏùò JSON ÌååÏùºÏùÑ Ï∞æÏùÑ Ïàò ÏóÜÏäµÎãàÎã§.', 'warning');
                                    }
                                }
                            });
                            
                            // Ï≤òÎ¶¨ ÏôÑÎ£å ÌîåÎûòÍ∑∏ ÏÑ§Ï†ï (ÏûÑÏãú Îç∞Ïù¥ÌÑ∞Îäî Ïú†ÏßÄ)
                            localStorage.setItem('stage8TempProcessed', 'true');
                            
                        } catch (error) {
                            console.error('Stage 8 Ïó¨Îü¨ ÏûÑÏãú JSON Î°úÎìú Ïò§Î•ò:', error);
                            showMessage('ÏûÑÏãú Ï†ÄÏû•Îêú JSON ÌååÏùºÎì§ÏùÑ Î°úÎìúÌï† Ïàò ÏóÜÏäµÎãàÎã§.', 'error');
                            // Ïò§Î•ò ÏãúÏóêÎèÑ ÏûÑÏãú Îç∞Ïù¥ÌÑ∞ Ïú†ÏßÄ (Ïû¨ÏãúÎèÑ Í∞ÄÎä•ÌïòÎèÑÎ°ù)
                        }
                    } else {
                        console.log('ÏûÑÏãú Ï†ÄÏû•Îêú Stage 8 JSON Îç∞Ïù¥ÌÑ∞Îì§ÏùÑ Ï∞æÏùÑ Ïàò ÏóÜÏäµÎãàÎã§.');
                        showMessage('ÏûÑÏãú Ï†ÄÏû•Îêú ÌååÏùºÎì§ÏùÑ Ï∞æÏùÑ Ïàò ÏóÜÏäµÎãàÎã§.', 'warning');
                    }
                }, 5000);
            }
            // Í∏∞Ï°¥ autoImport ÌååÎùºÎØ∏ÌÑ∞ Ï≤òÎ¶¨
            else if (urlParams.get('autoImport') === 'true') {
                console.log('üîÑ ÏûêÎèô JSON Í∞ÄÏ†∏Ïò§Í∏∞ Ïã§Ìñâ...');
                setTimeout(() => {
                    // ÌååÏùº ÏûÖÎ†• ÏöîÏÜå ÏßÅÏ†ë ÌÅ¥Î¶≠ÌïòÏó¨ ÌååÏùº ÏÑ†ÌÉù ÎåÄÌôîÏÉÅÏûê Ïó¥Í∏∞
                    const fileInput = document.getElementById('file-input');
                    if (fileInput) {
                        fileInput.click();
                        showMessage('JSON ÌååÏùºÏùÑ ÏÑ†ÌÉùÌï¥Ï£ºÏÑ∏Ïöî.', 'info');
                        console.log('‚úÖ ÌååÏùº ÏÑ†ÌÉù ÎåÄÌôîÏÉÅÏûêÍ∞Ä Ïó¥Î†∏ÏäµÎãàÎã§.');
                    } else {
                        console.error('‚ùå ÌååÏùº ÏûÖÎ†• ÏöîÏÜåÎ•º Ï∞æÏùÑ Ïàò ÏóÜÏäµÎãàÎã§.');
                        showMessage('ÌååÏùº ÏûÖÎ†• ÏöîÏÜåÎ•º Ï∞æÏùÑ Ïàò ÏóÜÏäµÎãàÎã§.', 'error');
                    }
                }, 1500); // 1.5Ï¥à ÏßÄÏó∞ÏúºÎ°ú ÌéòÏù¥ÏßÄÍ∞Ä ÏôÑÏ†ÑÌûà Î°úÎìúÎêú ÌõÑ Ïã§Ìñâ
            }
            
            console.log('‚úÖ Ï¥àÍ∏∞Ìôî ÏôÑÎ£å');
        } catch (error) {
            console.error('‚ùå Ï¥àÍ∏∞Ìôî Ïò§Î•ò:', error);
            showMessage(`Ï¥àÍ∏∞Ìôî Ïò§Î•ò: ${error.message}`, 'error');
        }
    });
    
    console.log('‚úÖ JavaScript Î°úÎî© ÏôÑÎ£å');
</script>
</body>
</html>