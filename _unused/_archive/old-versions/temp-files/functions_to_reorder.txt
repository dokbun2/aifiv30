  6157	        // AIë¥¼ í†µí•œ í”„ë¡¬í”„íŠ¸ ìµœì í™” ë° ì˜ë¬¸ ë²ˆì—­
  6158	        async function optimizePromptWithAI(data) {
  6159	            try {
  6160	                const configStr = localStorage.getItem('aiApiConfig');
  6161	                if (!configStr) {
  6162	                    throw new Error('API ì„¤ì •ì´ ì—†ìŠµë‹ˆë‹¤.');
  6163	                }
  6164	                
  6165	                const config = JSON.parse(configStr);
  6166	                if (!config || !config.provider || !config.apiKey || !config.model) {
  6167	                    throw new Error('API ì„¤ì •ì´ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.');
  6168	                }
  6169	                
  6170	                const { provider, apiKey, model } = config;
  6171	                
  6172	                console.log('=== AI API ì„¤ì • ===');
  6173	                console.log('Provider:', provider);
  6174	                console.log('Model:', model);
  6175	                console.log('API Key:', apiKey ? `${apiKey.substring(0, 10)}...` : 'ì—†ìŒ');
  6176	                
  6177	                // ê° ì„¹ì…˜ë³„ë¡œ ê°œë³„ ìµœì í™”
  6178	                const optimizedData = {};
  6179	                
  6180	                for (const [key, value] of Object.entries(data)) {
  6181	                    if (!value || value.trim() === '') continue;
  6182	                    
  6183	                    console.log(`\n=== ${key} ì„¹ì…˜ ìµœì í™” ì‹œì‘ ===`);
  6184	                    console.log('ì›ë³¸:', value);
  6185	                    
  6186	                    try {
  6187	                        const optimizedText = await optimizeSinglePrompt(value, provider, apiKey, model);
  6188	                        optimizedData[key] = optimizedText;
  6189	                        console.log('ìµœì í™” ê²°ê³¼:', optimizedText);
  6190	                    } catch (error) {
  6191	                        console.error(`${key} ìµœì í™” ì‹¤íŒ¨:`, error);
  6192	                        // ì‹¤íŒ¨ ì‹œ ì›ë³¸ ì‚¬ìš©
  6193	                        optimizedData[key] = value;
  6194	                    }
  6195	                }
  6196	                
  6197	                return optimizedData;
  6198	            } catch (error) {
  6199	                console.error('AI ìµœì í™” ì´ˆê¸°í™” ì‹¤íŒ¨:', error);
  6200	                throw error;
  6201	            }
  6202	        }
  6203	        
  6204	        // ë‹¨ì¼ í”„ë¡¬í”„íŠ¸ ìµœì í™” í•¨ìˆ˜ - optimizePromptWithAIë³´ë‹¤ ë¨¼ì € ì •ì˜
  6205	        async function optimizeSinglePrompt(text, provider, apiKey, model) {
  6206	            // ìˆ˜ì§‘ëœ ë°ì´í„°ë¥¼ í”„ë¡¬í”„íŠ¸ í…ìŠ¤íŠ¸ë¡œ ë³€í™˜
  6207	            let promptText = '';
  6208	            if (typeof text === 'string') {
  6209	                promptText = text;
  6210	            } else if (text && typeof text === 'object') {
  6211	                // êµ¬ì¡°í™”ëœ ë°ì´í„°ì¸ ê²½ìš°
  6212	                promptText = Object.entries(text)
  6213	                    .map(([key, value]) => `${key}: ${value}`)
  6214	                    .join(', ');
  6215	            } else {
  6216	                promptText = String(text || '');
  6217	            }
  6218	            
  6219	            console.log('=== í”„ë¡¬í”„íŠ¸ ì •ë³´ ===');
  6220	            console.log('ì…ë ¥ ë°ì´í„°:', text);
  6221	            console.log('ë³€í™˜ëœ í”„ë¡¬í”„íŠ¸ í…ìŠ¤íŠ¸:', promptText);
  6222	            console.log('í…ìŠ¤íŠ¸ ê¸¸ì´:', promptText.length);
  6223	            
  6224	            const systemPrompt = `You are a translator for AI image generation prompts.
  6225	Your task is to:
  6226	1. Identify Korean text in the input
  6227	2. Translate ONLY the Korean parts to English
  6228	3. Keep any existing English text exactly as is
  6229	4. Do NOT combine or merge the translations with existing English
  6230	5. Output ONLY the translated Korean parts without any explanations
  6231	
  6232	Examples:
  6233	- Input: "ë¹¨ê°„ ë“œë ˆìŠ¤ red dress" â†’ Output: "red dress"
  6234	- Input: "ê¸´ ë¨¸ë¦¬ woman with braids" â†’ Output: "long hair"
  6235	- Input: "blue eyes íŒŒë€ ëˆˆ" â†’ Output: "blue eyes"`;
  6236	            
  6237	            try {
  6238	                let optimizedText;
  6239	                
  6240	                if (provider === 'gemini') {
  6241	                    const geminiUrl = `https://generativelanguage.googleapis.com/v1beta/models/${model}:generateContent?key=${apiKey}`;
  6242	                    const geminiBody = {
  6243	                        contents: [{
  6244	                            parts: [{
  6245	                                text: `${systemPrompt}\n\nTranslate only Korean parts: ${promptText}`
  6246	                            }]
  6247	                        }],
  6248	                        generationConfig: {
  6249	                            temperature: 0.3,
  6250	                            maxOutputTokens: 500
  6251	                        }
  6252	                    };
  6253	                    
  6254	                    console.log('=== Gemini API ìš”ì²­ ===');
  6255	                    console.log('URL:', geminiUrl.replace(apiKey, 'API_KEY_HIDDEN'));
  6256	                    console.log('Model:', model);
  6257	                    console.log('Request Body:', JSON.stringify(geminiBody, null, 2));
  6258	                    
  6259	                    // ì§€ì›ë˜ëŠ” ëª¨ë¸ ëª©ë¡ í‘œì‹œ
  6260	                    console.log('ğŸ’¡ ìš”ì²­í•œ ëª¨ë¸:', model);
  6261	                    console.log('ğŸ’¡ ì§€ì›ë˜ëŠ” Gemini ëª¨ë¸: gemini-2.5-flash, gemini-2.5-pro, gemini-1.5-flash, gemini-1.5-pro');
  6262	                    
  6263	                    const response = await fetch(geminiUrl, {
  6264	                        method: 'POST',
  6265	                        headers: {
  6266	                            'Content-Type': 'application/json',
  6267	                        },
  6268	                        body: JSON.stringify(geminiBody)
  6269	                    });
  6270	                    
  6271	                    console.log('=== Gemini API ì‘ë‹µ ìƒíƒœ ===');
  6272	                    console.log('Status:', response.status);
  6273	                    console.log('StatusText:', response.statusText);
  6274	                    console.log('Headers:', response.headers);
  6275	                    
  6276	                    const responseText = await response.text();
  6277	                    console.log('Raw Response:', responseText);
  6278	                    
  6279	                    let data;
  6280	                    try {
  6281	                        data = JSON.parse(responseText);
  6282	                    } catch (parseError) {
  6283	                        console.error('JSON íŒŒì‹± ì‹¤íŒ¨:', parseError);
  6284	                        console.error('ì‘ë‹µ í…ìŠ¤íŠ¸:', responseText);
  6285	                        throw new Error('API ì‘ë‹µì„ íŒŒì‹±í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
  6286	                    }
  6287	                    
  6288	                    if (response.ok) {
  6289	                        console.log('Parsed Gemini API ì‘ë‹µ:', JSON.stringify(data, null, 2));
  6290	                        
  6291	                        // ë‹¤ì–‘í•œ ì‘ë‹µ êµ¬ì¡° ì²˜ë¦¬
  6292	                        if (data && data.candidates && data.candidates.length > 0) {
  6293	                            const candidate = data.candidates[0];
  6294	                            if (candidate.content && candidate.content.parts && candidate.content.parts.length > 0) {
  6295	                                optimizedText = candidate.content.parts[0].text;
  6296	                                console.log('Gemini ìµœì í™”ëœ í…ìŠ¤íŠ¸:', optimizedText);
  6297	                            } else if (candidate.text) {
  6298	                                // ë‹¤ë¥¸ ê°€ëŠ¥í•œ ì‘ë‹µ êµ¬ì¡°
  6299	                                optimizedText = candidate.text;
  6300	                                console.log('Gemini ìµœì í™”ëœ í…ìŠ¤íŠ¸ (ëŒ€ì²´ êµ¬ì¡°):', optimizedText);
  6301	                            } else {
  6302	                                console.error('Candidate êµ¬ì¡°ê°€ ì˜ˆìƒê³¼ ë‹¤ë¦„:', candidate);
  6303	                                throw new Error('ì‘ë‹µì—ì„œ í…ìŠ¤íŠ¸ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
  6304	                            }
  6305	                        } else if (data && data.error) {
  6306	                            console.error('Gemini API ì—ëŸ¬ ì‘ë‹µ:', data.error);
  6307	                            const errorMessage = data.error.message || data.error.status || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜';
  6308	                            const errorCode = data.error.code || 'UNKNOWN';
  6309	                            throw new Error(`Gemini API ì—ëŸ¬ [${errorCode}]: ${errorMessage}`);
  6310	                        } else {
  6311	                            console.error('ì˜ˆìƒì¹˜ ëª»í•œ Gemini API ì‘ë‹µ êµ¬ì¡°:', data);
  6312	                            throw new Error('Gemini API ì‘ë‹µ êµ¬ì¡°ê°€ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.');
  6313	                        }
  6314	                    } else {
  6315	                        // ì˜¤ë¥˜ ì‘ë‹µ ì²˜ë¦¬
  6316	                        console.error('Gemini API ì˜¤ë¥˜ ì‘ë‹µ:', data);
  6317	                        console.error('ì‘ë‹µ ìƒíƒœ ì½”ë“œ:', response.status);
  6318	                        console.error('ìš”ì²­í•œ ëª¨ë¸:', model);
  6319	                        
  6320	                        if (data && data.error) {
  6321	                            const errorMessage = data.error.message || data.error.status || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜';
  6322	                            const errorCode = data.error.code || response.status;
  6323	                            console.error('ì—ëŸ¬ ì½”ë“œ:', errorCode);
  6324	                            console.error('ì—ëŸ¬ ë©”ì‹œì§€:', errorMessage);
  6325	                            
  6326	                            // ì¼ë°˜ì ì¸ ì˜¤ë¥˜ ë©”ì‹œì§€ ì²˜ë¦¬
  6327	                            let userMessage = errorMessage;
  6328	                            if (response.status === 400) {
  6329	                                userMessage = 'API ìš”ì²­ì´ ì˜ëª»ë˜ì—ˆìŠµë‹ˆë‹¤. API í‚¤ì™€ ëª¨ë¸ëª…ì„ í™•ì¸í•´ì£¼ì„¸ìš”.';
  6330	                            } else if (response.status === 401) {
  6331	                                userMessage = 'API í‚¤ê°€ ìœ íš¨í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤. ì„¤ì •ì„ í™•ì¸í•´ì£¼ì„¸ìš”.';
  6332	                            } else if (response.status === 403) {
  6333	                                userMessage = 'API ì ‘ê·¼ì´ ê±°ë¶€ë˜ì—ˆìŠµë‹ˆë‹¤. API í‚¤ ê¶Œí•œì„ í™•ì¸í•´ì£¼ì„¸ìš”.';
  6334	                            } else if (response.status === 429) {
  6335	                                userMessage = 'API ìš”ì²­ í•œë„ë¥¼ ì´ˆê³¼í–ˆìŠµë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.';
  6336	                            } else if (response.status === 404) {
  6337	                                userMessage = 'ì˜ëª»ëœ ëª¨ë¸ëª…ì…ë‹ˆë‹¤. gemini-1.5-flash ë˜ëŠ” gemini-1.5-proë¥¼ ì‚¬ìš©í•´ë³´ì„¸ìš”.';
  6338	                            }
  6339	                            
  6340	                            throw new Error(`[${errorCode}] ${userMessage}`);
  6341	                        } else {
  6342	                            throw new Error(`API ìš”ì²­ ì‹¤íŒ¨: ${response.status} ${response.statusText}`);
  6343	                        }
  6344	                    }
  6345	                } else if (provider === 'openai') {
  6346	                    const response = await fetch('https://api.openai.com/v1/chat/completions', {
  6347	                        method: 'POST',
  6348	                        headers: {
  6349	                            'Content-Type': 'application/json',
  6350	                            'Authorization': `Bearer ${apiKey}`
  6351	                        },
  6352	                        body: JSON.stringify({
  6353	                            model: model,
  6354	                            messages: [
  6355	                                {
  6356	                                    role: 'system',
  6357	                                    content: systemPrompt
  6358	                                },
  6359	                                {
  6360	                                    role: 'user',
  6361	                                    content: `Translate only Korean parts: ${promptText}`
  6362	                                }
  6363	                            ],
  6364	                            temperature: 0.3,
  6365	                            max_tokens: 500
  6366	                        })
  6367	                    });
  6368	                    
  6369	                    if (response.ok) {
  6370	                        const data = await response.json();
  6371	                        console.log('OpenAI API ì‘ë‹µ:', data);
  6372	                        
  6373	                        // ì•ˆì „í•œ íŒŒì‹±
  6374	                        if (data && data.choices && data.choices[0] && 
  6375	                            data.choices[0].message && data.choices[0].message.content) {
  6376	                            optimizedText = data.choices[0].message.content;
  6377	                            console.log('OpenAI ìµœì í™”ëœ í…ìŠ¤íŠ¸:', optimizedText);
  6378	                        } else if (data && data.error) {
  6379	                            console.error('OpenAI API ì—ëŸ¬:', data.error);
  6380	                            throw new Error(`OpenAI API ì—ëŸ¬: ${data.error.message || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜'}`);
  6381	                        } else {
  6382	                            console.error('ì˜ˆìƒì¹˜ ëª»í•œ OpenAI API ì‘ë‹µ êµ¬ì¡°:', data);
  6383	                            throw new Error('OpenAI API ì‘ë‹µ êµ¬ì¡°ê°€ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.');
  6384	                        }
  6385	                    } else {
  6386	                        const errorData = await response.json().catch(() => null);
  6387	                        console.error('OpenAI API ìš”ì²­ ì‹¤íŒ¨:', response.status, errorData);
  6388	                        throw new Error(`API ìš”ì²­ ì‹¤íŒ¨: ${response.status} ${errorData?.error?.message || ''}`);
  6389	                    }
  6390	                }
  6391	                
  6392	                return optimizedText;
  6393	            } catch (error) {
  6394	                console.error('ë‹¨ì¼ í”„ë¡¬í”„íŠ¸ ìµœì í™” ì‹¤íŒ¨:', error);
  6395	                
  6396	                // CORS ì˜¤ë¥˜ ê°ì§€
  6397	                if (error.message.includes('Failed to fetch') || error.message.includes('NetworkError') || error.name === 'TypeError') {
  6398	                    console.error('ğŸš« CORS ì˜¤ë¥˜ ê°ì§€ë¨!');
  6399	                    console.error('í•´ê²° ë°©ë²•:');
  6400	                    console.error('1. Chrome í™•ì¥ í”„ë¡œê·¸ë¨: "Allow CORS" ë˜ëŠ” "CORS Unblock" ì„¤ì¹˜');
  6401	                    console.error('2. í”„ë¡ì‹œ ì„œë²„ ì‚¬ìš© (https://cors-anywhere.herokuapp.com/ ë“±)');
  6402	                    console.error('3. ë¡œì»¬ ê°œë°œ ì„œë²„ì—ì„œ CORS ì„¤ì •');
  6403	                    throw new Error('CORS ì˜¤ë¥˜: ë¸Œë¼ìš°ì €ì—ì„œ API í˜¸ì¶œì´ ì°¨ë‹¨ë˜ì—ˆìŠµë‹ˆë‹¤. ìœ„ì˜ í•´ê²° ë°©ë²•ì„ ì°¸ê³ í•´ì£¼ì„¸ìš”.');
  6404	                }
  6405	                
  6406	                throw error;
  6407	            }
  6408	        }
